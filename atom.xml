<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zhishengçš„åšå®¢</title>
  
  <subtitle>å‘è¦ä¸€ä¸ªä¸ªå¡«ï¼Œè·¯è¦ä¸€æ­¥æ­¥èµ°ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.54tianzhisheng.cn/"/>
  <updated>2022-11-09T16:27:04.077Z</updated>
  <id>http://www.54tianzhisheng.cn/</id>
  
  <author>
    <name>zhisheng</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å…³é—­ Flink Checkpointï¼Œå¼•å‘ P3 æ•…éšœ</title>
    <link href="http://www.54tianzhisheng.cn/2022/10/09/flink-disable-checkpoint/"/>
    <id>http://www.54tianzhisheng.cn/2022/10/09/flink-disable-checkpoint/</id>
    <published>2022-10-08T16:00:00.000Z</published>
    <updated>2022-11-09T16:27:04.077Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„ä¹‰çš„æ•…éšœï¼Œæ²¡é‡åˆ°çš„å¯ä»¥é¿å‘ï¼Œå·²ç»è¢«å‘è¿‡çš„åªèƒ½æ¡æ‰‹ğŸ¤äº†ã€‚</p><a id="more"></a><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>å› é˜¿é‡Œäº‘æç¤ºæœºå™¨æœ‰æ•…éšœï¼Œä¼šåœ¨ç¬¬äºŒå¤©æ—©é«˜å³°è‡ªåŠ¨é‡å¯ï¼ŒæŒ‰ç…§ä¹‹å‰è¿ç»´æ“ä½œï¼Œæå‰åšå¥½é€šçŸ¥åï¼Œåœ¨é›†ç¾¤éé«˜å³°æœŸå°†æœºå™¨è¸¢å‡ºé›†ç¾¤ã€‚è¸¢å‡ºé›†ç¾¤æ—¶è¯¥æœºå™¨ä¸Šè¿è¡Œçš„ TaskManager Pod ä¼šæŒ‚æ‰ï¼ŒFlink ä¼šåœ¨å…¶ä»–æ­£å¸¸æœºå™¨ä¸Šç”³è¯·æ–°çš„ TaskManager è¿è¡Œï¼ŒæœŸé—´ä¼šæœ‰ä»»åŠ¡çš„ failoverã€‚</p><p>æ“ä½œå 10 æ¥åˆ†é’Ÿçœ‹åˆ°å…¬å¸å¤§ç¾¤æœ‰å€¼ç­åŒäº‹å“åº”æŒ‡æ ‡å¼‚å¸¸é—®é¢˜ï¼ŒåŠ å…¥åˆ°é—®é¢˜ç¾¤èŠä¸­å‘ç°å¯èƒ½å’Œå‰”é™¤æ•…éšœæœºå™¨æœ‰å…³ï¼Œäºæ˜¯åŠ å…¥æ’æŸ¥ï¼Œæä¾›äº†å½“æ—¶å—å½±å“çš„ä»»åŠ¡ä¿¡æ¯ï¼Œå‘ç°äº†å¼‚å¸¸æŒ‡æ ‡å¯¹åº”çš„ä»»åŠ¡å½“æ—¶åœ¨æ¶ˆè´¹ 10 åˆ†é’Ÿä¹‹å‰çš„æ•°æ®ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-140823.png" alt="Flink ä»»åŠ¡æ¶ˆè´¹åˆ°çš„æ•°æ®æ—¶é—´"></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-141234.png" alt="Flink ä»»åŠ¡æ¶ˆè´¹å»¶è¿Ÿæ—¶é—´"></p><p>è€Œè¿™ä¸ªæ¶ˆè´¹å»¶è¿Ÿæ—¶é•¿å¯¹äºè¯¥ä½œä¸šçš„ä¸šåŠ¡åœºæ™¯å®Œå…¨ä¸èƒ½æ¥å—ï¼ˆå»¶è¿Ÿ 10s å°±ä¼šé€ æˆå¾ˆå¤§é—®é¢˜ï¼‰ï¼Œæœ€ç»ˆå»¶è¿Ÿå¯¼è‡´ä¸šåŠ¡æŒ‡æ ‡ä¸‹è·Œï¼Œäº§ç”Ÿèµ„æŸï¼Œæ•…éšœæœ€ç»ˆå®šçº§ P3ã€‚</p><p>è§£å†³åŠæ³•ï¼šä¸šåŠ¡æ–¹åœäº†å‡ ä¸ªåŒæ­¥æ•°æ®åˆ° ES ç´¢å¼•çš„ä»»åŠ¡ï¼Œç„¶åé‡å»ºäº†ä¸»é“¾ç´¢å¼•ä»»åŠ¡ï¼ˆä»»åŠ¡åŒæ—¶åŠ å¤§å¹¶å‘ï¼‰ï¼Œä¸‹æ¸¸åˆ‡æ¢åˆ°æ–°ç´¢å¼•å³æ¢å¤ã€‚</p><h3 id="æ•…éšœæ ¹å› åˆ†æè¿‡ç¨‹"><a href="#æ•…éšœæ ¹å› åˆ†æè¿‡ç¨‹" class="headerlink" title="æ•…éšœæ ¹å› åˆ†æè¿‡ç¨‹"></a>æ•…éšœæ ¹å› åˆ†æè¿‡ç¨‹</h3><p>äº‹åæ‰¾ä¸šåŠ¡æ–¹çº¿ä¸‹è®¨è®ºäº†ä¸€ä¸‹ï¼Œåˆæ­¥åˆ†ææ˜¯ ES å‹åŠ›å¤§ï¼Œå¯¼è‡´ Flink ä»»åŠ¡æœ‰åå‹ï¼Œä»è€Œå¼•èµ·ä»»åŠ¡ Source ç«¯æ¶ˆè´¹ Kafka æ•°æ®å¯¼è‡´çš„å»¶è¿Ÿã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-143142.png" alt="ES CPU ç›‘æ§"></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-143238.jpg" alt="Flink ä»»åŠ¡åå‹ç›‘æ§"></p><p>æœ¬ä»¥ä¸ºç»“è®ºå°±æ˜¯å‰”é™¤æœºå™¨åï¼Œå—å½±å“ä»»åŠ¡æ¯”è¾ƒå¤šï¼Œä»»åŠ¡ failover åä¼šä»ä¸Šä¸€æ¬¡ Checkpoint ä¿å­˜çš„ Kafka offset å¼€å§‹æ¶ˆè´¹ï¼Œè¿™æ—¶å€™å†™åˆ° ES çš„æ•°æ®é‡ä¼šæ¯”æ­£å¸¸å¤š 2min å·¦å³çš„æ•°æ®ï¼ˆCheckpoint é›†ç¾¤é»˜è®¤è®¾ç½®çš„ 2min æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œä»è€Œå¯¼è‡´å¯¹ ES æœ‰ç‚¹å‹åŠ›è¿›è€Œå½±å“åˆ° Flink ä»»åŠ¡å‡ºç°åå‹æƒ…å†µã€‚ä½†æ˜¯æ™šä¸Šä¸šåŠ¡æ–¹ç»™æˆ‘æä¾›äº†ä¸€ä¸ªå¦å¤–å—å½±å“ä»»åŠ¡ï¼ˆè¿™é‡Œç§°å¤‡é“¾ä»»åŠ¡ï¼Œä¸»é“¾ä»»åŠ¡å°±æ˜¯é‚£ä¸ªæ¶ˆè´¹ 10 åˆ†é’Ÿä¹‹å‰æ•°æ®çš„ä»»åŠ¡ï¼‰çš„ä½œä¸šç›‘æ§é“¾æ¥ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡è¿™ä¸ªä»»åŠ¡çš„ç›‘æ§ä¿¡æ¯æ‰çœŸæ­£å‘ç°é—®é¢˜çš„æ ¹å› ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-144829.png" alt=""></p><p>å½“æ—¶å‘ç°è¿™ä¸ªå¤‡é“¾ä»»åŠ¡åœ¨æ•…éšœåæœ‰å¤§éƒ¨åˆ† TaskManager çš„ task æ˜¯ä» 22 ä¸ªå°æ—¶ä¹‹å‰çš„æ•°æ®å¼€å§‹æ¶ˆè´¹çš„ï¼Œå¦‚ä¸‹å›¾ç›‘æ§æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-150438.png" alt=""></p><p>åˆæœ‰å°‘éƒ¨åˆ† TaskManager çš„ task æ˜¯æ­£å¸¸æ¶ˆè´¹çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-150640.png" alt=""></p><p>åœ¨ failover ä¹‹åè¯¥å¤‡é“¾ä»»åŠ¡çš„æ¶ˆè´¹é€Ÿåº¦ TPS ä»æ­£å¸¸çš„ä¸¤åƒå¢é•¿åˆ° 12W/s</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-151423.png" alt=""></p><p>ä¸»é“¾ä»»åŠ¡ failover åæ‰€æœ‰çš„ task æ¶ˆè´¹æ¯”è¾ƒæ­£å¸¸ï¼ˆå‰æ–‡å·²æˆªå›¾ï¼‰ï¼Œå¯¹æ¯”å‡ ä¸ªç›‘æ§æ¥çœ‹è¯¥å¤‡é“¾ä»»åŠ¡åœ¨ failover åæ˜æ˜¾æ¶ˆè´¹æœ‰å¼‚å¸¸ï¼Œå³æ¶ˆè´¹ 22 å°æ—¶ä¹‹å‰çš„æ•°æ®ï¼ŒåŒæ—¶çœ‹åˆ°ä»»åŠ¡å¯åŠ¨è¿è¡Œæ—¶é•¿å°±æ˜¯ 22 å°æ—¶å·¦å³ï¼Œç›¸å½“äºä»ä»»åŠ¡å¼€ç¬¬ä¸€æ¬¡å§‹å¯åŠ¨çš„æ—¶å€™æŒ‡å®šçš„æ—¶é—´ç‚¹å¼€å§‹æ¶ˆè´¹äº†ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-153006.png" alt=""></p><p>æ—¢ç„¶ä¸»é“¾å’Œå¤‡é“¾ä»»åŠ¡ failover åçš„æ¶ˆè´¹ç­–ç•¥éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘å½“æ—¶ç¬¬ä¸€ååº”è§‰å¾—æ˜¯ä¸æ˜¯å¤‡é“¾ä»»åŠ¡é•¿æœŸ Checkpoint å¤±è´¥ï¼Œç„¶å failover åä»æ—©æœŸå®Œæˆçš„ Checkpoint ä¸­ä¿å­˜çš„ offset å¼€å§‹æ¶ˆè´¹ï¼Œä»è€Œå¯¼è‡´çš„æ¶ˆè´¹ 22 å°æ—¶ä¹‹å‰çš„æ•°æ®ï¼Œä½†æ˜¯å’¨è¯¢äº†ä¸šåŠ¡æ–¹å‘ç°ä»»åŠ¡å…³é—­äº† Checkpointã€‚å¿ƒæƒ³é‚£åªæœ‰å¯èƒ½æ˜¯æ²¡æ‰“å¼€ Kafka çš„ auto.commit.offset æˆ–è€…æ‰“å¼€äº†ä½†æ˜¯è‡ªåŠ¨æäº¤ä¸€ç›´å¤±è´¥äº†ï¼Œæˆ‘å»çœ‹äº† Kafka topic groupid çš„ committed offset ç›‘æ§å‘ç°æ­£å¸¸ï¼Œä¸€ç›´æœ‰åœ¨æ­£å¸¸çš„æäº¤ offsetï¼Œæ‰€ä»¥ä¹Ÿå¦å®šäº†åˆšæ‰çš„çŒœæƒ³ã€‚å¦å¤–å°±æ˜¯è§‰å¾—ä¸¤ä¸ªä»»åŠ¡çš„æ¶ˆè´¹ç­–ç•¥è¿™ä¹ˆå¤§ï¼Œæ˜¯ä¸æ˜¯ä»£ç ä¸ä¸€è‡´æˆ–è€…é…ç½®ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œå› ä¸ºä¸€å¼€å§‹é—®äº†ä¸šåŠ¡æ–¹ä»£ç æ˜¯å¦ä¸€è‡´ï¼Œå›å¤æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œæˆ‘ä¹Ÿè¢«å‘äº†ä¸€ä¸‹ï¼Œåé¢åœ¨å¹³å°å‘ç°ä¸¤ä¸ªä»»åŠ¡çš„ä»£ç  Git commitId éƒ½ä¸ä¸€æ ·ï¼Œé‚£ä¹Ÿå°±æ˜¯æ„å‘³ç€ä»£ç ä¸ä¸€è‡´ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-154650.png" alt=""></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-154815.png" alt=""></p><p>æ¥ç€å°±å¼€å§‹ review ä¸šåŠ¡æ–¹çš„é¡¹ç›®ä»£ç ï¼Œå‘ç°å¤‡é“¾è·¯ä»»åŠ¡å…³é—­äº† Checkpointï¼Œè€Œä¸»é“¾ä»»åŠ¡æ˜¯å¼€å¯ Checkpoint çš„ï¼ŒåŒæ—¶ä»£ç æ¶ˆè´¹æ–¹å¼æ˜¯æŒ‡å®šäº† Offset å¼€å§‹æ¶ˆè´¹ï¼ˆæ ¹æ®æ—¶é—´é…ç½®æŸ¥è¯¢ topic çš„ offsetï¼Œç„¶åä»æŒ‡å®šçš„ offset å¼€å§‹æ¶ˆè´¹ï¼Œè¿™ç§æ¶ˆè´¹æ–¹å¼å…¶å®å’ŒæŒ‡å®š timestamp å¼€å§‹æ¶ˆè´¹æ˜¯ä¸€è‡´çš„ï¼‰ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-155112.jpg" alt=""></p><p>ç„¶åæˆ‘å°±ç¿»äº†ä¸‹ KafkaSource Consumer æºç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-155503.jpg" alt=""></p><p>Open æ–¹æ³•ä¸»è¦åšäº†çŠ¶æ€åˆå§‹åŒ–ç›¸å…³é€»è¾‘ï¼Œå¯ä»¥å‘ç°å¦‚æœå…³é—­äº† Checkpointï¼Œé‚£ä¹ˆè‚¯å®šä¸ä¼šæœ‰æ¢å¤çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯èµ°åˆ°åé¢çš„é€»è¾‘ï¼ŒæŒ‰ç…§ç”¨æˆ·æŒ‡å®šçš„ offset å¼€å§‹æ¶ˆè´¹ã€‚åœ¨è¸¢å‡ºæ•…éšœæœºå™¨åï¼Œä¼šç”³è¯·æ–°çš„ TaskManager åšçŠ¶æ€åˆå§‹åŒ–å…¶å®å°±æ˜¯ä¼šèµ°åˆ°ä¸Šé¢çš„é€»è¾‘ï¼Œä¹Ÿå°±å¯¼è‡´ failover åæ¶ˆè´¹äº†å¾ˆæ—©ä¹‹å‰çš„æ•°æ®ã€‚æ’æŸ¥åˆ°è¿™ï¼Œå‡ ä¹æ ¹å› å·²ç»å‡ºæ¥äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯éªŒè¯è¿‡ç¨‹ã€‚</p><h3 id="æ ¹å› éªŒè¯"><a href="#æ ¹å› éªŒè¯" class="headerlink" title="æ ¹å› éªŒè¯"></a>æ ¹å› éªŒè¯</h3><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckpointTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ParameterTool parameters = ParameterTool.fromArgs(args);</span><br><span class="line">        <span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.getConfig().setGlobalJobParameters(parameters);</span><br><span class="line">        env.setParallelism(parameters.getInt(<span class="string">"envParallelism"</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        env.setRestartStrategy(RestartStrategies.fixedDelayRestart(</span><br><span class="line">                <span class="number">100</span>,</span><br><span class="line">                Time.of(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">        ));</span><br><span class="line">        <span class="comment">//æ‰‹åŠ¨å…³é—­ checkpoint</span></span><br><span class="line">        env.getCheckpointConfig().disableCheckpointing();</span><br><span class="line"></span><br><span class="line">        FlinkKafkaConsumer&lt;String&gt; flinkKafkaConsumer = <span class="keyword">new</span> FlinkKafkaConsumer&lt;&gt;(parameters.get(<span class="string">"sourceTopic"</span>, <span class="string">"yarn_flink_log"</span>), <span class="keyword">new</span> SimpleStringSchema(), buildKafkaProps(parameters));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parameters.get(<span class="string">"timestamp"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"Start from timestamp "</span> + parameters.getLong(<span class="string">"timestamp"</span>));</span><br><span class="line">            <span class="comment">// æ‰‹åŠ¨æŒ‡å®š timestamp å¼€å§‹æ¶ˆè´¹ï¼Œåº•å±‚ä¹Ÿæ˜¯ä¼šæ ¹æ® timestamp å»æ‰¾è¿™ä¸ª timestamp ä¸‹å¯¹åº”çš„ offset æ•°æ®</span></span><br><span class="line">            flinkKafkaConsumer.setStartFromTimestamp(parameters.getLong(<span class="string">"timestamp"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        env.addSource(flinkKafkaConsumer)</span><br><span class="line">                .setParallelism(parameters.getInt(<span class="string">"sourceParallelism"</span>, <span class="number">1</span>))</span><br><span class="line">                .print();</span><br><span class="line">        env.execute(<span class="string">"test checkpoint not enable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Properties <span class="title">buildKafkaProps</span><span class="params">(ParameterTool parameterTool)</span> </span>&#123;</span><br><span class="line">        Properties props = parameterTool.getProperties();</span><br><span class="line">        props.put(<span class="string">"bootstrap.servers"</span>, parameterTool.get(<span class="string">"sourceBootstrapServers"</span>, <span class="string">"localhost:9092"</span>));</span><br><span class="line">        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="keyword">true</span>);</span><br><span class="line">        props.put(<span class="string">"group.id"</span>, parameterTool.get(<span class="string">"sourceGroupId"</span>, String.valueOf(UUID.randomUUID())));</span><br><span class="line">        props.put(<span class="string">"flink.partition-discovery.interval-millis"</span>, <span class="string">"10000"</span>);</span><br><span class="line">        props.put(<span class="string">"auto.offset.reset"</span>, parameterTool.get(<span class="string">"sourceAutoOffsetReset"</span>, <span class="string">"latest"</span>));</span><br><span class="line">        <span class="keyword">return</span> props;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ—¶æŒ‡å®šçš„ timestamp æ˜¯ 1666819431000 ï¼ˆå¯¹åº” 2022-10-27 05:23:51ï¼‰ï¼Œç„¶ååœ¨ 2022-10-28 15:31 æ—¶æ‰‹åŠ¨ Kill æ‰ä¸€ä¸ª TaskManager podï¼Œä»»åŠ¡å‘ç”Ÿ failoverï¼Œæ–°ç”³è¯·çš„ pod å¼€å§‹æ¶ˆè´¹ 1666819431000 ï¼ˆå¯¹åº” 2022-10-27 05:23:51ï¼‰æ—¶å€™çš„æ•°æ®</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-11-09-160323.png" alt=""></p><p>æ–°ç”³è¯· TM å¯åŠ¨æ—¥å¿—ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2022-10-28 15:31:05,254 INFO  org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumerBase [] - Consumer subtask 0 will start reading the following 6 partitions from timestamp 1666819431000: [KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=34&#125;, KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=4&#125;, KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=54&#125;, KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=24&#125;, KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=44&#125;, KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=14&#125;]</span><br><span class="line"></span><br><span class="line">2022-10-28 15:31:05,267 INFO  org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumerBase [] - Consumer subtask 0 creating fetcher with offsets &#123;KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=34&#125;=(782507410,-1), KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=4&#125;=(87934879,-1), KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=54&#125;=(1259521975,-1), KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=24&#125;=(4335766087,-1), KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=44&#125;=(4210596124,-1), KafkaTopicPartition&#123;topic=&apos;yxxx_log&apos;, partition=14&#125;=(350718902,-1)&#125;.</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä»æ—¥å¿—å‘ç°æ˜¯ç»§ç»­ä» 1666819431000 å¼€å§‹</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>å…³é—­ Checkpoint + æŒ‡å®š timestamp æˆ–è€… Offset æ¶ˆè´¹ + æ•…éšœ failover æ—¶ä¼šå‡ºç°é‡å¤è¯»æ•°æ®é—®é¢˜</p><h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><p>1ã€æ ¸å¿ƒä»»åŠ¡ä¸€å®šè¦é…ç½®å¥½æ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦ï¼ŒåŠæ—¶å‘ç°å’Œå®šä½é—®é¢˜èƒ½å‡å°‘æ•…éšœæŸå¤±</p><p>2ã€ä¸è¦è½»æ˜“æ¼æ‰æŸäº›æŒ‡æ ‡ï¼Œå¦åˆ™å¯èƒ½ä¼šå¿½ç•¥æ‰æ ¹å› </p><p>3ã€å…³é—­æ‰é›†ç¾¤é»˜è®¤å¼€å¯çš„é…ç½®éœ€è¦è°¨æ…ï¼Œå¤šå……åˆ†æµ‹è¯•</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è®°å½•ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„ä¹‰çš„æ•…éšœï¼Œæ²¡é‡åˆ°çš„å¯ä»¥é¿å‘ï¼Œå·²ç»è¢«å‘è¿‡çš„åªèƒ½æ¡æ‰‹ğŸ¤äº†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Flink Table Store â€”â€”ä»è®¡ç®—åˆ°å­˜å‚¨æå‡æµæ‰¹ç»Ÿä¸€ç«¯åˆ°ç«¯ç”¨æˆ·ä½“éªŒ</title>
    <link href="http://www.54tianzhisheng.cn/2022/05/12/flink-table-store/"/>
    <id>http://www.54tianzhisheng.cn/2022/05/12/flink-table-store/</id>
    <published>2022-05-11T16:00:00.000Z</published>
    <updated>2022-05-11T16:06:12.752Z</updated>
    
    <content type="html"><![CDATA[<p>è¯¥é¡¹ç›®ç”¨äºåœ¨ Flink ä¸­ä¸ºæµå¤„ç†å’Œæ‰¹å¤„ç†æ„å»ºåŠ¨æ€è¡¨ï¼Œæ”¯æŒè¶…å¤§æµé‡çš„æ•°æ®æå–å’ŒåŠæ—¶çš„æ•°æ®æŸ¥è¯¢ã€‚</p><a id="more"></a><p>æ³¨æ„ï¼šè¯¥é¡¹ç›®ä»å¤„äº beta çŠ¶æ€ï¼Œæ­£åœ¨å¿«é€Ÿå‘å±•ï¼Œä¸å»ºè®®ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒã€‚</p><h3 id="Flink-Table-Store-ä»‹ç»"><a href="#Flink-Table-Store-ä»‹ç»" class="headerlink" title="Flink Table Store ä»‹ç»"></a>Flink Table Store ä»‹ç»</h3><p>åœ¨è¿‡å»çš„å‡ å¹´é‡Œï¼Œå¾—ç›Šäº Flink ç¤¾åŒºä¼—å¤šçš„è´¡çŒ®è€…å’Œç”¨æˆ·ï¼ŒApache Flink å·²ç»æˆä¸ºæœ€å¥½çš„åˆ†å¸ƒå¼è®¡ç®—å¼•æ“ä¹‹ä¸€ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡æœ‰çŠ¶æ€æµå¤„ç†æ–¹é¢ã€‚ç„¶è€Œï¼Œå½“äººä»¬è¯•å›¾ä»ä»–ä»¬çš„æ•°æ®ä¸­å®æ—¶è·å–æ´å¯ŸåŠ›æ—¶ï¼Œä»ç„¶é¢ä¸´ç€ä¸€äº›æŒ‘æˆ˜ã€‚åœ¨è¿™äº›æŒ‘æˆ˜ä¸­ï¼Œä¸€ä¸ªçªå‡ºçš„é—®é¢˜æ˜¯ç¼ºä¹æ»¡è¶³æ‰€æœ‰è®¡ç®—æ¨¡å¼çš„å­˜å‚¨ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šéƒ¨ç½²ä¸€äº›å­˜å‚¨ç³»ç»Ÿæ¥ä¸ Flink ä¸€èµ·ç”¨äºä¸åŒç›®çš„æ˜¯å¾ˆå¸¸è§çš„ã€‚å…¸å‹çš„è®¾ç½®æ˜¯ç”¨äºæµå¤„ç†çš„æ¶ˆæ¯é˜Ÿåˆ—ã€ç”¨äºæ‰¹å¤„ç†å’Œå³å¸­æŸ¥è¯¢çš„å¯æŸ¥è¯¢æ–‡ä»¶ç³»ç»Ÿ/å¯¹è±¡å­˜å‚¨ï¼Œä»¥åŠç”¨äºæŸ¥æ‰¾çš„ K-V å­˜å‚¨ã€‚ç”±äºå…¶å¤æ‚æ€§å’Œå¼‚æ„æ€§ï¼Œè¿™ç§æ¶æ„åœ¨æ•°æ®è´¨é‡å’Œç³»ç»Ÿç»´æŠ¤æ–¹é¢æå‡ºäº†æŒ‘æˆ˜ã€‚è¿™æ­£åœ¨æˆä¸ºå½±å“ Apache Flink å¸¦æ¥çš„æµæ‰¹ç»Ÿä¸€ç«¯åˆ°ç«¯ç”¨æˆ·ä½“éªŒçš„ä¸€å¤§é—®é¢˜ã€‚</p><p>Flink Table Store çš„ç›®æ ‡å°±æ˜¯è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œè¿™æ˜¯è¯¥é¡¹ç›®çš„é‡è¦ä¸€æ­¥ã€‚å®ƒå°† Flink çš„èƒ½åŠ›ä»è®¡ç®—æ‰©å±•åˆ°å­˜å‚¨é¢†åŸŸã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„ç«¯åˆ°ç«¯ä½“éªŒã€‚</p><p>Flink Table Store æ—¨åœ¨æä¾›ç»Ÿä¸€çš„å­˜å‚¨æŠ½è±¡ï¼Œè®©ç”¨æˆ·ä¸å¿…è‡ªå·±æ„å»ºæ··åˆå­˜å‚¨ã€‚å…·ä½“æ¥è¯´ï¼ŒFlink Table Store æä¾›ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š</p><ul><li><p>æ”¯æŒè¶…å¤§æ•°æ®é›†çš„å­˜å‚¨ï¼Œå¹¶å…è®¸ä»¥æ‰¹å¤„ç†å’Œæµæ–¹å¼è¯»å–å’Œå†™å…¥</p></li><li><p>æ”¯æŒæ¯«ç§’çº§åˆ«å»¶è¿Ÿçš„æµå¼æŸ¥è¯¢</p></li><li><p>æ”¯æŒç§’çº§åˆ«å»¶è¿Ÿçš„ Batch/OLAP æŸ¥è¯¢</p></li><li><p>é»˜è®¤æ”¯æŒæµè¯»å¢é‡å¿«ç…§ï¼Œæ‰€ä»¥ç”¨æˆ·ä¸éœ€è¦è‡ªå·±è§£å†³ç»„åˆä¸åŒå­˜å‚¨çš„é—®é¢˜</p></li></ul><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2022-05-11-151450.jpg" alt=""></p><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæ¶æ„å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ul><li><p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Flink å°†æ•°æ®å†™å…¥åˆ° Table Store ä¸­ï¼Œæ—¢å¯ä»¥é€šè¿‡æµå¼å°†æ•°æ®åº“ä¸­æ•è·çš„å˜æ›´æ—¥å¿—å†™å…¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»æ•°æ®ä»“åº“ç­‰å…¶ä»–å­˜å‚¨ä¸­æ‰¹é‡åŠ è½½æ•°æ®åå†å†™å…¥</p></li><li><p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Flink ä»¥ä¸åŒçš„æ–¹å¼æŸ¥è¯¢ Table Storeï¼ŒåŒ…æ‹¬æµå¼æŸ¥è¯¢å’Œ Batch/OLAP æŸ¥è¯¢ã€‚ è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–å¼•æ“ï¼ˆä¾‹å¦‚ Apache Hiveï¼‰ä» Table Store ä¸­æŸ¥è¯¢</p></li><li><p>åœ¨åº•å±‚ï¼ŒTable Store ä½¿ç”¨æ··åˆå­˜å‚¨æ¶æ„ï¼Œä½¿ç”¨ Lake Store å­˜å‚¨å†å²æ•°æ®ï¼Œä½¿ç”¨ Queue ç³»ç»Ÿï¼ˆç›®å‰æ”¯æŒ Apache Kafka é›†æˆï¼‰å­˜å‚¨å¢é‡æ•°æ®ã€‚ å®ƒä¸ºæ··åˆæµå¼è¯»å–æä¾›å¢é‡å¿«ç…§</p></li><li><p>Table Store çš„ Lake Store å°†æ•°æ®ä½œä¸ºåˆ—æ–‡ä»¶å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿ/å¯¹è±¡å­˜å‚¨ä¸Šï¼Œå¹¶ä½¿ç”¨ LSM ç»“æ„æ¥æ”¯æŒå¤§é‡çš„æ•°æ®æ›´æ–°å’Œé«˜æ€§èƒ½æŸ¥è¯¢</p></li></ul><p>éå¸¸æ„Ÿè°¢ä»¥ä¸‹ç³»ç»Ÿçš„å¯å‘ï¼šApache Iceberg å’Œ RocksDBã€‚</p><h3 id="åç»­è¿›å±•"><a href="#åç»­è¿›å±•" class="headerlink" title="åç»­è¿›å±•"></a>åç»­è¿›å±•</h3><p>ç¤¾åŒºç›®å‰æ­£åœ¨åŠªåŠ›å¼ºåŒ–æ ¸å¿ƒé€»è¾‘ï¼Œç¨³å®šå­˜å‚¨æ ¼å¼ç­‰ï¼Œä»¥ä½¿ Flink Table Store å¯ä»¥æŠ•å…¥ç”Ÿäº§ã€‚</p><p>åœ¨å³å°†å‘å¸ƒçš„ 0.2.0 ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥æœŸå¾…ï¼ˆè‡³å°‘ï¼‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><p>ç”Ÿæ€ï¼šæ”¯æŒ Apache Hive Engine çš„ Flink Table Store Reader</p></li><li><p>æ ¸å¿ƒï¼šæ”¯æŒè‡ªé€‚åº” Bucket æ•°é‡</p></li><li><p>æ ¸å¿ƒï¼šæ”¯æŒä»… append çš„æ•°æ®ï¼ŒTable Store ä¸ä»…ä»…å±€é™äºæ›´æ–°åœºæ™¯</p></li><li><p>æ ¸å¿ƒï¼šå®Œå–„çš„ schema å˜åŒ–</p></li><li><p>æ”¹è¿›åŸºäºé¢„è§ˆç‰ˆå¾—åˆ°çš„åé¦ˆ</p></li></ul><p>ä»ä¸­æœŸæ¥çœ‹ï¼Œä½ è¿˜å¯ä»¥æœŸå¾…ï¼š</p><ul><li><p>ç”Ÿæ€ç³»ç»Ÿï¼šæ”¯æŒ Trinoã€PrestoDB å’Œ Apache Spark çš„ Flink Table Store Reader</p></li><li><p>Flink Table Store Service ä¼šåŠ é€Ÿæ›´æ–°ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½</p></li></ul><h3 id="å°é²œ"><a href="#å°é²œ" class="headerlink" title="å°é²œ"></a>å°é²œ</h3><p>å¯ä»¥é€šè¿‡ <a href="https://nightlies.apache.org/flink/flink-table-store-docs-release-0.1/docs/try-table-store/quick-start/">https://nightlies.apache.org/flink/flink-table-store-docs-release-0.1/docs/try-table-store/quick-start/</a> æ¥å°è¯•ä¸€ä¸‹ã€‚</p><p>ä¸‹è½½é“¾æ¥ï¼š<a href="https://flink.apache.org/downloads.html">https://flink.apache.org/downloads.html</a></p><blockquote><p>ç¿»è¯‘åŸæ–‡é“¾æ¥ï¼š<a href="https://flink.apache.org/news/2022/05/11/release-table-store-0.1.0.html">https://flink.apache.org/news/2022/05/11/release-table-store-0.1.0.html</a></p><p>åŸæ–‡ä½œè€…ï¼šæåŠ²æ¾ &amp; ç§¦æ±Ÿæ°</p></blockquote><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¯¥é¡¹ç›®ç”¨äºåœ¨ Flink ä¸­ä¸ºæµå¤„ç†å’Œæ‰¹å¤„ç†æ„å»ºåŠ¨æ€è¡¨ï¼Œæ”¯æŒè¶…å¤§æµé‡çš„æ•°æ®æå–å’ŒåŠæ—¶çš„æ•°æ®æŸ¥è¯¢ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Flink Iceberg Source å¹¶è¡Œåº¦æ¨æ–­æºç è§£æ</title>
    <link href="http://www.54tianzhisheng.cn/2022/05/02/flink-iceberg-source-parallelism/"/>
    <id>http://www.54tianzhisheng.cn/2022/05/02/flink-iceberg-source-parallelism/</id>
    <published>2022-05-01T16:00:00.000Z</published>
    <updated>2022-05-07T13:50:31.173Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ‰¹è¯»-Iceberg"><a href="#æ‰¹è¯»-Iceberg" class="headerlink" title="æ‰¹è¯» Iceberg"></a>æ‰¹è¯» Iceberg</h3><p>Iceberg æä¾›äº†ä¸¤ä¸ªé…ç½®ï¼š</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Boolean&gt; TABLE_EXEC_ICEBERG_INFER_SOURCE_PARALLELISM =</span><br><span class="line">  ConfigOptions.key(<span class="string">"table.exec.iceberg.infer-source-parallelism"</span>)</span><br><span class="line">      .booleanType()</span><br><span class="line">      .defaultValue(<span class="keyword">true</span>)</span><br><span class="line">      .withDescription(<span class="string">"If is false, parallelism of source are set by config.\n"</span> +</span><br><span class="line">          <span class="string">"If is true, source parallelism is inferred according to splits number.\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Integer&gt; TABLE_EXEC_ICEBERG_INFER_SOURCE_PARALLELISM_MAX =</span><br><span class="line">  ConfigOptions.key(<span class="string">"table.exec.iceberg.infer-source-parallelism.max"</span>)</span><br><span class="line">      .intType()</span><br><span class="line">      .defaultValue(<span class="number">100</span>)</span><br><span class="line">      .withDescription(<span class="string">"Sets max infer parallelism for source operator."</span>);</span><br></pre></td></tr></table></figure><ul><li>table.exec.iceberg.infer-source-parallelismï¼šé»˜è®¤æ˜¯ trueï¼Œæ„å‘³ç€ source çš„å¹¶è¡Œåº¦æ˜¯æ ¹æ®æ¨æ–­æ¥é…ç½®çš„ï¼Œå¦‚æœé…ç½®çš„ false çš„è¯ï¼Œé‚£ä¹ˆå¹¶è¡Œåº¦çš„é…ç½®æ˜¯ä»¥é…ç½®çš„ä¸ºå‡†ã€‚</li><li>table.exec.iceberg.infer-source-parallelism.maxï¼š é»˜è®¤æ˜¯ 100ï¼Œsource ç®—å­çš„æœ€å¤§å¹¶è¡Œåº¦ã€‚</li></ul><p>è¿™ä¸¤ä¸ªå‚æ•°åªåœ¨ FileSource çš„ inferParallelism æ–¹æ³•ä¸­è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inferParallelism</span><span class="params">(FlinkInputFormat format, ScanContext context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¯»å– table.exec.resource.default-parallelism é…ç½®ï¼Œé»˜è®¤å€¼ä¸º -1  </span></span><br><span class="line">  <span class="keyword">int</span> parallelism = readableConfig.get(ExecutionConfigOptions.TABLE_EXEC_RESOURCE_DEFAULT_PARALLELISM);</span><br><span class="line">  <span class="comment">// è¯»å– table.exec.iceberg.infer-source-parallelism é…ç½®ï¼Œé»˜è®¤æ˜¯ true  </span></span><br><span class="line">  <span class="keyword">if</span> (readableConfig.get(FlinkConfigOptions.TABLE_EXEC_ICEBERG_INFER_SOURCE_PARALLELISM)) &#123;</span><br><span class="line">    <span class="comment">// è¯»å– table.exec.iceberg.infer-source-parallelism.max é…ç½®ï¼Œé»˜è®¤æ˜¯ 100</span></span><br><span class="line">    <span class="keyword">int</span> maxInferParallelism = readableConfig.get(FlinkConfigOptions</span><br><span class="line">        .TABLE_EXEC_ICEBERG_INFER_SOURCE_PARALLELISM_MAX);</span><br><span class="line">    Preconditions.checkState(</span><br><span class="line">        maxInferParallelism &gt;= <span class="number">1</span>,</span><br><span class="line">        FlinkConfigOptions.TABLE_EXEC_ICEBERG_INFER_SOURCE_PARALLELISM_MAX.key() + <span class="string">" cannot be less than 1"</span>);</span><br><span class="line">    <span class="comment">//è·å–è¡¨çš„ splitNum </span></span><br><span class="line">    <span class="keyword">int</span> splitNum;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      FlinkInputSplit[] splits = format.createInputSplits(<span class="number">0</span>);</span><br><span class="line">      splitNum = splits.length;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UncheckedIOException(<span class="string">"Failed to create iceberg input splits for table: "</span> + table, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parallelism = Math.min(splitNum, maxInferParallelism);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (context.limit() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> limit = context.limit() &gt;= Integer.MAX_VALUE ? Integer.MAX_VALUE : (<span class="keyword">int</span>) context.limit();</span><br><span class="line">    parallelism = Math.min(parallelism, limit);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// parallelism must be positive.</span></span><br><span class="line">  parallelism = Math.max(<span class="number">1</span>, parallelism);</span><br><span class="line">  <span class="keyword">return</span> parallelism;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹é¢ä»£ç è·å–åˆ°è¡¨çš„ splitNum</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">FlinkInputSplit[] splits = format.createInputSplits(<span class="number">0</span>);</span><br><span class="line">splitNum = splits.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> FlinkInputSplit[] createInputSplits(<span class="keyword">int</span> minNumSplits) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// Called in Job manager, so it is OK to load table from catalog.</span></span><br><span class="line">    <span class="comment">// åŠ è½½ catalog  </span></span><br><span class="line">    tableLoader.open();</span><br><span class="line">    <span class="keyword">final</span> ExecutorService workerPool = ThreadPools.newWorkerPool(<span class="string">"iceberg-plan-worker-pool"</span>, context.planParallelism());</span><br><span class="line">    <span class="keyword">try</span> (TableLoader loader = tableLoader) &#123;</span><br><span class="line">      <span class="comment">// åŠ è½½è¡¨  </span></span><br><span class="line">      Table table = loader.loadTable();</span><br><span class="line">      <span class="comment">// è°ƒç”¨ </span></span><br><span class="line">      <span class="keyword">return</span> FlinkSplitPlanner.planInputSplits(table, context, workerPool);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      workerPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> FlinkInputSplit[] planInputSplits(Table table, ScanContext context, ExecutorService workerPool) &#123;</span><br><span class="line">    <span class="comment">// ä¸»è¦é€šè¿‡ planTasks æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">try</span> (CloseableIterable&lt;CombinedScanTask&gt; tasksIterable = planTasks(table, context, workerPool)) &#123;</span><br><span class="line">      List&lt;CombinedScanTask&gt; tasks = Lists.newArrayList(tasksIterable);</span><br><span class="line">      FlinkInputSplit[] splits = <span class="keyword">new</span> FlinkInputSplit[tasks.size()];</span><br><span class="line">      <span class="keyword">boolean</span> exposeLocality = context.exposeLocality();</span><br><span class="line"></span><br><span class="line">      Tasks.range(tasks.size())</span><br><span class="line">          .stopOnFailure()</span><br><span class="line">          .executeWith(exposeLocality ? workerPool : <span class="keyword">null</span>)</span><br><span class="line">          .run(index -&gt; &#123;</span><br><span class="line">            CombinedScanTask task = tasks.get(index);</span><br><span class="line">            String[] hostnames = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (exposeLocality) &#123;</span><br><span class="line">              hostnames = Util.blockLocations(table.io(), task);</span><br><span class="line">            &#125;</span><br><span class="line">            splits[index] = <span class="keyword">new</span> FlinkInputSplit(index, task, hostnames);</span><br><span class="line">          &#125;);</span><br><span class="line">      <span class="keyword">return</span> splits;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UncheckedIOException(<span class="string">"Failed to process tasks iterable"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>planTasks æ–¹æ³•ä¸­ä¸»è¦é  scan.planTasks()ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> CloseableIterable&lt;CombinedScanTask&gt; <span class="title">planTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CloseableIterable&lt;FileScanTask&gt; fileScanTasks = planFiles();</span><br><span class="line">    CloseableIterable&lt;FileScanTask&gt; splitFiles = TableScanUtil.splitFiles(fileScanTasks, targetSplitSize());</span><br><span class="line">    <span class="keyword">return</span> TableScanUtil.planTasks(splitFiles, targetSplitSize(), splitLookback(), splitOpenFileCost());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æ–‡ä»¶æƒ…å†µ </span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CloseableIterable&lt;FileScanTask&gt; <span class="title">planFiles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Snapshot snapshot = snapshot();</span><br><span class="line">    <span class="keyword">if</span> (snapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">      LOG.info(<span class="string">"Scanning table &#123;&#125; snapshot &#123;&#125; created at &#123;&#125; with filter &#123;&#125;"</span>, table,</span><br><span class="line">          snapshot.snapshotId(), DateTimeUtil.formatTimestampMillis(snapshot.timestampMillis()),</span><br><span class="line">          context.rowFilter());</span><br><span class="line"></span><br><span class="line">      Listeners.notifyAll(</span><br><span class="line">          <span class="keyword">new</span> ScanEvent(table.name(), snapshot.snapshotId(), context.rowFilter(), schema()));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> planFiles(ops, snapshot,</span><br><span class="line">          context.rowFilter(), context.ignoreResiduals(), context.caseSensitive(), context.returnColumnStats());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      LOG.info(<span class="string">"Scanning empty table &#123;&#125;"</span>, table);</span><br><span class="line">      <span class="keyword">return</span> CloseableIterable.empty();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// split  </span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CloseableIterable&lt;FileScanTask&gt; <span class="title">splitFiles</span><span class="params">(CloseableIterable&lt;FileScanTask&gt; tasks, <span class="keyword">long</span> splitSize)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkArgument(splitSize &gt; <span class="number">0</span>, <span class="string">"Invalid split size (negative or 0): %s"</span>, splitSize);</span><br><span class="line"></span><br><span class="line">    Iterable&lt;FileScanTask&gt; splitTasks = FluentIterable</span><br><span class="line">        .from(tasks)</span><br><span class="line">        .transformAndConcat(input -&gt; input.split(splitSize));</span><br><span class="line">    <span class="comment">// Capture manifests which can be closed after scan planning</span></span><br><span class="line">    <span class="keyword">return</span> CloseableIterable.combine(splitTasks, tasks);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CloseableIterable&lt;CombinedScanTask&gt; <span class="title">planTasks</span><span class="params">(CloseableIterable&lt;FileScanTask&gt; splitFiles,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              <span class="keyword">long</span> splitSize, <span class="keyword">int</span> lookback, <span class="keyword">long</span> openFileCost)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkArgument(splitSize &gt; <span class="number">0</span>, <span class="string">"Invalid split size (negative or 0): %s"</span>, splitSize);</span><br><span class="line">    Preconditions.checkArgument(lookback &gt; <span class="number">0</span>, <span class="string">"Invalid split planning lookback (negative or 0): %s"</span>, lookback);</span><br><span class="line">    Preconditions.checkArgument(openFileCost &gt;= <span class="number">0</span>, <span class="string">"Invalid file open cost (negative): %s"</span>, openFileCost);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the size of delete file as well to avoid unbalanced bin-packing</span></span><br><span class="line">    Function&lt;FileScanTask, Long&gt; weightFunc = file -&gt; Math.max(</span><br><span class="line">        file.length() + file.deletes().stream().mapToLong(ContentFile::fileSizeInBytes).sum(),</span><br><span class="line">        (<span class="number">1</span> + file.deletes().size()) * openFileCost);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CloseableIterable.transform(</span><br><span class="line">        CloseableIterable.combine(</span><br><span class="line">            <span class="keyword">new</span> BinPacking.PackingIterable&lt;&gt;(splitFiles, splitSize, lookback, weightFunc, <span class="keyword">true</span>),</span><br><span class="line">            splitFiles),</span><br><span class="line">        BaseCombinedScanTask::<span class="keyword">new</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ¨æ–­åˆ°è¡¨æ–‡ä»¶ split çš„æ•°é‡åï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æ˜¯å†³å®šå¹¶è¡Œåº¦å¤§å°çš„æ—¶å€™äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parallelism = Math.min(splitNum, maxInferParallelism);</span><br></pre></td></tr></table></figure><p>å–é…ç½®çš„æœ€å¤§å¹¶è¡Œåº¦å’Œ split æ•°é‡çš„æœ€å°å€¼ï¼Œegï¼šè®¾ç½®çš„ source æœ€å¤§å¹¶è¡Œåº¦ä¸º 50ï¼Œä½†æ˜¯æ ¹æ®è¡¨æ–‡ä»¶åˆ’åˆ†å‡ºæ¥çš„ split æ•°é‡ä¸º 40ï¼Œé‚£ä¹ˆ source çš„å¹¶è¡Œåº¦ä¸º 40ã€‚</p><p>å¦‚æœæ²¡æœ‰é…ç½® table.exec.iceberg.infer-source-parallelism ä¸º true çš„è¯ï¼Œé‚£ä¹ˆå°±ä»¥ table.exec.resource.default-parallelism çš„å¹¶è¡Œåº¦ä¸ºå‡†ï¼ˆé»˜è®¤å€¼æ˜¯ -1ï¼‰ã€‚</p><p>ç»§ç»­åˆ†ææ¥ä¸‹æ¥çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (context.limit() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> limit = context.limit() &gt;= Integer.MAX_VALUE ? Integer.MAX_VALUE : (<span class="keyword">int</span>) context.limit();</span><br><span class="line">    parallelism = Math.min(parallelism, limit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>limit åƒæ˜¯ SQL æŸ¥è¯¢è¯­å¥é‡Œé¢çš„ limit çš„å€¼ï¼Œå¦‚æœé…ç½®äº† limitï¼Œé‚£ä¹ˆä¹Ÿä¼šå‚ä¸å¹¶è¡Œåº¦é…ç½®çš„è®¡ç®—çš„ï¼Œegï¼šå¦‚æœ limti ä¸º 1ï¼Œé‚£ä¹ˆ parallelism å–å‰é¢  parallelism çš„å€¼ä¸ 1 ä¸¤è€…çš„æœ€å°å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parallelism must be positive.</span></span><br><span class="line">parallelism = Math.max(<span class="number">1</span>, parallelism);</span><br><span class="line"><span class="keyword">return</span> parallelism;</span><br></pre></td></tr></table></figure><p>æœ€åä»£ç ä¿è¯å¹¶è¡Œåº¦çš„æœ€å°å€¼ä¸º 1ã€‚</p><p>æ¥çœ‹ä¸‹ inferParallelism æ–¹æ³•çš„è°ƒç”¨æƒ…å†µï¼Œåªåœ¨ FileSource ç±»çš„ build() æ–¹æ³•è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DataStream&lt;RowData&gt; <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Preconditions.checkNotNull(env, <span class="string">"StreamExecutionEnvironment should not be null"</span>);</span><br><span class="line">  FlinkInputFormat format = buildFormat();</span><br><span class="line"></span><br><span class="line">  ScanContext context = contextBuilder.build();</span><br><span class="line">  TypeInformation&lt;RowData&gt; typeInfo = FlinkCompatibilityUtil.toTypeInfo(FlinkSchemaUtil.convert(context.project()));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!context.isStreaming()) &#123;</span><br><span class="line">    <span class="comment">// åªåœ¨ æ‰¹ æ¨¡å¼ä¸‹ç”Ÿæ•ˆ  </span></span><br><span class="line">    <span class="keyword">int</span> parallelism = inferParallelism(format, context);</span><br><span class="line">    <span class="keyword">return</span> env.createInput(format, typeInfo).setParallelism(parallelism);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    StreamingMonitorFunction function = <span class="keyword">new</span> StreamingMonitorFunction(tableLoader, context);</span><br><span class="line"></span><br><span class="line">    String monitorFunctionName = String.format(<span class="string">"Iceberg table (%s) monitor"</span>, table);</span><br><span class="line">    String readerOperatorName = String.format(<span class="string">"Iceberg table (%s) reader"</span>, table);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env.addSource(function, monitorFunctionName)</span><br><span class="line">        .transform(readerOperatorName, typeInfo, StreamingReaderOperator.factory(format));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹ TestFlinkScanSql æµ‹è¯•ç±»çš„ testInferedParallelism æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInferedParallelism</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Table table = catalog.createTable(TableIdentifier.of(<span class="string">"default"</span>, <span class="string">"t"</span>), TestFixtures.SCHEMA, TestFixtures.SPEC);</span><br><span class="line"></span><br><span class="line">  TableLoader tableLoader = TableLoader.fromHadoopTable(table.location());</span><br><span class="line">  FlinkInputFormat flinkInputFormat = FlinkSource.forRowData().tableLoader(tableLoader).table(table).buildFormat();</span><br><span class="line">  ScanContext scanContext = ScanContext.builder().build();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Empty table, infer parallelism should be at least 1</span></span><br><span class="line">  <span class="keyword">int</span> parallelism = FlinkSource.forRowData().inferParallelism(flinkInputFormat, scanContext);</span><br><span class="line">  Assert.assertEquals(<span class="string">"Should produce the expected parallelism."</span>, <span class="number">1</span>, parallelism);</span><br><span class="line"></span><br><span class="line">  GenericAppenderHelper helper = <span class="keyword">new</span> GenericAppenderHelper(table, fileFormat, TEMPORARY_FOLDER);</span><br><span class="line">  DataFile dataFile1 = helper.writeFile(TestHelpers.Row.of(<span class="string">"2020-03-20"</span>, <span class="number">0</span>),</span><br><span class="line">      RandomGenericData.generate(TestFixtures.SCHEMA, <span class="number">2</span>, <span class="number">0L</span>));</span><br><span class="line">  DataFile dataFile2 = helper.writeFile(TestHelpers.Row.of(<span class="string">"2020-03-21"</span>, <span class="number">0</span>),</span><br><span class="line">      RandomGenericData.generate(TestFixtures.SCHEMA, <span class="number">2</span>, <span class="number">0L</span>));</span><br><span class="line">  helper.appendToTable(dataFile1, dataFile2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure to generate 2 CombinedScanTasks</span></span><br><span class="line">  <span class="keyword">long</span> maxFileLen = Math.max(dataFile1.fileSizeInBytes(), dataFile2.fileSizeInBytes());</span><br><span class="line">  sql(<span class="string">"ALTER TABLE t SET ('read.split.open-file-cost'='1', 'read.split.target-size'='%s')"</span>, maxFileLen);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2 splits (max infer is the default value 100 , max &gt; splits num), the parallelism is splits num : 2</span></span><br><span class="line">  parallelism = FlinkSource.forRowData().inferParallelism(flinkInputFormat, scanContext);</span><br><span class="line">  Assert.assertEquals(<span class="string">"Should produce the expected parallelism."</span>, <span class="number">2</span>, parallelism);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2 splits and limit is 1 , max infer parallelism is default 100ï¼Œ</span></span><br><span class="line">  <span class="comment">// which is greater than splits num and limit, the parallelism is the limit value : 1</span></span><br><span class="line">  parallelism = FlinkSource.forRowData().inferParallelism(flinkInputFormat, ScanContext.builder().limit(<span class="number">1</span>).build());</span><br><span class="line">  Assert.assertEquals(<span class="string">"Should produce the expected parallelism."</span>, <span class="number">1</span>, parallelism);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2 splits and max infer parallelism is 1 (max &lt; splits num), the parallelism is  1</span></span><br><span class="line">  Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">  configuration.setInteger(FlinkConfigOptions.TABLE_EXEC_ICEBERG_INFER_SOURCE_PARALLELISM_MAX, <span class="number">1</span>);</span><br><span class="line">  parallelism = FlinkSource.forRowData()</span><br><span class="line">      .flinkConf(configuration)</span><br><span class="line">      .inferParallelism(flinkInputFormat, ScanContext.builder().build());</span><br><span class="line">  Assert.assertEquals(<span class="string">"Should produce the expected parallelism."</span>, <span class="number">1</span>, parallelism);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2 splits, max infer parallelism is 1, limit is 3, the parallelism is max infer parallelism : 1</span></span><br><span class="line">  parallelism = FlinkSource.forRowData()</span><br><span class="line">      .flinkConf(configuration)</span><br><span class="line">      .inferParallelism(flinkInputFormat, ScanContext.builder().limit(<span class="number">3</span>).build());</span><br><span class="line">  Assert.assertEquals(<span class="string">"Should produce the expected parallelism."</span>, <span class="number">1</span>, parallelism);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2 splits, infer parallelism is disabled, the parallelism is flink default parallelism 1</span></span><br><span class="line">  configuration.setBoolean(FlinkConfigOptions.TABLE_EXEC_ICEBERG_INFER_SOURCE_PARALLELISM, <span class="keyword">false</span>);</span><br><span class="line">  parallelism = FlinkSource.forRowData()</span><br><span class="line">      .flinkConf(configuration)</span><br><span class="line">      .inferParallelism(flinkInputFormat, ScanContext.builder().limit(<span class="number">3</span>).build());</span><br><span class="line">  Assert.assertEquals(<span class="string">"Should produce the expected parallelism."</span>, <span class="number">1</span>, parallelism);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„âš ï¸ï¼šè¯¥ä»£ç æ¨¡å—æ˜¯åœ¨ Iceberg é¡¹ç›®çš„ flink module ä¸‹</p><h3 id="æµè¯»-Iceberg"><a href="#æµè¯»-Iceberg" class="headerlink" title="æµè¯» Iceberg"></a>æµè¯» Iceberg</h3><p>å¹¶æ²¡æœ‰é’ˆå¯¹æµè¯»é…ç½® Source å¹¶è¡Œåº¦</p><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/6YjyJYR">https://t.zsxq.com/6YjyJYR</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;æ‰¹è¯»-Iceberg&quot;&gt;&lt;a href=&quot;#æ‰¹è¯»-Iceberg&quot; class=&quot;headerlink&quot; title=&quot;æ‰¹è¯» Iceberg&quot;&gt;&lt;/a&gt;æ‰¹è¯» Iceberg&lt;/h3&gt;&lt;p&gt;Iceberg æä¾›äº†ä¸¤ä¸ªé…ç½®ï¼š&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Flink Hive Source å¹¶è¡Œåº¦æ¨æ–­æºç è§£æ</title>
    <link href="http://www.54tianzhisheng.cn/2022/05/01/flink-hive-source-parallelism/"/>
    <id>http://www.54tianzhisheng.cn/2022/05/01/flink-hive-source-parallelism/</id>
    <published>2022-04-30T16:00:00.000Z</published>
    <updated>2022-05-07T13:50:31.165Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ‰¹è¯»-Hive"><a href="#æ‰¹è¯»-Hive" class="headerlink" title="æ‰¹è¯» Hive"></a>æ‰¹è¯» Hive</h3><p>HiveOptions ä¸­æœ‰ä¸¤ä¸ªé…ç½®</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Boolean&gt; TABLE_EXEC_HIVE_INFER_SOURCE_PARALLELISM =</span><br><span class="line">        key(<span class="string">"table.exec.hive.infer-source-parallelism"</span>)</span><br><span class="line">                .defaultValue(<span class="keyword">true</span>)</span><br><span class="line">                .withDescription(</span><br><span class="line">                        <span class="string">"If is false, parallelism of source are set by config.\n"</span> +</span><br><span class="line">                        <span class="string">"If is true, source parallelism is inferred according to splits number.\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Integer&gt; TABLE_EXEC_HIVE_INFER_SOURCE_PARALLELISM_MAX =</span><br><span class="line">        key(<span class="string">"table.exec.hive.infer-source-parallelism.max"</span>)</span><br><span class="line">                .defaultValue(<span class="number">1000</span>)</span><br><span class="line">                .withDescription(<span class="string">"Sets max infer parallelism for source operator."</span>);</span><br></pre></td></tr></table></figure><ul><li>table.exec.hive.infer-source-parallelismï¼šé»˜è®¤å€¼æ˜¯ trueï¼Œè¡¨ç¤º source çš„å¹¶è¡Œåº¦æ˜¯æ ¹æ®æ•°æ®åˆ†åŒºæ•°å’Œæ–‡ä»¶æ•°æ¨æ–­çš„ï¼Œå¦‚æœè®¾ç½®ä¸º false çš„è¯è¡¨ç¤ºå¹¶è¡Œåº¦æ˜¯ä»¥é…ç½®çš„ä¸ºå‡†</li><li>table.exec.hive.infer-source-parallelism.maxï¼šé»˜è®¤å€¼æ˜¯ 1000ï¼Œè¡¨ç¤ºè¯»å– Hive æ•°æ®çš„ source æœ€å¤§å¹¶è¡Œåº¦</li></ul><p>è¿™ä¸¤ä¸ªå‚æ•°åªåœ¨ HiveParallelismInference ç±»ä¸­ä½¿ç”¨ï¼Œè§‚å¯Ÿåˆ° HiveParallelismInference ç±»æ˜¯ä¸“é—¨é’ˆå¯¹ Hive å¹¶è¡Œåº¦é…ç½®çš„å·¥å…·ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A utility class to calculate parallelism for Hive connector considering various factors.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HiveParallelismInference</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(HiveParallelismInference.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectPath tablePath;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> infer;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> inferMaxParallelism;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> parallelism;</span><br><span class="line"></span><br><span class="line">HiveParallelismInference(ObjectPath tablePath, ReadableConfig flinkConf) &#123;</span><br><span class="line"><span class="keyword">this</span>.tablePath = tablePath;</span><br><span class="line">        <span class="comment">// è·å– table.exec.hive.infer-source-parallelism é…ç½®å¹¶èµ‹å€¼ï¼Œ</span></span><br><span class="line"><span class="keyword">this</span>.infer = flinkConf.get(HiveOptions.TABLE_EXEC_HIVE_INFER_SOURCE_PARALLELISM);</span><br><span class="line"><span class="comment">// è·å– table.exec.hive.infer-source-parallelism.max é…ç½®å¹¶èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">this</span>.inferMaxParallelism = flinkConf.get(HiveOptions.TABLE_EXEC_HIVE_INFER_SOURCE_PARALLELISM_MAX);</span><br><span class="line">Preconditions.checkArgument(</span><br><span class="line">inferMaxParallelism &gt;= <span class="number">1</span>,</span><br><span class="line">HiveOptions.TABLE_EXEC_HIVE_INFER_SOURCE_PARALLELISM_MAX.key() + <span class="string">" cannot be less than 1"</span>);</span><br><span class="line">        <span class="comment">// è·å– table.exec.resource.default-parallelism é…ç½®</span></span><br><span class="line"><span class="keyword">this</span>.parallelism = flinkConf.get(ExecutionConfigOptions.TABLE_EXEC_RESOURCE_DEFAULT_PARALLELISM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Apply limit to calculate the parallelism.</span></span><br><span class="line"><span class="comment"> * Here limit is the limit in query &lt;code&gt;SELECT * FROM xxx LIMIT [limit]&lt;/code&gt;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">limit</span><span class="params">(Long limit)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (limit != <span class="keyword">null</span>) &#123;</span><br><span class="line">parallelism = Math.min(parallelism, (<span class="keyword">int</span>) (limit / <span class="number">1000</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// make sure that parallelism is at least 1</span></span><br><span class="line"><span class="keyword">return</span> Math.max(<span class="number">1</span>, parallelism);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Infer parallelism by number of files and number of splits.</span></span><br><span class="line"><span class="comment"> * If &#123;<span class="doctag">@link</span> HiveOptions#TABLE_EXEC_HIVE_INFER_SOURCE_PARALLELISM&#125; is not set this method does nothing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">HiveParallelismInference <span class="title">infer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">SupplierWithException&lt;Integer, IOException&gt; numFiles,</span></span></span><br><span class="line"><span class="function"><span class="params">SupplierWithException&lt;Integer, IOException&gt; numSplits)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å¦‚æœè®¾ç½® table.exec.hive.infer-source-parallelism ä¸º falseï¼Œåˆ™ç›´æ¥è·³è¿‡äº†</span></span><br><span class="line"><span class="keyword">if</span> (!infer) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// `createInputSplits` is costly,</span></span><br><span class="line"><span class="comment">// so we try to avoid calling it by first checking the number of files</span></span><br><span class="line"><span class="comment">// which is the lower bound of the number of splits</span></span><br><span class="line"><span class="keyword">int</span> lowerBound = logRunningTime(<span class="string">"getNumFiles"</span>, numFiles);</span><br><span class="line"><span class="keyword">if</span> (lowerBound &gt;= inferMaxParallelism) &#123;</span><br><span class="line">parallelism = inferMaxParallelism;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> splitNum = logRunningTime(<span class="string">"createInputSplits"</span>, numSplits);</span><br><span class="line">parallelism = Math.min(splitNum, inferMaxParallelism);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> FlinkHiveException(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">logRunningTime</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">String operationName, SupplierWithException&lt;Integer, IOException&gt; supplier)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="keyword">long</span> startTimeMillis = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">int</span> result = supplier.get();</span><br><span class="line">LOG.info(</span><br><span class="line"><span class="string">"Hive source(&#123;&#125;&#125;) &#123;&#125; use time: &#123;&#125; ms, result: &#123;&#125;"</span>,</span><br><span class="line">tablePath,</span><br><span class="line">operationName,</span><br><span class="line">System.currentTimeMillis() - startTimeMillis,</span><br><span class="line">result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ³¨é‡Šä¸»è¦æ˜¯ infer æ–¹æ³•å»åšçš„çš„å¹¶è¡Œåº¦æ¨æ–­ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•° numFiles å’Œ numSplitsï¼Œè¯¥æ–¹æ³•åªåœ¨HiveTableSource ç±»ä¸­çš„ getDataStream æ–¹æ³•ä¸­è°ƒç”¨ï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹å›¾ï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-05-07-134123.jpg" alt=""></p><p>é‚£å°±æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ï¼š</p><p>getNumFiles æ–¹æ³•æ˜¯ç”¨æ¥è·å– Hive è¡¨åˆ†åŒºä¸‹é¢çš„æ–‡ä»¶æ•°é‡çš„:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getNumFiles</span><span class="params">(List&lt;HiveTablePartition&gt; partitions, JobConf jobConf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> numFiles = <span class="number">0</span>;</span><br><span class="line">    FileSystem fs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (HiveTablePartition partition : partitions) &#123;</span><br><span class="line">        StorageDescriptor sd = partition.getStorageDescriptor();</span><br><span class="line">        org.apache.hadoop.fs.Path inputPath = <span class="keyword">new</span> org.apache.hadoop.fs.Path(sd.getLocation());</span><br><span class="line">        <span class="keyword">if</span> (fs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            fs = inputPath.getFileSystem(jobConf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// it's possible a partition exists in metastore but the data has been removed</span></span><br><span class="line">        <span class="keyword">if</span> (!fs.exists(inputPath)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        numFiles += fs.listStatus(inputPath).length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> numFiles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createInputSplits æ–¹æ³•æ˜¯ç”¨æ¥å°† Hive è¡¨åˆ†åŒºä¸‹çš„æ–‡ä»¶åˆ†å‰²æˆé€»è¾‘ä¸Šçš„ InputSplitï¼Œè¿™é‡Œæ˜¯åœ¨ Flink Hive Connector é‡Œé¢å®šä¹‰äº†ä¸€ä¸ª HiveSourceSplit ç±»æ¥åŒ…è£… InputSplitï¼ŒåŒ…å«äº† Hive è¡¨åˆ†åŒºçš„ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;HiveSourceSplit&gt; <span class="title">createInputSplits</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> minNumSplits,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;HiveTablePartition&gt; partitions,</span></span></span><br><span class="line"><span class="function"><span class="params">        JobConf jobConf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    List&lt;HiveSourceSplit&gt; hiveSplits = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    FileSystem fs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (HiveTablePartition partition : partitions) &#123;</span><br><span class="line">        StorageDescriptor sd = partition.getStorageDescriptor();</span><br><span class="line">        org.apache.hadoop.fs.Path inputPath = <span class="keyword">new</span> org.apache.hadoop.fs.Path(sd.getLocation());</span><br><span class="line">        <span class="keyword">if</span> (fs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            fs = inputPath.getFileSystem(jobConf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// it's possible a partition exists in metastore but the data has been removed</span></span><br><span class="line">        <span class="keyword">if</span> (!fs.exists(inputPath)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        InputFormat format;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            format = (InputFormat)</span><br><span class="line">                    Class.forName(sd.getInputFormat(), <span class="keyword">true</span>, Thread.currentThread().getContextClassLoader()).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FlinkHiveException(<span class="string">"Unable to instantiate the hadoop input format"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        ReflectionUtils.setConf(format, jobConf);</span><br><span class="line">        jobConf.set(INPUT_DIR, sd.getLocation());</span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span> we should consider how to calculate the splits according to minNumSplits in the future.</span></span><br><span class="line">        org.apache.hadoop.mapred.InputSplit[] splitArray = format.getSplits(jobConf, minNumSplits);</span><br><span class="line">        <span class="keyword">for</span> (org.apache.hadoop.mapred.InputSplit inputSplit : splitArray) &#123;</span><br><span class="line">            Preconditions.checkState(inputSplit <span class="keyword">instanceof</span> FileSplit,</span><br><span class="line">                    <span class="string">"Unsupported InputSplit type: "</span> + inputSplit.getClass().getName());</span><br><span class="line">            hiveSplits.add(<span class="keyword">new</span> HiveSourceSplit((FileSplit) inputSplit, partition, <span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hiveSplits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸Šé¢ä¸¤ä¸ªæ–¹æ³•çš„æ‰§è¡Œå¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼Œæ‰€ä»¥ä¸“é—¨è¿˜å†™äº†ä¸€ä¸ª logRunningTime è®°å½•å…¶æ‰§è¡Œçš„æ—¶é—´ã€‚</p><p>å¦‚æœæ–‡ä»¶æ•°å¤§äºé…ç½®çš„æœ€å¤§å¹¶è¡Œåº¦ï¼Œé‚£ä¹ˆä½œä¸šçš„å¹¶è¡Œåº¦ç›´æ¥ä»¥é…ç½®çš„æœ€å¤§å¹¶è¡Œåº¦ä¸ºå‡†ï¼›å¦åˆ™å– InputSplit ä¸ªæ•°ä¸é…ç½®çš„æœ€å¤§å¹¶è¡Œåº¦ä¸¤è€…æœ€å°å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> lowerBound = logRunningTime(<span class="string">"getNumFiles"</span>, numFiles);</span><br><span class="line"><span class="keyword">if</span> (lowerBound &gt;= inferMaxParallelism) &#123;</span><br><span class="line">    parallelism = inferMaxParallelism;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> splitNum = logRunningTime(<span class="string">"createInputSplits"</span>, numSplits);</span><br><span class="line">parallelism = Math.min(splitNum, inferMaxParallelism);</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ limit æ–¹æ³•çš„é™åˆ¶å¹¶è¡Œåº¦äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Apply limit to calculate the parallelism.</span></span><br><span class="line"><span class="comment"> * Here limit is the limit in query &lt;code&gt;SELECT * FROM xxx LIMIT [limit]&lt;/code&gt;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">limit</span><span class="params">(Long limit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (limit != <span class="keyword">null</span>) &#123;</span><br><span class="line">        parallelism = Math.min(parallelism, (<span class="keyword">int</span>) (limit / <span class="number">1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure that parallelism is at least 1</span></span><br><span class="line">    <span class="keyword">return</span> Math.max(<span class="number">1</span>, parallelism);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šçš„æ„æ€æ˜¯æ ¹æ®æŸ¥è¯¢è¯­å¥çš„ limit æ¥é…ç½®å¹¶è¡Œåº¦ï¼Œåˆ¤æ–­å‰é¢å¾—åˆ°çš„å¹¶è¡Œåº¦ä¸ limit/1000 çš„å¤§å°ï¼Œå–ä¸¤è€…æœ€å°å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‰é¢åˆ¤æ–­è¿™ä¸ª Hive è¡¨åˆ†åŒºæœ‰éå¸¸å¤šçš„æ–‡ä»¶ï¼Œæ¯”å¦‚ 10001 ä¸ªï¼Œé‚£å¤§äºé»˜è®¤çš„æœ€å¤§å€¼ 1000ï¼Œé‚£ä¹ˆè¿”å›çš„å¹¶è¡Œåº¦æ˜¯ 1000ï¼Œä½†æ˜¯å› ä¸ºæŸ¥è¯¢ Hive çš„ SQL åªæ˜¯ 100 æ¡ï¼Œé‚£ä¹ˆè¿™é‡Œå–å€¼å¾—åˆ°çš„æœ€å°å€¼æ˜¯ 0ï¼Œæœ€åé€šè¿‡ Math.max(1, parallelism) è¿”å›çš„ source å¹¶è¡Œåº¦æ˜¯ 1ã€‚</p><p>æ³¨æ„âš ï¸ï¼šä¸Šé¢çš„å¹¶è¡Œåº¦é…ç½®ä»…ä»…é’ˆå¯¹äºæ‰¹ä½œä¸šæŸ¥ Hive æ•°æ®ï¼Œä¸é’ˆå¯¹æµè¯» Hive æ•°æ®ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-05-07-134319.jpg" alt=""></p><h3 id="æµè¯»-Hive"><a href="#æµè¯»-Hive" class="headerlink" title="æµè¯» Hive"></a>æµè¯» Hive</h3><p>åœ¨ HiveTableSource ç±»ä¸­çš„ getDataStream æ–¹æ³•ä¸­å¹¶æ²¡æœ‰é’ˆå¯¹æµè¯»é…ç½® Source å¹¶è¡Œåº¦ã€‚</p><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/E6Mj6uv">https://t.zsxq.com/E6Mj6uv</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;æ‰¹è¯»-Hive&quot;&gt;&lt;a href=&quot;#æ‰¹è¯»-Hive&quot; class=&quot;headerlink&quot; title=&quot;æ‰¹è¯» Hive&quot;&gt;&lt;/a&gt;æ‰¹è¯» Hive&lt;/h3&gt;&lt;p&gt;HiveOptions ä¸­æœ‰ä¸¤ä¸ªé…ç½®&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•æé«˜ Flink K8s é›†ç¾¤èµ„æºä½¿ç”¨ç‡ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2022/03/26/flink-k8s-pod-add-request-and-limit/"/>
    <id>http://www.54tianzhisheng.cn/2022/03/26/flink-k8s-pod-add-request-and-limit/</id>
    <published>2022-03-25T16:00:00.000Z</published>
    <updated>2022-03-30T08:38:05.716Z</updated>
    
    <content type="html"><![CDATA[<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>åœ¨ flink on k8s é»˜è®¤æäº¤ä½œä¸šçš„å‘½ä»¤ä¸‹ï¼Œæˆ‘ä»¬ä¼šæŒ‡å®šä½œä¸šçš„ JM/TM çš„ CPU å’Œ Memoryï¼Œæœ€åä½œä¸šç”Ÿæˆçš„ pod å®ƒçš„ CPU/Memory çš„ request/limit éƒ½æ˜¯ä¸€æ ·çš„èµ„æºï¼Œä½†æ˜¯ä½œä¸šçœŸå®è¿è¡Œæ—¶ä½¿ç”¨çš„èµ„æºè¿œè¾¾ä¸åˆ° limit çš„å€¼ï¼Œè¿™æ ·å°±ä¼š<strong>é€ æˆæœºå™¨èµ„æºæµªè´¹</strong>ï¼ˆæ°´ä½ä¸é«˜ï¼Œä½†æ˜¯æœºå™¨åˆä¸èƒ½å†ç”³è¯· podï¼‰ã€‚</p><a id="more"></a><p>æ¯”å¦‚ä¸‹é¢å‘½ä»¤ï¼šï¼ˆæŒ‡å®šäº† TM çš„èµ„æºï¼ŒæœªæŒ‡å®š JM èµ„æºï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./bin/flink run-application -p 1 -t kubernetes-application  -c com.zhisheng.Test \</span><br><span class="line">  -Dkubernetes.cluster-id=flink-log-alert-test1 \</span><br><span class="line">  -Dtaskmanager.memory.process.size=6g \</span><br><span class="line">  -Djobmanager.memory.process.size=2g \</span><br><span class="line">  -Dkubernetes.jobmanager.cpu=0.5 \</span><br><span class="line">  -Dkubernetes.taskmanager.cpu=1 \</span><br><span class="line">  -Dtaskmanager.numberOfTaskSlots=1 \</span><br><span class="line">  ....</span><br></pre></td></tr></table></figure><p>JM:</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-03-29-144153.jpg" alt=""></p><p>TM:</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-03-29-144217.jpg" alt=""></p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>1ã€åˆ†åˆ«ä¸º JM/TM çš„ å†…å­˜å’Œ CPU æ·»åŠ å‚æ•°è®¾ç½® request å’Œ limitï¼Œå¦‚æœè¡Œå¾—é€šçš„è¯ï¼Œè¿™ç§æ–¹å¼è¦å¢åŠ  8 ä¸ªå‚æ•°æ‰èƒ½æ»¡è¶³éœ€æ±‚ï¼Œä½†å›  Flink å†…å­˜æ¨¡å‹ä½¿å¾—å•ç‹¬è®¾ç½®å†…å­˜çš„ request/limit å˜å¾—éå¸¸å¤æ‚ï¼Œåªèƒ½è®¾ç½® CPU å‚æ•°ï¼Œè€Œä¸”ä¹‹å‰çš„å‚æ•°ä¹Ÿå°†å˜å¾—ä¸å¯ä»¥ä½¿ç”¨ã€‚</p><p>2ã€åˆ†åˆ«ä¸º JM/TM çš„ å†…å­˜å’Œ CPU æ·»åŠ å‚æ•° limit å› å­ï¼Œç”¨æˆ·é…ç½®çš„å†…å­˜æˆ–è€… CPU çš„å€¼é»˜è®¤ä¸º request çš„å€¼ï¼Œlimit å› å­å¿…é¡» &gt;= 1ï¼Œè¿™ç§æ–¹å¼éœ€è¦å¢åŠ å››ä¸ªå‚æ•°ï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ–¹æ³•è¿™ç§æ–¹æ³•è¾ƒä¸ºç®€å•ï¼Œä½†æ˜¯ç›®å‰ YARN é›†ç¾¤ç”¨æˆ·çš„èµ„æºé…ç½®ï¼Œå¤§å¤šæ•°ä½œä¸šå·²ç»æ˜¯æœ‰ä¸€å®šçš„èµ„æºæµªè´¹ï¼ˆç”³è¯·çš„èµ„æºè¿œå¤§äºå®é™…ä½¿ç”¨çš„èµ„æºï¼‰ï¼Œå¦‚æœä½¿ç”¨è¯¥æ–¹å¼ï¼Œç”¨æˆ·ä½œä¸šæ— æ„Ÿè¿ç§»åˆ° K8s é›†ç¾¤åï¼Œå…¶å®<strong>èµ„æºæµªè´¹é—®é¢˜å¹¶æ²¡æœ‰è§£å†³</strong>ã€‚</p><p>3ã€åˆ†åˆ«ä¸º JM/TM çš„ å†…å­˜å’Œ CPU æ·»åŠ å‚æ•° request å› å­ï¼Œç”¨æˆ·é…ç½®çš„å†…å­˜æˆ–è€… CPU çš„å€¼é»˜è®¤ä¸º limit çš„å€¼ï¼Œrequest å› å­å¿…é¡» &lt;= 1ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç”Ÿäº§çš„æ•°æ®é…ç½®ä¸€ä¸ªåˆç†çš„å€¼ï¼Œæ¯”å¦‚ä¸º 0.5ã€‚è¿™ç§æ–¹å¼åŒæ ·éœ€è¦å¢åŠ å››ä¸ªå‚æ•°ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å¯¹æ¯”ç¬¬äºŒç§å¸¦æ¥çš„å¥½å¤„æ˜¯ï¼Œ<strong>å¤§å¤šæ•°ç”¨æˆ·ä½œä¸šçš„èµ„æºé…ç½®å°†ä¼šæ›´åˆç†ï¼Œæœºå™¨åŒç­‰èµ„æºèƒ½è¿è¡Œæ›´å¤šçš„ podï¼Œä»è€Œå¯ä»¥æé«˜æœºå™¨çš„èµ„æºæ°´ä½</strong>ã€‚</p><p>ä»£ç å¼€å‘</p><p>1ã€åœ¨ KubernetesConfigOptions å¢åŠ é…ç½® </p><p>KubernetesConfigOptions.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jobmanager</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Double&gt; JOB_MANAGER_CPU_REQUEST_FACTOR =</span><br><span class="line">    key(<span class="string">"kubernetes.jobmanager.cpu.request-factor"</span>)</span><br><span class="line">    .doubleType()</span><br><span class="line">    .defaultValue(<span class="number">1.0</span>)</span><br><span class="line">    .withDescription(</span><br><span class="line">    <span class="string">"The request factor of cpu used by job manager. "</span></span><br><span class="line">    + <span class="string">"The resources request cpu will be set to cpu * request-factor."</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Double&gt; JOB_MANAGER_MEMORY_REQUEST_FACTOR =</span><br><span class="line">    key(<span class="string">"kubernetes.jobmanager.memory.request-factor"</span>)</span><br><span class="line">    .doubleType()</span><br><span class="line">    .defaultValue(<span class="number">1.0</span>)</span><br><span class="line">    .withDescription(</span><br><span class="line">    <span class="string">"The request factor of memory used by job manager. "</span></span><br><span class="line">+ <span class="string">"The resources request memory will be set to memory * request-factor."</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// taskmanager</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Double&gt; TASK_MANAGER_CPU_REQUEST_FACTOR =</span><br><span class="line">    key(<span class="string">"kubernetes.taskmanager.cpu.request-factor"</span>)</span><br><span class="line">        .doubleType()</span><br><span class="line">        .defaultValue(<span class="number">1.0</span>)</span><br><span class="line">        .withDescription(</span><br><span class="line">            <span class="string">"The request factor of cpu used by task manager. "</span></span><br><span class="line">                + <span class="string">"The resources request cpu will be set to cpu * request-factor."</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigOption&lt;Double&gt; TASK_MANAGER_MEMORY_REQUEST_FACTOR =</span><br><span class="line">    key(<span class="string">"kubernetes.taskmanager.memory.request-factor"</span>)</span><br><span class="line">        .doubleType()</span><br><span class="line">        .defaultValue(<span class="number">1.0</span>)</span><br><span class="line">        .withDescription(</span><br><span class="line">            <span class="string">"The request factor of memory used by task manager. "</span></span><br><span class="line">                + <span class="string">"The resources request memory will be set to memory * request-factor."</span>);</span><br></pre></td></tr></table></figure><p>2ã€åœ¨ KubernetesJobManagerParameters å’Œ KubernetesTaskManagerParameters ä¸­åˆ†åˆ«æä¾›è·å–å‚æ•°çš„æ–¹æ³•</p><p>KubernetesJobManagerParameters.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getJobManagerCPURequestFactor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">double</span> requestFactor =</span><br><span class="line">        flinkConfig.getDouble(KubernetesConfigOptions.JOB_MANAGER_CPU_REQUEST_FACTOR);</span><br><span class="line">    checkArgument(</span><br><span class="line">        requestFactor &lt;= <span class="number">1</span>,</span><br><span class="line">        <span class="string">"%s should be less than or equal to 1."</span>,</span><br><span class="line">        KubernetesConfigOptions.JOB_MANAGER_CPU_REQUEST_FACTOR.key());</span><br><span class="line">    <span class="keyword">return</span> requestFactor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getJobManagerMemoryRequestFactor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">double</span> requestFactor =</span><br><span class="line">        flinkConfig.getDouble(KubernetesConfigOptions.JOB_MANAGER_MEMORY_REQUEST_FACTOR);</span><br><span class="line">    checkArgument(</span><br><span class="line">        requestFactor &lt;= <span class="number">1</span>,</span><br><span class="line">        <span class="string">"%s should be less than or equal to 1."</span>,</span><br><span class="line">        KubernetesConfigOptions.JOB_MANAGER_MEMORY_REQUEST_FACTOR.key());</span><br><span class="line">    <span class="keyword">return</span> requestFactor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>KubernetesTaskManagerParameters.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getTaskManagerCPURequestFactor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">double</span> requestFactor =</span><br><span class="line">        flinkConfig.getDouble(KubernetesConfigOptions.TASK_MANAGER_CPU_REQUEST_FACTOR);</span><br><span class="line">    checkArgument(</span><br><span class="line">        requestFactor &lt;= <span class="number">1</span>,</span><br><span class="line">        <span class="string">"%s should be less than or equal to 1."</span>,</span><br><span class="line">        KubernetesConfigOptions.TASK_MANAGER_CPU_REQUEST_FACTOR.key());</span><br><span class="line">    <span class="keyword">return</span> requestFactor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getTaskManagerMemoryRequestFactor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">double</span> requestFactor =</span><br><span class="line">        flinkConfig.getDouble(KubernetesConfigOptions.TASK_MANAGER_MEMORY_REQUEST_FACTOR);</span><br><span class="line">    checkArgument(</span><br><span class="line">        requestFactor &lt;= <span class="number">1</span>,</span><br><span class="line">        <span class="string">"%s should be less than or equal to 1."</span>,</span><br><span class="line">        KubernetesConfigOptions.TASK_MANAGER_MEMORY_REQUEST_FACTOR.key());</span><br><span class="line">    <span class="keyword">return</span> requestFactor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3ã€KubernetesUtils.getResourceRequirements() æ–¹æ³•åšå¦‚ä¸‹æ”¹å˜ï¼Œå¢åŠ  request å› å­å‚æ•°</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-03-29-144238.jpg" alt=""></p><p>KubernetesUtils.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get resource requirements from memory and cpu.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mem Memory in mb.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> memoryRequestFactor Memory request factor.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cpu cpu.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cpuRequestFactor cpu request factor.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> externalResources external resources</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> KubernetesResource requirements.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResourceRequirements <span class="title">getResourceRequirements</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> mem,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">double</span> memoryRequestFactor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">double</span> cpu,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">double</span> cpuRequestFactor,</span></span></span><br><span class="line"><span class="function"><span class="params">        Map&lt;String, Long&gt; externalResources)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//todoï¼šcpu å’Œ å†…å­˜åˆ†åˆ«è®¾ç½®ä¸€ä¸ªå› å­ï¼Œé»˜è®¤æ˜¯ 0.5ï¼Œç”¨æˆ·è®¾ç½®çš„èµ„æºé…ç½®ä¸º limitï¼›request = limit * å› å­</span></span><br><span class="line">    <span class="keyword">final</span> Quantity cpuQuantity = <span class="keyword">new</span> Quantity(String.valueOf(cpu));</span><br><span class="line">    <span class="keyword">final</span> Quantity cpuRequestQuantity = <span class="keyword">new</span> Quantity(String.valueOf(cpu * cpuRequestFactor));</span><br><span class="line">    <span class="keyword">final</span> Quantity memQuantity = <span class="keyword">new</span> Quantity(mem + Constants.RESOURCE_UNIT_MB);</span><br><span class="line">    <span class="keyword">final</span> Quantity memRequestQuantity =</span><br><span class="line">        <span class="keyword">new</span> Quantity(((<span class="keyword">int</span>) (mem * memoryRequestFactor)) + Constants.RESOURCE_UNIT_MB);</span><br><span class="line"></span><br><span class="line">    ResourceRequirementsBuilder resourceRequirementsBuilder = <span class="keyword">new</span> ResourceRequirementsBuilder()</span><br><span class="line">        .addToRequests(Constants.RESOURCE_NAME_MEMORY, memRequestQuantity)</span><br><span class="line">        .addToRequests(Constants.RESOURCE_NAME_CPU, cpuRequestQuantity)</span><br><span class="line">        .addToLimits(Constants.RESOURCE_NAME_MEMORY, memQuantity)</span><br><span class="line">        .addToLimits(Constants.RESOURCE_NAME_CPU, cpuQuantity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the external resources to resource requirement.</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Long&gt; externalResource: externalResources.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">final</span> Quantity resourceQuantity = <span class="keyword">new</span> Quantity(String.valueOf(externalResource.getValue()));</span><br><span class="line">        resourceRequirementsBuilder</span><br><span class="line">            .addToRequests(externalResource.getKey(), resourceQuantity)</span><br><span class="line">            .addToLimits(externalResource.getKey(), resourceQuantity);</span><br><span class="line">        LOG.info(<span class="string">"Request external resource &#123;&#125; with config key &#123;&#125;."</span>, resourceQuantity.getAmount(), externalResource.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resourceRequirementsBuilder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4ã€åœ¨ InitJobManagerDecorator å’Œ InitTaskManagerDecorator è°ƒç”¨ä¸Šé¢æ–¹æ³•çš„åœ°æ–¹åšç›¸åº”çš„ä¿®æ”¹</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-03-29-144238.jpg" alt=""></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-03-29-144323.jpg" alt=""></p><h3 id="æœ€ç»ˆæ•ˆæœ"><a href="#æœ€ç»ˆæ•ˆæœ" class="headerlink" title="æœ€ç»ˆæ•ˆæœ"></a>æœ€ç»ˆæ•ˆæœ</h3><p>å¯ä»¥åœ¨ flink-conf.yaml ä¸­å®šä¹‰é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubernetes.jobmanager.cpu.request-factor:</span> <span class="number">0.5</span></span><br><span class="line"><span class="string">kubernetes.jobmanager.memory.request-factor:</span> <span class="number">0.8</span></span><br><span class="line"><span class="string">kubernetes.taskmanager.cpu.request-factor:</span> <span class="number">0.5</span></span><br><span class="line"><span class="string">kubernetes.taskmanager.memory.request-factor:</span> <span class="number">0.8</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œç”¨æˆ·çš„ä½œä¸šæäº¤å‚æ•°ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šé¢çš„å‚æ•°è¿›è¡Œè¦†ç›–ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2022-03-29-144340.jpg" alt=""></p><h3 id="å…³æ³¨æˆ‘"><a href="#å…³æ³¨æˆ‘" class="headerlink" title="å…³æ³¨æˆ‘"></a>å…³æ³¨æˆ‘</h3><p>å¾®ä¿¡å…¬ä¼—å·ï¼š<strong>zhisheng</strong></p><p>å¦å¤–æˆ‘è‡ªå·±æ•´ç†äº†äº› Flink çš„å­¦ä¹ èµ„æ–™ï¼Œç›®å‰å·²ç»å…¨éƒ¨æ”¾åˆ°å¾®ä¿¡å…¬ä¼—å·ï¼ˆzhishengï¼‰äº†ï¼Œä½ å¯ä»¥å›å¤å…³é”®å­—ï¼š<strong>Flink</strong> å³å¯æ— æ¡ä»¶è·å–åˆ°ã€‚å¦å¤–ä¹Ÿå¯ä»¥åŠ æˆ‘å¾®ä¿¡ ä½ å¯ä»¥åŠ æˆ‘çš„å¾®ä¿¡ï¼š<strong>yuanblog_tzs</strong>ï¼Œæ¢è®¨æŠ€æœ¯ï¼</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-17-143454.jpg" alt=""></p><p>æ›´å¤šç§å¯†èµ„æ–™è¯·åŠ å…¥çŸ¥è¯†æ˜Ÿçƒï¼</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p><h3 id="Github-ä»£ç ä»“åº“"><a href="#Github-ä»£ç ä»“åº“" class="headerlink" title="Github ä»£ç ä»“åº“"></a>Github ä»£ç ä»“åº“</h3><p><a href="https://github.com/zhisheng17/flink-learning/">https://github.com/zhisheng17/flink-learning/</a></p><p>ä»¥åè¿™ä¸ªé¡¹ç›®çš„æ‰€æœ‰ä»£ç éƒ½å°†æ”¾åœ¨è¿™ä¸ªä»“åº“é‡Œï¼ŒåŒ…å«äº†è‡ªå·±å­¦ä¹  flink çš„ä¸€äº› demo å’Œåšå®¢</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;é—®é¢˜&quot;&gt;&lt;a href=&quot;#é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜&quot;&gt;&lt;/a&gt;é—®é¢˜&lt;/h3&gt;&lt;p&gt;åœ¨ flink on k8s é»˜è®¤æäº¤ä½œä¸šçš„å‘½ä»¤ä¸‹ï¼Œæˆ‘ä»¬ä¼šæŒ‡å®šä½œä¸šçš„ JM/TM çš„ CPU å’Œ Memoryï¼Œæœ€åä½œä¸šç”Ÿæˆçš„ pod å®ƒçš„ CPU/Memory çš„ request/limit éƒ½æ˜¯ä¸€æ ·çš„èµ„æºï¼Œä½†æ˜¯ä½œä¸šçœŸå®è¿è¡Œæ—¶ä½¿ç”¨çš„èµ„æºè¿œè¾¾ä¸åˆ° limit çš„å€¼ï¼Œè¿™æ ·å°±ä¼š&lt;strong&gt;é€ æˆæœºå™¨èµ„æºæµªè´¹&lt;/strong&gt;ï¼ˆæ°´ä½ä¸é«˜ï¼Œä½†æ˜¯æœºå™¨åˆä¸èƒ½å†ç”³è¯· podï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>å®•æœºä¸€å°æœºå™¨ï¼Œç»“æœä¸€ç™¾å¤šä¸ª Flink ä½œä¸šæŒ‚äº†</title>
    <link href="http://www.54tianzhisheng.cn/2021/11/11/flink-akka-framesize/"/>
    <id>http://www.54tianzhisheng.cn/2021/11/11/flink-akka-framesize/</id>
    <published>2021-11-10T16:00:00.000Z</published>
    <updated>2021-11-11T15:33:45.652Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>å› å®•æœºäº†ä¸€å°ç‰©ç†æœºå™¨ï¼Œå®æ—¶é›†ç¾¤ä¸å°‘ä½œä¸šå‘ç”Ÿ failoverï¼Œå…¶ä¸­å¤§éƒ¨åˆ†ä½œä¸šéƒ½èƒ½ failover æˆåŠŸï¼ŒæŸä¸ªéƒ¨é—¨çš„éƒ¨åˆ†ä½œä¸šä¸€ç›´åœ¨ failoverï¼Œå§‹ç»ˆæœªæˆåŠŸï¼Œåˆ° WebUI æŸ¥çœ‹ä½œä¸šå¼‚å¸¸æ—¥å¿—å¦‚ä¸‹ï¼š</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">2021-11-09 16:01:11</span><br><span class="line">java.util.concurrent.CompletionException: java.lang.reflect.UndeclaredThrowableException</span><br><span class="line"> at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)</span><br><span class="line"> at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)</span><br><span class="line"> at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1592)</span><br><span class="line"> at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line"> at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line"> at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)</span><br><span class="line"> at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)</span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line"> at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line"> at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">Caused by: java.lang.reflect.UndeclaredThrowableException</span><br><span class="line"> at com.sun.proxy.$Proxy54.submitTask(Unknown Source)</span><br><span class="line"> at org.apache.flink.runtime.jobmaster.RpcTaskManagerGateway.submitTask(RpcTaskManagerGateway.java:72)</span><br><span class="line"> at org.apache.flink.runtime.executiongraph.Execution.lambda$deploy$10(Execution.java:756)</span><br><span class="line"> at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1590)</span><br><span class="line"> ... 7 more</span><br><span class="line">Caused by: java.io.IOException: The rpc invocation size 56424326 exceeds the maximum akka framesize.</span><br><span class="line"> at org.apache.flink.runtime.rpc.akka.AkkaInvocationHandler.createRpcInvocationMessage(AkkaInvocationHandler.java:276)</span><br><span class="line"> at org.apache.flink.runtime.rpc.akka.AkkaInvocationHandler.invokeRpc(AkkaInvocationHandler.java:205)</span><br><span class="line"> at org.apache.flink.runtime.rpc.akka.AkkaInvocationHandler.invoke(AkkaInvocationHandler.java:134)</span><br><span class="line"> ... 11 more</span><br></pre></td></tr></table></figure><h3 id="è§£å†³å¼‚å¸¸è¿‡ç¨‹"><a href="#è§£å†³å¼‚å¸¸è¿‡ç¨‹" class="headerlink" title="è§£å†³å¼‚å¸¸è¿‡ç¨‹"></a>è§£å†³å¼‚å¸¸è¿‡ç¨‹</h3><p>ä»ä¸Šé¢çš„å¼‚å¸¸æ—¥å¿—ä¸­æˆ‘ä»¬æå–åˆ°å…³é”®ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.io.IOException: The rpc invocation size 56424326 exceeds the maximum akka framesize.</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥æ˜¯ RPC çš„æ¶ˆæ¯å¤§å°è¶…è¿‡äº†é»˜è®¤çš„ akka framesize çš„æœ€å¤§å€¼äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è¿™ä¸ªå€¼çš„é»˜è®¤å€¼ï¼Œä» <a href="https://nightlies.apache.org/flink/flink-docs-release-1.12/deployment/config.html#akka-framesize">å®˜ç½‘</a> æˆ‘ä»¬å¯ä»¥çœ‹çš„åˆ°è¯¥å€¼çš„é»˜è®¤å¤§å°ä¸º â€œ10485760bâ€ï¼Œå¹¶ä¸”è¯¥å‚æ•°çš„æè¿°ä¸ºï¼š</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwbm72hedkj31i806imya.jpg" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Maximum size of messages which are sent between the JobManager and the TaskManagers. If Flink fails because messages exceed this limit, then you should increase it. The message size requires a size-unit specifier.</span><br></pre></td></tr></table></figure><p>ç¿»è¯‘è¿‡æ¥çš„æ„æ€å°±æ˜¯ï¼šè¿™ä¸ªå‚æ•°æ˜¯ JobManager å’Œ TaskManagers ä¹‹é—´é€šä¿¡å…è®¸çš„æœ€å¤§æ¶ˆæ¯å¤§å°ï¼Œå¦‚æœ Flink ä½œä¸šå› ä¸ºé€šä¿¡æ¶ˆæ¯å¤§å°è¶…è¿‡äº†è¯¥å€¼ï¼Œä½ å¯ä»¥é€šè¿‡å¢åŠ è¯¥å€¼çš„å¤§å°æ¥è§£å†³ï¼Œè¯¥å‚æ•°éœ€è¦æŒ‡å®šä¸€ä¸ªå•ä½ã€‚</p><h3 id="åˆ†æåŸå› "><a href="#åˆ†æåŸå› " class="headerlink" title="åˆ†æåŸå› "></a>åˆ†æåŸå› </h3><p>Flink ä½¿ç”¨ Akka ä½œä¸ºç»„ä»¶ï¼ˆJobManager/TaskManager/ResourceManagerï¼‰ä¹‹é—´çš„ RPC æ¡†æ¶ï¼Œåœ¨ JobManager å’Œ TaskManagers ä¹‹é—´å‘é€çš„æ¶ˆæ¯çš„æœ€å¤§å¤§å°é»˜è®¤ä¸º 10485760bï¼Œå¦‚æœæ¶ˆæ¯è¶…è¿‡è¿™ä¸ªé™åˆ¶å°±ä¼šå¤±è´¥ï¼ŒæŠ¥é”™ã€‚è¿™ä¸ªå¯ä»¥çœ‹ä¸‹æŠ›å‡ºå¼‚å¸¸å¤„çš„æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected RpcInvocation createRpcInvocationMessage(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] args) throws IOException &#123;</span><br><span class="line">    Object rpcInvocation;</span><br><span class="line">    if (this.isLocal) &#123;</span><br><span class="line">        rpcInvocation = new LocalRpcInvocation(methodName, parameterTypes, args);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            RemoteRpcInvocation remoteRpcInvocation = new RemoteRpcInvocation(methodName, parameterTypes, args);</span><br><span class="line">            if (remoteRpcInvocation.getSize() &gt; this.maximumFramesize) &#123;</span><br><span class="line">                // å¼‚å¸¸æ‰€åœ¨ä½ç½®</span><br><span class="line">                throw new IOException(&quot;The rpc invocation size exceeds the maximum akka framesize.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rpcInvocation = remoteRpcInvocation;</span><br><span class="line">        &#125; catch (IOException var6) &#123;</span><br><span class="line">            LOG.warn(&quot;Could not create remote rpc invocation message. Failing rpc invocation because...&quot;, var6);</span><br><span class="line">            throw var6;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (RpcInvocation)rpcInvocation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³äºä¸ºä»€ä¹ˆ JobManager å’Œ TaskManager ä¹‹é—´çš„ RPC æ¶ˆæ¯å¤§å°ä¼šå¦‚æ­¤ä¹‹å¤§ï¼Œåˆæ­¥çš„è§£é‡Šæ˜¯åœ¨ task å‡ºç°å¼‚å¸¸ä¹‹åï¼Œå®ƒéœ€è¦è°ƒç”¨ updateTaskExecutionState(TaskExecutionStateï¼ŒtaskExecutionState) è¿™ä¸ª RPC æ¥å£å»é€šçŸ¥ Flink Jobmanager å»æ”¹å˜å¯¹åº” task çš„çŠ¶æ€å¹¶ä¸”é‡å¯ taskã€‚ä½†æ˜¯å‘¢ï¼ŒtaskExecutionState è¿™ä¸ªå‚æ•°é‡Œé¢æœ‰ä¸ª error å±æ€§ï¼Œå½“æˆ‘çš„ task æ‰“å‡ºæ¥çš„é”™è¯¯æ ˆå¤ªå¤šçš„æ—¶å€™ï¼Œåœ¨åºåˆ—åŒ–çš„ä¹‹åè¶…è¿‡äº† rpc æ¥å£è¦æ±‚çš„æœ€å¤§æ•°æ®å¤§å°ï¼ˆä¹Ÿå°±æ˜¯ maximum akka framesizeï¼‰ï¼Œå¯¼è‡´è°ƒç”¨ updateTaskExecutionState è¿™ä¸ª rpc æ¥å£å¤±è´¥ï¼ŒJobmanager æ— æ³•è·çŸ¥è¿™ä¸ª task å·²ç»å¤„äº fail çš„çŠ¶æ€ï¼Œä¹Ÿæ— æ³•é‡å¯ï¼Œç„¶åå°±å¯¼è‡´äº†ä¸€ç³»åˆ—è¿é”ååº”ã€‚</p><h3 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h3><p>ä»»åŠ¡åœæ­¢ï¼Œåœ¨ <code>flink-conf.yaml</code> ä¸­åŠ å…¥ <code>akka.framesize</code> å‚æ•°ï¼Œè°ƒå¤§è¯¥å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">akka.framesize: &quot;62914560b&quot;</span><br></pre></td></tr></table></figure><p>ç„¶åå°†ä»»åŠ¡é‡å¯ï¼Œå¯ä»¥è§‚å¯Ÿ Jobmanager Configration çœ‹çœ‹å‚æ•°æ˜¯å¦ç”Ÿæ•ˆã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h3&gt;&lt;p&gt;å› å®•æœºäº†ä¸€å°ç‰©ç†æœºå™¨ï¼Œå®æ—¶é›†ç¾¤ä¸å°‘ä½œä¸šå‘ç”Ÿ failoverï¼Œå…¶ä¸­å¤§éƒ¨åˆ†ä½œä¸šéƒ½èƒ½ failover æˆåŠŸï¼ŒæŸä¸ªéƒ¨é—¨çš„éƒ¨åˆ†ä½œä¸šä¸€ç›´åœ¨ failoverï¼Œå§‹ç»ˆæœªæˆåŠŸï¼Œåˆ° WebUI æŸ¥çœ‹ä½œä¸šå¼‚å¸¸æ—¥å¿—å¦‚ä¸‹ï¼š&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>å®æ—¶å¹³å°å¦‚ä½•ç®¡ç†å¤šä¸ª Flink ç‰ˆæœ¬ï¼Ÿâ€”â€” ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/09/26/realtime-platform-flink-version/"/>
    <id>http://www.54tianzhisheng.cn/2021/09/26/realtime-platform-flink-version/</id>
    <published>2021-09-25T16:00:00.000Z</published>
    <updated>2021-11-14T03:12:49.099Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ"><a href="#ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ" class="headerlink" title="ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ"></a>ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ</h3><a id="more"></a><ul><li><p><strong>Flink ç¤¾åŒº</strong>æœ¬èº«è¿­ä»£é€Ÿåº¦éå¸¸å¿«ï¼Œç›®å‰é˜¿é‡Œäº‘æœ‰ä¸€å¤§æ³¢çš„äººä¸“èŒåš Flink å¼€æºï¼Œå¦å¤–è¿˜æ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºè´¡çŒ®è€…ï¼Œæ‰€ä»¥åŠŸèƒ½å¼€å‘è¾ƒå¿«ï¼Œbug ä¿®å¤é€Ÿåº¦è¾ƒå¿«ï¼Œå‡ ä¹æ¯ 4 ä¸ªæœˆä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼Œæ¯ä¸ªå¤§ç‰ˆæœ¬ä¹‹é—´è¿­ä»£çš„åŠŸèƒ½éå¸¸å¤šï¼Œä»£ç å˜åŠ¨éå¸¸å¤§ï¼ŒAPI æ¥å£å˜åŠ¨ä¹Ÿå¤§ï¼ŒåŠ¨ä¸åŠ¨å°±å¹²ç¿»è‡ªå·±äº†ã€‚</p></li><li><p>ç¤¾åŒºè¿­ä»£å¿«å°±å¿«å‘—ï¼Œä¸ºä»€ä¹ˆ<strong>å…¬å¸</strong>ä¹Ÿè¦è¦ä¸æ–­è·Ÿç€ç¤¾åŒºé¼»å­èµ°ï¼Ÿç¤¾åŒºè¿­ä»£å¿«æ„å‘³ç€åŠŸèƒ½å¤šï¼Œä¿®å¤çš„ bug å¤šï¼Œç›¸å¯¹äºæ—©æœŸç‰ˆæœ¬æ„å‘³ç€ç¨³å®šæ€§ä¹Ÿé«˜äº›ã€‚é™¤äº†å›½å†…ä¸€äºŒçº¿å…¬å¸æœ‰ç‰¹åˆ«å¤šçš„ä¸“èŒäººå»è´Ÿè´£è¿™å—ï¼Œå¤§å¤šæ•°ä¸­å°å…¬å¸æœ€ç®€å•æœ€å¿«æ·ä½“éªŒåˆ°ç¨³å®šæ€§æœ€é«˜ã€åŠŸèƒ½æ€§æœ€å¤šã€æ€§èƒ½æœ€å¥½çš„ Flink ç‰ˆæœ¬æ— éæ˜¯ç›´æ¥ä½¿ç”¨æœ€æ–°çš„ Flink ç‰ˆæœ¬ã€‚ä¸¾ä¸ªä¾‹å­ï¼šFlink SQL ä»æœ€æ—©æœŸï¼ˆ1.9ï¼‰çš„åŠŸèƒ½ã€æ€§èƒ½åˆ°ç›®å‰ 1.14ï¼Œå·®åˆ«çœŸçš„å¤§å¾ˆå¤šï¼Œä¼˜åŒ–äº†ç‰¹åˆ«å¤šçš„åœ°æ–¹ï¼Œå¢å¼ºäº†å¾ˆå¤šåŠŸèƒ½ã€‚åŸå…ˆä½¿ç”¨ Flink SQL å®Œæˆä¸€ä¸ªæµå¤„ç†ä»»åŠ¡éå¸¸éº»çƒ¦ï¼Œè¿˜ä¸å¦‚ç›´æ¥å†™å‡ åè¡Œä»£ç æ¥çš„å¿«ï¼Œç›®å‰æˆ‘æƒ…æ„¿å†™ SQL å»å¤„ç†ä¸€ä¸ªæµä»»åŠ¡ã€‚é‚£ä¹ˆè‡ªç„¶ä¼šè·Ÿç€å‡çº§åˆ°æ–°ç‰ˆæœ¬ã€‚</p></li><li><p><strong>ç”¨æˆ· A</strong> é—® Flink SQL æ”¯æŒå•ç‹¬è®¾ç½®å¹¶è¡Œåº¦å—ï¼Ÿ<strong>ç”¨æˆ· B</strong> é—®å®æ—¶å¹³å°ç°åœ¨æ”¯æŒ Flink 1.13 ç‰ˆæœ¬çš„ Window TVFï¼Ÿè¿™ä¸ªè¦ Flink xxx ç‰ˆæœ¬æ‰èƒ½æ”¯æŒï¼Œè¦ä¸ä½ å‡çº§ä¸€ä¸‹ Flink ç‰ˆæœ¬åˆ° xxxï¼Ÿè¿™æ ·å°±èƒ½æ”¯æŒäº†ï¼Œç±»ä¼¼çš„åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œå¯¹äº<strong>ä¸­å°å…¬å¸çš„å®æ—¶å¹³å°è´Ÿè´£äºº</strong>æ¥è¯´ï¼Œè¿™æ— éæœ€çœäº‹ï¼›å¯¹äº<strong>å¤§å…¬å¸çš„è´Ÿè´£å®æ—¶å¼€å‘çš„äºº</strong>æ¥è¯´ï¼Œè¿™æ— ç–‘æ˜¯ä¸€ä¸ªå™©æ¢¦ï¼Œæ¯æ¬¡å‡çº§æ–°ç‰ˆæœ¬éƒ½è¦å°†åœ¨è€ç‰ˆæœ¬å¼€å‘çš„å„ç§åŠŸèƒ½éƒ½æƒ³å°½åŠæ³•ç§»æ¤åˆ°æ–°ç‰ˆæœ¬ä¸Šæ¥ï¼Œç¢°åˆ° API æ¥å£å˜åŠ¨å¤§çš„æ— éç›¸å½“äºé‡å†™äº†ï¼Œæˆ–è€…å°†æ–°ç‰ˆæœ¬çš„æŸäº›ç‰¹åˆ«éœ€è¦çš„åŠŸèƒ½é€šè¿‡æ‰“ patch çš„æ–¹å¼æ‰“åˆ°è€ç‰ˆæœ¬é‡Œé¢å»ã€‚</p></li><li><p>æ–°ç‰ˆæœ¬é¦™æ˜¯çœŸçš„é¦™ï¼Œå¯æ˜¯ä¸ºå•¥æœ‰çš„äººä¸ç”¨å‘¢ï¼Ÿé—®é¢˜å°±æ˜¯ï¼Œå®æ—¶ä½œä¸šå¤§å¤šæ•°æ˜¯é•¿æœŸè¿è¡Œçš„ï¼Œå¦‚æœä¸€ä¸ªä½œä¸šæ²¡å•¥é”™è¯¯ï¼Œåœ¨ç”Ÿäº§è¿è¡Œçš„å¥½å¥½çš„ï¼Œä¹Ÿä¸å‡ºå•¥æ•…éšœï¼Œç¨³å®šæ€§å’Œæ€§èƒ½ä¹Ÿéƒ½èƒ½æ¥å—ï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰ä½œä¸šæ•°æ®é‡éƒ½å¾ˆå¤§ï¼Œä¼šé‡åˆ°æ€§èƒ½é—®é¢˜ï¼‰ï¼Œé‚£ä¹ˆ<strong>ç”¨æˆ·</strong>ä¸ºå•¥è¦ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼Ÿç”¨æˆ·æ‰ä¸ç®¡ä½ æ–°ç‰ˆæœ¬åŠŸèƒ½å¤šç‰›é€¼ï¼Œæ€§èƒ½å¤šå±Œå‘¢ï¼Œè€å­å‡çº§è¿˜è¦æ”¹ä¾èµ–ç‰ˆæœ¬ã€æ”¹æ¥å£ä»£ç ã€æµ‹è¯•è”è°ƒã€æ€§èƒ½æµ‹è¯•ï¼ˆè°çŸ¥é“ä½ è¯´çš„æ€§èƒ½æå‡æ˜¯ä¸æ˜¯å¹ç‰›é€¼çš„ï¼‰ã€ç¨³å®šæ€§æµ‹è¯•ï¼ˆå¯èƒ½ä¸Šçº¿åŒè·‘ä¸€æ®µæ—¶é—´éªŒè¯ï¼‰ï¼Œè¿™äº›ä¸éœ€è¦æ—¶é—´å‘€ï¼Œä½ å«æˆ‘å‡çº§å°±å‡çº§ï¼Œæ»šçŠŠå­å§ï¼Œä½ çŸ¥é“æˆ‘è¿˜æœ‰å¤šå°‘ä¸šåŠ¡éœ€æ±‚è¦åšå—ï¼Ÿ</p></li></ul><p>é‚£ä¹ˆå°±è½ä¸‹è¿™ä¸ªåœºåœ°äº†ï¼Œåˆè¦ä½¿ç”¨æ–°ç‰ˆæœ¬çš„åŠŸèƒ½å»è§£å†³é—®é¢˜ï¼Œè€ä½œä¸šçš„ç”¨æˆ·è·Ÿä»–å„ç§æ‰¯çš®ä¹Ÿæ‰“åŠ¨ä¸äº†ä»–å‡çº§ä½œä¸šçš„ç‰ˆæœ¬ï¼Œé‚£ä¹ˆè‡ªç„¶å°±ä¸æ–­çš„å‡ºç°äº†å¤šä¸ªç‰ˆæœ¬äº†ã€‚</p><p>è¿™æ ·ï¼Œå¦‚æœä¸å¯¹ç‰ˆæœ¬åšå¥½è§„åˆ’ï¼Œé‚£ä¹ˆæ‘Šå­å°±é€æ¸è¶Šæ¥è¶Šå¤§ï¼Œè¶Šæ¥è¶Šéš¾æ”¶æ‹¾äº†ï¼Ÿ</p><p>é‚£ä¹ˆè¯¥å¦‚ä½•ç®¡ç†å…¬å¸çš„ Flink ç‰ˆæœ¬ï¼Ÿå¦‚æœç®¡ç†å’Œå…¼å®¹å¤šä¸ª Flink ç‰ˆæœ¬çš„ä½œä¸šæäº¤ï¼Ÿå¦‚ä½•å…¼å®¹ Jar åŒ…å’Œ SQL ä½œä¸šçš„æäº¤</p><h3 id="æ€ä¹ˆç®¡ç†å¤šä¸ª-Flink-ç‰ˆæœ¬çš„ä½œä¸šæäº¤ï¼Ÿ"><a href="#æ€ä¹ˆç®¡ç†å¤šä¸ª-Flink-ç‰ˆæœ¬çš„ä½œä¸šæäº¤ï¼Ÿ" class="headerlink" title="æ€ä¹ˆç®¡ç†å¤šä¸ª Flink ç‰ˆæœ¬çš„ä½œä¸šæäº¤ï¼Ÿ"></a>æ€ä¹ˆç®¡ç†å¤šä¸ª Flink ç‰ˆæœ¬çš„ä½œä¸šæäº¤ï¼Ÿ</h3><p>å°½è¯·æœŸå¾…ä¸‹ç¯‡æ–‡ç« </p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ&quot;&gt;&lt;/a&gt;ä¸ºå•¥ä¼šå‡ºç°å¤šä¸ªç‰ˆæœ¬ï¼Ÿ&lt;/h3&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” åŸºäº Flink çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/21/flink-in-action-12.3/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/21/flink-in-action-12.3/</id>
    <published>2021-08-20T16:00:00.000Z</published>
    <updated>2022-02-20T13:15:20.296Z</updated>
    
    <content type="html"><![CDATA[<h2 id="12-3-åŸºäº-Flink-çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ"><a href="#12-3-åŸºäº-Flink-çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ" class="headerlink" title="12.3 åŸºäº Flink çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ"></a>12.3 åŸºäº Flink çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ</h2><p>åœ¨å¦‚ä»Šå¾®æœåŠ¡ã€äº‘åŸç”Ÿç­‰æŠ€æœ¯ç››è¡Œçš„æ—¶ä»£ï¼Œå½“è°ˆåˆ°è¯´è¦ä» 0 å¼€å§‹æ„å»ºä¸€ä¸ªç›‘æ§ç³»ç»Ÿï¼Œå¤§å®¶æ— éå°±é¦–å…ˆæƒ³åˆ°ä¸‰ä¸ªè¯ï¼šMetricsã€Tracingã€Loggingã€‚</p><a id="more"></a><h3 id="12-3-1-ç›‘æ§ç³»ç»Ÿçš„è¯‰æ±‚"><a href="#12-3-1-ç›‘æ§ç³»ç»Ÿçš„è¯‰æ±‚" class="headerlink" title="12.3.1 ç›‘æ§ç³»ç»Ÿçš„è¯‰æ±‚"></a>12.3.1 ç›‘æ§ç³»ç»Ÿçš„è¯‰æ±‚</h3><p>å›½å¤–ä¸€ç¯‡æ¯”è¾ƒç«çš„æ–‡ç«  <a href="http://peter.bourgon.org/blog/2017/02/21/metrics-tracing-and-logging.html">Metrics, Tracing, and Logging</a> å†…æœ‰ä¸ªå›¾å¾ˆå¥½çš„æ€»ç»“äº†ä¸€ä¸ªç›‘æ§ç³»ç»Ÿçš„è¯‰æ±‚ï¼Œåˆ†åˆ«æ˜¯ Metricsã€Loggingã€Tracingï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-12-08-132227.png" alt="ç›‘æ§ç³»ç»Ÿçš„è¯‰æ±‚"></p><p>Metrics çš„ç‰¹ç‚¹ï¼šå®ƒè‡ªå·±æä¾›äº†äº”ç§åŸºæœ¬çš„åº¦é‡ç±»å‹ Gaugeã€Counterã€Histogramã€Timerã€Meterã€‚</p><p>Tracing çš„ç‰¹ç‚¹ï¼šæä¾›äº†ä¸€ä¸ªè¯·æ±‚ä»æ¥æ”¶åˆ°å¤„ç†å®Œæ¯•æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„è·Ÿè¸ªè·¯å¾„ï¼Œé€šå¸¸è¯·æ±‚éƒ½æ˜¯åœ¨åˆ†å¸ƒå¼çš„ç³»ç»Ÿä¸­å¤„ç†ï¼Œæ‰€ä»¥ä¹Ÿå«åšåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€‚</p><p>Logging çš„ç‰¹ç‚¹ï¼šæä¾›é¡¹ç›®åº”ç”¨è¿è¡Œçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚æ–¹æ³•çš„å…¥å‚ã€è¿è¡Œçš„å¼‚å¸¸è®°å½•ç­‰ã€‚</p><p>è¿™ä¸‰è€…åœ¨ç›‘æ§ç³»ç»Ÿä¸­ç¼ºä¸€ä¸å¯ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯ï¼šåŸºäº Metrics çš„å¼‚å¸¸å‘Šè­¦äº‹ä»¶ï¼Œç„¶åé€šè¿‡ Tracing å®šä½é—®é¢˜å¯ç–‘æ¨¡å—ï¼Œæ ¹æ®æ¨¡å—è¯¦ç»†çš„æ—¥å¿—å®šä½åˆ°é”™è¯¯æ ¹æºï¼Œæœ€åå†è¿”å›æ¥è°ƒæ•´ Metrics çš„å‘Šè­¦è§„åˆ™ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ›´æ—©çš„é¢„è­¦ï¼Œæå‰é¢„é˜²å‡ºç°æ­¤ç±»é—®é¢˜ã€‚</p><h3 id="12-3-2-ç›‘æ§ç³»ç»ŸåŒ…å«çš„å†…å®¹"><a href="#12-3-2-ç›‘æ§ç³»ç»ŸåŒ…å«çš„å†…å®¹" class="headerlink" title="12.3.2 ç›‘æ§ç³»ç»ŸåŒ…å«çš„å†…å®¹"></a>12.3.2 ç›‘æ§ç³»ç»ŸåŒ…å«çš„å†…å®¹</h3><p>é’ˆå¯¹æåˆ°çš„ä¸‰ä¸ªç‚¹ï¼Œç¬”è€…æ‰¾åˆ°å›½å†…å¤–çš„å¼€æºç›‘æ§ç³»ç»Ÿåšäº†å¯¹æ¯”ï¼Œå‘ç°çœŸæ­£æ‹¥æœ‰å…¨éƒ¨åŠŸèƒ½çš„æ¯”è¾ƒå°‘ï¼Œæœ‰çš„ç³»ç»Ÿæ¯”è¾ƒä¸“æ³¨äº Loggingã€æœ‰çš„ç³»ç»Ÿæ¯”è¾ƒä¸“æ³¨äº Tracingï¼Œè€Œå¤§éƒ¨åˆ†å…¶ä»–çš„ç›‘æ§ç³»ç»Ÿæ— éæ˜¯åªæ˜¯ç›‘æ§ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚æ˜¯ä½œä¸ºä¸€æ¬¾æ•°æ®åº“å­˜å‚¨ç›‘æ§æ•°æ®ã€ä½œä¸ºä¸€ä¸ªå¯è§†åŒ–å›¾è¡¨çš„ç³»ç»Ÿå»å±•ç¤ºå„ç§å„æ ·çš„ç›‘æ§æ•°æ®ä¿¡æ¯ã€‚</p><p>æ‹¿ Logging æ¥è¯´ï¼Œå¼€æºç”¨çš„æœ€å¤šæœ€ç«çš„æŠ€æœ¯æ ˆæ˜¯ ELKï¼ŒTracing è¿™å—æœ‰ Skywalkingã€Pinpoint ç­‰æŠ€æœ¯ï¼Œå®ƒä»¬çš„å¯¹æ¯”å¦‚ <a href="https://mp.weixin.qq.com/s/_XE-gCJnDY3-yEK4xmWiMg">APM å·…å³°å¯¹å†³ï¼šSkywalking PK Pinpoint</a> ä¸€æ–‡ä»‹ç»ã€‚è€Œå­˜å‚¨ç›‘æ§æ•°æ®çš„æ—¶åºæ•°æ®åº“é‚£å°±æ¯”è¾ƒå¤šäº†ï¼Œå¸¸è§çš„æ¯”å¦‚ InfluxDBã€Prometheusã€OpenTSDB ç­‰ï¼Œå®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”ä»‹ç»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-31-%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%AF%94%E8%BE%83.png" alt="å¸¸è§æ—¶åºæ•°æ®åº“å¯¹æ¯”"></p><p>ç›‘æ§å¯è§†åŒ–å›¾è¡¨çš„å¼€æºç³»ç»Ÿä¸ªäººè§‰å¾—æœ€å¥½çœ‹çš„å°±æ˜¯ Grafanaï¼Œåœ¨ 8.2 èŠ‚ä¸­æ­å»º Flink ç›‘æ§ç³»ç»Ÿçš„æ•°æ®å±•ç¤ºä¹Ÿæ˜¯ç”¨çš„ Grafanaï¼Œå½“ç„¶è¿˜å¯ä»¥åˆ©ç”¨ EChartsã€BizCharts ç­‰æ•°æ®å›¾è¡¨åº“åšäºŒæ¬¡å¼€å‘æ¥é€‚é…å…¬å¸çš„æ•°æ®å±•ç¤ºå›¾è¡¨ã€‚</p><p>ä¸Šé¢è¯´äº†è¿™ä¹ˆå¤šï¼Œè¿™é‡Œç¬”è€…æ ¹æ®è‡ªå·±çš„å·¥ä½œç»éªŒå…ˆè°ˆè°ˆå‡ ç‚¹è‡ªå·±å¯¹ç›‘æ§ç³»ç»Ÿçš„å¿ƒå¾—ï¼š</p><ol><li><strong>å‘Šè­¦æ˜¯ç›‘æ§ç³»ç»Ÿç¬¬ä¸€å…¥å£ï¼Œå›¾è¡¨å±•ç¤ºä½“ç°ç›‘æ§çš„ä»·å€¼</strong>ï¼šå‘Šè­¦æ˜¯å”¯ä¸€å¯ä»¥ç¬¬ä¸€æ—¶é—´åæ˜ è¿è¡ŒçŠ¶æ€ï¼Œå®ƒæ‰¿æ‹…ç€ç³»ç»Ÿä¸äººä¹‹é—´çš„æ²Ÿé€šæ¡¥æ¢ï¼Œé€šå¸¸å‘Šè­¦æ¶ˆæ¯åˆä¼šæºå¸¦é“¾æ¥è·³è½¬åˆ°å›¾è¡¨å±•ç¤ºï¼Œå®ƒä½œä¸ºç¬¬ä¸€å…¥å£å¹¶è¡”æ¥ä¸Šäº†æ•´ä¸ªç›‘æ§ç³»ç»Ÿã€‚</li><li><strong>æ•°æ®é‡‡é›†æ˜¯ç›‘æ§çš„æºæ³‰</strong>ï¼šæ•°æ®é‡‡é›†æ˜¯ç›‘æ§ç³»ç»Ÿçš„æºæ³‰ï¼Œå¦‚æœé‡‡é›†çš„æ•°æ®æ˜¯é”™è¯¯çš„ï¼Œå°†å¯¼è‡´åé¢çš„é“¾è·¯ï¼ˆå‘Šè­¦ã€æ•°æ®å±•ç¤ºï¼‰å…¨å¤„äºæ— æ•ˆçŠ¶æ€ï¼Œæ‰€ä»¥åƒä¸‡åƒä¸‡è¦ä¿è¯æ•°æ®é‡‡é›†çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚</li><li><strong>æ•°æ®å­˜å‚¨æ˜¯ç›‘æ§æœ€å¤§æŒ‘æˆ˜</strong>ï¼šå½“æœºå™¨ã€ç³»ç»Ÿåº”ç”¨å’Œç›‘æ§æŒ‡æ ‡ç­‰å˜å¾—è¶Šå¤šæ¥å¤šæ—¶ï¼Œé‡‡é›†ä¸Šæ¥çš„æ•°æ®æ˜¯çˆ†ç‚¸æ€§å¢é•¿çš„ï¼Œå°†æµ·é‡çš„ç›‘æ§æ•°æ®å®æ—¶å­˜å‚¨åˆ°ä»»ä½•ä¸€ä¸ªæ•°æ®åº“ï¼ŒæŒ‘æˆ˜éƒ½æ˜¯ä¸å°çš„ã€‚</li></ol><p>è¯´å®Œå¿ƒå¾—å†æ¥è®²è§£åˆ°åº•ä¸€ä¸ªç›‘æ§ç³»ç»ŸçœŸæ­£è¯¥åŒ…å«å“ªäº›ä¸œè¥¿å‘¢ï¼Ÿç¬”è€…è§‰å¾—é¦–å…ˆåˆ† 6 å±‚ï¼šæ•°æ®é‡‡é›†å±‚ã€æ•°æ®ä¼ è¾“å±‚ã€æ•°æ®è®¡ç®—å±‚ã€å‘Šè­¦ã€æ•°æ®å­˜å‚¨ã€æ•°æ®å±•ç¤ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-12-11-012408.png" alt="ç›‘æ§ç³»ç»Ÿåˆ†å±‚"></p><p>ç›‘æ§ç³»ç»Ÿè¿™å…­å±‚çš„ä¸»è¦åŠŸèƒ½åˆ†åˆ«æ˜¯ï¼š</p><ul><li>æ•°æ®é‡‡é›†å±‚ï¼šè¯¥å±‚ä¸»è¦åŠŸèƒ½å°±æ˜¯å»é‡‡é›†å„ç§å„æ ·çš„æ•°æ®ï¼Œæ¯”å¦‚ Metricsã€Loggingã€Tracing æ•°æ®ã€‚</li><li>æ•°æ®ä¼ è¾“å±‚ï¼šè¯¥å±‚ä¸»è¦åŠŸèƒ½å°±æ˜¯ä¼ è¾“é‡‡é›†åˆ°çš„ç›‘æ§æ•°æ®ï¼Œä¸€èˆ¬ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å±…å¤šï¼Œæ¯”å¦‚ Kafkaã€RocketMQ ç­‰ã€‚</li><li>æ•°æ®è®¡ç®—å±‚ï¼šè¯¥å±‚çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†é‡‡é›†åˆ°çš„æ•°æ®è¿›è¡Œæ•°æ®æ¸…æ´—å’Œè®¡ç®—ï¼Œä¸€èˆ¬é‡‡ç”¨ Flinkã€Spark ç­‰è®¡ç®—å¼•æ“æ¥å¤„ç†ã€‚</li><li>å‘Šè­¦ï¼šè¯¥å±‚å…¶å®ä¹Ÿå±äºæ•°æ®è®¡ç®—å±‚ï¼Œä½†æ˜¯å› ä¸ºå‘Šè­¦æ¶‰åŠçš„å†…å®¹å¤ªå¤šï¼Œæ¯”å¦‚å‘Šè­¦è§„åˆ™ã€å‘Šè­¦è®¡ç®—ã€å‘Šè­¦é€šçŸ¥ç­‰ï¼Œæ‰€ä»¥å¯ä»¥å•ç‹¬ä½œä¸ºä¸€ä¸ªé‡è¦ç‚¹æ¥è®²ã€‚</li><li>æ•°æ®å­˜å‚¨å±‚ï¼šè¯¥å±‚çš„ä¸»è¦åŠŸèƒ½æ˜¯å­˜å‚¨æ‰€æœ‰çš„ç›‘æ§æ•°æ®ï¼Œä¸ºåé¢çš„æ•°æ®å¯è§†åŒ–æä¾›æ•°æ®æºã€‚</li><li>æ•°æ®å±•ç¤ºå±‚ï¼šè¯¥å±‚çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†ç›‘æ§æ•°æ®é€šè¿‡å¯è§†åŒ–å›¾è¡¨æ¥å±•ç¤ºå‡ºæ¥ï¼Œé€šè¿‡å›¾è¡¨å¯ä»¥çŸ¥é“æœåŠ¡å™¨ã€åº”ç”¨çš„è¿è¡ŒçŠ¶æ€ã€‚</li></ul><h3 id="12-3-3-Metricsï¼Tracingï¼Logging-æ•°æ®å®æ—¶é‡‡é›†"><a href="#12-3-3-Metricsï¼Tracingï¼Logging-æ•°æ®å®æ—¶é‡‡é›†" class="headerlink" title="12.3.3 Metricsï¼Tracingï¼Logging æ•°æ®å®æ—¶é‡‡é›†"></a>12.3.3 Metricsï¼Tracingï¼Logging æ•°æ®å®æ—¶é‡‡é›†</h3><p>åœ¨ 12.1 èŠ‚ä¸­è®²è§£äº†æ—¥å¿—æ•°æ®å¦‚ä½•é‡‡é›†ï¼Œé‚£ä¹ˆå¯¹äº Metrics å’Œ Tracing æ•°æ®è¯¥æ€ä¹ˆé‡‡é›†å‘¢ï¼Ÿ</p><h4 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h4><h4 id="Tracing"><a href="#Tracing" class="headerlink" title="Tracing"></a>Tracing</h4><h3 id="12-3-4-æ¶ˆæ¯é˜Ÿåˆ—å¦‚ä½•æ’‘ä½é«˜å³°æµé‡"><a href="#12-3-4-æ¶ˆæ¯é˜Ÿåˆ—å¦‚ä½•æ’‘ä½é«˜å³°æµé‡" class="headerlink" title="12.3.4 æ¶ˆæ¯é˜Ÿåˆ—å¦‚ä½•æ’‘ä½é«˜å³°æµé‡"></a>12.3.4 æ¶ˆæ¯é˜Ÿåˆ—å¦‚ä½•æ’‘ä½é«˜å³°æµé‡</h3><h4 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h4><h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h4><h4 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h4><h3 id="12-3-5-æŒ‡æ ‡æ•°æ®å®æ—¶è®¡ç®—"><a href="#12-3-5-æŒ‡æ ‡æ•°æ®å®æ—¶è®¡ç®—" class="headerlink" title="12.3.5 æŒ‡æ ‡æ•°æ®å®æ—¶è®¡ç®—"></a>12.3.5 æŒ‡æ ‡æ•°æ®å®æ—¶è®¡ç®—</h3><h3 id="12-3-6-æä¾›åŠæ—¶ä¸”å‡†ç¡®çš„æ ¹å› åˆ†æå‘Šè­¦"><a href="#12-3-6-æä¾›åŠæ—¶ä¸”å‡†ç¡®çš„æ ¹å› åˆ†æå‘Šè­¦" class="headerlink" title="12.3.6 æä¾›åŠæ—¶ä¸”å‡†ç¡®çš„æ ¹å› åˆ†æå‘Šè­¦"></a>12.3.6 æä¾›åŠæ—¶ä¸”å‡†ç¡®çš„æ ¹å› åˆ†æå‘Šè­¦</h3><h4 id="å‘Šè­¦æœ¬è´¨"><a href="#å‘Šè­¦æœ¬è´¨" class="headerlink" title="å‘Šè­¦æœ¬è´¨"></a>å‘Šè­¦æœ¬è´¨</h4><h4 id="å‘Šè­¦é€šçŸ¥å¯¹è±¡"><a href="#å‘Šè­¦é€šçŸ¥å¯¹è±¡" class="headerlink" title="å‘Šè­¦é€šçŸ¥å¯¹è±¡"></a>å‘Šè­¦é€šçŸ¥å¯¹è±¡</h4><h4 id="å‘Šè­¦é€šçŸ¥æ–¹å¼"><a href="#å‘Šè­¦é€šçŸ¥æ–¹å¼" class="headerlink" title="å‘Šè­¦é€šçŸ¥æ–¹å¼"></a>å‘Šè­¦é€šçŸ¥æ–¹å¼</h4><h4 id="å‘Šè­¦è§„åˆ™çš„è®¾è®¡"><a href="#å‘Šè­¦è§„åˆ™çš„è®¾è®¡" class="headerlink" title="å‘Šè­¦è§„åˆ™çš„è®¾è®¡"></a>å‘Šè­¦è§„åˆ™çš„è®¾è®¡</h4><h4 id="æ ¹å› åˆ†æå‘Šè­¦"><a href="#æ ¹å› åˆ†æå‘Šè­¦" class="headerlink" title="æ ¹å› åˆ†æå‘Šè­¦"></a>æ ¹å› åˆ†æå‘Šè­¦</h4><h4 id="å‘Šè­¦äº‹ä»¶è§£è€¦"><a href="#å‘Šè­¦äº‹ä»¶è§£è€¦" class="headerlink" title="å‘Šè­¦äº‹ä»¶è§£è€¦"></a>å‘Šè­¦äº‹ä»¶è§£è€¦</h4><h4 id="å‘Šè­¦å·¥å•è®°å½•å‘Šè­¦è§£å†³è¿‡ç¨‹"><a href="#å‘Šè­¦å·¥å•è®°å½•å‘Šè­¦è§£å†³è¿‡ç¨‹" class="headerlink" title="å‘Šè­¦å·¥å•è®°å½•å‘Šè­¦è§£å†³è¿‡ç¨‹"></a>å‘Šè­¦å·¥å•è®°å½•å‘Šè­¦è§£å†³è¿‡ç¨‹</h4><h3 id="12-3-7-AIOps-æ™ºèƒ½è¿ç»´é“è·¯æ¢ç´¢"><a href="#12-3-7-AIOps-æ™ºèƒ½è¿ç»´é“è·¯æ¢ç´¢" class="headerlink" title="12.3.7 AIOps æ™ºèƒ½è¿ç»´é“è·¯æ¢ç´¢"></a>12.3.7 AIOps æ™ºèƒ½è¿ç»´é“è·¯æ¢ç´¢</h3><h3 id="12-3-8-å¦‚ä½•ä¿éšœé«˜å³°æµé‡å®æ—¶å†™å…¥å­˜å‚¨ç³»ç»Ÿçš„ç¨³å®šæ€§"><a href="#12-3-8-å¦‚ä½•ä¿éšœé«˜å³°æµé‡å®æ—¶å†™å…¥å­˜å‚¨ç³»ç»Ÿçš„ç¨³å®šæ€§" class="headerlink" title="12.3.8 å¦‚ä½•ä¿éšœé«˜å³°æµé‡å®æ—¶å†™å…¥å­˜å‚¨ç³»ç»Ÿçš„ç¨³å®šæ€§"></a>12.3.8 å¦‚ä½•ä¿éšœé«˜å³°æµé‡å®æ—¶å†™å…¥å­˜å‚¨ç³»ç»Ÿçš„ç¨³å®šæ€§</h3><h3 id="12-3-9-ç›‘æ§æ•°æ®ä½¿ç”¨å¯è§†åŒ–å›¾è¡¨å±•ç¤º"><a href="#12-3-9-ç›‘æ§æ•°æ®ä½¿ç”¨å¯è§†åŒ–å›¾è¡¨å±•ç¤º" class="headerlink" title="12.3.9 ç›‘æ§æ•°æ®ä½¿ç”¨å¯è§†åŒ–å›¾è¡¨å±•ç¤º"></a>12.3.9 ç›‘æ§æ•°æ®ä½¿ç”¨å¯è§†åŒ–å›¾è¡¨å±•ç¤º</h3><h4 id="Grafana-ä»‹ç»"><a href="#Grafana-ä»‹ç»" class="headerlink" title="Grafana ä»‹ç»"></a>Grafana ä»‹ç»</h4><h3 id="12-3-10-å°ç»“ä¸åæ€"><a href="#12-3-10-å°ç»“ä¸åæ€" class="headerlink" title="12.3.10 å°ç»“ä¸åæ€"></a>12.3.10 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/IeAYbEy">https://t.zsxq.com/IeAYbEy</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p><h3 id="æœ¬ç« æ€»ç»“"><a href="#æœ¬ç« æ€»ç»“" class="headerlink" title="æœ¬ç« æ€»ç»“"></a>æœ¬ç« æ€»ç»“</h3><p>æœ¬ç« è®²äº†ä¸‰ä¸ªå…¬å¸å¸¸è§åœºæ™¯æ¡ˆä¾‹ï¼šæ—¥å¿—å¤„ç†ã€å»é‡ã€ç›‘æ§å‘Šè­¦ã€‚åœ¨æ—¥å¿—å¤„ç†æ¡ˆä¾‹ä¸­è®²è§£äº†æ—¥å¿—çš„é‡‡é›†çš„éœ€æ±‚ï¼Œä»¥åŠåˆ†æäº†æ•´ä¸ªæ—¥å¿—é‡‡é›†æ¡ˆä¾‹çš„æ¶æ„è®¾è®¡åˆ†å±‚ï¼Œå…³äºæ—¥å¿—é‡‡é›†å·¥å…·çš„é€‰å‹åœ¨ 11.5 èŠ‚ä¸­æœ‰è®²è¿‡ï¼Œæ‰€ä»¥è¯¥æ¡ˆä¾‹ä¸­å°±ç›´æ¥è®²è¿°é‡‡é›†å·¥å…·çš„ä½¿ç”¨å’Œå®‰è£…ï¼Œå¹¶å°†é‡‡é›†åˆ°çš„æ•°æ®å‘é€åˆ° Kafkaï¼Œç„¶åä½¿ç”¨ Flink æ¸…æ´—æ—¥å¿—æ•°æ®å¹¶å°†å¼‚å¸¸æ—¥å¿—å‘Šè­¦é€šçŸ¥åˆ°ç›¸åº”è´Ÿè´£äººï¼Œæ¥ç€å°†æ•°æ®å†™å…¥åˆ° ElasticSearchï¼Œæœ€åé€šè¿‡ Kibana å¯ä»¥å±•ç¤ºå’Œæœç´¢æ—¥å¿—æ•°æ®ã€‚</p><p>åœ¨ç™¾äº¿æ•°æ®å®æ—¶å»é‡æ¡ˆä¾‹ä¸­é€šè¿‡å¯¹æ¯”é€šç”¨è§£å†³æ–¹æ³•ã€ä½¿ç”¨ BloomFilterã€ä½¿ç”¨ HBase å’Œä½¿ç”¨ Flink KeyedState å‡ ç§æ–¹æ¡ˆæ¥åˆ†æå®æ—¶å»é‡çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶åœ¨è¯¥æ¡ˆä¾‹ä¸­è¿˜æåŠåˆ°å¦‚ä½•å»ä¼˜åŒ–å»é‡çš„æ•ˆæœã€‚</p><p>åœ¨å®æ—¶ç›‘æ§å‘Šè­¦æ¡ˆä¾‹ä¸­è®²è¿°äº†å…¬å¸é€šç”¨çš„ç›‘æ§å‘Šè­¦éœ€æ±‚ï¼ŒåŒ…æ‹¬ Metricsã€Loggingã€Tracingï¼Œç„¶åè®¾è®¡å‡ºæ•´ä¸ªç›‘æ§å‘Šè­¦ç³»ç»Ÿçš„æ¶æ„åˆ†å±‚å’ŒæŠ€æœ¯é€‰å‹ï¼Œå…¶ä¸­åˆ†å±‚åŒ…å«æ•°æ®é‡‡é›†å±‚ã€æ•°æ®ä¼ è¾“å±‚ã€æ•°æ®è®¡ç®—å±‚ã€æ•°æ®å­˜å‚¨å±‚ã€æ•°æ®å±•ç¤ºå±‚ã€‚å…³äºæ•°æ®é‡‡é›†å·¥å…·ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ•°æ®å­˜å‚¨ä¸­é—´ä»¶ã€æ•°æ®å±•ç¤ºçš„æŠ€æœ¯é€‰å‹ï¼Œç¬”è€…ä¹Ÿåˆ†åˆ«åšäº†å¯¹æ¯”ä»‹ç»ï¼Œä»¥ä¾¿å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±å…¬å¸çš„æƒ…å†µåšæ¶æ„é€‰å‹ã€‚å¦å¤–é’ˆå¯¹å®æ—¶å‘Šè­¦è¿™å—ï¼Œç¬”è€…ä¹Ÿè¯¦è¿°äº†å¾ˆå¤šï¼ŒåŒ…æ‹¬å‘Šè­¦è§„åˆ™çš„è®¾è®¡ã€å‘Šè­¦é€šçŸ¥å¯¹è±¡ã€å‘Šè­¦é€šçŸ¥æ–¹å¼ã€å‘Šè­¦æ¶ˆæ¯æ”¶æ•›ã€å‘Šè­¦æ¶ˆæ¯æ ¹å› åˆ†æç­‰ï¼Œæœ€åè¿˜è®²äº†å¯¹ç›‘æ§å‘Šè­¦çš„å±•æœ›ï¼Œå¸Œæœ›èƒ½å¤Ÿåœ¨ AIOps åšæ›´å¤šçš„æ¢ç´¢ï¼Œå¯¹äºè¿™å—çš„å†…å®¹ï¼Œç¬”è€…åœ¨ç¤¾åŒºé’‰é’‰ç¾¤åšè¿‡è§†é¢‘ç›´æ’­ï¼Œå¤§å®¶å¯ä»¥å»ç¬”è€…çš„åšå®¢æŸ¥çœ‹å½•æ’­çš„è§†é¢‘ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;12-3-åŸºäº-Flink-çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ&quot;&gt;&lt;a href=&quot;#12-3-åŸºäº-Flink-çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ&quot; class=&quot;headerlink&quot; title=&quot;12.3 åŸºäº Flink çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ&quot;&gt;&lt;/a&gt;12.3 åŸºäº Flink çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ&lt;/h2&gt;&lt;p&gt;åœ¨å¦‚ä»Šå¾®æœåŠ¡ã€äº‘åŸç”Ÿç­‰æŠ€æœ¯ç››è¡Œçš„æ—¶ä»£ï¼Œå½“è°ˆåˆ°è¯´è¦ä» 0 å¼€å§‹æ„å»ºä¸€ä¸ªç›‘æ§ç³»ç»Ÿï¼Œå¤§å®¶æ— éå°±é¦–å…ˆæƒ³åˆ°ä¸‰ä¸ªè¯ï¼šMetricsã€Tracingã€Loggingã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” åŸºäº Flink çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/20/flink-in-action-12.2/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/20/flink-in-action-12.2/</id>
    <published>2021-08-19T16:00:00.000Z</published>
    <updated>2022-02-20T13:10:49.299Z</updated>
    
    <content type="html"><![CDATA[<h2 id="12-2-åŸºäº-Flink-çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ"><a href="#12-2-åŸºäº-Flink-çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ" class="headerlink" title="12.2 åŸºäº Flink çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ"></a>12.2 åŸºäº Flink çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ</h2><p>åœ¨å·¥ä½œä¸­ç»å¸¸ä¼šé‡åˆ°å»é‡çš„åœºæ™¯ï¼Œä¾‹å¦‚åŸºäº APP çš„ç”¨æˆ·è¡Œä¸ºæ—¥å¿—åˆ†æç³»ç»Ÿï¼šç”¨æˆ·çš„è¡Œä¸ºæ—¥å¿—ä»æ‰‹æœº APP ç«¯ä¸ŠæŠ¥åˆ° Nginx æœåŠ¡ç«¯ï¼Œç„¶åé€šè¿‡ Logstashã€Flume æˆ–å…¶ä»–å·¥å…·å°†æ—¥å¿—ä» Nginx å†™å…¥åˆ° Kafka ä¸­ã€‚ç”±äºç”¨æˆ·æ‰‹æœºå®¢æˆ·ç«¯çš„ç½‘ç»œå¯èƒ½å‡ºç°ä¸ç¨³å®šï¼Œæ‰€ä»¥æ‰‹æœº APP ç«¯ä¸Šä¼ æ—¥å¿—çš„ç­–ç•¥æ˜¯ï¼šå®å¯é‡å¤ä¸ŠæŠ¥ï¼Œä¹Ÿä¸èƒ½æ¼æŠ¥æ—¥å¿—ï¼Œæ‰€ä»¥å¯¼è‡´ Kafka ä¸­å¯èƒ½ä¼šå‡ºç°æ—¥å¿—é‡å¤çš„æƒ…å†µï¼Œå³ï¼šåŒä¸€æ¡æ—¥å¿—å‡ºç°äº† 2 æ¡æˆ– 2 æ¡ä»¥ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒFlink ä»»åŠ¡çš„æ•°æ®æºéƒ½æ˜¯ Kafkaï¼Œè‹¥ Kafka ä¸­æ•°æ®å‡ºç°äº†é‡å¤ï¼Œåœ¨å®æ—¶ ETL æˆ–è€…æµè®¡ç®—æ—¶éƒ½éœ€è¦è€ƒè™‘åŸºäºæ—¥å¿—ä¸»é”®å¯¹æ—¥å¿—è¿›è¡Œå»é‡ï¼Œå¦åˆ™ä¼šå¯¼è‡´æµè®¡ç®—ç»“æœåé«˜æˆ–ç»“æœä¸å‡†ç¡®çš„é—®é¢˜ï¼Œä¾‹å¦‚ç”¨æˆ· a åœ¨æŸä¸ªé¡µé¢åªç‚¹å‡»äº†ä¸€æ¬¡ï¼Œä½†ç”±äºæ—¥å¿—é‡å¤ä¸ŠæŠ¥ï¼Œæ‰€ä»¥ç”¨æˆ· a åœ¨è¯¥é¡µé¢çš„ç‚¹å‡»æ—¥å¿—åœ¨ Kafka ä¸­å‡ºç°äº† 2 æ¬¡ï¼Œæœ€åç»Ÿè®¡è¯¥é¡µé¢çš„ç‚¹å‡»æ•°æ—¶ï¼Œç»“æœå°±ä¼šåé«˜ã€‚è¿™é‡Œåªé˜è¿°äº†ä¸€ç§å¯èƒ½é€ æˆ Kafka ä¸­æ•°æ®é‡å¤çš„æƒ…å†µï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¾ˆå¤šæƒ…å†µéƒ½å¯èƒ½é€ æˆ Kafka ä¸­æ•°æ®é‡å¤ï¼Œè¿™é‡Œä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œæœ¬èŠ‚ä¸»è¦è®²è¿°å‡ºç°äº†æ•°æ®é‡å¤åï¼Œè¯¥å¦‚ä½•å¤„ç†ã€‚</p><a id="more"></a><h3 id="12-2-1-å»é‡çš„é€šç”¨è§£å†³æ–¹æ¡ˆ"><a href="#12-2-1-å»é‡çš„é€šç”¨è§£å†³æ–¹æ¡ˆ" class="headerlink" title="12.2.1 å»é‡çš„é€šç”¨è§£å†³æ–¹æ¡ˆ"></a>12.2.1 å»é‡çš„é€šç”¨è§£å†³æ–¹æ¡ˆ</h3><p>Kafka ä¸­æ•°æ®å‡ºç°é‡å¤åï¼Œå„ç§è§£å†³æ–¹æ¡ˆéƒ½æ¯”è¾ƒç±»ä¼¼ï¼Œä¸€èˆ¬éœ€è¦ä¸€ä¸ªå…¨å±€ Set é›†åˆæ¥ç»´æŠ¤å†å²æ‰€æœ‰æ•°æ®çš„ä¸»é”®ã€‚å½“å¤„ç†æ–°æ—¥å¿—æ—¶ï¼Œéœ€è¦æ‹¿åˆ°å½“å‰æ—¥å¿—çš„ä¸»é”®ä¸å†å²æ•°æ®çš„ Set é›†åˆæŒ‰ç…§è§„åˆ™è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ Set é›†åˆä¸­å·²ç»åŒ…å«äº†å½“å‰æ—¥å¿—çš„ä¸»é”®ï¼Œè¯´æ˜å½“å‰æ—¥å¿—åœ¨ä¹‹å‰å·²ç»è¢«å¤„ç†è¿‡äº†ï¼Œåˆ™å½“å‰æ—¥å¿—åº”è¯¥è¢«è¿‡æ»¤æ‰ï¼Œå¦åˆ™è®¤ä¸ºå½“å‰æ—¥å¿—ä¸åº”è¯¥è¢«è¿‡æ»¤åº”è¯¥è¢«å¤„ç†ï¼Œè€Œä¸”å¤„ç†å®Œæˆåéœ€è¦å°†æ–°æ—¥å¿—çš„ä¸»é”®åŠ å…¥åˆ° Set é›†åˆä¸­ï¼ŒSet é›†åˆæ°¸è¿œå­˜æ”¾ç€æ‰€æœ‰å·²ç»è¢«å¤„ç†è¿‡çš„æ•°æ®ã€‚è¿™ç§å»é‡çš„é€šç”¨è§£å†³æ–¹æ¡ˆçš„æµç¨‹å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-12-11-151455.png" alt="å»é‡çš„é€šç”¨è§£å†³æ–¹æ¡ˆçš„æµç¨‹å›¾"></p><p>å¤„ç†æµç¨‹å¾ˆç®€å•ï¼Œå…³é”®åœ¨äºå¦‚ä½•ç»´æŠ¤è¿™ä¸ª Set é›†åˆï¼Œå¯ä»¥ç®€å•ä¼°ç®—ä¸€ä¸‹è¿™ä¸ª Set é›†åˆéœ€è¦å ç”¨å¤šå¤§ç©ºé—´ã€‚æœ¬å°èŠ‚è¦è§£å†³çš„é—®é¢˜æ˜¯ç™¾äº¿æ•°æ®å»é‡ï¼Œæ‰€ä»¥å°±æŒ‰ç…§æ¯å¤© 1 ç™¾äº¿çš„æ•°æ®é‡æ¥è®¡ç®—ã€‚ç”±äºæ¯å¤©æ•°æ®é‡å·¨å¤§ï¼Œå› æ­¤ä¸»é”®å ç”¨ç©ºé—´é€šå¸¸ä¼šæ¯”è¾ƒå¤§ï¼Œå¦‚æœä¸»é”®å ç”¨ç©ºé—´å°æ„å‘³ç€è¡¨ç¤ºçš„æ•°æ®èŒƒå›´å°±æ¯”è¾ƒå°ï¼Œå°±å¯èƒ½å¯¼è‡´ä¸»é”®å†²çªï¼Œä¾‹å¦‚ï¼š4 ä¸ªå­—èŠ‚çš„ int ç±»å‹è¡¨ç¤ºæ•°æ®èŒƒå›´æ˜¯ä¸º -2147483648 ~ 2147483647ï¼Œæ€»å…±å¯ä»¥è¡¨ç¤º 42 äº¿ä¸ªæ•°ï¼Œå¦‚æœè¿™é‡Œæ¯å¤©ç™¾äº¿çš„æ•°æ®é‡é€‰ç”¨ int ç±»å‹åšä¸ºä¸»é”®çš„è¯ï¼Œå¾ˆæ˜æ˜¾ä¼šæœ‰å¤§é‡çš„ä¸»é”®å‘ç”Ÿå†²çªï¼Œä¼šå°†ä¸é‡å¤çš„æ•°æ®è®¤ä¸ºæ˜¯å‘ç”Ÿäº†é‡å¤ã€‚ç”¨æˆ·çš„è¡Œä¸ºæ—¥å¿—æ˜¯åœ¨æ‰‹æœºå®¢æˆ·ç«¯ç”Ÿæˆçš„ï¼Œæ²¡æœ‰å…¨å±€å‘å·å™¨ï¼Œä¸€èˆ¬ä¼šé€‰å– UUID åšä¸ºæ—¥å¿—çš„ä¸»é”®ï¼ŒUUID ä¼šç”Ÿæˆ 36 ä½çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼šâ€f106c4a1-4c6f-41c1-9d30-bbb2b271284aâ€ã€‚æ¯ä¸ªä¸»é”®å ç”¨ 36 å­—èŠ‚ï¼Œæ¯å¤© 1 ç™¾äº¿æ•°æ®ï¼Œ36å­—èŠ‚ <em> 100äº¿ â‰ˆ 360 GBã€‚è¿™ä»…ä»…æ˜¯ä¸€å¤©çš„æ•°æ®é‡ï¼Œæ‰€ä»¥è¯¥ Set é›†åˆè¦æƒ³å­˜å‚¨ç©ºé—´ä¸å‘ç”ŸæŒç»­åœ°çˆ†ç‚¸å¼å¢é•¿ï¼Œå¿…é¡»å¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯ç»™æ‰€æœ‰çš„ä¸»é”®å¢åŠ  TTLï¼ˆè¿‡æœŸæ—¶é—´ï¼‰ã€‚å¦‚æœä¸å¢åŠ  TTLï¼Œ10 å¤©æ•°æ®é‡çš„ä¸»é”®å ç”¨ç©ºé—´å°± 3.6Tï¼Œ100 å¤©æ•°æ®é‡çš„ä¸»é”®å ç”¨ç©ºé—´ 36Tï¼Œæ‰€ä»¥åœ¨è®¾è®¡ä¹‹åˆå¿…é¡»è€ƒè™‘ä¸ºä¸»é”®è®¾å®š TTLã€‚å¦‚æœè¦æ±‚æŒ‰å¤©è¿›è¡Œå»é‡æˆ–è€…è®¤ä¸ºæ—¥å¿—å‘ç”Ÿé‡å¤ä¸ŠæŠ¥çš„æ—¶é—´é—´éš”ä¸å¯èƒ½å¤§äº 24 å°æ—¶ï¼Œé‚£ä¹ˆä¸ºäº†ç³»ç»Ÿçš„å¯é æ€§ TTL å¯ä»¥è®¾ç½®ä¸º 36 å°æ—¶ã€‚æ¯å¤©æ•°æ®é‡ 1 ç™¾äº¿ï¼Œä¸” Set é›†åˆä¸­å­˜æ”¾ç€ 36 å°æ—¶çš„æ•°æ®é‡ï¼Œå³ 100 äº¿ </em> 1.5 = 150 äº¿ï¼Œæ‰€ä»¥ Set é›†åˆä¸­éœ€è¦ç»´æŠ¤ 150 äº¿çš„æ•°æ®é‡ï¼Œä¸” Set é›†åˆä¸­æ¯æ¡æ•°æ®éƒ½å¢åŠ äº† TTLï¼Œæ„å‘³ç€ Set é›†åˆéœ€è¦ä¸ºæ¯æ¡æ•°æ®å†é™„å¸¦ä¿å­˜ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæ¥ç¡®å®šè¯¥æ•°æ®ä»€ä¹ˆæ—¶å€™è¿‡æœŸã€‚ä¾‹å¦‚ Redis ä¸­ä¸ºä¸€ä¸ª key è®¾ç½®äº† TTLï¼Œå¦‚æœæ²¡æœ‰ä¸ºè¿™ä¸ª key é™„å¸¦æ—¶é—´æˆ³ï¼Œé‚£ä¹ˆæ ¹æœ¬æ— æ³•åˆ¤æ–­è¯¥ key ä»€ä¹ˆæ—¶å€™åº”è¯¥è¢«æ¸…ç†ã€‚æ‰€ä»¥åœ¨è€ƒè™‘æ¯æ¡æ•°æ®å ç”¨ç©ºé—´æ—¶ï¼Œä¸ä»…è¦è€ƒè™‘æ•°æ®æœ¬èº«ï¼Œè¿˜éœ€è¦è€ƒè™‘æ˜¯å¦éœ€è¦å…¶ä»–é™„å¸¦çš„å­˜å‚¨ã€‚ä¸»é”®æœ¬èº«å ç”¨ 36 å­—èŠ‚åŠ ä¸Š long ç±»å‹çš„æ—¶é—´æˆ³ 8 å­—èŠ‚ï¼Œæ‰€ä»¥æ¯æ¡æ•°æ®è‡³å°‘éœ€è¦å ç”¨ 44 å­—èŠ‚ï¼Œ150 äº¿ * 44 å­—èŠ‚ = 660 GBã€‚æ‰€ä»¥æ¯å¤©ç™¾äº¿çš„æ•°æ®é‡ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Set é›†åˆçš„æ–¹æ¡ˆæ¥å®ç°ï¼Œè‡³å°‘éœ€è¦å ç”¨ 660 GB ä»¥ä¸Šçš„å­˜å‚¨ç©ºé—´ã€‚</p><h3 id="12-2-2-ä½¿ç”¨-BloomFilter-å®ç°å»é‡"><a href="#12-2-2-ä½¿ç”¨-BloomFilter-å®ç°å»é‡" class="headerlink" title="12.2.2 ä½¿ç”¨ BloomFilter å®ç°å»é‡"></a>12.2.2 ä½¿ç”¨ BloomFilter å®ç°å»é‡</h3><p>æœ‰äº›æµè®¡ç®—çš„åœºæ™¯å¯¹å‡†ç¡®æ€§è¦æ±‚å¹¶ä¸æ˜¯å¾ˆé«˜ï¼Œä¾‹å¦‚ä¼ ç»Ÿçš„ Lambda æ¶æ„ä¸­ï¼Œéƒ½ä¼šæœ‰ç¦»çº¿å»çŸ«æ­£å®æ—¶è®¡ç®—çš„ç»“æœï¼Œæ‰€ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œå½“ä¸šåŠ¡è¦æ±‚å¯ä»¥æ¥å—ç»“æœæœ‰å°é‡è¯¯å·®æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ä¸€äº›ä½æˆæœ¬çš„æ•°æ®ç»“æ„ã€‚BloomFilter å’Œ HyperLogLog éƒ½æ˜¯ç›¸å¯¹ä½æˆæœ¬çš„æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«æœ‰è‡ªå·±çš„åº”ç”¨åœºæ™¯ï¼Œä¸”ä¸¤ç§æ•°æ®ç»“æ„éƒ½æœ‰ä¸€å®šè¯¯å·®ã€‚HyperLogLog å¯ä»¥ä¼°ç®—å‡º HyperLogLog ä¸­æ’å…¥äº†å¤šå°‘ä¸ªä¸é‡å¤çš„å…ƒç´ ï¼Œè€Œä¸èƒ½å‘Šè¯‰æˆ‘ä»¬ä¹‹å‰æ˜¯å¦æ’å…¥äº†å“ªäº›å…ƒç´ ã€‚BloomFilter åˆ™æ°å¥½ç›¸åï¼Œç›¸å¯¹è€Œè¨€ BloomFilter æ›´åƒæ˜¯ä¸€ä¸ª Set é›†åˆï¼ŒBloomFilter å¯ä»¥å‘Šè¯‰ä½  BloomFilter ä¸­<strong>è‚¯å®šä¸åŒ…å«</strong>å…ƒç´  aï¼Œæˆ–è€…å‘Šè¯‰ä½  BloomFilter ä¸­<strong>å¯èƒ½åŒ…å«</strong>å…ƒç´  bï¼Œä½† BloomFilter ä¸èƒ½å‘Šè¯‰ä½  BloomFilter ä¸­æ’å…¥äº†å¤šå°‘ä¸ªå…ƒç´ ã€‚æ¥ä¸‹æ¥äº†è§£ä¸€ä¸‹ BloomFilter çš„å®ç°åŸç†ã€‚</p><h4 id="bitmap-ä½å›¾"><a href="#bitmap-ä½å›¾" class="headerlink" title="bitmap ä½å›¾"></a>bitmap ä½å›¾</h4><p>äº†è§£ BloomFilterï¼Œä» bitmapï¼ˆä½å›¾ï¼‰å¼€å§‹è¯´èµ·ã€‚ç°åœ¨æœ‰ 1 åƒä¸‡ä¸ªæ•´æ•°ï¼Œæ•°æ®èŒƒå›´åœ¨ 0 åˆ° 2 åƒä¸‡ä¹‹é—´ã€‚å¦‚ä½•å¿«é€ŸæŸ¥æ‰¾æŸä¸ªæ•´æ•°æ˜¯å¦åœ¨è¿™ 1 åƒä¸‡ä¸ªæ•´æ•°ä¸­å‘¢ï¼Ÿå¯ä»¥å°†è¿™ 1 åƒä¸‡ä¸ªæ•°ä¿å­˜åœ¨ HashMap ä¸­ï¼Œä¸è€ƒè™‘å¯¹è±¡å¤´åŠå…¶ä»–ç©ºé—´ï¼Œ1000 ä¸‡ä¸ª int ç±»å‹æ•°æ®éœ€è¦å ç”¨å¤§çº¦ 1000ä¸‡ * 4 å­—èŠ‚ â‰ˆ 40 MB å­˜å‚¨ç©ºé—´ã€‚æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ¡ˆå‘¢ï¼Ÿå› ä¸ºæ•°æ®èŒƒå›´æ˜¯ 0 åˆ° 2 åƒä¸‡ï¼Œæ‰€ä»¥å¯ä»¥ç”³è¯·ä¸€ä¸ªé•¿åº¦ä¸º 2000 ä¸‡ã€boolean ç±»å‹çš„æ•°ç»„ï¼Œå°†è¿™ 2 åƒä¸‡ä¸ªæ•´æ•°ä½œä¸ºæ•°ç»„ä¸‹æ ‡ï¼Œå°†å…¶å¯¹åº”çš„æ•°ç»„é»˜è®¤å€¼è®¾ç½®æˆ falseï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•°ç»„ä¸‹æ ‡ä¸º 2ã€666ã€999 çš„ä½ç½®å­˜å‚¨çš„æ•°æ®ä¸º trueï¼Œè¡¨ç¤º 1 åƒä¸‡ä¸ªæ•°ä¸­åŒ…å«äº† 2ã€666ã€999 ç­‰ã€‚å½“æŸ¥è¯¢æŸä¸ªæ•´æ•° K æ˜¯å¦åœ¨è¿™ 1 åƒä¸‡ä¸ªæ•´æ•°ä¸­æ—¶ï¼Œåªéœ€è¦å°†å¯¹åº”çš„æ•°ç»„å€¼ <code>array[K]</code> å–å‡ºæ¥ï¼Œçœ‹æ˜¯å¦ç­‰äº trueã€‚å¦‚æœç­‰äº trueï¼Œè¯´æ˜ 1 åƒä¸‡æ•´æ•°ä¸­åŒ…å«è¿™ä¸ªæ•´æ•° Kï¼Œå¦åˆ™è¡¨ç¤ºä¸åŒ…å«è¿™ä¸ªæ•´æ•° Kã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-11-03-103907.jpg" alt=""></p><p>Java çš„ boolean åŸºæœ¬ç±»å‹å ç”¨ä¸€ä¸ªå­—èŠ‚ï¼ˆ8bitï¼‰çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥ä¸Šè¿°æ–¹æ¡ˆéœ€è¦ç”³è¯· 2000 ä¸‡å­—èŠ‚ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥é€šè¿‡ç¼–ç¨‹è¯­è¨€ç”¨äºŒè¿›åˆ¶ä½æ¥æ¨¡æ‹Ÿå¸ƒå°”ç±»å‹ï¼ŒäºŒè¿›åˆ¶çš„ 1 è¡¨ç¤ºtrueã€äºŒè¿›åˆ¶çš„ 0 è¡¨ç¤ºfalseã€‚é€šè¿‡äºŒè¿›åˆ¶æ¨¡æ‹Ÿå¸ƒå°”ç±»å‹çš„æ–¹æ¡ˆï¼Œåªéœ€è¦ç”³è¯· 2000 ä¸‡ bit å³å¯ï¼Œç›¸æ¯” boolean ç±»å‹è€Œè¨€ï¼Œå­˜å‚¨ç©ºé—´å ç”¨ä»…ä¸ºåŸæ¥çš„ 1/8ã€‚2000 ä¸‡ bit â‰ˆ 2.4 MBï¼Œç›¸æ¯”å­˜å‚¨åŸå§‹æ•°æ®çš„æ–¹æ¡ˆ 40 MB è€Œè¨€ï¼Œå ç”¨çš„å­˜å‚¨ç©ºé—´å°‘äº†å¾ˆå¤šã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-11-03-103905.jpg" alt=""></p><p>å‡å¦‚è¿™ 1 åƒä¸‡ä¸ªæ•´æ•°çš„æ•°æ®èŒƒå›´æ˜¯ 0 åˆ° 100 äº¿ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”³è¯· 100 äº¿ä¸ª bit çº¦ç­‰äº 1200 MBï¼Œæ¯”å­˜å‚¨åŸå§‹æ•°æ®æ–¹æ¡ˆçš„ 40MB è¿˜è¦å¤§å¾ˆå¤šã€‚è¯¥æƒ…å†µä¸‹ï¼Œç›´æ¥ä½¿ç”¨ä½å›¾ä½¿ç”¨çš„å­˜å‚¨ç©ºé—´æ›´å¤šäº†ï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Ÿå¯ä»¥åªç”³è¯· 1 äº¿ bit çš„å­˜å‚¨ç©ºé—´ï¼Œå¯¹ 1000 ä¸‡ä¸ªæ•°æ±‚hashï¼Œæ˜ å°„åˆ° 1 äº¿çš„äºŒè¿›åˆ¶ä½ä¸Šï¼Œæœ€åå¤§çº¦å ç”¨ 12 MB çš„å­˜å‚¨ç©ºé—´ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨ hash å†²çªçš„æƒ…å†µã€‚ä¾‹å¦‚ 3 å’Œ 100000003ï¼ˆä¸€äº¿é›¶ä¸‰ï¼‰è¿™ä¸¤ä¸ªæ•°å¯¹ä¸€äº¿æ±‚ä½™éƒ½ä¸º 3ï¼Œæ‰€ä»¥æ˜ å°„åˆ°é•¿åº¦ä¸º 1 äº¿çš„ä½å›¾ä¸Šï¼Œè¿™ä¸¤ä¸ªæ•°ä¼šå ç”¨åŒä¸€ä¸ª bitï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼š1 åƒä¸‡ä¸ªæ•´æ•°ä¸­åŒ…å«äº†ä¸€äº¿é›¶ä¸‰ï¼Œæ‰€ä»¥ä½å›¾ä¸­ä¸‹æ ‡ä¸º 3 çš„ä½ç½®å­˜å‚¨ç€äºŒè¿›åˆ¶ 1ã€‚å½“æŸ¥è¯¢ 1 åƒä¸‡ä¸ªæ•´æ•°ä¸­æ˜¯å¦åŒ…å«æ•°å­— 3 æ—¶ï¼ŒåŒæ ·ä¹Ÿæ˜¯å»ä½å›¾ä¸­ä¸‹æ ‡ 3 çš„ä½ç½®å»æŸ¥æ‰¾ï¼Œå‘ç°ä¸‹æ ‡ä¸º 3 çš„ä½ç½®å­˜å‚¨ç€äºŒè¿›åˆ¶ 1ï¼Œæ‰€ä»¥è¯¯ä»¥ä¸º 1 åƒä¸‡ä¸ªæ•´æ•°ä¸­åŒ…å«æ•°å­— 3ã€‚ä¸ºäº†å‡å°‘ hash å†²çªï¼Œäºæ˜¯è¯ç”Ÿäº† BloomFilterã€‚</p><h4 id="BloomFilter-åŸç†ä»‹ç»"><a href="#BloomFilter-åŸç†ä»‹ç»" class="headerlink" title="BloomFilter åŸç†ä»‹ç»"></a>BloomFilter åŸç†ä»‹ç»</h4><p>hash å­˜åœ¨ hash å†²çªï¼ˆç¢°æ’ï¼‰çš„é—®é¢˜ï¼Œä¸¤ä¸ªä¸åŒçš„ key é€šè¿‡åŒä¸€ä¸ª hash å‡½æ•°å¾—åˆ°çš„å€¼æœ‰å¯èƒ½ç›¸åŒã€‚ä¸ºäº†å‡å°‘å†²çªï¼Œå¯ä»¥å¼•å…¥å¤šä¸ª hash å‡½æ•°ï¼Œå¦‚æœé€šè¿‡å…¶ä¸­çš„ä¸€ä¸ª hash å‡½æ•°å‘ç°æŸå…ƒç´ ä¸åœ¨é›†åˆä¸­ï¼Œé‚£ä¹ˆè¯¥å…ƒç´ è‚¯å®šä¸åœ¨é›†åˆä¸­ã€‚å½“æ‰€æœ‰çš„ hash å‡½æ•°å‘Šè¯‰æˆ‘ä»¬è¯¥å…ƒç´ åœ¨é›†åˆä¸­æ—¶ï¼Œæ‰èƒ½ç¡®å®šè¯¥å…ƒç´ å­˜åœ¨äºé›†åˆä¸­ï¼Œè¿™ä¾¿æ˜¯BloomFilterçš„åŸºæœ¬æ€æƒ³ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯å¾€ BloomFilter ä¸­æ’å…¥å…ƒç´  aã€b çš„è¿‡ç¨‹ï¼Œæœ‰ 3 ä¸ª hash å‡½æ•°ï¼Œå…ƒç´  a ç»è¿‡ 3 ä¸ª hash å‡½æ•°åå¯¹åº”çš„ 2ã€8ã€10 è¿™ä¸‰ä¸ªäºŒè¿›åˆ¶ä½ï¼Œæ‰€ä»¥å°†è¿™ä¸‰ä¸ªäºŒè¿›åˆ¶ä½ç½®ä¸º 1ï¼Œå…ƒç´  b  ç»è¿‡ 3 ä¸ª hash å‡½æ•°åï¼Œå¯¹åº”çš„ 5ã€10ã€14 è¿™ä¸‰ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå°†è¿™ä¸‰ä¸ªäºŒè¿›åˆ¶ä½ä¹Ÿç½®ä¸º 1ï¼Œå…¶ä¸­ä¸‹æ ‡ä¸º 10 çš„äºŒè¿›åˆ¶ä½è¢« aã€b å…ƒç´ éƒ½æ¶‰åŠåˆ°ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-11-03-103858.jpg" style="zoom:20%;" /></p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯ä» BloomFilter ä¸­æŸ¥æ‰¾å…ƒç´  cã€d çš„è¿‡ç¨‹ï¼ŒåŒæ ·åŒ…å«äº† 3 ä¸ª hash å‡½æ•°ï¼Œå…ƒç´  c ç»è¿‡ 3 ä¸ª hash å‡½æ•°åå¯¹åº”çš„ 2ã€6ã€9 è¿™ä¸‰ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå…¶ä¸­ä¸‹æ ‡ 6 å’Œ 9 å¯¹åº”çš„äºŒè¿›åˆ¶ä½ä¸º 0ï¼Œæ‰€ä»¥ä¼šè®¤ä¸º BloomFilter ä¸­ä¸å­˜åœ¨å…ƒç´  cã€‚å…ƒç´  d ç»è¿‡ 3 ä¸ª hash å‡½æ•°åå¯¹åº”çš„ 5ã€8ã€14 è¿™ä¸‰ä¸ªäºŒè¿›åˆ¶ä½ï¼Œè¿™ä¸‰ä¸ªä½å¯¹åº”çš„äºŒè¿›åˆ¶ä½éƒ½ä¸º 1ï¼Œæ‰€ä»¥ä¼šè®¤ä¸º BloomFilter ä¸­å­˜åœ¨å…ƒç´  dï¼Œä½†å…¶å® BloomFilter ä¸­å¹¶ä¸å­˜åœ¨å…ƒç´  dï¼Œæ˜¯å› ä¸ºå…ƒç´  a å’Œå…ƒç´  b ä¹Ÿå¯¹åº”åˆ°äº† 5ã€8ã€14 è¿™ä¸‰ä¸ªäºŒè¿›åˆ¶ä½ä¸Šï¼Œæ‰€ä»¥ BloomFilter ä¼šæœ‰è¯¯åˆ¤ã€‚ä½†æ˜¯ä»å®ç°åŸç†æ¥çœ‹ï¼Œå½“ BloomFilter å‘Šè¯‰ä½ ä¸åŒ…å«å…ƒç´  c æ—¶ï¼ŒBloomFilter ä¸­<strong>è‚¯å®šä¸åŒ…å«</strong>å…ƒç´  cï¼Œå½“ BloomFilter å‘Šè¯‰ä½  BloomFilter ä¸­åŒ…å«å…ƒç´  d æ—¶ï¼Œå®ƒåªæ˜¯<strong>å¯èƒ½åŒ…å«</strong>ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸åŒ…å«ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-11-03-103906.jpg" style="zoom:20%;" /></p><h4 id="ä½¿ç”¨-BloomFilter-å®ç°æ•°æ®å»é‡"><a href="#ä½¿ç”¨-BloomFilter-å®ç°æ•°æ®å»é‡" class="headerlink" title="ä½¿ç”¨ BloomFilter å®ç°æ•°æ®å»é‡"></a>ä½¿ç”¨ BloomFilter å®ç°æ•°æ®å»é‡</h4><p>Redis 4.0 ä¹‹å BloomFilter ä»¥æ’ä»¶çš„å½¢å¼åŠ å…¥åˆ° Redis ä¸­ï¼Œå…³äº api çš„å…·ä½“ä½¿ç”¨è¿™é‡Œä¸å¤šèµ˜è¿°ã€‚BloomFilter åœ¨åˆ›å»ºæ—¶æ”¯æŒè®¾å®šä¸€ä¸ªé¢„æœŸå®¹é‡å’Œè¯¯åˆ¤ç‡ï¼Œé¢„æœŸå®¹é‡å³é¢„è®¡æ’å…¥çš„æ•°æ®é‡ï¼Œè¯¯åˆ¤ç‡å³ï¼šå½“ BloomFilter ä¸­æ’å…¥çš„æ•°æ®è¾¾åˆ°é¢„æœŸå®¹é‡æ—¶ï¼Œè¯¯åˆ¤çš„æ¦‚ç‡ï¼Œå¦‚æœ BloomFilter ä¸­æ’å…¥æ•°æ®è¾ƒå°‘çš„è¯ï¼Œè¯¯åˆ¤ç‡ä¼šæ›´ä½ã€‚</p><p>ç»ç¬”è€…æµ‹è¯•ï¼Œç”³è¯·ä¸€ä¸ªé¢„æœŸå®¹é‡ä¸º 10 äº¿ï¼Œè¯¯åˆ¤ç‡ä¸ºåƒåˆ†ä¹‹ä¸€çš„ BloomFilterï¼ŒBloomFilter ä¼šç”³è¯·çº¦ 143 äº¿ä¸ª bitï¼Œå³ï¼š14Gå·¦å³ï¼Œç›¸æ¯”ä¹‹å‰ 660G çš„å­˜å‚¨ç©ºé—´å°å¤ªå¤šäº†ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è®°å½• BloomFilter ä¸­æ’å…¥å…ƒç´ çš„ä¸ªæ•°ï¼Œå½“æ’å…¥å…ƒç´ ä¸ªæ•°è¾¾åˆ° 10 äº¿æ—¶ï¼Œä¸ºäº†ä¿éšœè¯¯å·®ç‡ï¼Œå¯ä»¥å°†å½“å‰ BloomFilter æ¸…é™¤ï¼Œé‡æ–°ç”³è¯·ä¸€ä¸ªæ–°çš„ BloomFilterã€‚</p><p>é€šè¿‡ä½¿ç”¨ Redis çš„ BloomFilterï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç›¸å¯¹è¾ƒå°çš„å†…å­˜å®ç°ç™¾äº¿æ•°æ®çš„å»é‡ï¼Œä½†æ˜¯ BloomFilter æœ‰è¯¯å·®ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨åœ¨é‚£äº›å¯¹ç»“æœèƒ½æ‰¿å—ä¸€å®šè¯¯å·®çš„åº”ç”¨åœºæ™¯ï¼Œå¯¹äºå¹¿å‘Šè®¡è´¹ç­‰å¯¹æ•°æ®ç²¾åº¦è¦æ±‚éå¸¸é«˜çš„åœºæ™¯ï¼ŒæåŠ›æ¨èå¤§å®¶ä½¿ç”¨ç²¾å‡†å»é‡çš„æ–¹æ¡ˆæ¥å®ç°ã€‚</p><h3 id="12-2-3-ä½¿ç”¨-HBase-ç»´æŠ¤å…¨å±€-Set-å®ç°å»é‡"><a href="#12-2-3-ä½¿ç”¨-HBase-ç»´æŠ¤å…¨å±€-Set-å®ç°å»é‡" class="headerlink" title="12.2.3 ä½¿ç”¨ HBase ç»´æŠ¤å…¨å±€ Set å®ç°å»é‡"></a>12.2.3 ä½¿ç”¨ HBase ç»´æŠ¤å…¨å±€ Set å®ç°å»é‡</h3><p>é€šè¿‡ä¹‹å‰åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“è¦æƒ³å®ç°ç™¾äº¿æ•°æ®é‡çš„ç²¾å‡†å»é‡ï¼Œéœ€è¦ç»´æŠ¤ 150 äº¿æ•°æ®é‡çš„ Set é›†åˆï¼Œæ¯æ¡æ•°æ®å ç”¨ 44 KBï¼Œæ€»å…±éœ€è¦ 660 GB çš„å­˜å‚¨ç©ºé—´ã€‚æ³¨æ„è¿™é‡Œè¯´çš„æ˜¯å­˜å‚¨ç©ºé—´è€Œä¸æ˜¯å†…å­˜ç©ºé—´ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º 660 G çš„å†…å­˜å®åœ¨æ˜¯å¤ªè´µäº†ï¼Œ660G çš„ Redis äº‘æœåŠ¡ä¸€ä¸ªæœˆè‡³å°‘è¦ 2 ä¸‡ RMB ä»¥ä¸Šï¼Œä¿—è¯è¯´è®¾è®¡æ¶æ„ä¸è€ƒè™‘æˆæœ¬ç­‰äºè€æµæ°“ã€‚è¿™é‡Œä½¿ç”¨ Redis ç¡®å®å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯æˆæœ¬è¾ƒé«˜ã€‚HBase åŸºäº RowKey Get çš„æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥è€ƒè™‘å°†è¿™ä¸ªå¤§çš„ Set é›†åˆä»¥ HBase RowKey çš„å½¢å¼å­˜æ”¾åˆ° HBase ä¸­ã€‚HBase è¡¨è®¾ç½® TTL ä¸º 36 å°æ—¶ï¼Œæœ€è¿‘ 36 å°æ—¶çš„ 150 äº¿æ¡æ—¥å¿—çš„ä¸»é”®éƒ½å­˜æ”¾åˆ° HBase ä¸­ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®ï¼Œå…ˆæ‹¿åˆ°ä¸»é”®å» HBase ä¸­æŸ¥è¯¢ï¼Œå¦‚æœ HBase è¡¨ä¸­å­˜åœ¨è¯¥ä¸»é”®ï¼Œè¯´æ˜å½“å‰æ—¥å¿—å·²ç»è¢«å¤„ç†è¿‡äº†ï¼Œå½“å‰æ—¥å¿—åº”è¯¥è¢«è¿‡æ»¤ã€‚å¦‚æœ HBase è¡¨ä¸­ä¸å­˜åœ¨è¯¥ä¸»é”®ï¼Œè¯´æ˜å½“å‰æ—¥å¿—ä¹‹å‰æ²¡æœ‰è¢«å¤„ç†è¿‡ï¼Œæ­¤æ—¶åº”è¯¥è¢«å¤„ç†ï¼Œä¸”å¤„ç†å®Œæˆåå°†å½“å‰ä¸»é”® Put åˆ° HBase è¡¨ä¸­ã€‚ç”±äºæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä¸€å®šè¦æå‰å¯¹ HBase è¡¨è¿›è¡Œé¢„åˆ†åŒºï¼Œå°†å‹åŠ›åˆ†æ•£åˆ°å„ä¸ª RegionServer ä¸Šã€‚</p><h4 id="ä½¿ç”¨-HBase-RowKey-å»é‡å¸¦æ¥çš„é—®é¢˜"><a href="#ä½¿ç”¨-HBase-RowKey-å»é‡å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="ä½¿ç”¨ HBase RowKey å»é‡å¸¦æ¥çš„é—®é¢˜"></a>ä½¿ç”¨ HBase RowKey å»é‡å¸¦æ¥çš„é—®é¢˜</h4><h3 id="12-2-4-ä½¿ç”¨-Flink-çš„-KeyedState-å®ç°å»é‡"><a href="#12-2-4-ä½¿ç”¨-Flink-çš„-KeyedState-å®ç°å»é‡" class="headerlink" title="12.2.4 ä½¿ç”¨ Flink çš„ KeyedState å®ç°å»é‡"></a>12.2.4 ä½¿ç”¨ Flink çš„ KeyedState å®ç°å»é‡</h3><p>ä¸‹é¢å°±æ•™å¤§å®¶å¦‚ä½•ä½¿ç”¨ Flink çš„ KeyedState å®ç°å»é‡ã€‚</p><h4 id="ä½¿ç”¨-Flink-çŠ¶æ€æ¥ç»´æŠ¤-Set-é›†åˆçš„ä¼˜åŠ¿"><a href="#ä½¿ç”¨-Flink-çŠ¶æ€æ¥ç»´æŠ¤-Set-é›†åˆçš„ä¼˜åŠ¿" class="headerlink" title="ä½¿ç”¨ Flink çŠ¶æ€æ¥ç»´æŠ¤ Set é›†åˆçš„ä¼˜åŠ¿"></a>ä½¿ç”¨ Flink çŠ¶æ€æ¥ç»´æŠ¤ Set é›†åˆçš„ä¼˜åŠ¿</h4><h4 id="å¦‚ä½•ä½¿ç”¨-KeyedState-ç»´æŠ¤-Set-é›†åˆ"><a href="#å¦‚ä½•ä½¿ç”¨-KeyedState-ç»´æŠ¤-Set-é›†åˆ" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ KeyedState ç»´æŠ¤ Set é›†åˆ"></a>å¦‚ä½•ä½¿ç”¨ KeyedState ç»´æŠ¤ Set é›†åˆ</h4><h4 id="ä¼˜åŒ–ä¸»é”®æ¥å‡å°‘çŠ¶æ€å¤§å°ï¼Œä¸”æé«˜ååé‡"><a href="#ä¼˜åŒ–ä¸»é”®æ¥å‡å°‘çŠ¶æ€å¤§å°ï¼Œä¸”æé«˜ååé‡" class="headerlink" title="ä¼˜åŒ–ä¸»é”®æ¥å‡å°‘çŠ¶æ€å¤§å°ï¼Œä¸”æé«˜ååé‡"></a>ä¼˜åŒ–ä¸»é”®æ¥å‡å°‘çŠ¶æ€å¤§å°ï¼Œä¸”æé«˜ååé‡</h4><h3 id="12-2-5-ä½¿ç”¨-RocksDBStateBackend-çš„ä¼˜åŒ–æ–¹æ³•"><a href="#12-2-5-ä½¿ç”¨-RocksDBStateBackend-çš„ä¼˜åŒ–æ–¹æ³•" class="headerlink" title="12.2.5 ä½¿ç”¨ RocksDBStateBackend çš„ä¼˜åŒ–æ–¹æ³•"></a>12.2.5 ä½¿ç”¨ RocksDBStateBackend çš„ä¼˜åŒ–æ–¹æ³•</h3><p>åœ¨ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆçš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°ååé‡æ—¶é«˜æ—¶ä½ï¼Œæˆ–è€…ååé‡æ¯”ç¬”è€…çš„æµ‹è¯•æ€§èƒ½è¦ä½ä¸€äº›ï¼Œå½“å‡ºç°è¿™ç±»é—®é¢˜çš„æ—¶å€™ï¼Œå¯ä»¥å°è¯•ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œä¼˜åŒ–ã€‚</p><h4 id="è®¾ç½®æœ¬åœ°-RocksDB-çš„æ•°æ®ç›®å½•"><a href="#è®¾ç½®æœ¬åœ°-RocksDB-çš„æ•°æ®ç›®å½•" class="headerlink" title="è®¾ç½®æœ¬åœ° RocksDB çš„æ•°æ®ç›®å½•"></a>è®¾ç½®æœ¬åœ° RocksDB çš„æ•°æ®ç›®å½•</h4><h4 id="Checkpoint-å‚æ•°ç›¸å…³é…ç½®"><a href="#Checkpoint-å‚æ•°ç›¸å…³é…ç½®" class="headerlink" title="Checkpoint å‚æ•°ç›¸å…³é…ç½®"></a>Checkpoint å‚æ•°ç›¸å…³é…ç½®</h4><h4 id="RocksDB-å‚æ•°ç›¸å…³é…ç½®"><a href="#RocksDB-å‚æ•°ç›¸å…³é…ç½®" class="headerlink" title="RocksDB å‚æ•°ç›¸å…³é…ç½®"></a>RocksDB å‚æ•°ç›¸å…³é…ç½®</h4><h3 id="12-2-6-å°ç»“ä¸åæ€"><a href="#12-2-6-å°ç»“ä¸åæ€" class="headerlink" title="12.2.6 å°ç»“ä¸åæ€"></a>12.2.6 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/IeAYbEy">https://t.zsxq.com/IeAYbEy</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;12-2-åŸºäº-Flink-çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ&quot;&gt;&lt;a href=&quot;#12-2-åŸºäº-Flink-çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ&quot; class=&quot;headerlink&quot; title=&quot;12.2 åŸºäº Flink çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ&quot;&gt;&lt;/a&gt;12.2 åŸºäº Flink çš„ç™¾äº¿æ•°æ®å»é‡å®è·µ&lt;/h2&gt;&lt;p&gt;åœ¨å·¥ä½œä¸­ç»å¸¸ä¼šé‡åˆ°å»é‡çš„åœºæ™¯ï¼Œä¾‹å¦‚åŸºäº APP çš„ç”¨æˆ·è¡Œä¸ºæ—¥å¿—åˆ†æç³»ç»Ÿï¼šç”¨æˆ·çš„è¡Œä¸ºæ—¥å¿—ä»æ‰‹æœº APP ç«¯ä¸ŠæŠ¥åˆ° Nginx æœåŠ¡ç«¯ï¼Œç„¶åé€šè¿‡ Logstashã€Flume æˆ–å…¶ä»–å·¥å…·å°†æ—¥å¿—ä» Nginx å†™å…¥åˆ° Kafka ä¸­ã€‚ç”±äºç”¨æˆ·æ‰‹æœºå®¢æˆ·ç«¯çš„ç½‘ç»œå¯èƒ½å‡ºç°ä¸ç¨³å®šï¼Œæ‰€ä»¥æ‰‹æœº APP ç«¯ä¸Šä¼ æ—¥å¿—çš„ç­–ç•¥æ˜¯ï¼šå®å¯é‡å¤ä¸ŠæŠ¥ï¼Œä¹Ÿä¸èƒ½æ¼æŠ¥æ—¥å¿—ï¼Œæ‰€ä»¥å¯¼è‡´ Kafka ä¸­å¯èƒ½ä¼šå‡ºç°æ—¥å¿—é‡å¤çš„æƒ…å†µï¼Œå³ï¼šåŒä¸€æ¡æ—¥å¿—å‡ºç°äº† 2 æ¡æˆ– 2 æ¡ä»¥ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒFlink ä»»åŠ¡çš„æ•°æ®æºéƒ½æ˜¯ Kafkaï¼Œè‹¥ Kafka ä¸­æ•°æ®å‡ºç°äº†é‡å¤ï¼Œåœ¨å®æ—¶ ETL æˆ–è€…æµè®¡ç®—æ—¶éƒ½éœ€è¦è€ƒè™‘åŸºäºæ—¥å¿—ä¸»é”®å¯¹æ—¥å¿—è¿›è¡Œå»é‡ï¼Œå¦åˆ™ä¼šå¯¼è‡´æµè®¡ç®—ç»“æœåé«˜æˆ–ç»“æœä¸å‡†ç¡®çš„é—®é¢˜ï¼Œä¾‹å¦‚ç”¨æˆ· a åœ¨æŸä¸ªé¡µé¢åªç‚¹å‡»äº†ä¸€æ¬¡ï¼Œä½†ç”±äºæ—¥å¿—é‡å¤ä¸ŠæŠ¥ï¼Œæ‰€ä»¥ç”¨æˆ· a åœ¨è¯¥é¡µé¢çš„ç‚¹å‡»æ—¥å¿—åœ¨ Kafka ä¸­å‡ºç°äº† 2 æ¬¡ï¼Œæœ€åç»Ÿè®¡è¯¥é¡µé¢çš„ç‚¹å‡»æ•°æ—¶ï¼Œç»“æœå°±ä¼šåé«˜ã€‚è¿™é‡Œåªé˜è¿°äº†ä¸€ç§å¯èƒ½é€ æˆ Kafka ä¸­æ•°æ®é‡å¤çš„æƒ…å†µï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¾ˆå¤šæƒ…å†µéƒ½å¯èƒ½é€ æˆ Kafka ä¸­æ•°æ®é‡å¤ï¼Œè¿™é‡Œä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œæœ¬èŠ‚ä¸»è¦è®²è¿°å‡ºç°äº†æ•°æ®é‡å¤åï¼Œè¯¥å¦‚ä½•å¤„ç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” åŸºäº Flink å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/19/flink-in-action-12.1/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/19/flink-in-action-12.1/</id>
    <published>2021-08-18T16:00:00.000Z</published>
    <updated>2022-02-20T13:07:36.232Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬åäºŒç« -â€”â€”-Flink-æ¡ˆä¾‹"><a href="#ç¬¬åäºŒç« -â€”â€”-Flink-æ¡ˆä¾‹" class="headerlink" title="ç¬¬åäºŒç«  â€”â€” Flink æ¡ˆä¾‹"></a>ç¬¬åäºŒç«  â€”â€” Flink æ¡ˆä¾‹</h1><p>æœ¬ç« å°†ä»‹ç» Flink åœ¨å¤šä¸ªåœºæ™¯ä¸‹è½åœ°å®ç°çš„å¤§å‹æ¡ˆä¾‹ï¼Œç¬¬ä¸€ä¸ªæ˜¯å®æ—¶å¤„ç†æµ·é‡çš„æ—¥å¿—ï¼Œå°†ä»æ—¥å¿—çš„æ”¶é›†ã€æ—¥å¿—çš„ä¼ è¾“ã€æ—¥å¿—çš„å®æ—¶æ¸…æ´—å’Œå¼‚å¸¸æ£€æµ‹ã€æ—¥å¿—å­˜å‚¨ã€æ—¥å¿—å±•ç¤ºç­‰æ–¹é¢å»ä»‹ç» Flink åœ¨å…¶ä¸­èµ·çš„ä½œç”¨ï¼Œå¸Œæœ›æ•´ä¸ªæ—¥å¿—å¤„ç†çš„æ¶æ„å¤§å®¶å¯ä»¥çµæ´»çš„è¿ç”¨åœ¨è‡ªå·±çš„å…¬å¸ï¼›ç¬¬äºŒä¸ªæ˜¯ç™¾äº¿æ•°æ®é‡çš„æƒ…å†µä¸‹å¦‚ä½•ä½¿ç”¨ Flink å®æ—¶å»é‡ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­å°†å¯¹æ¯”ä»‹ç»å…¶ä»–å‡ ç§å¸¸è§çš„å»é‡å®ç°æ–¹æ¡ˆï¼›ç¬¬ä¸‰ä¸ªæ˜¯ Flink åœ¨ç›‘æ§å‘Šè­¦ç³»ç»Ÿä¸­çš„è½åœ°å®ç°ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­åŒæ ·å¾ˆè¯¦ç»†çš„ä»‹ç»äº†ä¸€ä¸ªç›‘æ§å‘Šè­¦ç³»ç»Ÿçš„å…¨é“¾è·¯ï¼Œæ¯ä¸€ä¸ªå…³èŠ‚éƒ½ä¸å¯æˆ–ç¼ºï¼Œå¹¶ä¸”è¿˜ä»‹ç»äº† Flink åœ¨æœªæ¥ç»“åˆæœºå™¨å­¦ä¹ ç®—æ³•åšä¸€äº› AIOps çš„äº‹æƒ…ã€‚ä¸‰ä¸ªæ¡ˆä¾‹éƒ½æ¯”è¾ƒå…¸å‹ï¼Œå¦‚æœä½ ä¹Ÿåœ¨åšç±»ä¼¼çš„é¡¹ç›®ï¼Œå¸Œæœ›å¯¹ä½ ä»¬çš„æŠ€æœ¯é€‰å‹æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚</p><h2 id="12-1-åŸºäº-Flink-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—"><a href="#12-1-åŸºäº-Flink-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—" class="headerlink" title="12.1 åŸºäº Flink å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—"></a>12.1 åŸºäº Flink å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—</h2><p>åœ¨ 11.5 èŠ‚ä¸­è®²è§£äº† Flink å¦‚ä½•å®æ—¶å¤„ç†å¼‚å¸¸çš„æ—¥å¿—ï¼Œå¹¶ä¸”å¯¹æ¯”åˆ†æäº†å‡ ç§å¸¸ç”¨çš„æ—¥å¿—é‡‡é›†å·¥å…·ã€‚æˆ‘ä»¬ä¹ŸçŸ¥é“é€šå¸¸åœ¨æ’æŸ¥çº¿ä¸Šå¼‚å¸¸æ•…éšœçš„æ—¶å€™ï¼Œæ—¥å¿—æ˜¯å¿…ä¸å¯ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡å¼‚å¸¸æ—¥å¿—æˆ‘ä»¬å¯ä»¥å¿«é€Ÿçš„å®šä½åˆ°é—®é¢˜çš„æ ¹å› ã€‚é‚£ä¹ˆé€šå¸¸åœ¨å…¬å¸å¯¹äºæ—¥å¿—å¤„ç†æœ‰å“ªäº›éœ€æ±‚å‘¢ï¼Ÿ</p><a id="more"></a><h3 id="12-1-1-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—éœ€æ±‚åˆ†æ"><a href="#12-1-1-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—éœ€æ±‚åˆ†æ" class="headerlink" title="12.1.1 å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—éœ€æ±‚åˆ†æ"></a>12.1.1 å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—éœ€æ±‚åˆ†æ</h3><p>ç°åœ¨å…¬å¸éƒ½åœ¨æµè¡Œæ„å»ºåˆ†å¸ƒå¼ã€å¾®æœåŠ¡ã€äº‘åŸç”Ÿçš„æ¶æ„ï¼Œåœ¨è¿™ç±»æ¶æ„ä¸‹ï¼Œé¡¹ç›®åº”ç”¨çš„æ—¥å¿—éƒ½è¢«åˆ†æ•£åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œæ—¥å¿—æŸ¥è¯¢å°±ä¼šæ¯”è¾ƒå›°éš¾ï¼Œæ‰€ä»¥ç»Ÿä¸€çš„æ—¥å¿—æ”¶é›†å‡ ä¹ä¹Ÿæ˜¯æ¯å®¶å…¬å¸å¿…ä¸å¯å°‘çš„ã€‚æ®ç¬”è€…è°ƒç ”ï¼Œä¸å°‘å…¬å¸ç°åœ¨æ˜¯æœ‰æ—¥å¿—ç»Ÿä¸€çš„æ”¶é›†ï¼Œä¹Ÿä¼šå»åšæ—¥å¿—çš„å®æ—¶ ETLï¼Œåˆ©ç”¨ä¸€äº›ä¸»æµçš„æŠ€æœ¯æ¯”å¦‚ ELK å»åšæ—¥å¿—çš„å±•ç¤ºã€æœç´¢å’Œåˆ†æï¼Œä½†æ˜¯å´ç¼ºå°‘äº†æ—¥å¿—çš„å®æ—¶å‘Šè­¦ã€‚æ€»ç»“æ¥è¯´ï¼Œå¤§éƒ¨åˆ†å…¬å¸å¯¹äºæ—¥å¿—è¿™å—çš„ç°çŠ¶æ˜¯ï¼š</p><ul><li><strong>æ—¥å¿—åˆ†å¸ƒé›¶æ•£</strong>ï¼šåˆ†å¸ƒå¼åº”ç”¨å¯¼è‡´æ—¥å¿—åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œäººè‚‰ç™»å½•åˆ°æœºå™¨ä¸Šæ“ä½œå¤æ‚ï¼Œéœ€è¦ç»Ÿä¸€çš„æ—¥å¿—æ”¶é›†å·¥å…·ã€‚</li><li><strong>å¼‚å¸¸æ—¥å¿—æ— å‘Šè­¦</strong>ï¼šå‡ºé”™æ—¶æ— å¼‚å¸¸æ—¥å¿—å‘Šè­¦ï¼Œå¯¼è‡´é”™è¿‡æœ€ä½³å®šä½é—®é¢˜çš„æ—¶æœºï¼Œéœ€è¦å¼‚å¸¸é”™è¯¯æ—¥å¿—çš„å‘Šè­¦ã€‚</li><li><strong>æ—¥å¿—æŸ¥çœ‹ä¸å‹å¥½</strong>ï¼šç™»å½•æœåŠ¡å™¨ä¸Šåœ¨ç»ˆç«¯æŸ¥çœ‹æ—¥å¿—ä¸å¤ªæ–¹ä¾¿ï¼Œéœ€è¦ä¸€ä¸ªæ“ä½œå‹å¥½çš„é¡µé¢å»æŸ¥çœ‹æ—¥å¿—ã€‚</li><li><strong>æ— æ—¥å¿—æœç´¢åˆ†æ</strong>ï¼šå†å²æ—¥å¿—æ–‡ä»¶å¤ªå¤šï¼Œæƒ³æ‰¾æŸç§æ—¥å¿—æ‰¾ä¸åˆ°äº†ï¼Œéœ€è¦ä¸€ä¸ªå¯ä»¥æœç´¢æ—¥å¿—çš„åŠŸèƒ½ã€‚</li></ul><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œç¬”è€…å°†ä¸ºå¤§å®¶è®²è§£æ—¥å¿—çš„å…¨é“¾è·¯ï¼ŒåŒ…å«äº†æ—¥å¿—çš„å®æ—¶é‡‡é›†ã€æ—¥å¿—çš„ ETLã€æ—¥å¿—çš„å®æ—¶ç›‘æ§å‘Šè­¦ã€æ—¥å¿—çš„å­˜å‚¨ã€æ—¥å¿—çš„å¯è§†åŒ–å›¾è¡¨å±•ç¤ºä¸æœç´¢åˆ†æç­‰ã€‚</p><h3 id="12-1-2-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—æ¶æ„è®¾è®¡"><a href="#12-1-2-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—æ¶æ„è®¾è®¡" class="headerlink" title="12.1.2 å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—æ¶æ„è®¾è®¡"></a>12.1.2 å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—æ¶æ„è®¾è®¡</h3><p>åˆ†æå®Œæˆ‘ä»¬è¿™ä¸ªæ¡ˆä¾‹çš„éœ€æ±‚åï¼Œæ¥ä¸‹æ¥å¯¹æ•´ä¸ªé¡¹ç›®çš„æ¶æ„åšä¸€ä¸ªåˆç†çš„è®¾è®¡ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-27-145059.png" alt=""></p><p>æ•´ä¸ªæ¶æ„åˆ†ä¸ºäº”å±‚ï¼šæ—¥å¿—æ¥å…¥å±‚ã€æ—¥å¿—å‰Šå³°å±‚ã€æ—¥å¿—å¤„ç†å±‚ã€æ—¥å¿—å­˜å‚¨å±‚ã€æ—¥å¿—å±•ç¤ºå±‚ã€‚</p><ul><li>æ—¥å¿—æ¥å…¥å±‚ï¼šæ—¥å¿—é‡‡é›†çš„è¯ä½¿ç”¨çš„æ˜¯ Filebeat ç»„ä»¶ï¼Œéœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šéƒ¨ç½²ä¸€ä¸ª Filebeatã€‚</li><li>æ—¥å¿—å‰Šå³°å±‚ï¼šé˜²æ­¢æ—¥å¿—æµé‡é«˜å³°ï¼Œä½¿ç”¨ Kafka æ¶ˆæ¯é˜Ÿåˆ—åšå‰Šå³°ã€‚</li><li>æ—¥å¿—å¤„ç†å±‚ï¼šFlink ä½œä¸šåŒæ—¶æ¶ˆè´¹ Kafka æ•°æ®åšæ—¥å¿—æ¸…æ´—ã€ETLã€å®æ—¶å‘Šè­¦ã€‚</li><li>æ—¥å¿—å­˜å‚¨å±‚ï¼šä½¿ç”¨ ElasticSearch åšæ—¥å¿—çš„å­˜å‚¨ã€‚</li><li>æ—¥å¿—å±•ç¤ºå±‚ï¼šä½¿ç”¨ Kibana åšæ—¥å¿—çš„å±•ç¤ºä¸æœç´¢æŸ¥è¯¢ç•Œé¢ã€‚</li></ul><h3 id="12-1-3-æ—¥å¿—å®æ—¶é‡‡é›†"><a href="#12-1-3-æ—¥å¿—å®æ—¶é‡‡é›†" class="headerlink" title="12.1.3 æ—¥å¿—å®æ—¶é‡‡é›†"></a>12.1.3 æ—¥å¿—å®æ—¶é‡‡é›†</h3><p>åœ¨ 11.5.1 ä¸­å¯¹æ¯”äº†è¿™å‡ ç§æ¯”è¾ƒæµè¡Œçš„æ—¥å¿—é‡‡é›†å·¥å…·ï¼ˆLogstashã€Filebeatã€Fluentdã€Logagentï¼‰ï¼Œä»åŠŸèƒ½å®Œæ•´æ€§ã€æ€§èƒ½ã€æˆæœ¬ã€ä½¿ç”¨éš¾åº¦ç­‰æ–¹é¢ç»¼åˆè€ƒè™‘åï¼Œè¿™é‡Œæ¼”ç¤ºä½¿ç”¨çš„æ˜¯ Filebeatã€‚</p><h4 id="å®‰è£…-Filebeat"><a href="#å®‰è£…-Filebeat" class="headerlink" title="å®‰è£… Filebeat"></a>å®‰è£… Filebeat</h4><p>åœ¨æœåŠ¡å™¨ä¸Šä¸‹è½½ <a href="https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.3.2-linux-x86_64.tar.gz">Fliebeat 6.3.2</a> å®‰è£…åŒ…ï¼ˆè¯·æ ¹æ®è‡ªå·±æœåŠ¡å™¨å’Œæ‰€éœ€è¦çš„ç‰ˆæœ¬è¿›è¡Œä¸‹è½½ï¼‰ï¼Œä¸‹è½½åè¿›è¡Œè§£å‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf filebeat-6.3.2-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="é…ç½®-Filebeat"><a href="#é…ç½®-Filebeat" class="headerlink" title="é…ç½® Filebeat"></a>é…ç½® Filebeat</h4><p>é…ç½® Filebeat éœ€è¦ç¼–è¾‘ Filebeat çš„é…ç½®æ–‡ä»¶ <code>filebeat.yml</code>ï¼Œä¸åŒå®‰è£…æ–¹å¼é…ç½®æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„æœ‰ä¸€äº›ä¸åŒï¼Œå¯¹äºè§£å‹åŒ…å®‰è£…çš„æ–¹å¼ï¼Œé…ç½®æ–‡ä»¶å­˜åœ¨è§£å‹ç›®å½•ä¸‹é¢ï¼›å¯¹äº rpm å’Œ deb çš„æ–¹å¼, é…ç½®æ–‡ä»¶è·¯å¾„çš„æ˜¯ <code>/etc/filebeat/filebeat.yml</code> ä¸‹ã€‚</p><p>å› ä¸º Filebeat æ˜¯è¦å®æ—¶é‡‡é›†æ—¥å¿—çš„ï¼Œæ‰€ä»¥å¾—è®© Filebeat çŸ¥é“æ—¥å¿—çš„è·¯å¾„æ˜¯åœ¨å“ªé‡Œï¼Œä¸‹é¢åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸‹æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ã€‚é€šå¸¸å»ºè®®åœ¨æœåŠ¡å™¨ä¸Šå›ºå®šå­˜æ”¾æ—¥å¿—çš„è·¯å¾„ï¼Œç„¶ååº”ç”¨çš„æ—¥å¿—éƒ½æ‰“åœ¨è¿™ä¸ªå›ºå®šçš„è·¯å¾„ä¸­ï¼Œè¿™æ · Filebeat çš„æ—¥å¿—è·¯å¾„é…ç½®åªéœ€è¦å¡«å†™ä¸€æ¬¡ï¼Œå…¶ä»–æœºå™¨ä¸Šå¯ä»¥æ‹·è´åŒæ ·çš„é…ç½®å°±èƒ½å°† Filebeat è¿è¡Œèµ·æ¥ï¼Œé…ç½®å¦‚ä¸‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- type: log</span><br><span class="line">  # é…ç½®ä¸º true è¡¨ç¤ºå¼€å¯</span><br><span class="line">  enabled: true</span><br><span class="line">  # æ—¥å¿—çš„è·¯å¾„</span><br><span class="line">  paths:</span><br><span class="line">    - /var/logs/*.log</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„é…ç½®è¡¨ç¤ºå°†å¯¹ /var/logs ç›®å½•ä¸‹æ‰€æœ‰ä»¥ .log ç»“å°¾çš„æ–‡ä»¶è¿›è¡Œé‡‡é›†ï¼Œæ¥ä¸‹æ¥é…ç½®æ—¥å¿—è¾“å‡ºçš„æ–¹å¼ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ Kafkaï¼Œé…ç½®å¦‚ä¸‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output.kafka:</span><br><span class="line">  # å¡«å†™ Kafka åœ°å€ä¿¡æ¯</span><br><span class="line">  hosts: [&quot;localhost:9092&quot;]</span><br><span class="line">  # æ•°æ®å‘åˆ°å“ªä¸ª topic</span><br><span class="line">  topic: zhisheng-log</span><br><span class="line">  partition.round_robin:</span><br><span class="line">    reachable_only: false</span><br><span class="line">  required_acks: 1</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è®²è§£çš„ä¸¤ä¸ªé…ç½®ï¼Œç¬”è€…è¿™é‡Œå°†å®ƒä»¬å†™åœ¨ä¸€ä¸ªæ–°å»ºçš„é…ç½®æ–‡ä»¶ä¸­ kafka.ymlï¼Œç„¶åå¯åŠ¨ Filebeat çš„æ—¶å€™ä½¿ç”¨è¯¥é…ç½®ã€‚</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/logs/*.log</span></span><br><span class="line"><span class="string">output.kafka:</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["localhost:9092"]</span></span><br><span class="line"><span class="attr">  topic:</span> <span class="string">zhisheng_log</span></span><br><span class="line">  <span class="string">partition.round_robin:</span></span><br><span class="line"><span class="attr">    reachable_only:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  required_acks:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨-Filebeat"><a href="#å¯åŠ¨-Filebeat" class="headerlink" title="å¯åŠ¨ Filebeat"></a>å¯åŠ¨ Filebeat</h4><p>æ—¥å¿—è·¯å¾„çš„é…ç½®å’Œ Kafka çš„é…ç½®éƒ½å†™å¥½åï¼Œåˆ™æ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢å‘½ä»¤å°† Filebeat å¯åŠ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/filebeat -e -c kafka.yml</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œå‘½ä»¤åå‡ºç°çš„æ—¥å¿—å¦‚ä¸‹åˆ™è¡¨ç¤ºå¯åŠ¨æˆåŠŸäº†ï¼Œå¦å¤–è¿˜å¯ä»¥çœ‹å¾—åˆ°ä¼šåœ¨ç»ˆç«¯æ‰“å°å‡º metrics æ•°æ®å‡ºæ¥ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-26-075438.png" alt=""></p><h4 id="éªŒè¯-Filebeat-æ˜¯å¦å°†æ—¥å¿—æ•°æ®å‘åˆ°-Kafka"><a href="#éªŒè¯-Filebeat-æ˜¯å¦å°†æ—¥å¿—æ•°æ®å‘åˆ°-Kafka" class="headerlink" title="éªŒè¯ Filebeat æ˜¯å¦å°†æ—¥å¿—æ•°æ®å‘åˆ° Kafka"></a>éªŒè¯ Filebeat æ˜¯å¦å°†æ—¥å¿—æ•°æ®å‘åˆ° Kafka</h4><p>é‚£ä¹ˆæ­¤æ—¶å°±å¾—å»æŸ¥çœ‹æ˜¯å¦çœŸæ­£å°±å°†è¿™äº›æ—¥å¿—æ•°æ®å‘åˆ° Kafka äº†å‘¢ï¼Œä½ å¯ä»¥é€šè¿‡ Kafka çš„è‡ªå¸¦å‘½ä»¤å»æ¶ˆè´¹è¿™ä¸ª Topic çœ‹æ˜¯å¦ä¸æ–­æœ‰æ•°æ®å‘å‡ºæ¥ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --zookeeper 106.54.248.27:2181 --topic zhisheng_log --from-beginning</span><br></pre></td></tr></table></figure><p>å¦‚æœå‡ºç°æ•°æ®åˆ™ä»£è¡¨æ˜¯å·²ç»æœ‰æ•°æ®å‘åˆ° Kafka äº†ï¼Œå¦‚æœä½ ä¸å–œæ¬¢ä½¿ç”¨è¿™ç§æ–¹å¼éªŒè¯ï¼Œå¯ä»¥è‡ªå·±å†™ä¸ª Flink Job å»è¯»å– Kafka è¯¥ Topic çš„æ•°æ®ï¼Œæ¯”å¦‚å†™äº†ä¸ªä½œä¸šè¿è¡Œç»“æœå¦‚ä¸‹å°±ä»£è¡¨ç€æ—¥å¿—æ•°æ®å·²ç»æˆåŠŸå‘é€åˆ° Kafkaã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-27-150039.png" alt=""></p><h4 id="å‘åˆ°-Kafka-çš„æ—¥å¿—ç»“æ„"><a href="#å‘åˆ°-Kafka-çš„æ—¥å¿—ç»“æ„" class="headerlink" title="å‘åˆ° Kafka çš„æ—¥å¿—ç»“æ„"></a>å‘åˆ° Kafka çš„æ—¥å¿—ç»“æ„</h4><p>æ—¢ç„¶æ•°æ®éƒ½å·²ç»å‘åˆ° Kafka äº†ï¼Œé€šè¿‡æ¶ˆè´¹ Kafka è¯¥ Topic çš„æ•°æ®æˆ‘ä»¬å¯ä»¥å‘ç°è¿™äº›æ•°æ®çš„æ ¼å¼å¦æ˜¯ JSONï¼Œç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"@timestamp"</span>: <span class="string">"2019-10-26T08:18:18.087Z"</span>,</span><br><span class="line"><span class="attr">"@metadata"</span>: &#123;</span><br><span class="line"><span class="attr">"beat"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line"><span class="attr">"type"</span>: <span class="string">"doc"</span>,</span><br><span class="line"><span class="attr">"version"</span>: <span class="string">"6.8.4"</span>,</span><br><span class="line"><span class="attr">"topic"</span>: <span class="string">"zhisheng_log"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"prospector"</span>: &#123;</span><br><span class="line"><span class="attr">"type"</span>: <span class="string">"log"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"input"</span>: &#123;</span><br><span class="line"><span class="attr">"type"</span>: <span class="string">"log"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"beat"</span>: &#123;</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"VM_0_2_centos"</span>,</span><br><span class="line"><span class="attr">"hostname"</span>: <span class="string">"VM_0_2_centos"</span>,</span><br><span class="line"><span class="attr">"version"</span>: <span class="string">"6.8.4"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"host"</span>: &#123;</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"VM_0_2_centos"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"source"</span>: <span class="string">"/var/logs/middleware/kafka.log"</span>,</span><br><span class="line"><span class="attr">"offset"</span>: <span class="number">9460</span>,</span><br><span class="line"><span class="attr">"log"</span>: &#123;</span><br><span class="line"><span class="attr">"file"</span>: &#123;</span><br><span class="line"><span class="attr">"path"</span>: <span class="string">"/var/logs/middleware/kafka.log"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"message"</span>: <span class="string">"2019-10-26 16:18:11 TRACE [Controller id=0] Leader imbalance ratio for broker 0 is 0.0 (kafka.controller.KafkaController)"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¥å¿—ç»“æ„é‡Œé¢åŒ…å«äº†å¾ˆå¤šå­—æ®µï¼Œæ¯”å¦‚ timestampã€metadataã€hostã€sourceã€message ç­‰ï¼Œä½†æ˜¯å…¶ä¸­æŸäº›å­—æ®µæˆ‘ä»¬å…¶å®æ ¹æœ¬ä¸éœ€è¦çš„ï¼Œä½ å¯ä»¥æ ¹æ®å…¬å¸çš„éœ€æ±‚ä¸¢å¼ƒä¸€äº›å­—æ®µï¼ŒæŠŠè¦ä¸¢å¼ƒçš„å­—æ®µä¹Ÿé…ç½®åœ¨ kafka.yml ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">processors:</span><br><span class="line">- drop_fields:</span><br><span class="line">    fields: [&quot;prospector&quot;,&quot;input&quot;,&quot;beat&quot;,&quot;log&quot;,&quot;offset&quot;,&quot;@metadata&quot;]</span><br></pre></td></tr></table></figure><p>ç„¶åå†æ¬¡å¯åŠ¨ Filebeat ï¼Œå‘ç°ä¸Šé¢é…ç½®çš„å­—æ®µåœ¨æ–°çš„æ•°æ®ä¸­æ²¡æœ‰äº†ï¼ˆé™¤ @metadata ä¹‹å¤–ï¼‰ï¼Œå¦å¤–ç»ç¬”è€…éªŒè¯ï¼šä¸ä»… @metadata å­—æ®µä¸èƒ½ä¸¢å¼ƒï¼Œå¦‚æœ @timestamp è¿™ä¸ªå­—æ®µåœ¨ drop_fields ä¸­é…ç½®äº†ï¼Œä¹Ÿæ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œå®ƒä»¬ä¸¤ä¸å…è®¸ä¸¢å¼ƒã€‚é€šå¸¸æ¥è¯´ä¸€è¡Œæ—¥å¿—å·²ç»å¤Ÿé•¿äº†ï¼Œå†åŠ ä¸Šè¿™ä¹ˆå¤šæˆ‘ä»¬ä¸éœ€è¦çš„å­—æ®µï¼Œå°±ä¼šå¢åŠ æ•°æ®çš„å¤§å°ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒçš„è¯ï¼Œæ—¥å¿—æ•°æ®é‡éå¸¸å¤§ï¼Œé‚£æ— ç–‘ä¼šå¯¹åé¢æ‰€æœ‰çš„é“¾è·¯éƒ½ä¼šé€ æˆä¸€å®šçš„å½±å“ï¼Œæ‰€ä»¥ä¸€å®šè¦åœ¨åº•å±‚æ•°æ®æºå¤´åšå¥½ç²¾ç®€ã€‚å¦å¤–è¿˜å¯ä»¥åœ¨å‘é€ Kafka çš„æ—¶å€™å¯¹æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ä¸€ä¸ª <code>compression: gzip</code>ã€‚ç²¾ç®€åçš„æ—¥å¿—æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"@timestamp"</span>: <span class="string">"2019-10-26T09:23:16.848Z"</span>,</span><br><span class="line"><span class="attr">"@metadata"</span>: &#123;</span><br><span class="line"><span class="attr">"beat"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line"><span class="attr">"type"</span>: <span class="string">"doc"</span>,</span><br><span class="line"><span class="attr">"version"</span>: <span class="string">"6.8.4"</span>,</span><br><span class="line"><span class="attr">"topic"</span>: <span class="string">"zhisheng_log"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"host"</span>: &#123;</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"VM_0_2_centos"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"source"</span>: <span class="string">"/var/logs/middleware/kafka.log"</span>,</span><br><span class="line"><span class="attr">"message"</span>: <span class="string">"2019-10-26 17:23:11 TRACE [Controller id=0] Leader imbalance ratio for broker 0 is 0.0 (kafka.controller.KafkaController)"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="12-1-4-æ—¥å¿—æ ¼å¼ç»Ÿä¸€"><a href="#12-1-4-æ—¥å¿—æ ¼å¼ç»Ÿä¸€" class="headerlink" title="12.1.4 æ—¥å¿—æ ¼å¼ç»Ÿä¸€"></a>12.1.4 æ—¥å¿—æ ¼å¼ç»Ÿä¸€</h3><p>å› ä¸º Filebeat æ˜¯åœ¨æœºå™¨ä¸Šé‡‡é›†çš„æ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—çš„ç§ç±»æ¯”è¾ƒå¤šï¼Œå¸¸è§çš„æœ‰åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¥å¿—ã€ä½œä¸šæ„å»ºç¼–è¯‘æ‰“åŒ…çš„æ—¥å¿—ã€ä¸­é—´ä»¶æœåŠ¡è¿è¡Œçš„æ—¥å¿—ç­‰ã€‚é€šå¸¸åœ¨å…¬å¸æ˜¯å¯ä»¥ç»™å¼€å‘çº¦å®šæ—¥å¿—æ‰“å°çš„è§„åˆ™ï¼Œä½†æ˜¯åƒä¸­é—´ä»¶è¿™ç±»æœåŠ¡çš„æ—¥å¿—æ˜¯ä¸å›ºå®šçš„ï¼Œå¦‚æœå°† Kafka ä¸­çš„æ¶ˆæ¯ç›´æ¥å­˜å‚¨åˆ° ElasticSearch çš„è¯ï¼Œåé¢å¦‚æœè¦åšåŒºåˆ†ç­›é€‰çš„è¯å¯èƒ½ä¼šæœ‰é—®é¢˜ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾—åœ¨æ—¥å¿—å­˜å…¥ ElasticSearch ä¹‹å‰åšä¸€ä¸ªæ•°æ®æ ¼å¼åŒ–å’Œæ¸…æ´—çš„å·¥ä½œï¼Œå› ä¸º Flink å¤„ç†æ•°æ®çš„é€Ÿåº¦æ¯”è¾ƒå¥½ï¼Œè€Œä¸”å¯ä»¥åšåˆ°å®æ—¶ï¼Œæ‰€ä»¥é€‰æ‹©åœ¨ Flink Job ä¸­å®Œæˆè¯¥å·¥ä½œã€‚</p><p>åœ¨è¯¥ä½œä¸šä¸­çš„è¦å°† message è§£æï¼Œä¸€èˆ¬è¯¥è¡Œæ—¥å¿—ä¿¡æ¯ä¼šåŒ…å«å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚æ—¥å¿—æ‰“å°æ—¶é—´ã€æ—¥å¿—çº§åˆ«ã€åº”ç”¨åã€å”¯ä¸€æ€§ IDï¼ˆç”¨æ¥å…³è”å„ä¸ªè¯·æ±‚ï¼‰ã€è¯·æ±‚ä¸Šä¸‹æ–‡ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªæ–°çš„æ—¥å¿—ç»“æ„å¯¹è±¡æ¥ç»Ÿä¸€æ—¥å¿—çš„æ ¼å¼ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><h3 id="12-1-5-æ—¥å¿—å®æ—¶æ¸…æ´—"><a href="#12-1-5-æ—¥å¿—å®æ—¶æ¸…æ´—" class="headerlink" title="12.1.5 æ—¥å¿—å®æ—¶æ¸…æ´—"></a>12.1.5 æ—¥å¿—å®æ—¶æ¸…æ´—</h3><h3 id="12-1-6-æ—¥å¿—å®æ—¶å‘Šè­¦"><a href="#12-1-6-æ—¥å¿—å®æ—¶å‘Šè­¦" class="headerlink" title="12.1.6 æ—¥å¿—å®æ—¶å‘Šè­¦"></a>12.1.6 æ—¥å¿—å®æ—¶å‘Šè­¦</h3><h3 id="12-1-7-æ—¥å¿—å®æ—¶å­˜å‚¨"><a href="#12-1-7-æ—¥å¿—å®æ—¶å­˜å‚¨" class="headerlink" title="12.1.7 æ—¥å¿—å®æ—¶å­˜å‚¨"></a>12.1.7 æ—¥å¿—å®æ—¶å­˜å‚¨</h3><h3 id="12-1-8-æ—¥å¿—å®æ—¶å±•ç¤º"><a href="#12-1-8-æ—¥å¿—å®æ—¶å±•ç¤º" class="headerlink" title="12.1.8 æ—¥å¿—å®æ—¶å±•ç¤º"></a>12.1.8 æ—¥å¿—å®æ—¶å±•ç¤º</h3><h3 id="12-1-9-å°ç»“ä¸åæ€"><a href="#12-1-9-å°ç»“ä¸åæ€" class="headerlink" title="12.1.9 å°ç»“ä¸åæ€"></a>12.1.9 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/IeAYbEy">https://t.zsxq.com/IeAYbEy</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ç¬¬åäºŒç« -â€”â€”-Flink-æ¡ˆä¾‹&quot;&gt;&lt;a href=&quot;#ç¬¬åäºŒç« -â€”â€”-Flink-æ¡ˆä¾‹&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬åäºŒç«  â€”â€” Flink æ¡ˆä¾‹&quot;&gt;&lt;/a&gt;ç¬¬åäºŒç«  â€”â€” Flink æ¡ˆä¾‹&lt;/h1&gt;&lt;p&gt;æœ¬ç« å°†ä»‹ç» Flink åœ¨å¤šä¸ªåœºæ™¯ä¸‹è½åœ°å®ç°çš„å¤§å‹æ¡ˆä¾‹ï¼Œç¬¬ä¸€ä¸ªæ˜¯å®æ—¶å¤„ç†æµ·é‡çš„æ—¥å¿—ï¼Œå°†ä»æ—¥å¿—çš„æ”¶é›†ã€æ—¥å¿—çš„ä¼ è¾“ã€æ—¥å¿—çš„å®æ—¶æ¸…æ´—å’Œå¼‚å¸¸æ£€æµ‹ã€æ—¥å¿—å­˜å‚¨ã€æ—¥å¿—å±•ç¤ºç­‰æ–¹é¢å»ä»‹ç» Flink åœ¨å…¶ä¸­èµ·çš„ä½œç”¨ï¼Œå¸Œæœ›æ•´ä¸ªæ—¥å¿—å¤„ç†çš„æ¶æ„å¤§å®¶å¯ä»¥çµæ´»çš„è¿ç”¨åœ¨è‡ªå·±çš„å…¬å¸ï¼›ç¬¬äºŒä¸ªæ˜¯ç™¾äº¿æ•°æ®é‡çš„æƒ…å†µä¸‹å¦‚ä½•ä½¿ç”¨ Flink å®æ—¶å»é‡ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­å°†å¯¹æ¯”ä»‹ç»å…¶ä»–å‡ ç§å¸¸è§çš„å»é‡å®ç°æ–¹æ¡ˆï¼›ç¬¬ä¸‰ä¸ªæ˜¯ Flink åœ¨ç›‘æ§å‘Šè­¦ç³»ç»Ÿä¸­çš„è½åœ°å®ç°ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­åŒæ ·å¾ˆè¯¦ç»†çš„ä»‹ç»äº†ä¸€ä¸ªç›‘æ§å‘Šè­¦ç³»ç»Ÿçš„å…¨é“¾è·¯ï¼Œæ¯ä¸€ä¸ªå…³èŠ‚éƒ½ä¸å¯æˆ–ç¼ºï¼Œå¹¶ä¸”è¿˜ä»‹ç»äº† Flink åœ¨æœªæ¥ç»“åˆæœºå™¨å­¦ä¹ ç®—æ³•åšä¸€äº› AIOps çš„äº‹æƒ…ã€‚ä¸‰ä¸ªæ¡ˆä¾‹éƒ½æ¯”è¾ƒå…¸å‹ï¼Œå¦‚æœä½ ä¹Ÿåœ¨åšç±»ä¼¼çš„é¡¹ç›®ï¼Œå¸Œæœ›å¯¹ä½ ä»¬çš„æŠ€æœ¯é€‰å‹æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚&lt;/p&gt;
&lt;h2 id=&quot;12-1-åŸºäº-Flink-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—&quot;&gt;&lt;a href=&quot;#12-1-åŸºäº-Flink-å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—&quot; class=&quot;headerlink&quot; title=&quot;12.1 åŸºäº Flink å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—&quot;&gt;&lt;/a&gt;12.1 åŸºäº Flink å®æ—¶å¤„ç†æµ·é‡æ—¥å¿—&lt;/h2&gt;&lt;p&gt;åœ¨ 11.5 èŠ‚ä¸­è®²è§£äº† Flink å¦‚ä½•å®æ—¶å¤„ç†å¼‚å¸¸çš„æ—¥å¿—ï¼Œå¹¶ä¸”å¯¹æ¯”åˆ†æäº†å‡ ç§å¸¸ç”¨çš„æ—¥å¿—é‡‡é›†å·¥å…·ã€‚æˆ‘ä»¬ä¹ŸçŸ¥é“é€šå¸¸åœ¨æ’æŸ¥çº¿ä¸Šå¼‚å¸¸æ•…éšœçš„æ—¶å€™ï¼Œæ—¥å¿—æ˜¯å¿…ä¸å¯ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡å¼‚å¸¸æ—¥å¿—æˆ‘ä»¬å¯ä»¥å¿«é€Ÿçš„å®šä½åˆ°é—®é¢˜çš„æ ¹å› ã€‚é‚£ä¹ˆé€šå¸¸åœ¨å…¬å¸å¯¹äºæ—¥å¿—å¤„ç†æœ‰å“ªäº›éœ€æ±‚å‘¢ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•å®æ—¶å°†åº”ç”¨ Error æ—¥å¿—å‘Šè­¦ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/18/flink-in-action-11.5/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/18/flink-in-action-11.5/</id>
    <published>2021-08-17T16:00:00.000Z</published>
    <updated>2022-02-07T14:13:56.910Z</updated>
    
    <content type="html"><![CDATA[<h2 id="11-5-å¦‚ä½•å®æ—¶å°†åº”ç”¨-Error-æ—¥å¿—å‘Šè­¦ï¼Ÿ"><a href="#11-5-å¦‚ä½•å®æ—¶å°†åº”ç”¨-Error-æ—¥å¿—å‘Šè­¦ï¼Ÿ" class="headerlink" title="11.5 å¦‚ä½•å®æ—¶å°†åº”ç”¨ Error æ—¥å¿—å‘Šè­¦ï¼Ÿ"></a>11.5 å¦‚ä½•å®æ—¶å°†åº”ç”¨ Error æ—¥å¿—å‘Šè­¦ï¼Ÿ</h2><p>å¤§æ•°æ®æ—¶ä»£ï¼Œéšç€å…¬å¸ä¸šåŠ¡ä¸æ–­çš„å¢é•¿ï¼Œæ•°æ®é‡è‡ªç„¶ä¹Ÿä¼šè·Ÿç€ä¸æ–­çš„å¢é•¿ï¼Œé‚£ä¹ˆä¸šåŠ¡åº”ç”¨å’Œé›†ç¾¤æœåŠ¡å™¨çš„çš„è§„æ¨¡ä¹Ÿä¼šé€æ¸æ‰©å¤§ï¼Œå‡ ç™¾å°æœåŠ¡å™¨åœ¨ä¸€èˆ¬çš„å…¬å¸å·²ç»æ˜¯å¾ˆå¸¸è§çš„äº†ã€‚é‚£ä¹ˆå°†åº”ç”¨æœåŠ¡éƒ¨ç½²åœ¨å¦‚æ­¤å¤šçš„æœåŠ¡å™¨ä¸Šï¼Œå¯¹å¼€å‘å’Œè¿ç»´äººå‘˜æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚ä¸€ä¸ªä¼˜ç§€çš„ç³»ç»Ÿè¿ç»´å¹³å°æ˜¯éœ€è¦å°†éƒ¨ç½²åœ¨è¿™ä¹ˆå¤šæœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç›‘æ§ä¿¡æ¯æ±‡æ€»æˆä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®å±•ç¤ºå¹³å°ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜åšæ—¥å¸¸çš„ç›‘æµ‹ã€æå‡è¿ç»´æ•ˆç‡ï¼Œè¿˜å¯ä»¥åŠæ—¶åé¦ˆåº”ç”¨çš„è¿è¡ŒçŠ¶æ€ç»™åº”ç”¨å¼€å‘äººå‘˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåº”ç”¨çš„è¿è¡Œæ—¥å¿—éœ€è¦æŒ‰ç…§æ—¶é—´æ’åºåšä¸€ä¸ªå±•ç¤ºï¼Œå¹¶ä¸”æä¾›æ—¥å¿—ä¸‹è½½å’Œæ—¥å¿—æœç´¢ç­‰æœåŠ¡ï¼Œè¿™æ ·å¦‚æœåº”ç”¨å‡ºç°é—®é¢˜å¼€å‘äººå‘˜é¦–å…ˆå¯ä»¥æ ¹æ®åº”ç”¨æ—¥å¿—çš„é”™è¯¯ä¿¡æ¯è¿›è¡Œé—®é¢˜çš„æ’æŸ¥ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•å®æ—¶çš„å°†åº”ç”¨çš„ Error æ—¥å¿—æ¨é€ç»™åº”ç”¨å¼€å‘äººå‘˜å‘¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è®²è§£æ—¥å¿—çš„å¤„ç†æ–¹æ¡ˆã€‚</p><a id="more"></a><h3 id="11-5-1-æ—¥å¿—å¤„ç†æ–¹æ¡ˆçš„æ¼”è¿›"><a href="#11-5-1-æ—¥å¿—å¤„ç†æ–¹æ¡ˆçš„æ¼”è¿›" class="headerlink" title="11.5.1 æ—¥å¿—å¤„ç†æ–¹æ¡ˆçš„æ¼”è¿›"></a>11.5.1 æ—¥å¿—å¤„ç†æ–¹æ¡ˆçš„æ¼”è¿›</h3><p>æ—¥å¿—å¤„ç†çš„æ–¹æ¡ˆä¹Ÿæ˜¯æœ‰ä¸€ä¸ªæ¼”è¿›çš„è¿‡ç¨‹ï¼Œè¦æƒ³å¼„æ¸…æ¥šæ•´ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ—¥å¿—çš„ä»‹ç»ã€‚</p><h4 id="ä»€ä¹ˆæ˜¯æ—¥å¿—ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ—¥å¿—ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ—¥å¿—ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯æ—¥å¿—ï¼Ÿ</h4><p>æ—¥å¿—æ˜¯å¸¦æ—¶é—´æˆ³çš„åŸºäºæ—¶é—´åºåˆ—çš„æ•°æ®ï¼Œå®ƒå¯ä»¥åæ˜ ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬äº†ä¸€äº›æ ‡è¯†ä¿¡æ¯ï¼ˆåº”ç”¨æ‰€åœ¨æœåŠ¡å™¨é›†ç¾¤åã€é›†ç¾¤æœºå™¨ IPã€æœºå™¨è®¾å¤‡ç³»ç»Ÿä¿¡æ¯ã€åº”ç”¨åã€åº”ç”¨ IDã€åº”ç”¨æ‰€å±é¡¹ç›®ç­‰ï¼‰</p><h4 id="æ—¥å¿—å¤„ç†æ–¹æ¡ˆæ¼”è¿›"><a href="#æ—¥å¿—å¤„ç†æ–¹æ¡ˆæ¼”è¿›" class="headerlink" title="æ—¥å¿—å¤„ç†æ–¹æ¡ˆæ¼”è¿›"></a>æ—¥å¿—å¤„ç†æ–¹æ¡ˆæ¼”è¿›</h4><p>æ—¥å¿—å¤„ç†æ–¹æ¡ˆçš„æ¼”è¿›è¿‡ç¨‹ï¼š</p><ul><li>æ—¥å¿—å¤„ç† v1.0: åº”ç”¨æ—¥å¿—åˆ†å¸ƒåœ¨å¾ˆå¤šæœºå™¨ä¸Šï¼Œéœ€è¦äººè‚‰æ‰‹åŠ¨å»æœºå™¨æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯ã€‚</li><li>æ—¥å¿—å¤„ç† v2.0: åˆ©ç”¨ç¦»çº¿è®¡ç®—å¼•æ“ç»Ÿä¸€çš„å°†æ—¥å¿—æ”¶é›†ï¼Œå½¢æˆä¸€ä¸ªæ—¥å¿—æœç´¢åˆ†æå¹³å°ï¼Œæä¾›æœç´¢è®©ç”¨æˆ·æ ¹æ®å…³é”®å­—è¿›è¡Œæœç´¢å’Œåˆ†æï¼Œç¼ºç‚¹å°±æ˜¯åŠæ—¶æ€§æ¯”è¾ƒå·®ã€‚</li><li>æ—¥å¿—å¤„ç† v3.0: åˆ©ç”¨ Agent å®æ—¶çš„é‡‡é›†éƒ¨ç½²åœ¨æ¯å°æœºå™¨ä¸Šçš„æ—¥å¿—ï¼Œç„¶åç»Ÿä¸€å‘åˆ°æ—¥å¿—æ”¶é›†å¹³å°åšæ±‡æ€»ï¼Œå¹¶æä¾›å®æ—¶æ—¥å¿—åˆ†æå’Œæœç´¢çš„åŠŸèƒ½ï¼Œè¿™æ ·ä»æ—¥å¿—äº§ç”Ÿåˆ°æœç´¢åˆ†æå‡ºç»“æœåªæœ‰ç®€çŸ­çš„å»¶è¿Ÿï¼ˆåœ¨ç”¨æˆ·å®¹å¿æ—¶é—´èŒƒå›´ä¹‹å†…ï¼‰ï¼Œä¼˜ç‚¹æ˜¯å¿«ï¼Œä½†æ˜¯æ—¥å¿—æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹å¸¦æ¥çš„æŒ‘æˆ˜ä¹Ÿå¤§ã€‚</li></ul><h3 id="11-5-2-æ—¥å¿—é‡‡é›†å·¥å…·å¯¹æ¯”"><a href="#11-5-2-æ—¥å¿—é‡‡é›†å·¥å…·å¯¹æ¯”" class="headerlink" title="11.5.2 æ—¥å¿—é‡‡é›†å·¥å…·å¯¹æ¯”"></a>11.5.2 æ—¥å¿—é‡‡é›†å·¥å…·å¯¹æ¯”</h3><p>ä¸Šé¢æåˆ°çš„æ—¥å¿—é‡‡é›†ï¼Œå…¶å®ç°åœ¨å·²ç»æœ‰å¾ˆå¤šå¼€æºçš„ç»„ä»¶æ”¯æŒå»é‡‡é›†æ—¥å¿—ï¼Œæ¯”å¦‚ Logstashã€Filebeatã€Fluentdã€Logagent ç­‰ï¼Œè¿™é‡Œç®€å•åšä¸ªå¯¹æ¯”ã€‚</p><h4 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h4><p>Logstash æ˜¯ä¸€ä¸ªå¼€æºæ•°æ®æ”¶é›†å¼•æ“ï¼Œå…·æœ‰å®æ—¶ç®¡é“åŠŸèƒ½ã€‚Logstash å¯ä»¥åŠ¨æ€åœ°å°†æ¥è‡ªä¸åŒæ•°æ®æºçš„æ•°æ®ç»Ÿä¸€èµ·æ¥ï¼Œå¹¶å°†æ•°æ®æ ‡å‡†åŒ–åˆ°ä½ æ‰€é€‰æ‹©çš„ç›®çš„åœ°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒLogstash å°†é‡‡é›†åˆ°çš„æ•°æ®ç”¨ä½œåˆ†æã€ç›‘æ§ã€å‘Šè­¦ç­‰ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-13-025214.jpg" alt=""></p><p><strong>ä¼˜åŠ¿</strong>ï¼šLogstash ä¸»è¦çš„ä¼˜ç‚¹å°±æ˜¯å®ƒçš„çµæ´»æ€§ï¼Œå®ƒæä¾›å¾ˆå¤šæ’ä»¶ï¼Œè¯¦ç»†çš„æ–‡æ¡£ä»¥åŠç›´ç™½çš„é…ç½®æ ¼å¼è®©å®ƒå¯ä»¥åœ¨å¤šç§åœºæ™¯ä¸‹åº”ç”¨ã€‚è€Œä¸”ç°åœ¨ ELK æ•´ä¸ªæŠ€æœ¯æ ˆåœ¨å¾ˆå¤šå…¬å¸åº”ç”¨çš„æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šå¯ä»¥åœ¨å¾€ä¸Šæ‰¾åˆ°å¾ˆå¤šç›¸å…³çš„å­¦ä¹ èµ„æºã€‚</p><p><strong>åŠ£åŠ¿</strong>ï¼šLogstash è‡´å‘½çš„é—®é¢˜æ˜¯å®ƒçš„æ€§èƒ½ä»¥åŠèµ„æºæ¶ˆè€—(é»˜è®¤çš„å †å¤§å°æ˜¯ 1GB)ã€‚å°½ç®¡å®ƒçš„æ€§èƒ½åœ¨è¿‘å‡ å¹´å·²ç»æœ‰å¾ˆå¤§æå‡ï¼Œä¸å®ƒçš„æ›¿ä»£è€…ä»¬ç›¸æ¯”è¿˜æ˜¯è¦æ…¢å¾ˆå¤šçš„ï¼Œå®ƒåœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ä¼šæ˜¯ä¸ªé—®é¢˜ã€‚å¦ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒç›®å‰ä¸æ”¯æŒç¼“å­˜ï¼Œç›®å‰çš„å…¸å‹æ›¿ä»£æ–¹æ¡ˆæ˜¯å°† Redis æˆ– Kafka ä½œä¸ºä¸­å¿ƒç¼“å†²æ± ï¼š</p><h4 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h4><p>ä½œä¸º Beats å®¶æ—çš„ä¸€å‘˜ï¼ŒFilebeat æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—ä¼ è¾“å·¥å…·ï¼Œå®ƒçš„å­˜åœ¨æ­£å¼¥è¡¥äº† Logstash çš„ç¼ºç‚¹ï¼ŒFilebeat ä½œä¸ºä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—ä¼ è¾“å·¥å…·å¯ä»¥å°†æ—¥å¿—æ¨é€åˆ° Kafkaã€Logstashã€ElasticSearchã€Redisã€‚å®ƒçš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-13-030138.jpg" alt=""></p><p><strong>ä¼˜åŠ¿</strong>ï¼šFilebeat åªæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰ä»»ä½•ä¾èµ–ã€‚å®ƒå ç”¨èµ„æºæå°‘ï¼Œå°½ç®¡å®ƒè¿˜ååˆ†å¹´è½»ï¼Œæ­£å¼å› ä¸ºå®ƒç®€å•ï¼Œæ‰€ä»¥å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå¯ä»¥å‡ºé”™çš„åœ°æ–¹ï¼Œæ‰€ä»¥å®ƒçš„å¯é æ€§è¿˜æ˜¯å¾ˆé«˜çš„ã€‚å®ƒä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¤šå¯ä»¥è°ƒèŠ‚çš„ç‚¹ï¼Œä¾‹å¦‚ï¼šå®ƒä»¥ä½•ç§æ–¹å¼æœç´¢æ–°çš„æ–‡ä»¶ï¼Œä»¥åŠå½“æ–‡ä»¶æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä½•æ—¶é€‰æ‹©å…³é—­æ–‡ä»¶å¥æŸ„ã€‚</p><p><strong>åŠ£åŠ¿</strong>ï¼šFilebeat çš„åº”ç”¨èŒƒå›´ååˆ†æœ‰é™ï¼Œæ‰€ä»¥åœ¨æŸäº›åœºæ™¯ä¸‹æˆ‘ä»¬ä¼šç¢°åˆ°é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨ Logstash ä½œä¸ºä¸‹æ¸¸ç®¡é“ï¼Œæˆ‘ä»¬åŒæ ·ä¼šé‡åˆ°æ€§èƒ½é—®é¢˜ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒFilebeat çš„èŒƒå›´åœ¨æ‰©å¤§ã€‚å¼€å§‹æ—¶ï¼Œå®ƒåªèƒ½å°†æ—¥å¿—å‘é€åˆ° Logstash å’Œ Elasticsearchï¼Œè€Œç°åœ¨å®ƒå¯ä»¥å°†æ—¥å¿—å‘é€ç»™ Kafka å’Œ Redisï¼Œåœ¨ 5.x ç‰ˆæœ¬ä¸­ï¼Œå®ƒè¿˜å…·å¤‡è¿‡æ»¤çš„èƒ½åŠ›ã€‚</p><h4 id="Fluentd"><a href="#Fluentd" class="headerlink" title="Fluentd"></a>Fluentd</h4><p>Fluentd åˆ›å»ºçš„åˆè¡·ä¸»è¦æ˜¯å°½å¯èƒ½çš„ä½¿ç”¨ JSON ä½œä¸ºæ—¥å¿—è¾“å‡ºï¼Œæ‰€ä»¥ä¼ è¾“å·¥å…·åŠå…¶ä¸‹æ¸¸çš„ä¼ è¾“çº¿ä¸éœ€è¦çŒœæµ‹å­å­—ç¬¦ä¸²é‡Œé¢å„ä¸ªå­—æ®µçš„ç±»å‹ã€‚è¿™æ ·å®ƒä¸ºå‡ ä¹æ‰€æœ‰çš„è¯­è¨€éƒ½æä¾›åº“ï¼Œè¿™ä¹Ÿæ„å‘³ç€å¯ä»¥å°†å®ƒæ’å…¥åˆ°è‡ªå®šä¹‰çš„ç¨‹åºä¸­ã€‚å®ƒçš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-13-031337.png" alt=""></p><p><strong>ä¼˜åŠ¿</strong>ï¼šå’Œå¤šæ•° Logstash æ’ä»¶ä¸€æ ·ï¼ŒFluentd æ’ä»¶æ˜¯ç”¨ Ruby è¯­è¨€å¼€å‘çš„éå¸¸æ˜“äºç¼–å†™ç»´æŠ¤ã€‚æ‰€ä»¥å®ƒæ•°é‡å¾ˆå¤šï¼Œå‡ ä¹æ‰€æœ‰çš„æºå’Œç›®æ ‡å­˜å‚¨éƒ½æœ‰æ’ä»¶(å„ä¸ªæ’ä»¶çš„æˆç†Ÿåº¦ä¹Ÿä¸å¤ªä¸€æ ·)ã€‚è¿™ä¹Ÿæ„å‘³è¿™å¯ä»¥ç”¨ Fluentd æ¥ä¸²è”æ‰€æœ‰çš„ä¸œè¥¿ã€‚</p><p><strong>åŠ£åŠ¿</strong>ï¼šå› ä¸ºåœ¨å¤šæ•°åº”ç”¨åœºæ™¯ä¸‹å¾—åˆ° Fluentd ç»“æ„åŒ–çš„æ•°æ®ï¼Œå®ƒçš„çµæ´»æ€§å¹¶ä¸å¥½ã€‚ä½†æ˜¯ä»ç„¶å¯ä»¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥è§£æéç»“æ„åŒ–çš„æ•°æ®ã€‚å°½ç®¡æ€§èƒ½åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹éƒ½å¾ˆå¥½ï¼Œä½†å®ƒå¹¶ä¸æ˜¯æœ€å¥½çš„ï¼Œå®ƒçš„ç¼“å†²åªå­˜åœ¨ä¸è¾“å‡ºç«¯ï¼Œå•çº¿ç¨‹æ ¸å¿ƒä»¥åŠ Ruby GIL å®ç°çš„æ’ä»¶æ„å‘³ç€å®ƒå¤§çš„èŠ‚ç‚¹ä¸‹æ€§èƒ½æ˜¯å—é™çš„ã€‚</p><h4 id="Logagent"><a href="#Logagent" class="headerlink" title="Logagent"></a>Logagent</h4><p>Logagent æ˜¯ Sematext æä¾›çš„ä¼ è¾“å·¥å…·ï¼Œå®ƒç”¨æ¥å°†æ—¥å¿—ä¼ è¾“åˆ° Logsene(ä¸€ä¸ªåŸºäº SaaS å¹³å°çš„ Elasticsearch API)ï¼Œå› ä¸º Logsene ä¼šæš´éœ² Elasticsearch APIï¼Œæ‰€ä»¥ Logagent å¯ä»¥å¾ˆå®¹æ˜“å°†æ•°æ®æ¨é€åˆ° Elasticsearch ã€‚</p><p><strong>ä¼˜åŠ¿</strong>ï¼šå¯ä»¥è·å– /var/log ä¸‹çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè§£æå„ç§æ ¼å¼çš„æ—¥å¿—ï¼Œå¯ä»¥æ©ç›–æ•æ„Ÿçš„æ•°æ®ä¿¡æ¯ã€‚å®ƒè¿˜å¯ä»¥åŸºäº IP åš GeoIP ä¸°å¯Œåœ°ç†ä½ç½®ä¿¡æ¯ã€‚åŒæ ·ï¼Œå®ƒè½»é‡åˆå¿«é€Ÿï¼Œå¯ä»¥å°†å…¶ç½®å…¥ä»»ä½•æ—¥å¿—å—ä¸­ã€‚Logagent æœ‰æœ¬åœ°ç¼“å†²ï¼Œæ‰€ä»¥åœ¨æ•°æ®ä¼ è¾“ç›®çš„åœ°ä¸å¯ç”¨æ—¶ä¸ä¼šä¸¢å¤±æ—¥å¿—ã€‚</p><p><strong>åŠ£åŠ¿</strong>ï¼šæ²¡æœ‰ Logstash çµæ´»ã€‚</p><h3 id="11-5-3-æ—¥å¿—ç»“æ„è®¾è®¡"><a href="#11-5-3-æ—¥å¿—ç»“æ„è®¾è®¡" class="headerlink" title="11.5.3 æ—¥å¿—ç»“æ„è®¾è®¡"></a>11.5.3 æ—¥å¿—ç»“æ„è®¾è®¡</h3><p>å‰é¢ä»‹ç»äº†æ—¥å¿—å’Œå¯¹æ¯”äº†å¸¸ç”¨æ—¥å¿—é‡‡é›†å·¥å…·çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿ï¼Œé€šå¸¸åœ¨ä¸åŒç¯å¢ƒï¼Œä¸åŒæœºå™¨ä¸Šéƒ½ä¼šéƒ¨ç½²æ—¥å¿—é‡‡é›†å·¥å…·ï¼Œç„¶åé‡‡é›†å·¥å…·ä¼šå®æ—¶çš„å°†æ–°çš„æ—¥å¿—é‡‡é›†å‘é€åˆ°ä¸‹æ¸¸ï¼Œå› ä¸ºæ—¥å¿—æ•°æ®é‡æ¯•ç«Ÿå¤§ï¼Œæ‰€ä»¥å»ºè®®å‘åˆ° MQ ä¸­ï¼Œæ¯”å¦‚ Kafkaï¼Œè¿™æ ·å†æƒ³æ€ä¹ˆå¤„ç†è¿™äº›æ—¥å¿—å°±ä¼šæ¯”è¾ƒçµæ´»ã€‚å‡è®¾æˆ‘ä»¬å¿½ç•¥åº•å±‚é‡‡é›†å…·ä½“æ˜¯å“ªç§ï¼Œä½†æ˜¯è§„å®šé‡‡é›†å¥½çš„æ—¥å¿—ç»“æ„åŒ–æ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String type;<span class="comment">//æ—¥å¿—çš„ç±»å‹(åº”ç”¨ã€å®¹å™¨ã€...)</span></span><br><span class="line">    <span class="keyword">private</span> Long timestamp;<span class="comment">//æ—¥å¿—çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">private</span> String level;<span class="comment">//æ—¥å¿—çš„çº§åˆ«(debug/info/warn/error)</span></span><br><span class="line">    <span class="keyword">private</span> String message;<span class="comment">//æ—¥å¿—å†…å®¹</span></span><br><span class="line">    <span class="comment">//æ—¥å¿—çš„æ ‡è¯†(åº”ç”¨ IDã€åº”ç”¨åã€å®¹å™¨ IDã€æœºå™¨ IPã€é›†ç¾¤åã€...)</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; tags = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¸Šé¢è¿™ç§ LogEvent çš„æ•°æ®ï¼ˆå‡è®¾é‡‡é›†å‘ä¸Šæ¥çš„æ˜¯è¿™ç§ç»“æ„æ•°æ®çš„ JSON ä¸²ï¼Œæ‰€ä»¥éœ€è¦åœ¨ Flink ä¸­åšä¸€ä¸ªååºåˆ—åŒ–è§£æï¼‰å°±ä¼šå¾€ Kafka ä¸æ–­çš„å‘é€æ•°æ®ï¼Œæ ·ä¾‹æ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"type"</span>: <span class="string">"app"</span>,</span><br><span class="line"><span class="attr">"timestamp"</span>: <span class="number">1570941591229</span>,</span><br><span class="line"><span class="attr">"level"</span>: <span class="string">"error"</span>,</span><br><span class="line"><span class="attr">"message"</span>: <span class="string">"Exception in thread \"main\" java.lang.NoClassDefFoundError: org/apache/flink/api/common/ExecutionConfig$GlobalJobParameters"</span>,</span><br><span class="line"><span class="attr">"tags"</span>: &#123;</span><br><span class="line"><span class="attr">"cluster_name"</span>: <span class="string">"zhisheng"</span>,</span><br><span class="line"><span class="attr">"app_name"</span>: <span class="string">"zhisheng"</span>,</span><br><span class="line"><span class="attr">"host_ip"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line"><span class="attr">"app_id"</span>: <span class="string">"21"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨ Flink ä¸­å¦‚ä½•å°†åº”ç”¨å¼‚å¸¸æˆ–è€…é”™è¯¯çš„æ—¥å¿—åšå®æ—¶å‘Šè­¦å‘¢ï¼Ÿ</p><h3 id="11-5-4-å¼‚å¸¸æ—¥å¿—å®æ—¶å‘Šè­¦é¡¹ç›®æ¶æ„"><a href="#11-5-4-å¼‚å¸¸æ—¥å¿—å®æ—¶å‘Šè­¦é¡¹ç›®æ¶æ„" class="headerlink" title="11.5.4 å¼‚å¸¸æ—¥å¿—å®æ—¶å‘Šè­¦é¡¹ç›®æ¶æ„"></a>11.5.4 å¼‚å¸¸æ—¥å¿—å®æ—¶å‘Šè­¦é¡¹ç›®æ¶æ„</h3><p>æ•´ä¸ªå¼‚å¸¸æ—¥å¿—å®æ—¶å‘Šè­¦é¡¹ç›®çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-13-035811.png" alt=""></p><p>åº”ç”¨æ—¥å¿—æ•£åˆ—åœ¨ä¸åŒçš„æœºå™¨ï¼Œç„¶åæ¯å°æœºå™¨éƒ½æœ‰éƒ¨ç½²é‡‡é›†æ—¥å¿—çš„ Agentï¼ˆå¯ä»¥æ˜¯ä¸Šé¢çš„ Filebeatã€Logstash ç­‰ï¼‰ï¼Œè¿™äº› Agent ä¼šå®æ—¶çš„å°†åˆ†æ•£åœ¨ä¸åŒæœºå™¨ã€ä¸åŒç¯å¢ƒçš„åº”ç”¨æ—¥å¿—ç»Ÿä¸€çš„é‡‡é›†å‘åˆ° Kafka é›†ç¾¤ä¸­ï¼Œç„¶åå‘Šè­¦è¿™è¾¹æ˜¯æœ‰ä¸€ä¸ª Flink ä½œä¸šå»å®æ—¶çš„æ¶ˆè´¹ Kafka æ•°æ®åšä¸€ä¸ªå¼‚å¸¸å‘Šè­¦è®¡ç®—å¤„ç†ã€‚å¦‚æœè¿˜æƒ³åšæ—¥å¿—çš„æœç´¢åˆ†æï¼Œå¯ä»¥èµ·å¦å¤–ä¸€ä¸ªä½œä¸šå»å®æ—¶çš„å°† Kafka çš„æ—¥å¿—æ•°æ®å†™å…¥è¿› ElasticSearchï¼Œå†é€šè¿‡ Kibana é¡µé¢åšæœç´¢å’Œåˆ†æã€‚</p><h3 id="11-5-5-æ—¥å¿—æ•°æ®å‘é€åˆ°-Kafka"><a href="#11-5-5-æ—¥å¿—æ•°æ®å‘é€åˆ°-Kafka" class="headerlink" title="11.5.5 æ—¥å¿—æ•°æ®å‘é€åˆ° Kafka"></a>11.5.5 æ—¥å¿—æ•°æ®å‘é€åˆ° Kafka</h3><p>ä¸Šé¢å·²ç»è®²äº†æ—¥å¿—æ•°æ® LogEvent çš„ç»“æ„å’Œæ ·ä¾‹æ•°æ®ï¼Œå› ä¸ºè¦åœ¨æœåŠ¡å™¨éƒ¨ç½²é‡‡é›†å·¥å…·å»é‡‡é›†åº”ç”¨æ—¥å¿—æ•°æ®å¯¹äºæœ¬åœ°æµ‹è¯•æ¥è¯´å¯èƒ½ç¨å¾®å¤æ‚ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå°±åªé€šè¿‡ä»£ç æ¨¡æ‹Ÿæ„é€ æ•°æ®å‘åˆ° Kafka å»ï¼Œç„¶ååœ¨ Flink ä½œä¸šä¸­å»å®æ—¶æ¶ˆè´¹ Kafka ä¸­çš„æ•°æ®ï¼Œä¸‹é¢æ¼”ç¤ºæ„é€ æ—¥å¿—æ•°æ®å‘åˆ° Kafka çš„å·¥å…·ç±»ï¼Œè¿™ä¸ªå·¥å…·ç±»ä¸»è¦åˆ†ä¸¤å—ï¼Œæ„é€  LogEvent æ•°æ®å’Œå‘é€åˆ° Kafkaã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuildLogEventDataUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Kafka broker å’Œ topic ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BROKER_LIST = <span class="string">"localhost:9092"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TOPIC = <span class="string">"zhisheng_log"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeDataToKafka</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.put(<span class="string">"bootstrap.servers"</span>, BROKER_LIST);</span><br><span class="line">        props.put(<span class="string">"key.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        props.put(<span class="string">"value.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        KafkaProducer producer = <span class="keyword">new</span> KafkaProducer&lt;String, String&gt;(props);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//æ¨¡æ‹Ÿæ„é€  LogEvent å¯¹è±¡</span></span><br><span class="line">            LogEvent logEvent = <span class="keyword">new</span> LogEvent().builder()</span><br><span class="line">                    .type(<span class="string">"app"</span>)</span><br><span class="line">                    .timestamp(System.currentTimeMillis())</span><br><span class="line">                    .level(logLevel())</span><br><span class="line">                    .message(message(i + <span class="number">1</span>))</span><br><span class="line">                    .tags(mapData())</span><br><span class="line">                    .build();</span><br><span class="line"><span class="comment">//            System.out.println(logEvent);</span></span><br><span class="line">            ProducerRecord record = <span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(LOG_TOPIC, <span class="keyword">null</span>, <span class="keyword">null</span>, GsonUtil.toJson(logEvent));</span><br><span class="line">            producer.send(record);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        writeDataToKafka();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">message</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"è¿™æ˜¯ç¬¬ "</span> + i + <span class="string">" è¡Œæ—¥å¿—ï¼"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">logLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> number = random.nextInt(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">switch</span> (number) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"debug"</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"info"</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"warn"</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"info"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">hostIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> number = random.nextInt(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">switch</span> (number) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"121.12.17.10"</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"121.12.17.11"</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"121.12.17.12"</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"121.12.17.13"</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"121.12.17.10"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">mapData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"app_id"</span>, <span class="string">"11"</span>);</span><br><span class="line">        map.put(<span class="string">"app_name"</span>, <span class="string">"zhisheng"</span>);</span><br><span class="line">        map.put(<span class="string">"cluster_name"</span>, <span class="string">"zhisheng"</span>);</span><br><span class="line">        map.put(<span class="string">"host_ip"</span>, hostIp());</span><br><span class="line">        map.put(<span class="string">"class"</span>, <span class="string">"BuildLogEventDataUtil"</span>);</span><br><span class="line">        map.put(<span class="string">"method"</span>, <span class="string">"main"</span>);</span><br><span class="line">        map.put(<span class="string">"line"</span>, String.valueOf(<span class="keyword">new</span> Random().nextInt(<span class="number">100</span>)));</span><br><span class="line">        <span class="comment">//add more tag</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¹‹å‰ Kafka ä¸­æ²¡æœ‰ zhisheng_log è¿™ä¸ª topicï¼Œè¿è¡Œè¿™ä¸ªå·¥å…·ç±»ä¹‹åä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ª topic äº†ã€‚</p><h3 id="11-5-6-Flink-å®æ—¶å¤„ç†æ—¥å¿—æ•°æ®"><a href="#11-5-6-Flink-å®æ—¶å¤„ç†æ—¥å¿—æ•°æ®" class="headerlink" title="11.5.6 Flink å®æ—¶å¤„ç†æ—¥å¿—æ•°æ®"></a>11.5.6 Flink å®æ—¶å¤„ç†æ—¥å¿—æ•°æ®</h3><h3 id="11-5-7-å¤„ç†åº”ç”¨å¼‚å¸¸æ—¥å¿—"><a href="#11-5-7-å¤„ç†åº”ç”¨å¼‚å¸¸æ—¥å¿—" class="headerlink" title="11.5.7 å¤„ç†åº”ç”¨å¼‚å¸¸æ—¥å¿—"></a>11.5.7 å¤„ç†åº”ç”¨å¼‚å¸¸æ—¥å¿—</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/RBYj66M">https://t.zsxq.com/RBYj66M</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p><p>æœ¬ç« å±äº Flink å®æˆ˜ç¯‡ï¼Œå‰é¢ç« èŠ‚è®²äº†å¾ˆå¤š Flink ç›¸å…³çš„æŠ€æœ¯çŸ¥è¯†ç‚¹ï¼Œè¿™ç« ä¸»è¦æ˜¯é€šè¿‡æŠ€æœ¯ç‚¹æ¥æ•™å¤§å®¶å¦‚ä½•å»å®Œæˆä¸€äº›çœŸå®çš„éœ€æ±‚ï¼Œæ¯”å¦‚é€šè¿‡ State å»å®æ—¶ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©çš„ PV å’Œ UVã€é€šè¿‡ ProcessFunction å»åšå®šæ—¶å™¨å¤„ç†ä¸€äº›å»¶è¿Ÿçš„äº‹ä»¶ï¼ˆå®•æœºå‘Šè­¦ï¼‰ã€é€šè¿‡ Async IO è¯»å–å‘Šè­¦è§„åˆ™ã€é€šè¿‡å¹¿æ’­å˜é‡åŠ¨æ€çš„æ›´æ–°å‘Šè­¦è§„åˆ™ã€å¦‚ä½•å®æ—¶çš„åšåˆ°æ—¥å¿—å‘Šè­¦ã€‚</p><p>è™½ç„¶è¿™äº›éœ€æ±‚æ¢åˆ°ä½ ä»¬å…¬å¸å»å¯èƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯è¿™äº›æŠ€æœ¯çŸ¥è¯†ç‚¹æ˜¯å¯ä»¥è¿ç”¨åˆ°ä½ çš„é¡¹ç›®éœ€æ±‚ä¸­å»çš„ï¼Œè¿™é‡Œä»‹ç»çš„è¿™äº›éœ€æ±‚ï¼Œä½ è¦å­¦ä¼šå»åˆ†æï¼Œç„¶åå»åˆ¤æ–­è¿™äº›éœ€æ±‚åˆ°åº•è¯¥ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯æ¥å®ç°ä¼šæ›´å¥½ï¼Œè¿™æ ·æ‰å¯ä»¥åšåˆ°æ´»å­¦æ´»ç”¨ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;11-5-å¦‚ä½•å®æ—¶å°†åº”ç”¨-Error-æ—¥å¿—å‘Šè­¦ï¼Ÿ&quot;&gt;&lt;a href=&quot;#11-5-å¦‚ä½•å®æ—¶å°†åº”ç”¨-Error-æ—¥å¿—å‘Šè­¦ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;11.5 å¦‚ä½•å®æ—¶å°†åº”ç”¨ Error æ—¥å¿—å‘Šè­¦ï¼Ÿ&quot;&gt;&lt;/a&gt;11.5 å¦‚ä½•å®æ—¶å°†åº”ç”¨ Error æ—¥å¿—å‘Šè­¦ï¼Ÿ&lt;/h2&gt;&lt;p&gt;å¤§æ•°æ®æ—¶ä»£ï¼Œéšç€å…¬å¸ä¸šåŠ¡ä¸æ–­çš„å¢é•¿ï¼Œæ•°æ®é‡è‡ªç„¶ä¹Ÿä¼šè·Ÿç€ä¸æ–­çš„å¢é•¿ï¼Œé‚£ä¹ˆä¸šåŠ¡åº”ç”¨å’Œé›†ç¾¤æœåŠ¡å™¨çš„çš„è§„æ¨¡ä¹Ÿä¼šé€æ¸æ‰©å¤§ï¼Œå‡ ç™¾å°æœåŠ¡å™¨åœ¨ä¸€èˆ¬çš„å…¬å¸å·²ç»æ˜¯å¾ˆå¸¸è§çš„äº†ã€‚é‚£ä¹ˆå°†åº”ç”¨æœåŠ¡éƒ¨ç½²åœ¨å¦‚æ­¤å¤šçš„æœåŠ¡å™¨ä¸Šï¼Œå¯¹å¼€å‘å’Œè¿ç»´äººå‘˜æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚ä¸€ä¸ªä¼˜ç§€çš„ç³»ç»Ÿè¿ç»´å¹³å°æ˜¯éœ€è¦å°†éƒ¨ç½²åœ¨è¿™ä¹ˆå¤šæœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç›‘æ§ä¿¡æ¯æ±‡æ€»æˆä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®å±•ç¤ºå¹³å°ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜åšæ—¥å¸¸çš„ç›‘æµ‹ã€æå‡è¿ç»´æ•ˆç‡ï¼Œè¿˜å¯ä»¥åŠæ—¶åé¦ˆåº”ç”¨çš„è¿è¡ŒçŠ¶æ€ç»™åº”ç”¨å¼€å‘äººå‘˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåº”ç”¨çš„è¿è¡Œæ—¥å¿—éœ€è¦æŒ‰ç…§æ—¶é—´æ’åºåšä¸€ä¸ªå±•ç¤ºï¼Œå¹¶ä¸”æä¾›æ—¥å¿—ä¸‹è½½å’Œæ—¥å¿—æœç´¢ç­‰æœåŠ¡ï¼Œè¿™æ ·å¦‚æœåº”ç”¨å‡ºç°é—®é¢˜å¼€å‘äººå‘˜é¦–å…ˆå¯ä»¥æ ¹æ®åº”ç”¨æ—¥å¿—çš„é”™è¯¯ä¿¡æ¯è¿›è¡Œé—®é¢˜çš„æ’æŸ¥ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•å®æ—¶çš„å°†åº”ç”¨çš„ Error æ—¥å¿—æ¨é€ç»™åº”ç”¨å¼€å‘äººå‘˜å‘¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è®²è§£æ—¥å¿—çš„å¤„ç†æ–¹æ¡ˆã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/17/flink-in-action-11.4/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/17/flink-in-action-11.4/</id>
    <published>2021-08-16T16:00:00.000Z</published>
    <updated>2022-02-07T14:05:22.257Z</updated>
    
    <content type="html"><![CDATA[<h2 id="11-4-å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ"><a href="#11-4-å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ" class="headerlink" title="11.4 å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ"></a>11.4 å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ</h2><p>ä¸€ä¸ªåœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œçš„æµä½œä¸šæœ‰æ—¶å€™ä¼šæƒ³å˜æ›´ä¸€äº›ä½œä¸šçš„é…ç½®æˆ–è€…æ•°æ®æµçš„é…ç½®ï¼Œç„¶åä½œä¸šå¯ä»¥è¯»å–å¹¶ä½¿ç”¨æ–°çš„é…ç½®ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¿®æ”¹é…ç½®ç„¶åé‡å¯ä½œä¸šæ¥è¯»å–é…ç½®ï¼Œæ¯•ç«Ÿé‡å¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„æµä½œä¸šä»£ä»·æŒºå¤§ï¼Œæœ¬èŠ‚å°†å¸¦ä½ ç†Ÿæ‚‰ Broadcastï¼Œå¹¶é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥æ•™ä¼šä½ å¦‚ä½•å»åŠ¨æ€çš„æ›´æ–°ä½œä¸šçš„é…ç½®ã€‚</p><a id="more"></a><h3 id="11-4-1-BroadcastVariable-ç®€ä»‹"><a href="#11-4-1-BroadcastVariable-ç®€ä»‹" class="headerlink" title="11.4.1 BroadcastVariable ç®€ä»‹"></a>11.4.1 BroadcastVariable ç®€ä»‹</h3><p>BroadcastVariable ä¸­æ–‡æ„æ€æ˜¯å¹¿æ’­å˜é‡ï¼Œå…¶å®å¯ä»¥ç†è§£æ˜¯ä¸€ä¸ªå…¬å…±çš„å…±äº«å˜é‡ï¼ˆå¯èƒ½æ˜¯å›ºå®šä¸å˜çš„æ•°æ®é›†åˆï¼Œä¹Ÿå¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„æ•°æ®é›†åˆï¼‰ï¼Œåœ¨ä½œä¸šä¸­å°†è¯¥å…±äº«å˜é‡å¹¿æ’­å‡ºå»ï¼Œç„¶åä¸‹æ¸¸çš„æ‰€æœ‰ä»»åŠ¡éƒ½å¯ä»¥è·å–åˆ°è¯¥å…±äº«å˜é‡ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨å°†è¿™ä¸ªå˜é‡æ‹·è´åˆ°ä¸‹æ¸¸çš„æ¯ä¸ªä»»åŠ¡ä¸­ã€‚ä¹‹æ‰€ä»¥è®¾è®¡è¿™ä¸ªå¹¿æ’­å˜é‡çš„åŸå› ä¸»è¦æ˜¯å› ä¸ºåœ¨ Flink ä¸­å¤šå¹¶è¡Œåº¦çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç®—å­æˆ–è€…ä¸åŒç®—å­è¿è¡Œæ‰€åœ¨çš„ Slot ä¸ä¸€è‡´ï¼Œè¿™å°±å¯¼è‡´å®ƒä»¬ä¸ä¼šå…±äº«åŒä¸€ä¸ªå†…å­˜ï¼Œä¹Ÿå°±ä¸å¯ä»¥é€šè¿‡é™æ€å˜é‡çš„æ–¹å¼å»è·å–è¿™äº›å…±äº«å˜é‡å€¼ã€‚å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸å°‘è¯»è€…åœ¨é—®è¿‡æˆ‘ä¸ºå•¥æˆ‘è®¾ç½®çš„é™æ€å˜é‡å€¼åœ¨æœ¬åœ°è¿è¡Œæ˜¯å¯ä»¥è·å–åˆ°çš„ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒè¿è¡Œä½œä¸šå°±å‡ºç°ç©ºæŒ‡é’ˆå•Šï¼Œè¯¥é—®é¢˜å…¶å®ç¬”è€…è‡ªå·±ä¹Ÿåœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°è¿‡ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å¥½å¥½æ•™å¤§å®¶ä½¿ç”¨ï¼</p><h3 id="11-4-2-å¦‚ä½•ä½¿ç”¨-BroadcastVariable-ï¼Ÿ"><a href="#11-4-2-å¦‚ä½•ä½¿ç”¨-BroadcastVariable-ï¼Ÿ" class="headerlink" title="11.4.2 å¦‚ä½•ä½¿ç”¨ BroadcastVariable ï¼Ÿ"></a>11.4.2 å¦‚ä½•ä½¿ç”¨ BroadcastVariable ï¼Ÿ</h3><p>åœ¨ 3.4 èŠ‚ä¸­è®²è¿‡å¦‚ä½• broadcast ç®—å­å’Œ BroadcastStream å¦‚ä½•ä½¿ç”¨ï¼Œåœ¨ 4.1 èŠ‚ä¸­è®²è§£äº† Broadcast State å¦‚ä½•ä½¿ç”¨ä»¥åŠéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œæ³¨æ„ BroadcastVariable åªèƒ½åº”ç”¨åœ¨æ‰¹ä½œä¸šä¸­ï¼Œå¦‚æœè¦åº”ç”¨åœ¨æµä½œä¸šä¸­åˆ™éœ€è¦è¦ä½¿ç”¨ BroadcastStreamã€‚</p><p>åœ¨æ‰¹ä½œä¸šä¸­é€šè¿‡ä½¿ç”¨ <code>withBroadcastSet(DataSet, String)</code> æ¥å¹¿æ’­ä¸€ä¸ª DataSet æ•°æ®é›†åˆï¼Œå¹¶å¯ä»¥ç»™è¿™ä»½æ•°æ®èµ·ä¸ªåå­—ï¼Œå¦‚æœè¦è·å–æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ <code>getRuntimeContext().getBroadcastVariable(String)</code> è·å–å¹¿æ’­å‡ºå»çš„å˜é‡æ•°æ®ã€‚ä¸‹é¢æ¼”ç¤ºä¸€ä¸‹å¹¿æ’­ä¸€ä¸ª DataSet å˜é‡å’Œè·å–å˜é‡çš„æ ·ä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ParameterTool params = ParameterTool.fromArgs(args);</span><br><span class="line"><span class="keyword">final</span> ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line"><span class="comment">//1. å¾…å¹¿æ’­çš„æ•°æ®</span></span><br><span class="line">DataSet&lt;Integer&gt; toBroadcast = env.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">env.fromElements(<span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">        .map(<span class="keyword">new</span> RichMapFunction&lt;String, String&gt;() &#123;</span><br><span class="line">            List&lt;Integer&gt; broadcastData;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 3. è·å–å¹¿æ’­çš„ DataSet æ•°æ® ä½œä¸ºä¸€ä¸ª Collection</span></span><br><span class="line">                broadcastData = getRuntimeContext().getBroadcastVariable(<span class="string">"zhisheng"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> broadcastData.get(<span class="number">1</span>) + value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).withBroadcastSet(toBroadcast, <span class="string">"zhisheng"</span>)<span class="comment">// 2. å¹¿æ’­ DataSet</span></span><br><span class="line">        .print();</span><br></pre></td></tr></table></figure><p>æ³¨æ„å¹¿æ’­çš„æ—¶å€™è®¾ç½®çš„åç§°å’Œè·å–çš„åç§°è¦ä¸€è‡´ï¼Œç„¶åè¿è¡Œçš„ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-17-013429.png" alt=""></p><p>æµä½œä¸šä¸­é€šå¸¸ä½¿ç”¨ BroadcastStream çš„æ–¹å¼å°†å˜é‡é›†åˆåœ¨æ•°æ®æµä¸­ä¼ é€’ï¼Œå¯èƒ½æ•°æ®é›†åˆä¼šåšä¿®æ”¹æ›´æ–°ï¼Œä½†æ˜¯ä¿®æ”¹åå…¶å®å¹¶ä¸æƒ³é‡å¯ä½œä¸šå»è¯»å–è¿™äº›æ–°ä¿®æ”¹çš„é…ç½®ï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªæµä½œä¸šæ¥è¯´é‡å¯å¸¦æ¥çš„ä»£ä»·å¾ˆé«˜ï¼ˆéœ€è¦è€ƒè™‘æ•°æ®å †ç§¯å’Œå¦‚ä½•æ¢å¤è‡³é‡å¯å‰çš„çŠ¶æ€ç­‰é—®é¢˜ï¼‰ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹å°±å¯ä»¥åœ¨å¹¿æ’­æ•°æ®æµå¤„å®šæ—¶æŸ¥è¯¢æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å¤Ÿè·å–æ›´æ”¹åçš„æ•°æ®ï¼Œé€šå¸¸åœ¨è¿™ç§å¹¿æ’­æ•°æ®å¤„è·å–æ•°æ®åªéœ€è¦è®¾ç½®ä¸€ä¸ªå¹¶è¡Œåº¦å°±å¥½ï¼Œæ—¶é—´æ ¹æ®éœ€æ±‚æ¥åˆ¤æ–­åŠæ—¶æ€§ï¼Œä¸€èˆ¬ 1 åˆ†é’Ÿå†…çš„æ•°æ®å˜æ›´å»¶è¿Ÿéƒ½æ˜¯åœ¨å®¹å¿èŒƒå›´ä¹‹å†…ã€‚å¹¿æ’­æµä¸­çš„å…ƒç´ ä¿è¯æµæ‰€æœ‰çš„å…ƒç´ æœ€ç»ˆéƒ½ä¼šå‘åˆ°ä¸‹æ¸¸çš„æ‰€æœ‰å¹¶è¡Œå®ä¾‹ï¼Œä½†æ˜¯å…ƒç´ åˆ°è¾¾ä¸‹æ¸¸çš„å¹¶è¡Œå®ä¾‹çš„é¡ºåºå¯èƒ½ä¸ç›¸åŒã€‚å› æ­¤ï¼Œå¯¹å¹¿æ’­çŠ¶æ€çš„ä¿®æ”¹ä¸èƒ½ä¾èµ–äºè¾“å…¥æ•°æ®çš„é¡ºåºã€‚åœ¨è¿›è¡Œ Checkpoint æ—¶ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼š Checkpoint ä¸‹å®ƒä»¬çš„å¹¿æ’­çŠ¶æ€ã€‚</p><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¹¿æ’­å‡ºå»çš„å˜é‡å­˜åœ¨äºæ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªæ•°æ®é›†ä¸èƒ½å¤ªå¤§ï¼Œå› ä¸ºå¹¿æ’­å‡ºå»çš„æ•°æ®ï¼Œä¼šä¸€è‡´åœ¨å†…å­˜ä¸­å­˜åœ¨ï¼Œé™¤éç¨‹åºæ‰§è¡Œç»“æŸã€‚ä¸ªäººå»ºè®®ï¼šå¦‚æœæ•°æ®é›†åœ¨å‡ åå…†æˆ–è€…ç™¾å…†çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©è¿›è¡Œå¹¿æ’­ï¼Œå¦‚æœæ•°æ®é›†çš„å¤§å°ä¸Š G çš„è¯ï¼Œå°±ä¸å»ºè®®è¿›è¡Œå¹¿æ’­äº†ã€‚</p><p>ä¸Šé¢ä»‹ç»äº†ä¸‹å¹¿æ’­å˜é‡çš„åœ¨æ‰¹ä½œä¸šçš„ä½¿ç”¨æ–¹å¼ï¼Œä¸‹é¢é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥æ•™å¤§å®¶å¦‚ä½•åœ¨æµä½œä¸šä¸­ä½¿ç”¨å¹¿æ’­å˜é‡ã€‚</p><h3 id="11-4-3-åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™æ•°æ®éœ€æ±‚åˆ†æ"><a href="#11-4-3-åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™æ•°æ®éœ€æ±‚åˆ†æ" class="headerlink" title="11.4.3 åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™æ•°æ®éœ€æ±‚åˆ†æ"></a>11.4.3 åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™æ•°æ®éœ€æ±‚åˆ†æ</h3><p>åœ¨ 11.3.3 èŠ‚ä¸­æœ‰è®¾è®¡ä¸€å¼ ç®€å•çš„å‘Šè­¦è§„åˆ™è¡¨ï¼Œé€šå¸¸å‘Šè­¦è§„åˆ™æ˜¯ä¼šå¯¹å¤–æä¾›æ¥å£è¿›è¡Œå¢åˆ æ”¹æŸ¥çš„ï¼Œé‚£ä¹ˆéšç€ä¸šåŠ¡åº”ç”¨ä¸Šçº¿ï¼Œå¼€å‘äººå‘˜ä¼šå¯¹å…¶åº”ç”¨æœåŠ¡æ–°å¢æˆ–è€…ä¿®æ”¹å‘Šè­¦è§„åˆ™ï¼ˆæ›´æ”¹ä¹‹å‰è§„åˆ™ä¸­çš„é˜ˆå€¼ï¼‰ï¼Œé‚£ä¹ˆæ›´æ”¹ä¹‹åå°±éœ€è¦è®©å‘Šè­¦çš„ä½œä¸šèƒ½å¤Ÿå»æ„ŸçŸ¥åˆ°ä¹‹å‰çš„è§„åˆ™å‘ç”Ÿäº†å˜åŠ¨ï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨ä½œä¸šä¸­æƒ³ä¸ªä»€ä¹ˆåŠæ³•å»è·å–åˆ°æ›´æ”¹åçš„æ•°æ®ã€‚æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è®©ä½œä¸šçŸ¥é“è§„åˆ™çš„å˜æ›´ï¼š push å’Œ pull æ¨¡å¼ã€‚</p><p>push æ¨¡å¼åˆ™éœ€è¦åœ¨æ›´æ–°ã€åˆ é™¤ã€æ–°å¢æ¥å£ä¸­ä¸ä»…æ“ä½œæ•°æ®åº“ï¼Œè¿˜éœ€è¦é¢å¤–çš„å‘é€æ›´æ–°ã€åˆ é™¤ã€æ–°å¢è§„åˆ™çš„äº‹ä»¶åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åä½œä¸šæ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®å†å»åšæ›´æ–°ã€åˆ é™¤ã€æ–°å¢è§„åˆ™ï¼Œè¿™ç§åŠæ—¶æ€§æœ‰ä¿è¯ï¼Œä½†æ˜¯å¯èƒ½ä¼šæœ‰æ•°æ®ä¸ç»Ÿä¸€çš„é£é™©ï¼ˆå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®ä¸¢äº†ï¼Œä½†æ˜¯åœ¨æ¥å£ä¸­è¿˜æ˜¯å°†è§„åˆ™çš„æ•°æ®å˜æ›´å­˜å‚¨åˆ°æ•°æ®åº“ï¼‰ï¼›pull æ¨¡å¼ä¸‹å°±éœ€è¦ä½œä¸šå®šæ—¶å»æŸ¥æ‰¾ä¸€éæ‰€æœ‰çš„å‘Šè­¦è§„åˆ™æ•°æ®ï¼Œç„¶åå­˜åœ¨ä½œä¸šå†…å­˜ä¸­ï¼Œè¿™ä¸ªæ—¶é—´å¯ä»¥è®¾ç½®çš„æ¯”è¾ƒçŸ­ï¼Œæ¯”å¦‚ 1 åˆ†é’Ÿï¼Œè¿™æ ·å°±èƒ½æ—¢ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ—¶é—´å»¶è¿Ÿä¹Ÿæ˜¯åœ¨å®¹å¿èŒƒå›´ä¹‹å†…ã€‚</p><p>å¯¹äºè¿™ç§åŠ¨æ€å˜åŒ–çš„è§„åˆ™æ•°æ®ï¼Œåœ¨ Flink ä¸­é€šå¸¸æ˜¯ä½¿ç”¨å¹¿æ’­æµæ¥å¤„ç†çš„ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ¼”ç¤ºä¸‹å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™æ•°æ®ï¼Œå‡è®¾æˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­æ–°å¢å‘Šè­¦è§„åˆ™æˆ–è€…ä¿®æ”¹å‘Šè­¦è§„åˆ™æŒ‡æ ‡çš„é˜ˆå€¼ï¼Œç„¶åçœ‹ä½œä¸šä¸­æ˜¯å¦ä¼šå‡ºç°ç›¸åº”çš„å˜åŒ–ã€‚</p><h3 id="11-4-4-è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®"><a href="#11-4-4-è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®" class="headerlink" title="11.4.4 è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®"></a>11.4.4 è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®</h3><h3 id="11-4-5-ç›‘æ§æ•°æ®è¿æ¥è§„åˆ™æ•°æ®"><a href="#11-4-5-ç›‘æ§æ•°æ®è¿æ¥è§„åˆ™æ•°æ®" class="headerlink" title="11.4.5 ç›‘æ§æ•°æ®è¿æ¥è§„åˆ™æ•°æ®"></a>11.4.5 ç›‘æ§æ•°æ®è¿æ¥è§„åˆ™æ•°æ®</h3><h3 id="11-4-6-å°ç»“ä¸åæ€"><a href="#11-4-6-å°ç»“ä¸åæ€" class="headerlink" title="11.4.6 å°ç»“ä¸åæ€"></a>11.4.6 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/RBYj66M">https://t.zsxq.com/RBYj66M</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;11-4-å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ&quot;&gt;&lt;a href=&quot;#11-4-å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;11.4 å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ&quot;&gt;&lt;/a&gt;11.4 å¦‚ä½•åˆ©ç”¨å¹¿æ’­å˜é‡åŠ¨æ€æ›´æ–°å‘Šè­¦è§„åˆ™ï¼Ÿ&lt;/h2&gt;&lt;p&gt;ä¸€ä¸ªåœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œçš„æµä½œä¸šæœ‰æ—¶å€™ä¼šæƒ³å˜æ›´ä¸€äº›ä½œä¸šçš„é…ç½®æˆ–è€…æ•°æ®æµçš„é…ç½®ï¼Œç„¶åä½œä¸šå¯ä»¥è¯»å–å¹¶ä½¿ç”¨æ–°çš„é…ç½®ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¿®æ”¹é…ç½®ç„¶åé‡å¯ä½œä¸šæ¥è¯»å–é…ç½®ï¼Œæ¯•ç«Ÿé‡å¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„æµä½œä¸šä»£ä»·æŒºå¤§ï¼Œæœ¬èŠ‚å°†å¸¦ä½ ç†Ÿæ‚‰ Broadcastï¼Œå¹¶é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥æ•™ä¼šä½ å¦‚ä½•å»åŠ¨æ€çš„æ›´æ–°ä½œä¸šçš„é…ç½®ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•åˆ©ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/16/flink-in-action-11.3/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/16/flink-in-action-11.3/</id>
    <published>2021-08-15T16:00:00.000Z</published>
    <updated>2022-02-07T14:03:38.105Z</updated>
    
    <content type="html"><![CDATA[<h2 id="11-3-å¦‚ä½•åˆ©ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ"><a href="#11-3-å¦‚ä½•åˆ©ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ" class="headerlink" title="11.3 å¦‚ä½•åˆ©ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ"></a>11.3 å¦‚ä½•åˆ©ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ</h2><p>Async ä¸­æ–‡æ˜¯å¼‚æ­¥çš„æ„æ€ï¼Œåœ¨æµè®¡ç®—ä¸­ï¼Œä½¿ç”¨å¼‚æ­¥ I/O èƒ½å¤Ÿæå‡ä½œä¸šæ•´ä½“çš„è®¡ç®—èƒ½åŠ›ï¼Œæœ¬èŠ‚ä¸­ä¸ä»…ä¼šè®²è§£å¼‚æ­¥ I/O çš„ API åŸç†ï¼Œè¿˜ä¼šé€šè¿‡ä¸€ä¸ªå®æˆ˜éœ€æ±‚ï¼ˆè¯»å–å‘Šè­¦è§„åˆ™ï¼‰æ¥è®²è§£å¼‚æ­¥ I/O çš„ä½¿ç”¨ã€‚</p><a id="more"></a><h3 id="11-3-1-ä¸ºä»€ä¹ˆéœ€è¦-Async-I-Oï¼Ÿ"><a href="#11-3-1-ä¸ºä»€ä¹ˆéœ€è¦-Async-I-Oï¼Ÿ" class="headerlink" title="11.3.1 ä¸ºä»€ä¹ˆéœ€è¦ Async I/Oï¼Ÿ"></a>11.3.1 ä¸ºä»€ä¹ˆéœ€è¦ Async I/Oï¼Ÿ</h3><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒIO æ“ä½œéƒ½æ˜¯ä¸€ä¸ªè€—æ—¶çš„è¿‡ç¨‹ï¼Œå°¤å…¶åœ¨æµè®¡ç®—ä¸­ï¼Œå¦‚æœåœ¨å…·ä½“çš„ç®—å­é‡Œé¢è¿˜æœ‰å’Œç¬¬ä¸‰æ–¹å¤–éƒ¨ç³»ç»Ÿï¼ˆæ¯”å¦‚æ•°æ®åº“ã€Redisã€HBase ç­‰å­˜å‚¨ç³»ç»Ÿï¼‰åšäº¤äº’ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ª MapFunction ä¸­æ¯æ¥ä¸€æ¡æ•°æ®å°±è¦å»æŸ¥æ‰¾ MySQL ä¸­æŸå¼ è¡¨çš„æ•°æ®ï¼Œç„¶åè·ŸæŸ¥è¯¢å‡ºæ¥çš„æ•°æ®åšå…³è”ï¼ˆåŒæ­¥äº¤äº’ï¼‰ã€‚æŸ¥è¯¢è¯·æ±‚åˆ°æ•°æ®åº“ï¼Œå†åˆ°æ•°æ®åº“å“åº”è¿”å›æ•°æ®çš„æ•´ä¸ªæµç¨‹çš„æ—¶é—´å¯¹äºæµä½œä¸šæ¥è¯´æ˜¯æ¯”è¾ƒé•¿çš„ã€‚é‚£ä¹ˆè¯¥ Map ç®—å­å¤„ç†æ•°æ®çš„é€Ÿåº¦å°±ä¼šé™ä¸‹æ¥ï¼Œåœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹å¾ˆå¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªæµä½œä¸šå‡ºç°åå‹é—®é¢˜ï¼ˆåœ¨ 9.1 èŠ‚ä¸­è®²è¿‡ï¼‰ï¼Œé‚£ä¹ˆæ•´ä¸ªä½œä¸šçš„æ¶ˆè´¹å»¶è¿Ÿå°±ä¼šå¢åŠ ï¼Œå½±å“ä½œä¸šæ•´ä½“ååé‡å’Œå®æ—¶æ€§ï¼Œä»è€Œå¯¼è‡´æœ€ç»ˆè¯¥ä½œä¸šå¤„äºä¸å¯ç”¨çš„çŠ¶æ€ã€‚</p><p>è¿™ç§åŒæ­¥ï¼ˆSyncï¼‰çš„ä¸æ•°æ®åº“åšäº¤äº’æ“ä½œï¼Œä¼šå› è€—æ—¶å¤ªä¹…å¯¼è‡´æ•´ä¸ªä½œä¸šå»¶è¿Ÿï¼Œå¦‚æœæ¢æˆå¼‚æ­¥çš„è¯ï¼Œå°±å¯ä»¥åŒæ—¶å¤„ç†å¾ˆå¤šè¯·æ±‚å¹¶åŒæ—¶å¯ä»¥æ¥æ”¶å“åº”ï¼Œè¿™æ ·çš„è¯ï¼Œç­‰å¾…æ•°æ®åº“å“åº”çš„æ—¶é—´å°±ä¼šä¸å…¶ä»–å‘é€è¯·æ±‚å’Œæ¥æ”¶å“åº”çš„æ—¶é—´é‡å ï¼Œç›¸åŒçš„ç­‰å¾…æ—¶é—´å†…ä¼šå¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œä»è€Œæ¯”åŒæ­¥çš„è®¿é—®è¦æé«˜ä¸å°‘æµå¤„ç†çš„ååé‡ã€‚è™½ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å¢å¤§è¯¥ç®—å­çš„å¹¶è¡Œåº¦å»æ‰§è¡ŒæŸ¥æ•°æ®åº“ï¼Œä½†æ˜¯è¿™ç§è§£å†³åŠæ³•éœ€è¦æ¶ˆè€—æ›´å¤šçš„èµ„æºï¼ˆå¹¶è¡Œåº¦å¢åŠ æ„å‘³ç€æ¶ˆè´¹çš„ slot ä¸ªæ•°ä¹Ÿä¼šå¢åŠ ï¼‰ï¼Œè¿™ç§æ–¹æ³•å’Œä½¿ç”¨å¼‚æ­¥å¤„ç†çš„æ–¹æ³•å¯¹æ¯”ä¸€ä¸‹ï¼Œè¿˜æ˜¯ä½¿ç”¨å¼‚æ­¥çš„æŸ¥è¯¢æ•°æ®åº“è¿™ç§æ–¹æ³•å€¼å¾—ä½¿ç”¨ã€‚åŒæ­¥æ“ä½œï¼ˆSync I/Oï¼‰å’Œå¼‚æ­¥æ“ä½œï¼ˆAsync I/Oï¼‰çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-12-121929.png" alt=""></p><p>å·¦ä¾§è¡¨ç¤ºçš„æ˜¯åœ¨æµå¤„ç†ä¸­åŒæ­¥çš„æ•°æ®åº“è¯·æ±‚ï¼Œå³ä¾§æ˜¯å¼‚æ­¥çš„æ•°æ®åº“è¯·æ±‚ã€‚å‡è®¾å·¦ä¾§æ˜¯æ•°æ®æµä¸­ A æ•°æ®æ¥äº†å‘é€ä¸€ä¸ªæŸ¥è¯¢æ•°æ®åº“çš„è¯·æ±‚çœ‹æ˜¯å¦ä¹‹å‰å­˜åœ¨ Aï¼Œç„¶åç­‰å¾…æŸ¥è¯¢ç»“æœè¿”å›ï¼Œåªæœ‰ç­‰ A æ•´ä¸ªæŸ¥è¯¢è¯·æ±‚å“åº”åæ‰ä¼šç»§ç»­å¼€å§‹ B æ•°æ®çš„æŸ¥è¯¢è¯·æ±‚ï¼Œä¾æ­¤ç»§ç»­ï¼›è€Œå³ä¾§æ˜¯è¿ç»­çš„å»æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ Aã€Bã€Cã€Dï¼Œåé¢å“ªä¸ªè¯·æ±‚å…ˆå“åº”å°±å…ˆå¤„ç†å“ªä¸ªï¼Œä¸éœ€è¦å’Œå·¦ä¾§çš„ä¸€æ ·è¦ç­‰å¾…ä¸Šä¸€ä¸ªè¯·æ±‚å…¨éƒ¨å®Œæˆæ‰å¯ä»¥å¼€å§‹ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥å¼‚æ­¥çš„è¯ååé‡è‡ªç„¶å°±é«˜èµ·æ¥äº†ã€‚ä½†æ˜¯å¾—æ³¨æ„çš„æ˜¯ï¼šä½¿ç”¨å¼‚æ­¥è¿™ç§æ–¹æ³•å‰ææ˜¯è¦æ•°æ®åº“å®¢æˆ·ç«¯æ”¯æŒå¼‚æ­¥çš„è¯·æ±‚ï¼Œå¦åˆ™å¯èƒ½éœ€è¦å€ŸåŠ©çº¿ç¨‹æ± æ¥å®ç°å¼‚æ­¥è¯·æ±‚ï¼Œä½†æ˜¯ç°åœ¨ä¸»æµçš„æ•°æ®åº“é€šå¸¸éƒ½æ”¯æŒå¼‚æ­¥çš„æ“ä½œï¼Œæ‰€ä»¥ä¸ç”¨å¤ªæ‹…å¿ƒã€‚</p><h3 id="11-3-2-Async-I-O-API"><a href="#11-3-2-Async-I-O-API" class="headerlink" title="11.3.2 Async I/O API"></a>11.3.2 Async I/O API</h3><p>Flink çš„ Async I/O API å…è®¸ç”¨æˆ·åœ¨æ•°æ®æµå¤„ç†ä¸­ä½¿ç”¨å¼‚æ­¥è¯·æ±‚ï¼Œå¹¶ä¸”è¿˜æ”¯æŒè¶…æ—¶å¤„ç†ã€å¤„ç†é¡ºåºã€äº‹ä»¶æ—¶é—´ã€å®¹é”™ã€‚åœ¨ Flink ä¸­ï¼Œå¦‚æœè¦ä½¿ç”¨ Async I/O APIï¼Œæ˜¯éå¸¸ç®€å•çš„ï¼Œéœ€è¦é€šè¿‡ä¸‹é¢ä¸‰ä¸ªæ­¥éª¤æ¥æ‰§è¡Œå¯¹æ•°æ®åº“çš„å¼‚æ­¥æ“ä½œã€‚</p><ul><li>ç»§æ‰¿ RichAsyncFunction æŠ½è±¡ç±»æˆ–è€…å®ç°ç”¨æ¥åˆ†å‘è¯·æ±‚çš„ AsyncFunction æ¥å£</li><li>è¿”å›å¼‚æ­¥è¯·æ±‚çš„ç»“æœçš„ Future</li><li>åœ¨ DataStream ä¸Šä½¿ç”¨å¼‚æ­¥æ“ä½œ</li></ul><p>å®˜ç½‘ä¹Ÿç»™å‡ºæ¡ˆä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncDatabaseRequest</span> <span class="keyword">extends</span> <span class="title">RichAsyncFunction</span>&lt;<span class="title">String</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ•°æ®åº“çš„å®¢æˆ·ç«¯ï¼Œå®ƒå¯ä»¥å‘å‡ºå¸¦æœ‰ callback çš„å¹¶å‘è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> DatabaseClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        client = <span class="keyword">new</span> DatabaseClient(host, post, credentials);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">asyncInvoke</span><span class="params">(String key, <span class="keyword">final</span> ResultFuture&lt;Tuple2&lt;String, String&gt;&gt; resultFuture)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//å‘å‡ºå¼‚æ­¥è¯·æ±‚ï¼Œæ¥æ”¶ future çš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">final</span> Future&lt;String&gt; result = client.query(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è®¾ç½®å®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåæ‰§è¡Œçš„ callbackï¼Œcallback åªæ˜¯å°†ç»“æœè½¬å‘ç»™ ResultFuture</span></span><br><span class="line">        CompletableFuture.supplyAsync(<span class="keyword">new</span> Supplier&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> result.get();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).thenAccept( (String dbResult) -&gt; &#123;</span><br><span class="line">            resultFuture.complete(Collections.singleton(<span class="keyword">new</span> Tuple2&lt;&gt;(key, dbResult)));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŸå§‹æ•°æ®</span></span><br><span class="line">DataStream&lt;String&gt; stream = ...;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åº”ç”¨å¼‚æ­¥ I/O è½¬æ¢</span></span><br><span class="line">DataStream&lt;Tuple2&lt;String, String&gt;&gt; resultStream =</span><br><span class="line">    AsyncDataStream.unorderedWait(stream, <span class="keyword">new</span> AsyncDatabaseRequest(), <span class="number">1000</span>, TimeUnit.MILLISECONDS, <span class="number">100</span>);</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šResultFuture åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ resultFuture.complete æ—¶å°±å·²ç»å®Œæˆäº†ï¼Œåé¢æ‰€æœ‰ resultFuture.complete  çš„è°ƒç”¨éƒ½ä¼šè¢«å¿½ç•¥ã€‚</p><p>ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ§åˆ¶äº†å¼‚æ­¥æ“ä½œï¼š</p><ul><li>Timeoutï¼štimeout å®šä¹‰äº†å¼‚æ­¥æ“ä½œè¿‡äº†å¤šé•¿æ—¶é—´åä¼šè¢«ä¸¢å¼ƒï¼Œè¿™ä¸ªå‚æ•°æ˜¯é˜²æ­¢äº†æ­»çš„æˆ–è€…å¤±è´¥çš„è¯·æ±‚</li><li>Capacityï¼šè¿™ä¸ªå‚æ•°å®šä¹‰å¯ä»¥åŒæ—¶å¤„ç†å¤šå°‘ä¸ªå¼‚æ­¥è¯·æ±‚ã€‚è™½ç„¶å¼‚æ­¥è¯·æ±‚ä¼šå¸¦æ¥æ›´å¥½çš„ååé‡ï¼Œä½†æ˜¯è¯¥æ“ä½œä»ç„¶å¯èƒ½æˆä¸ºæµä½œä¸šçš„æ€§èƒ½ç“¶é¢ˆã€‚é™åˆ¶å¹¶å‘è¯·æ±‚çš„æ•°é‡å¯ç¡®ä¿æ“ä½œä¸ä¼šä¸æ–­ç´¯ç§¯å¤„ç†è¯·æ±‚ï¼Œä¸€æ—¦è¶…è¿‡ Capacity å€¼ï¼Œå®ƒå°†è§¦å‘åå‹ã€‚</li></ul><h4 id="è¶…æ—¶å¤„ç†"><a href="#è¶…æ—¶å¤„ç†" class="headerlink" title="è¶…æ—¶å¤„ç†"></a>è¶…æ—¶å¤„ç†</h4><h4 id="ç»“æœé¡ºåº"><a href="#ç»“æœé¡ºåº" class="headerlink" title="ç»“æœé¡ºåº"></a>ç»“æœé¡ºåº</h4><h4 id="äº‹ä»¶æ—¶é—´"><a href="#äº‹ä»¶æ—¶é—´" class="headerlink" title="äº‹ä»¶æ—¶é—´"></a>äº‹ä»¶æ—¶é—´</h4><h4 id="å®¹é”™æ€§ä¿è¯"><a href="#å®¹é”™æ€§ä¿è¯" class="headerlink" title="å®¹é”™æ€§ä¿è¯"></a>å®¹é”™æ€§ä¿è¯</h4><h4 id="å®è·µæŠ€å·§"><a href="#å®è·µæŠ€å·§" class="headerlink" title="å®è·µæŠ€å·§"></a>å®è·µæŠ€å·§</h4><h4 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h4><h3 id="11-3-3-åˆ©ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™éœ€æ±‚åˆ†æ"><a href="#11-3-3-åˆ©ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™éœ€æ±‚åˆ†æ" class="headerlink" title="11.3.3 åˆ©ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™éœ€æ±‚åˆ†æ"></a>11.3.3 åˆ©ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™éœ€æ±‚åˆ†æ</h3><h4 id="ç›‘æ§æ•°æ®æ ·ä¾‹"><a href="#ç›‘æ§æ•°æ®æ ·ä¾‹" class="headerlink" title="ç›‘æ§æ•°æ®æ ·ä¾‹"></a>ç›‘æ§æ•°æ®æ ·ä¾‹</h4><h4 id="å‘Šè­¦è§„åˆ™è¡¨è®¾è®¡"><a href="#å‘Šè­¦è§„åˆ™è¡¨è®¾è®¡" class="headerlink" title="å‘Šè­¦è§„åˆ™è¡¨è®¾è®¡"></a>å‘Šè­¦è§„åˆ™è¡¨è®¾è®¡</h4><h4 id="å‘Šè­¦è§„åˆ™å®ä½“ç±»"><a href="#å‘Šè­¦è§„åˆ™å®ä½“ç±»" class="headerlink" title="å‘Šè­¦è§„åˆ™å®ä½“ç±»"></a>å‘Šè­¦è§„åˆ™å®ä½“ç±»</h4><h3 id="11-3-4-å¦‚ä½•ä½¿ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®"><a href="#11-3-4-å¦‚ä½•ä½¿ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®" class="headerlink" title="11.3.4 å¦‚ä½•ä½¿ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®"></a>11.3.4 å¦‚ä½•ä½¿ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™æ•°æ®</h3><h3 id="11-3-5-å°ç»“ä¸åæ€"><a href="#11-3-5-å°ç»“ä¸åæ€" class="headerlink" title="11.3.5 å°ç»“ä¸åæ€"></a>11.3.5 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/RBYj66M">https://t.zsxq.com/RBYj66M</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;11-3-å¦‚ä½•åˆ©ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ&quot;&gt;&lt;a href=&quot;#11-3-å¦‚ä½•åˆ©ç”¨-Async-I-O-è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;11.3 å¦‚ä½•åˆ©ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ&quot;&gt;&lt;/a&gt;11.3 å¦‚ä½•åˆ©ç”¨ Async I/O è¯»å–å‘Šè­¦è§„åˆ™ï¼Ÿ&lt;/h2&gt;&lt;p&gt;Async ä¸­æ–‡æ˜¯å¼‚æ­¥çš„æ„æ€ï¼Œåœ¨æµè®¡ç®—ä¸­ï¼Œä½¿ç”¨å¼‚æ­¥ I/O èƒ½å¤Ÿæå‡ä½œä¸šæ•´ä½“çš„è®¡ç®—èƒ½åŠ›ï¼Œæœ¬èŠ‚ä¸­ä¸ä»…ä¼šè®²è§£å¼‚æ­¥ I/O çš„ API åŸç†ï¼Œè¿˜ä¼šé€šè¿‡ä¸€ä¸ªå®æˆ˜éœ€æ±‚ï¼ˆè¯»å–å‘Šè­¦è§„åˆ™ï¼‰æ¥è®²è§£å¼‚æ­¥ I/O çš„ä½¿ç”¨ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•ä½¿ç”¨ Flink ProcessFunction å¤„ç†å®•æœºå‘Šè­¦?</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/15/flink-in-action-11.2/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/15/flink-in-action-11.2/</id>
    <published>2021-08-14T16:00:00.000Z</published>
    <updated>2022-02-07T14:01:37.985Z</updated>
    
    <content type="html"><![CDATA[<h2 id="11-2-å¦‚ä½•ä½¿ç”¨-Flink-ProcessFunction-å¤„ç†å®•æœºå‘Šè­¦"><a href="#11-2-å¦‚ä½•ä½¿ç”¨-Flink-ProcessFunction-å¤„ç†å®•æœºå‘Šè­¦" class="headerlink" title="11.2 å¦‚ä½•ä½¿ç”¨ Flink ProcessFunction å¤„ç†å®•æœºå‘Šè­¦?"></a>11.2 å¦‚ä½•ä½¿ç”¨ Flink ProcessFunction å¤„ç†å®•æœºå‘Šè­¦?</h2><p>åœ¨ 3.3 èŠ‚ä¸­è®²è§£äº† Process ç®—å­çš„æ¦‚å¿µï¼Œæœ¬èŠ‚ä¸­å°†æ›´è¯¦ç»†çš„è®²è§£ Flink ProcessFunctionï¼Œç„¶åæ•™å¤§å®¶å¦‚ä½•ä½¿ç”¨ ProcessFunction æ¥è§£å†³å…¬å¸ä¸­å¸¸è§çš„é—®é¢˜ â€”â€” å®•æœºï¼Œè¿™ä¸ªå®•æœºä¸ä»…ä»…åŒ…æ‹¬æœºå™¨å®•æœºï¼Œè¿˜åŒ…å«åº”ç”¨å®•æœºï¼Œé€šå¸¸å‡ºç°å®•æœºå¸¦æ¥çš„å½±å“æ˜¯ä¼šå¾ˆå¤§çš„ï¼Œæ‰€ä»¥èƒ½åŠæ—¶æ”¶åˆ°å‘Šè­¦ä¼šå‡å°‘æŸå¤±ã€‚</p><a id="more"></a><h3 id="11-2-1-ProcessFunction-ç®€ä»‹"><a href="#11-2-1-ProcessFunction-ç®€ä»‹" class="headerlink" title="11.2.1 ProcessFunction ç®€ä»‹"></a>11.2.1 ProcessFunction ç®€ä»‹</h3><p>åœ¨ 1.2.5 èŠ‚ä¸­è®²äº† Flink çš„ API åˆ†å±‚ï¼Œå…¶ä¸­å¯ä»¥çœ‹è§ Flink çš„åº•å±‚ API å°±æ˜¯ ProcessFunctionï¼Œå®ƒæ˜¯ä¸€ä¸ªä½é˜¶çš„æµå¤„ç†æ“ä½œï¼Œå®ƒå¯ä»¥è®¿é—®æµå¤„ç†ç¨‹åºçš„åŸºç¡€æ„å»ºæ¨¡å—ï¼šEventã€Stateã€Timerã€‚ProcessFunction å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ç§æä¾›äº†å¯¹ KeyedState å’Œå®šæ—¶å™¨è®¿é—®çš„ FlatMapFunctionã€‚æ¯å½“æ•°æ®æºä¸­æ¥æ”¶åˆ°ä¸€ä¸ªäº‹ä»¶ï¼Œå°±ä¼šè°ƒç”¨æ¥æ­¤å‡½æ•°æ¥å¤„ç†ã€‚å¯¹äºå®¹é”™çš„çŠ¶æ€ï¼ŒProcessFunction å¯ä»¥é€šè¿‡ RuntimeContext è®¿é—® KeyedStateã€‚</p><p>å®šæ—¶å™¨å¯ä»¥å¯¹å¤„ç†æ—¶é—´å’Œäº‹ä»¶æ—¶é—´çš„å˜åŒ–åšä¸€äº›å¤„ç†ã€‚æ¯æ¬¡è°ƒç”¨ processElement() éƒ½å¯ä»¥è·å¾—ä¸€ä¸ª Context å¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡å¯ä»¥è®¿é—®å…ƒç´ çš„äº‹ä»¶æ—¶é—´æˆ³ä»¥åŠ TimerServiceã€‚TimerService å¯ä»¥ä¸ºå°šæœªå‘ç”Ÿçš„äº‹ä»¶æ—¶é—´/å¤„ç†æ—¶é—´å®ä¾‹æ³¨å†Œå›è°ƒã€‚å½“å®šæ—¶å™¨åˆ°è¾¾æŸä¸ªæ—¶åˆ»æ—¶ï¼Œä¼šè°ƒç”¨ onTimer() æ–¹æ³•ã€‚åœ¨è°ƒç”¨æœŸé—´ï¼Œæ‰€æœ‰çŠ¶æ€å†æ¬¡é™å®šä¸ºå®šæ—¶å™¨åˆ›å»ºçš„ keyï¼Œå…è®¸å®šæ—¶å™¨æ“ä½œ KeyedStateã€‚å¦‚æœè¦è®¿é—® KeyedState å’Œå®šæ—¶å™¨ï¼Œé‚£å¿…é¡»åœ¨ KeyedStream ä¸Šä½¿ç”¨ KeyedProcessFunctionï¼Œæ¯”å¦‚åœ¨ keyBy ç®—å­ä¹‹åä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dataStream.keyBy(...).process(<span class="keyword">new</span> KeyedProcessFunction&lt;&gt;()&#123;</span><br><span class="line">    </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>KeyedProcessFunction æ˜¯ ProcessFunction å‡½æ•°çš„ä¸€ä¸ªæ‰©å±•ï¼Œå®ƒå¯ä»¥åœ¨ onTimer å’Œ processElement æ–¹æ³•ä¸­è·å–åˆ°åˆ†åŒºçš„ Key å€¼ï¼Œè¿™å¯¹äºæ•°æ®ä¼ é€’æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œç»è¿‡ keyBy ç®—å­ä¹‹åå¯èƒ½è¿˜éœ€è¦è¿™ä¸ª key å­—æ®µï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œç›´æ¥æ„å»ºæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ˆæ–°å¢ä¸€ä¸ª key å­—æ®µï¼‰ï¼Œç„¶åä¸‹æ¸¸çš„ç®—å­ç›´æ¥ä½¿ç”¨è¿™ä¸ªæ–°å¯¹è±¡ä¸­çš„ key å°±å¥½äº†ï¼Œè€Œä¸åœ¨éœ€è¦é‡å¤çš„æ‹¼ä¸€ä¸ªå”¯ä¸€çš„ keyã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(String value, Context ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(ctx.getCurrentKey());</span><br><span class="line">    out.collect(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(ctx.getCurrentKey());</span><br><span class="line">    <span class="keyword">super</span>.onTimer(timestamp, ctx, out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="11-2-2-CoProcessFunction-ç®€ä»‹"><a href="#11-2-2-CoProcessFunction-ç®€ä»‹" class="headerlink" title="11.2.2 CoProcessFunction ç®€ä»‹"></a>11.2.2 CoProcessFunction ç®€ä»‹</h3><p>å¦‚æœè¦åœ¨ä¸¤ä¸ªè¾“å…¥æµä¸Šè¿›è¡Œæ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ CoProcessFunctionï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥ä¼ å…¥ä¸¤ä¸ªä¸åŒçš„æ•°æ®æµè¾“å…¥ï¼Œå¹¶ä¸ºæ¥è‡ªä¸¤ä¸ªä¸åŒæ•°æ®æºçš„äº‹ä»¶åˆ†åˆ«è°ƒç”¨ processElement1() å’Œ  processElement2() æ–¹æ³•ã€‚å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ¥å®ç°ä¸€ä¸ªå…¸å‹çš„ Join æ“ä½œï¼š</p><ul><li>ä¸ºä¸€ä¸ªæ•°æ®æºçš„æ•°æ®å»ºç«‹ä¸€ä¸ªçŠ¶æ€å¯¹è±¡</li><li>ä»æ•°æ®æºå¤„æœ‰æ–°æ•°æ®æµè¿‡æ¥çš„æ—¶å€™æ›´æ–°è¿™ä¸ªçŠ¶æ€å¯¹è±¡</li><li>åœ¨å¦ä¸€ä¸ªæ•°æ®æºæ¥æ”¶åˆ°å…ƒç´ æ—¶ï¼Œå…³è”çŠ¶æ€å¯¹è±¡å¹¶å¯¹å…¶äº§ç”Ÿå‡ºè¿æ¥çš„ç»“æœ</li></ul><p>æ¯”å¦‚ï¼Œå°†ç›‘æ§çš„ metric æ•°æ®å’Œå‘Šè­¦è§„åˆ™æ•°æ®è¿›è¡Œä¸€ä¸ªè¿æ¥ï¼Œåœ¨æµæ•°æ®çš„çŠ¶æ€ä¸­å­˜å‚¨äº†å‘Šè­¦è§„åˆ™æ•°æ®ï¼Œå½“æœ‰ç›‘æ§æ•°æ®è¿‡æ¥æ—¶ï¼Œæ ¹æ®ç›‘æ§æ•°æ®çš„ metric åç§°å’Œä¸€äº› tag å»æ‰¾å¯¹åº”å‘Šè­¦è§„åˆ™è®¡ç®—è¡¨è¾¾å¼ï¼Œç„¶åé€šè¿‡è§„åˆ™çš„è¡¨è¾¾å¼å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥å¤„ç†ï¼Œåˆ¤æ–­æ˜¯å¦è¦å‘Šè­¦ï¼Œå¦‚æœæ˜¯è¦å‘Šè­¦åˆ™ä¼šå…³è”æ„é€ æˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ–°å¯¹è±¡ä¸­ä¸ä»…æœ‰åˆå§‹çš„ç›‘æ§ metric æ•°æ®ï¼Œè¿˜æœ‰å«æœ‰å¯¹åº”çš„å‘Šè­¦è§„åˆ™æ•°æ®ä»¥åŠé€šçŸ¥ç­–ç•¥æ•°æ®ï¼Œç»„è£…æˆè¿™æ ·ä¸€æ¡æ•°æ®åï¼Œä¸‹æ¸¸å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ•°æ®è¿›è¡Œé€šçŸ¥ï¼Œé€šçŸ¥è¿˜ä¼šåœ¨çŠ¶æ€ä¸­å­˜å‚¨è¿™ä¸ªå‘Šè­¦çŠ¶æ€ï¼Œè¡¨ç¤ºå®ƒåœ¨ä»€ä¹ˆæ—¶é—´å‘Šè¿‡è­¦äº†ï¼Œä¸‹æ¬¡æœ‰æ–°æ•°æ®è¿‡æ¥çš„æ—¶å€™ï¼Œåˆ¤æ–­æ–°æ•°æ®æ˜¯å¦æ˜¯æ¢å¤çš„ï¼Œå¦‚æœå±äºæ¢å¤åˆ™æŠŠè¯¥çŠ¶æ€æ¸…é™¤ã€‚</p><h3 id="11-2-3-Timer-ç®€ä»‹"><a href="#11-2-3-Timer-ç®€ä»‹" class="headerlink" title="11.2.3 Timer ç®€ä»‹"></a>11.2.3 Timer ç®€ä»‹</h3><p>Timer æä¾›äº†ä¸€ç§å®šæ—¶è§¦å‘å™¨çš„åŠŸèƒ½ï¼Œé€šè¿‡ TimerService æ¥å£æ³¨å†Œ timerã€‚TimerService åœ¨å†…éƒ¨ç»´æŠ¤ä¸¤ç§ç±»å‹çš„å®šæ—¶å™¨ï¼ˆå¤„ç†æ—¶é—´å’Œäº‹ä»¶æ—¶é—´å®šæ—¶å™¨ï¼‰å¹¶æ’é˜Ÿæ‰§è¡Œã€‚å¤„ç†æ—¶é—´å®šæ—¶å™¨çš„è§¦å‘ä¾èµ–äº ProcessingTimeServiceï¼Œå®ƒè´Ÿè´£ç®¡ç†æ‰€æœ‰åŸºäºå¤„ç†æ—¶é—´çš„è§¦å‘å™¨ï¼Œå†…éƒ¨ä½¿ç”¨ ScheduledThreadPoolExecutor è°ƒåº¦å®šæ—¶ä»»åŠ¡ï¼›äº‹ä»¶æ—¶é—´å®šæ—¶å™¨çš„è§¦å‘ä¾èµ–äºç³»ç»Ÿå½“å‰çš„ Watermarkã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼š<strong>Timer åªèƒ½åœ¨ KeyedStream ä¸­ä½¿ç”¨</strong>ã€‚</p><p>TimerService ä¼šåˆ é™¤æ¯ä¸ª Key å’Œæ—¶é—´æˆ³é‡å¤çš„å®šæ—¶å™¨ï¼Œå³æ¯ä¸ª Key åœ¨åŒä¸€ä¸ªæ—¶é—´æˆ³ä¸Šæœ€å¤šæœ‰ä¸€ä¸ªå®šæ—¶å™¨ã€‚å¦‚æœä¸ºåŒä¸€æ—¶é—´æˆ³æ³¨å†Œäº†å¤šä¸ªå®šæ—¶å™¨ï¼Œåˆ™åªä¼šè°ƒç”¨ä¸€æ¬¡ onTimerï¼ˆï¼‰ æ–¹æ³•ã€‚Flink ä¼šåŒæ­¥è°ƒç”¨ onTimer() å’Œ  processElement() æ–¹æ³•ï¼Œå› æ­¤ä¸å¿…æ‹…å¿ƒçŠ¶æ€çš„å¹¶å‘ä¿®æ”¹é—®é¢˜ã€‚TimerService ä¸ä»…æä¾›äº†æ³¨å†Œå’Œåˆ é™¤ Timer çš„åŠŸèƒ½ï¼Œè¿˜å¯ä»¥é€šè¿‡å®ƒæ¥è·å–å½“å‰çš„ç³»ç»Ÿæ—¶é—´å’Œ Watermark çš„å€¼ã€‚TimerService ç±»ä¸­çš„æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/2020-01-12-070737.png" alt=""></p><h4 id="å®¹é”™"><a href="#å®¹é”™" class="headerlink" title="å®¹é”™"></a>å®¹é”™</h4><p>å®šæ—¶å™¨å…·æœ‰å®¹é”™èƒ½åŠ›ï¼Œå¹¶ä¸”ä¼šä¸åº”ç”¨ç¨‹åºçš„çŠ¶æ€ä¸€èµ·è¿›è¡Œ Checkpointï¼Œå¦‚æœå‘ç”Ÿæ•…éšœé‡å¯ä¼šä» Checkpointï¼Savepoint ä¸­æ¢å¤å®šæ—¶å™¨çš„çŠ¶æ€ã€‚å¦‚æœæœ‰å¤„ç†æ—¶é—´å®šæ—¶å™¨åŸæœ¬æ˜¯è¦åœ¨æ¢å¤èµ·æ¥çš„é‚£ä¸ªæ—¶é—´ä¹‹å‰è§¦å‘çš„ï¼Œé‚£ä¹ˆåœ¨æ¢å¤çš„é‚£ä¸€åˆ»ä¼šç«‹å³è§¦å‘è¯¥å®šæ—¶å™¨ã€‚å®šæ—¶å™¨å§‹ç»ˆæ˜¯å¼‚æ­¥çš„è¿›è¡Œ Checkpointï¼ˆé™¤ RocksDB çŠ¶æ€åç«¯å­˜å‚¨ã€å¢é‡çš„ Checkpointã€åŸºäºå †çš„å®šæ—¶å™¨å¤–ï¼‰ã€‚å› ä¸ºå®šæ—¶å™¨å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®ŠçŠ¶æ€çš„çŠ¶æ€ï¼Œåœ¨ Checkpoint æ—¶ä¼šå†™å…¥å¿«ç…§ä¸­ï¼Œæ‰€ä»¥å¦‚æœæœ‰å¤§é‡çš„å®šæ—¶å™¨ï¼Œåˆ™æ— éä¼šå¢åŠ ä¸€æ¬¡ Checkpoint æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¿…è¦çš„è¯å¾—æ ¹æ®å®é™…æƒ…å†µåˆå¹¶å®šæ—¶å™¨ã€‚</p><h4 id="åˆå¹¶å®šæ—¶å™¨"><a href="#åˆå¹¶å®šæ—¶å™¨" class="headerlink" title="åˆå¹¶å®šæ—¶å™¨"></a>åˆå¹¶å®šæ—¶å™¨</h4><p>ç”±äº Flink ä»…ä¸ºæ¯ä¸ª Key å’Œæ—¶é—´æˆ³ç»´æŠ¤ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå› æ­¤å¯ä»¥é€šè¿‡é™ä½å®šæ—¶å™¨çš„é¢‘ç‡æ¥è¿›è¡Œåˆå¹¶ä»¥å‡å°‘å®šæ—¶å™¨çš„æ•°é‡ã€‚å¯¹äºé¢‘ç‡ä¸º 1 ç§’çš„å®šæ—¶å™¨ï¼ˆåŸºäºäº‹ä»¶æ—¶é—´æˆ–å¤„ç†æ—¶é—´ï¼‰ï¼Œå¯ä»¥å°†ç›®æ ‡æ—¶é—´å‘ä¸‹èˆå…¥ä¸ºæ•´ç§’æ•°ï¼Œåˆ™å®šæ—¶å™¨æœ€å¤šæå‰ 1 ç§’è§¦å‘ï¼Œä½†ä¸ä¼šè¿Ÿäºæˆ‘ä»¬çš„è¦æ±‚ï¼Œç²¾ç¡®åˆ°æ¯«ç§’ã€‚å› æ­¤ï¼Œæ¯ä¸ªé”®æ¯ç§’æœ€å¤šæœ‰ä¸€ä¸ªå®šæ—¶å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> coalescedTime = ((ctx.timestamp() + timeout) / <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">ctx.timerService().registerProcessingTimeTimer(coalescedTime);</span><br></pre></td></tr></table></figure><p>ç”±äºäº‹ä»¶æ—¶é—´è®¡æ—¶å™¨ä»…åœ¨ Watermark åˆ°è¾¾æ—¶æ‰è§¦å‘ï¼Œå› æ­¤å¯ä»¥å°†å½“å‰ Watermark ä¸ä¸‹ä¸€ä¸ª Watermark çš„å®šæ—¶å™¨ä¸€èµ·è°ƒåº¦å’Œåˆå¹¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> coalescedTime = ctx.timerService().currentWatermark() + <span class="number">1</span>;</span><br><span class="line">ctx.timerService().registerEventTimeTimer(coalescedTime);</span><br></pre></td></tr></table></figure><p>å®šæ—¶å™¨ä¹Ÿå¯ä»¥ç±»ä¼¼ä¸‹é¢è¿™æ ·ç§»é™¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ é™¤å¤„ç†æ—¶é—´å®šæ—¶å™¨</span></span><br><span class="line"><span class="keyword">long</span> timestampOfTimerToStop = ...</span><br><span class="line">ctx.timerService().deleteProcessingTimeTimer(timestampOfTimerToStop);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ é™¤äº‹ä»¶æ—¶é—´å®šæ—¶å™¨</span></span><br><span class="line"><span class="keyword">long</span> timestampOfTimerToStop = ...</span><br><span class="line">ctx.timerService().deleteEventTimeTimer(timestampOfTimerToStop);</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è¯¥æ—¶é—´æˆ³çš„å®šæ—¶å™¨ï¼Œåˆ™åˆ é™¤å®šæ—¶å™¨æ— æ•ˆã€‚</p><h3 id="11-2-4-å¦‚æœåˆ©ç”¨-ProcessFunction-å¤„ç†å®•æœºå‘Šè­¦ï¼Ÿ"><a href="#11-2-4-å¦‚æœåˆ©ç”¨-ProcessFunction-å¤„ç†å®•æœºå‘Šè­¦ï¼Ÿ" class="headerlink" title="11.2.4 å¦‚æœåˆ©ç”¨ ProcessFunction å¤„ç†å®•æœºå‘Šè­¦ï¼Ÿ"></a>11.2.4 å¦‚æœåˆ©ç”¨ ProcessFunction å¤„ç†å®•æœºå‘Šè­¦ï¼Ÿ</h3><h4 id="å®•æœºå‘Šè­¦éœ€æ±‚åˆ†æ"><a href="#å®•æœºå‘Šè­¦éœ€æ±‚åˆ†æ" class="headerlink" title="å®•æœºå‘Šè­¦éœ€æ±‚åˆ†æ"></a>å®•æœºå‘Šè­¦éœ€æ±‚åˆ†æ</h4><h4 id="å®•æœºå‘Šè­¦ä»£ç å®ç°"><a href="#å®•æœºå‘Šè­¦ä»£ç å®ç°" class="headerlink" title="å®•æœºå‘Šè­¦ä»£ç å®ç°"></a>å®•æœºå‘Šè­¦ä»£ç å®ç°</h4><h3 id="11-2-5-å°ç»“ä¸åæ€"><a href="#11-2-5-å°ç»“ä¸åæ€" class="headerlink" title="11.2.5 å°ç»“ä¸åæ€"></a>11.2.5 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/RBYj66M">https://t.zsxq.com/RBYj66M</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;11-2-å¦‚ä½•ä½¿ç”¨-Flink-ProcessFunction-å¤„ç†å®•æœºå‘Šè­¦&quot;&gt;&lt;a href=&quot;#11-2-å¦‚ä½•ä½¿ç”¨-Flink-ProcessFunction-å¤„ç†å®•æœºå‘Šè­¦&quot; class=&quot;headerlink&quot; title=&quot;11.2 å¦‚ä½•ä½¿ç”¨ Flink ProcessFunction å¤„ç†å®•æœºå‘Šè­¦?&quot;&gt;&lt;/a&gt;11.2 å¦‚ä½•ä½¿ç”¨ Flink ProcessFunction å¤„ç†å®•æœºå‘Šè­¦?&lt;/h2&gt;&lt;p&gt;åœ¨ 3.3 èŠ‚ä¸­è®²è§£äº† Process ç®—å­çš„æ¦‚å¿µï¼Œæœ¬èŠ‚ä¸­å°†æ›´è¯¦ç»†çš„è®²è§£ Flink ProcessFunctionï¼Œç„¶åæ•™å¤§å®¶å¦‚ä½•ä½¿ç”¨ ProcessFunction æ¥è§£å†³å…¬å¸ä¸­å¸¸è§çš„é—®é¢˜ â€”â€” å®•æœºï¼Œè¿™ä¸ªå®•æœºä¸ä»…ä»…åŒ…æ‹¬æœºå™¨å®•æœºï¼Œè¿˜åŒ…å«åº”ç”¨å®•æœºï¼Œé€šå¸¸å‡ºç°å®•æœºå¸¦æ¥çš„å½±å“æ˜¯ä¼šå¾ˆå¤§çš„ï¼Œæ‰€ä»¥èƒ½åŠæ—¶æ”¶åˆ°å‘Šè­¦ä¼šå‡å°‘æŸå¤±ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PV å’Œ UVï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/14/flink-in-action-11.1/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/14/flink-in-action-11.1/</id>
    <published>2021-08-13T16:00:00.000Z</published>
    <updated>2022-02-07T13:59:31.806Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬åä¸€ç« -â€”â€”-Flink-å®æˆ˜"><a href="#ç¬¬åä¸€ç« -â€”â€”-Flink-å®æˆ˜" class="headerlink" title="ç¬¬åä¸€ç«  â€”â€” Flink å®æˆ˜"></a>ç¬¬åä¸€ç«  â€”â€” Flink å®æˆ˜</h1><p>æœ¬ç« ä¸»è¦æ˜¯ Flink å®æˆ˜ï¼Œä»‹ç»äº†ä¸€äº›å¸¸è§çš„éœ€æ±‚ï¼Œæ¯”å¦‚å®æ—¶ç»Ÿè®¡ç½‘ç«™é¡µé¢çš„ PV/UVã€å®•æœºå‘Šè­¦ã€åŠ¨æ€æ›´æ–°é…ç½®ã€åº”ç”¨ Error æ—¥å¿—å®æ—¶å‘Šè­¦ç­‰ï¼Œç„¶ååˆ†åˆ«å»åˆ†æè¿™äº›éœ€æ±‚çš„å®ç°æ–¹å¼ï¼Œæ˜ç™½è¯¥ä½¿ç”¨ Flink ä¸­çš„å“ªäº›çŸ¥è¯†ç‚¹æ‰èƒ½å¤Ÿå¾ˆå¥½çš„å®Œæˆè¿™ç§éœ€æ±‚ï¼Œå¹¶æä¾›å®Œæ•´çš„æ¡ˆä¾‹ä»£ç ä¾›å¤§å®¶å‚è€ƒã€‚åœ¨å®ç°å®Œæˆè¿™äº›éœ€æ±‚ä¹‹åï¼Œç¬”è€…è¿˜å°†ä¼šæ›´æ·±ä¸€æ­¥çš„å»è®²è§£ä¸‹è¿™äº›çŸ¥è¯†ç‚¹èƒŒåçš„å®ç°æ–¹å¼ï¼Œå¸Œæœ›å¯ä»¥åŠ æ·±ä½ å¯¹è¿™äº›çŸ¥è¯†ç‚¹çš„å°è±¡ï¼Œä»¥ä¾¿åé¢ä½ å¯ä»¥çµæ´»çš„å¤„ç†ç±»ä¼¼çš„éœ€æ±‚ã€‚</p><h2 id="11-1-å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„-PV-å’Œ-UVï¼Ÿ"><a href="#11-1-å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„-PV-å’Œ-UVï¼Ÿ" class="headerlink" title="11.1 å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PV å’Œ UVï¼Ÿ"></a>11.1 å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PV å’Œ UVï¼Ÿ</h2><p>å¤§æ•°æ®å¼€å‘æœ€å¸¸ç»Ÿè®¡çš„éœ€æ±‚å¯èƒ½å°±æ˜¯ PVã€UVã€‚PV å…¨æ‹¼ PageViewï¼Œå³é¡µé¢è®¿é—®é‡ï¼Œç”¨æˆ·æ¯æ¬¡å¯¹ç½‘ç«™çš„è®¿é—®å‡è¢«è®°å½•ï¼ŒæŒ‰ç…§è®¿é—®é‡è¿›è¡Œç´¯è®¡ï¼Œå‡å¦‚ç”¨æˆ·å¯¹åŒä¸€é¡µé¢è®¿é—®äº† 5 æ¬¡ï¼Œé‚£è¯¥é¡µé¢çš„ PV å°±åº”è¯¥åŠ  5ã€‚UV å…¨æ‹¼ä¸º UniqueVisitorï¼Œå³ç‹¬ç«‹è®¿é—®ç”¨æˆ·æ•°ï¼Œè®¿é—®è¯¥é¡µé¢çš„ä¸€å°ç”µè„‘å®¢æˆ·ç«¯ä¸ºä¸€ä¸ªè®¿å®¢ï¼Œå‡å¦‚ç”¨æˆ·å¯¹åŒä¸€é¡µé¢è®¿é—®äº† 5 æ¬¡ï¼Œé‚£ä¹ˆè¯¥é¡µé¢çš„ UV åªåº”è¯¥åŠ  1ï¼Œå› ä¸º UV è®¡ç®—çš„æ˜¯å»é‡åçš„ç”¨æˆ·æ•°è€Œä¸æ˜¯è®¿é—®æ¬¡æ•°ã€‚å½“ç„¶å¦‚æœæ˜¯æŒ‰å¤©ç»Ÿè®¡ï¼Œé‚£ä¹ˆå½“å¤© 0 ç‚¹åˆ° 24 ç‚¹ç›¸åŒçš„å®¢æˆ·ç«¯åªè¢«è®¡ç®—ä¸€æ¬¡ï¼Œå¦‚æœè¿‡äº†ä»Šå¤© 24 ç‚¹ï¼Œç¬¬äºŒå¤©è¯¥ç”¨æˆ·åˆè®¿é—®äº†è¯¥é¡µé¢ï¼Œé‚£ä¹ˆç¬¬äºŒå¤©è¯¥é¡µé¢çš„ UV åº”è¯¥åŠ  1ã€‚ æ¦‚å¿µæ˜ç™½äº†é‚£å¦‚ä½•ä½¿ç”¨ Flink æ¥ç»Ÿè®¡ç½‘ç«™å„é¡µé¢çš„ PV å’Œ UV å‘¢ï¼Ÿé€šè¿‡æœ¬èŠ‚æ¥è¯¦ç»†æè¿°ã€‚</p><a id="more"></a><h3 id="11-1-1-ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„-PV"><a href="#11-1-1-ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„-PV" class="headerlink" title="11.1.1 ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PV"></a>11.1.1 ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PV</h3><p>åœ¨ 9.5.2 èŠ‚ç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯ Exactly Once ä¸­çš„å¹‚ç­‰æ€§å†™å…¥å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯ Exactly Once éƒ¨åˆ†å·²ç»ç”¨æ¡ˆä¾‹è®²è¿°äº†å¦‚ä½•é€šè¿‡ Flink çš„çŠ¶æ€æ¥è®¡ç®— APP çš„ PVï¼Œå¹¶èƒ½å¤Ÿä¿è¯ Exactly Onceã€‚å¦‚æœåœ¨å·¥ä½œä¸­éœ€è¦è®¡ç®—ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PVï¼Œåªéœ€è¦å°†æ¡ˆä¾‹ä¸­çš„ APP æ›¿æ¢æˆå„é¡µé¢çš„ id æˆ–è€…å„é¡µé¢çš„ url è¿›è¡Œç»Ÿè®¡å³å¯ï¼ŒæŒ‰ç…§å„é¡µé¢ id å’Œæ—¥æœŸç»„åˆåšä¸º key è¿›è¡Œ keyByï¼Œç›¸åŒé¡µé¢ã€ç›¸åŒæ—¥æœŸçš„æ•°æ®å‘é€åˆ°ç›¸åŒçš„å®ä¾‹ä¸­è¿›è¡Œ PV å€¼çš„ç´¯åŠ ï¼Œæ¯ä¸ª key å¯¹åº”ä¸€ä¸ª ValueStateï¼Œå°† PV å€¼ç»´æŠ¤åœ¨ ValueState å³å¯ã€‚å¦‚æœä¸€äº›é¡µé¢å±äºçˆ†æ¬¾é¡µé¢ï¼Œä¾‹å¦‚é¦–é¡µæˆ–è€…æ´»åŠ¨é¡µé¢è®¿é—®ç‰¹åˆ«é¢‘ç¹å°±å¯èƒ½å‡ºç°æŸäº› subtask ä¸Šçš„æ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œå¯¼è‡´å„ä¸ª subtask ä¹‹å‰å‡ºç°æ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œå…³äºæ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆè¯·å‚è€ƒ 9.6 èŠ‚ã€‚</p><h3 id="11-1-2-ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…-UV-çš„ä¸‰ç§æ–¹æ¡ˆ"><a href="#11-1-2-ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…-UV-çš„ä¸‰ç§æ–¹æ¡ˆ" class="headerlink" title="11.1.2 ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†… UV çš„ä¸‰ç§æ–¹æ¡ˆ"></a>11.1.2 ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†… UV çš„ä¸‰ç§æ–¹æ¡ˆ</h3><p>PV ç»Ÿè®¡ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œæ¯æ¥ä¸€æ¡ç”¨æˆ·çš„è®¿é—®æ—¥å¿—åªéœ€è¦ä»æ—¥å¿—ä¸­æå–å‡ºç›¸åº”çš„é¡µé¢ id å’Œæ—¥æœŸï¼Œå°†å…¶å¯¹åº”çš„ PV å€¼åŠ ä¸€å³å¯ã€‚ç›¸å¯¹è€Œè¨€ç»Ÿè®¡ UV å°±æœ‰éš¾åº¦äº†ï¼ŒåŒä¸€ä¸ªç”¨æˆ·ä¸€å¤©å†…å¤šæ¬¡è®¿é—®åŒä¸€ä¸ªé¡µé¢ï¼Œåªèƒ½è®¡æ•°ä¸€æ¬¡ã€‚æ‰€ä»¥æ¯æ¥ä¸€æ¡æ—¥å¿—ï¼Œæ—¥å¿—ä¸­å¯¹åº”é¡µé¢çš„ UV å€¼æ˜¯å¦éœ€è¦åŠ ä¸€å‘¢ï¼Ÿå­˜åœ¨ä¸¤ç§æƒ…å†µï¼šå¦‚æœè¯¥ç”¨æˆ·ä»Šå¤©ç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µé¢ï¼Œé‚£ä¹ˆ UV åº”è¯¥åŠ ä¸€ã€‚å¦‚æœè¯¥ç”¨æˆ·ä»Šå¤©ä¸æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µé¢ï¼Œè¡¨ç¤º UV ä¸­å·²ç»è®°å½•äº†è¯¥ç”¨æˆ·ï¼ŒUV è¦åŸºäºç”¨æˆ·å»é‡ï¼Œæ‰€ä»¥æ­¤æ—¶ UV å€¼ä¸åº”è¯¥åŠ ä¸€ã€‚éš¾ç‚¹å°±åœ¨äºå¦‚ä½•åˆ¤æ–­è¯¥ç”¨æˆ·ä»Šå¤©æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µé¢å‘¢ï¼Ÿ</p><p>æŠŠé—®é¢˜ç®€å•åŒ–ï¼Œå…ˆä¸è€ƒè™‘æ—¥æœŸï¼Œç°åœ¨ç»Ÿè®¡ç½‘ç«™å„é¡µé¢çš„ç´¯ç§¯ UVï¼Œå¯ä»¥ä¸ºæ¯ä¸ªé¡µé¢ç»´æŠ¤ä¸€ä¸ª Set é›†åˆï¼Œå‡å¦‚ç½‘ç«™æœ‰ 10 ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆå°±ç»´æŠ¤ 10 ä¸ª Set é›†åˆï¼Œé›†åˆä¸­å­˜æ”¾ç€æ‰€æœ‰è®¿é—®è¿‡è¯¥é¡µé¢ç”¨æˆ·çš„ user_idã€‚æ¯æ¥ä¸€æ¡ç”¨æˆ·çš„è®¿é—®æ—¥å¿—ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä»æ—¥å¿—ä¸­è§£æå‡ºç›¸åº”çš„é¡µé¢ id å’Œç”¨æˆ· user_idï¼Œå»è¯¥é¡µé¢ id å¯¹åº”çš„ Set ä¸­æŸ¥æ‰¾è¯¥ user_id ä¹‹å‰æœ‰æ²¡æœ‰è®¿é—®è¿‡è¯¥é¡µé¢ï¼Œå¦‚æœ Set ä¸­åŒ…å«è¯¥ user_id è¡¨ç¤ºè¯¥ç”¨æˆ·ä¹‹å‰è®¿é—®è¿‡è¯¥é¡µé¢ï¼Œæ‰€ä»¥è¯¥é¡µé¢çš„ UV å€¼ä¸åº”è¯¥åŠ ä¸€ï¼Œå¦‚æœ Set ä¸­ä¸åŒ…å«è¯¥ user_id è¡¨ç¤ºè¯¥ç”¨æˆ·ä¹‹å‰æ²¡æœ‰è®¿é—®è¿‡è¯¥é¡µé¢ï¼Œæ‰€ä»¥è¯¥é¡µé¢çš„ UV å€¼åº”è¯¥åŠ ä¸€ï¼Œå¹¶ä¸”å°†è¯¥ user_id æ’å…¥åˆ°è¯¥é¡µé¢å¯¹åº”çš„ Set ä¸­ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·è®¿é—®è¿‡è¯¥é¡µé¢äº†ã€‚è¦æŒ‰å¤©å»ç»Ÿè®¡å„é¡µé¢ UVï¼Œåªéœ€è¦å°†æ—¥æœŸå’Œé¡µé¢ id çœ‹åšä¸€ä¸ªæ•´ä½“ keyï¼Œæ¯ä¸ª key å¯¹åº”ä¸€ä¸ª Setï¼Œå…¶ä»–æµç¨‹ä¸ä¸Šè¿°ç±»ä¼¼ã€‚å…·ä½“çš„ç¨‹åºæµç¨‹å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-12-11-151250.png" alt=""></p><h4 id="ä½¿ç”¨-Redis-çš„-set-æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ"><a href="#ä½¿ç”¨-Redis-çš„-set-æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ" class="headerlink" title="ä½¿ç”¨ Redis çš„ set æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ"></a>ä½¿ç”¨ Redis çš„ set æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ</h4><p>æ¯ä¸ª key éƒ½éœ€è¦ç»´æŠ¤ä¸€ä¸ª Setï¼Œè¿™ä¸ª Set å­˜æ”¾åœ¨å“ªé‡Œå‘¢ï¼Ÿè¿™é‡Œæ¯æ¡æ—¥å¿—éƒ½éœ€è¦è®¿é—®ä¸€æ¬¡ Setï¼Œå¯¹ Set è®¿é—®æ¯”è¾ƒé¢‘ç¹ï¼Œå¯¹å­˜å‚¨ä»‹è´¨çš„å»¶è¿Ÿè¦æ±‚æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ Redis çš„ set æ•°æ®ç»“æ„ï¼ŒRedis çš„ set æ•°æ®ç»“æ„ä¹Ÿä¼šå¯¹æ•°æ®è¿›è¡Œå»é‡ã€‚å¯ä»¥å°†é¡µé¢ id å’Œæ—¥æœŸæ‹¼æ¥åšä¸º Redis çš„ keyï¼Œé€šè¿‡ Redis çš„ sadd å‘½ä»¤å°† user_id æ”¾åˆ° key å¯¹åº”çš„ set ä¸­å³å¯ã€‚Redis çš„ set ä¸­å­˜æ”¾ç€ä»Šå¤©è®¿é—®è¿‡è¯¥é¡µé¢æ‰€æœ‰ç”¨æˆ·çš„ user_idã€‚</p><p>åœ¨çœŸå®çš„å·¥ä½œä¸­ï¼ŒFlink ä»»åŠ¡å¯èƒ½ä¸éœ€è¦ç»´æŠ¤ä¸€ä¸ª UV å€¼ï¼ŒFlink ä»»åŠ¡æ‰¿æ‹…çš„è§’è‰²æ˜¯å®æ—¶è®¡ç®—ï¼Œè€ŒæŸ¥è¯¢ UV å¯èƒ½æ˜¯ä¸€ä¸ª Java Web é¡¹ç›®ã€‚Web é¡¹ç›®åªéœ€è¦å» Redis æŸ¥è¯¢ç›¸åº” key å¯¹åº”çš„ set ä¸­å…ƒç´ çš„ä¸ªæ•°å³å¯ï¼ŒRedis çš„ set æ•°æ®ç»“æ„æœ‰ scard å‘½ä»¤å¯ä»¥æŸ¥è¯¢ set ä¸­å…ƒç´ ä¸ªæ•°ï¼Œè¿™é‡Œçš„å…ƒç´ ä¸ªæ•°å°±æ˜¯æˆ‘ä»¬æ‰€è¦ç»Ÿè®¡çš„ç½‘ç«™å„é¡µé¢æ¯å¤©çš„ UV å€¼ã€‚æ‰€ä»¥ä½¿ç”¨ Redis set æ•°æ®ç»“æ„çš„æ–¹æ¡ˆ Flink ä»»åŠ¡çš„ä»£ç å¾ˆç®€å•ï¼Œåªéœ€è¦ä»æ—¥å¿—ä¸­è§£æå‡ºç›¸åº”çš„æ—¥æœŸã€é¡µé¢id å’Œ user_idï¼Œå°†æ—¥æœŸå’Œé¡µé¢ id ç»„åˆåšä¸º Redis çš„ keyï¼Œæœ€åå°† user_id é€šè¿‡ sadd å‘½ä»¤æ·»åŠ åˆ° set ä¸­ï¼ŒFlink ä»»åŠ¡çš„å·¥ä½œå°±ç»“æŸäº†ï¼Œä¹‹å Web é¡¹ç›®å°±èƒ½ä» Redis ä¸­æŸ¥è¯¢åˆ°å®æ—¶å¢åŠ çš„ UV äº†ã€‚ä¸‹é¢æ¥çœ‹è¯¦ç»†çš„ä»£ç å®ç°ã€‚</p><p>ç”¨æˆ·è®¿é—®ç½‘ç«™é¡µé¢çš„æ—¥å¿—å®ä½“ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVisitWebEvent</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ—¥å¿—çš„å”¯ä¸€ id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">// æ—¥æœŸï¼Œå¦‚ï¼š20191025</span></span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="comment">// é¡µé¢ id</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageId;</span><br><span class="line">    <span class="comment">// ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨æˆ· id</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="comment">// é¡µé¢çš„ url</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆæµ‹è¯•æ•°æ®çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">String yyyyMMdd = <span class="keyword">new</span> DateTime(System.currentTimeMillis()).toString(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line"><span class="keyword">int</span> pageId = random.nextInt(<span class="number">10</span>);    <span class="comment">// éšæœºç”Ÿæˆé¡µé¢ id</span></span><br><span class="line"><span class="keyword">int</span> userId = random.nextInt(<span class="number">100</span>);   <span class="comment">// éšæœºç”Ÿæˆç”¨æˆ· id</span></span><br><span class="line"></span><br><span class="line">UserVisitWebEvent userVisitWebEvent = UserVisitWebEvent.builder()</span><br><span class="line">        .id(UUID.randomUUID().toString())   <span class="comment">// æ—¥å¿—çš„å”¯ä¸€ id</span></span><br><span class="line">        .date(yyyyMMdd)                     <span class="comment">// æ—¥æœŸ</span></span><br><span class="line">        .pageId(pageId)                     <span class="comment">// é¡µé¢ id</span></span><br><span class="line">        .userId(Integer.toString(userId))   <span class="comment">// ç”¨æˆ· id</span></span><br><span class="line">        .url(<span class="string">"url/"</span> + pageId)               <span class="comment">// é¡µé¢çš„ url</span></span><br><span class="line">        .build();</span><br><span class="line"><span class="comment">// å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å‘é€åˆ° Kafka</span></span><br><span class="line">ProducerRecord record = <span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(topic,</span><br><span class="line">        <span class="keyword">null</span>, <span class="keyword">null</span>, GsonUtil.toJson(userVisitWebEvent));</span><br><span class="line">producer.send(record);</span><br></pre></td></tr></table></figure><p>ç»Ÿè®¡ UV çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼Œå¯¹ Redis Connector ä¸ç†Ÿæ‚‰çš„è¯·å‚é˜… 3.11 èŠ‚å¦‚ä½•ä½¿ç”¨ Flink Connectors â€”â€” Redisï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisSetUvExample</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//  çœç•¥äº† envåˆå§‹åŒ–åŠ Checkpoint ç›¸å…³é…ç½®</span></span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, UvExampleUtil.broker_list);</span><br><span class="line">        props.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">"app-uv-stat"</span>);</span><br><span class="line"></span><br><span class="line">        FlinkKafkaConsumerBase&lt;String&gt; kafkaConsumer = <span class="keyword">new</span> FlinkKafkaConsumer011&lt;&gt;(</span><br><span class="line">                UvExampleUtil.topic, <span class="keyword">new</span> SimpleStringSchema(), props)</span><br><span class="line">                .setStartFromLatest();</span><br><span class="line"></span><br><span class="line">        FlinkJedisPoolConfig conf = <span class="keyword">new</span> FlinkJedisPoolConfig</span><br><span class="line">                .Builder().setHost(<span class="string">"192.168.30.244"</span>).build();</span><br><span class="line"></span><br><span class="line">        env.addSource(kafkaConsumer)</span><br><span class="line">                .map(string -&gt; &#123;</span><br><span class="line">                    <span class="comment">// ååºåˆ—åŒ– JSON</span></span><br><span class="line">                    UserVisitWebEvent userVisitWebEvent = GsonUtil.fromJson(</span><br><span class="line">                            string, UserVisitWebEvent.class);</span><br><span class="line">                    <span class="comment">// ç”Ÿæˆ Redis keyï¼Œæ ¼å¼ä¸º æ—¥æœŸ_pageIdï¼Œå¦‚: 20191026_0</span></span><br><span class="line">                    String redisKey = userVisitWebEvent.getDate() + <span class="string">"_"</span></span><br><span class="line">                            + userVisitWebEvent.getPageId();</span><br><span class="line">                    <span class="keyword">return</span> Tuple2.of(redisKey, userVisitWebEvent.getUserId());</span><br><span class="line">                &#125;)</span><br><span class="line">                .returns(<span class="keyword">new</span> TypeHint&lt;Tuple2&lt;String, String&gt;&gt;()&#123;&#125;)</span><br><span class="line">                .addSink(<span class="keyword">new</span> RedisSink&lt;&gt;(conf, <span class="keyword">new</span> RedisSaddSinkMapper()));</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"Redis Set UV Stat"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®ä¸ Redis key çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisSaddSinkMapper</span> </span></span><br><span class="line"><span class="class">            <span class="keyword">implements</span> <span class="title">RedisMapper</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RedisCommandDescription <span class="title">getCommandDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//  è¿™é‡Œå¿…é¡»æ˜¯ sadd æ“ä½œ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedisCommandDescription(RedisCommand.SADD);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getKeyFromData</span><span class="params">(Tuple2&lt;String, String&gt; data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> data.f0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getValueFromData</span><span class="params">(Tuple2&lt;String, String&gt; data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> data.f1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Redis ä¸­ç»Ÿè®¡ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦ä¾§å±•ç¤ºçš„ Redis keyï¼Œ20191026_1 è¡¨ç¤º 2019å¹´10æœˆ26æ—¥æµè§ˆè¿‡ pageId ä¸º 1 çš„é¡µé¢å¯¹åº”çš„ keyï¼Œå³ä¾§å±•ç¤º key å¯¹åº”çš„ set é›†åˆï¼Œè¡¨ç¤º userId ä¸º [0,6,27,30,66,67,79,88] çš„ç”¨æˆ·åœ¨ 2019å¹´10æœˆ26æ—¥æµè§ˆè¿‡ pageId ä¸º 1 çš„é¡µé¢ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-31-174242.jpg" style="zoom:50%;" /></p><p>è¦æƒ³è·å– 20191026_1 å¯¹åº”çš„ UV å€¼ï¼Œå¯é€šè¿‡ scard å‘½ä»¤è·å– set ä¸­ user_id çš„æ•°é‡ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis&gt;</span> scard 20191026_1</span><br><span class="line">8</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°ä»£ç å³å¯é€šè¿‡ Redis çš„ set æ•°æ®ç»“æ„æ¥ç»Ÿè®¡ç½‘ç«™å„é¡µé¢çš„ UVã€‚</p><h4 id="ä½¿ç”¨-Flink-çš„-KeyedState-æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ"><a href="#ä½¿ç”¨-Flink-çš„-KeyedState-æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ" class="headerlink" title="ä½¿ç”¨ Flink çš„ KeyedState æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ"></a>ä½¿ç”¨ Flink çš„ KeyedState æ¥ç»´æŠ¤ç”¨æˆ·é›†åˆ</h4><h4 id="ä½¿ç”¨-Redis-çš„-HyperLogLog-æ¥ç»Ÿè®¡-UV"><a href="#ä½¿ç”¨-Redis-çš„-HyperLogLog-æ¥ç»Ÿè®¡-UV" class="headerlink" title="ä½¿ç”¨ Redis çš„ HyperLogLog æ¥ç»Ÿè®¡ UV"></a>ä½¿ç”¨ Redis çš„ HyperLogLog æ¥ç»Ÿè®¡ UV</h4><h3 id="11-1-3-å°ç»“ä¸åæ€"><a href="#11-1-3-å°ç»“ä¸åæ€" class="headerlink" title="11.1.3 å°ç»“ä¸åæ€"></a>11.1.3 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/RBYj66M">https://t.zsxq.com/RBYj66M</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ç¬¬åä¸€ç« -â€”â€”-Flink-å®æˆ˜&quot;&gt;&lt;a href=&quot;#ç¬¬åä¸€ç« -â€”â€”-Flink-å®æˆ˜&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬åä¸€ç«  â€”â€” Flink å®æˆ˜&quot;&gt;&lt;/a&gt;ç¬¬åä¸€ç«  â€”â€” Flink å®æˆ˜&lt;/h1&gt;&lt;p&gt;æœ¬ç« ä¸»è¦æ˜¯ Flink å®æˆ˜ï¼Œä»‹ç»äº†ä¸€äº›å¸¸è§çš„éœ€æ±‚ï¼Œæ¯”å¦‚å®æ—¶ç»Ÿè®¡ç½‘ç«™é¡µé¢çš„ PV/UVã€å®•æœºå‘Šè­¦ã€åŠ¨æ€æ›´æ–°é…ç½®ã€åº”ç”¨ Error æ—¥å¿—å®æ—¶å‘Šè­¦ç­‰ï¼Œç„¶ååˆ†åˆ«å»åˆ†æè¿™äº›éœ€æ±‚çš„å®ç°æ–¹å¼ï¼Œæ˜ç™½è¯¥ä½¿ç”¨ Flink ä¸­çš„å“ªäº›çŸ¥è¯†ç‚¹æ‰èƒ½å¤Ÿå¾ˆå¥½çš„å®Œæˆè¿™ç§éœ€æ±‚ï¼Œå¹¶æä¾›å®Œæ•´çš„æ¡ˆä¾‹ä»£ç ä¾›å¤§å®¶å‚è€ƒã€‚åœ¨å®ç°å®Œæˆè¿™äº›éœ€æ±‚ä¹‹åï¼Œç¬”è€…è¿˜å°†ä¼šæ›´æ·±ä¸€æ­¥çš„å»è®²è§£ä¸‹è¿™äº›çŸ¥è¯†ç‚¹èƒŒåçš„å®ç°æ–¹å¼ï¼Œå¸Œæœ›å¯ä»¥åŠ æ·±ä½ å¯¹è¿™äº›çŸ¥è¯†ç‚¹çš„å°è±¡ï¼Œä»¥ä¾¿åé¢ä½ å¯ä»¥çµæ´»çš„å¤„ç†ç±»ä¼¼çš„éœ€æ±‚ã€‚&lt;/p&gt;
&lt;h2 id=&quot;11-1-å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„-PV-å’Œ-UVï¼Ÿ&quot;&gt;&lt;a href=&quot;#11-1-å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„-PV-å’Œ-UVï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;11.1 å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PV å’Œ UVï¼Ÿ&quot;&gt;&lt;/a&gt;11.1 å¦‚ä½•ç»Ÿè®¡ç½‘ç«™å„é¡µé¢ä¸€å¤©å†…çš„ PV å’Œ UVï¼Ÿ&lt;/h2&gt;&lt;p&gt;å¤§æ•°æ®å¼€å‘æœ€å¸¸ç»Ÿè®¡çš„éœ€æ±‚å¯èƒ½å°±æ˜¯ PVã€UVã€‚PV å…¨æ‹¼ PageViewï¼Œå³é¡µé¢è®¿é—®é‡ï¼Œç”¨æˆ·æ¯æ¬¡å¯¹ç½‘ç«™çš„è®¿é—®å‡è¢«è®°å½•ï¼ŒæŒ‰ç…§è®¿é—®é‡è¿›è¡Œç´¯è®¡ï¼Œå‡å¦‚ç”¨æˆ·å¯¹åŒä¸€é¡µé¢è®¿é—®äº† 5 æ¬¡ï¼Œé‚£è¯¥é¡µé¢çš„ PV å°±åº”è¯¥åŠ  5ã€‚UV å…¨æ‹¼ä¸º UniqueVisitorï¼Œå³ç‹¬ç«‹è®¿é—®ç”¨æˆ·æ•°ï¼Œè®¿é—®è¯¥é¡µé¢çš„ä¸€å°ç”µè„‘å®¢æˆ·ç«¯ä¸ºä¸€ä¸ªè®¿å®¢ï¼Œå‡å¦‚ç”¨æˆ·å¯¹åŒä¸€é¡µé¢è®¿é—®äº† 5 æ¬¡ï¼Œé‚£ä¹ˆè¯¥é¡µé¢çš„ UV åªåº”è¯¥åŠ  1ï¼Œå› ä¸º UV è®¡ç®—çš„æ˜¯å»é‡åçš„ç”¨æˆ·æ•°è€Œä¸æ˜¯è®¿é—®æ¬¡æ•°ã€‚å½“ç„¶å¦‚æœæ˜¯æŒ‰å¤©ç»Ÿè®¡ï¼Œé‚£ä¹ˆå½“å¤© 0 ç‚¹åˆ° 24 ç‚¹ç›¸åŒçš„å®¢æˆ·ç«¯åªè¢«è®¡ç®—ä¸€æ¬¡ï¼Œå¦‚æœè¿‡äº†ä»Šå¤© 24 ç‚¹ï¼Œç¬¬äºŒå¤©è¯¥ç”¨æˆ·åˆè®¿é—®äº†è¯¥é¡µé¢ï¼Œé‚£ä¹ˆç¬¬äºŒå¤©è¯¥é¡µé¢çš„ UV åº”è¯¥åŠ  1ã€‚ æ¦‚å¿µæ˜ç™½äº†é‚£å¦‚ä½•ä½¿ç”¨ Flink æ¥ç»Ÿè®¡ç½‘ç«™å„é¡µé¢çš„ PV å’Œ UV å‘¢ï¼Ÿé€šè¿‡æœ¬èŠ‚æ¥è¯¦ç»†æè¿°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•è®¾ç½® Flink Job RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/13/flink-in-action-10.2/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/13/flink-in-action-10.2/</id>
    <published>2021-08-12T16:00:00.000Z</published>
    <updated>2022-01-23T12:10:45.524Z</updated>
    
    <content type="html"><![CDATA[<h2 id="10-2-å¦‚ä½•ä½¿ç”¨-Flink-ParameterTool-è¯»å–é…ç½®ï¼Ÿ"><a href="#10-2-å¦‚ä½•ä½¿ç”¨-Flink-ParameterTool-è¯»å–é…ç½®ï¼Ÿ" class="headerlink" title="10.2 å¦‚ä½•ä½¿ç”¨ Flink ParameterTool è¯»å–é…ç½®ï¼Ÿ"></a>10.2 å¦‚ä½•ä½¿ç”¨ Flink ParameterTool è¯»å–é…ç½®ï¼Ÿ</h2><p>åœ¨ä½¿ç”¨ Flink ä¸­ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰è§‰å¾—é…ç½®çš„ç®¡ç†å¾ˆä¸æ–¹ä¾¿ï¼Œæ¯”å¦‚åƒç®—å­çš„å¹¶è¡Œåº¦é…ç½®ã€Kafka æ•°æ®æºçš„é…ç½®ï¼ˆbroker åœ°å€ã€topic åã€group.idï¼‰ã€Checkpoint æ˜¯å¦å¼€å¯ã€çŠ¶æ€åç«¯å­˜å‚¨è·¯å¾„ã€æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åå’Œå¯†ç ç­‰ï¼Œåæ­£å„ç§å„æ ·çš„é…ç½®éƒ½æ‚ä¹±åœ¨ä¸€èµ·ï¼Œå½“ç„¶ä½ å¯èƒ½è¯´æˆ‘å°±åœ¨ä»£ç é‡Œé¢å†™æ­»ä¸å°±å¥½äº†ï¼Œä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä½ çš„ä½œä¸šæ˜¯å¦å¯ä»¥ä¸ä¿®æ”¹ä»»ä½•é…ç½®å°±ç›´æ¥åœ¨å„ç§ç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€é¢„å‘ã€ç”Ÿäº§ï¼‰è¿è¡Œå‘¢ï¼Ÿå¯èƒ½æ¯ä¸ªç¯å¢ƒçš„è¿™äº›é…ç½®å¯¹åº”çš„å€¼éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚æœä½ æ˜¯ç›´æ¥åœ¨ä»£ç é‡Œé¢å†™æ­»çš„é…ç½®ï¼Œé‚£è¿™ä¸‹å­å°±æ¯”è¾ƒç—›è‹¦äº†ï¼Œæ¯æ¬¡æ¢ä¸ªç¯å¢ƒå»è¿è¡Œæµ‹è¯•ä½ çš„ä½œä¸šï¼Œä½ éƒ½è¦é‡æ–°å»ä¿®æ”¹ä»£ç ä¸­çš„é…ç½®ï¼Œç„¶åç¼–è¯‘æ‰“åŒ…ï¼Œæäº¤è¿è¡Œï¼Œè¿™æ ·ä½ å°±è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´åœ¨è¿™äº›é‡å¤çš„åŠ³åŠ¨åŠ›ä¸Šäº†ã€‚æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è§£å†³è¿™ç§é—®é¢˜å‘¢ï¼Ÿ</p><a id="more"></a><h3 id="10-2-1-Flink-Job-é…ç½®"><a href="#10-2-1-Flink-Job-é…ç½®" class="headerlink" title="10.2.1 Flink Job é…ç½®"></a>10.2.1 Flink Job é…ç½®</h3><p>åœ¨ Flink ä¸­å…¶å®æ˜¯æœ‰å‡ ç§æ–¹æ³•æ¥ç®¡ç†é…ç½®ï¼Œä¸‹é¢åˆ†åˆ«æ¥è®²è§£ä¸€ä¸‹ã€‚</p><h4 id="ä½¿ç”¨-Configuration"><a href="#ä½¿ç”¨-Configuration" class="headerlink" title="ä½¿ç”¨ Configuration"></a>ä½¿ç”¨ Configuration</h4><p>Flink æä¾›äº† withParameters æ–¹æ³•ï¼Œå®ƒå¯ä»¥ä¼ é€’ Configuration ä¸­çš„å‚æ•°ç»™ï¼Œè¦ä½¿ç”¨å®ƒï¼Œéœ€è¦å®ç°é‚£äº› Rich å‡½æ•°ï¼Œæ¯”å¦‚å®ç° RichMapFunctionï¼Œè€Œä¸æ˜¯ MapFunctionï¼Œå› ä¸º Rich å‡½æ•°ä¸­æœ‰ open æ–¹æ³•ï¼Œç„¶åå¯ä»¥é‡å†™ open æ–¹æ³•é€šè¿‡ Configuration è·å–åˆ°ä¼ å…¥çš„å‚æ•°å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"><span class="comment">// Configuration ç±»æ¥å­˜å‚¨å‚æ•°</span></span><br><span class="line">Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">configuration.setString(<span class="string">"name"</span>, <span class="string">"zhisheng"</span>);</span><br><span class="line"></span><br><span class="line">env.fromElements(WORDS)</span><br><span class="line">        .flatMap(<span class="keyword">new</span> RichFlatMapFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            String name;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//è¯»å–é…ç½®</span></span><br><span class="line">                name = parameters.getString(<span class="string">"name"</span>, <span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String[] splits = value.toLowerCase().split(<span class="string">"\\W+"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (String split : splits) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (split.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(split + name, <span class="number">1</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).withParameters(configuration)    <span class="comment">//å°†å‚æ•°ä¼ é€’ç»™å‡½æ•°</span></span><br><span class="line">        .print();</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¦æ³¨æ„è¿™ä¸ª withParameters åªåœ¨æ‰¹ç¨‹åºä¸­æ”¯æŒï¼Œæµç¨‹åºä¸­æ˜¯æ²¡æœ‰è¯¥æ–¹æ³•çš„ï¼Œå¹¶ä¸”è¿™ä¸ª withParameters è¦åœ¨æ¯ä¸ªç®—å­åé¢ä½¿ç”¨æ‰è¡Œï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡ä½¿ç”¨å°±æ‰€æœ‰éƒ½å¯ä»¥è·å–åˆ°ï¼Œå¦‚æœæ‰€æœ‰ç®—å­éƒ½è¦è¯¥é…ç½®ï¼Œé‚£ä¹ˆå°±é‡å¤è®¾ç½®å¤šæ¬¡å°±ä¼šæ¯”è¾ƒç¹çã€‚</p><h3 id="10-2-2-ParameterTool-ç®¡ç†é…ç½®"><a href="#10-2-2-ParameterTool-ç®¡ç†é…ç½®" class="headerlink" title="10.2.2 ParameterTool ç®¡ç†é…ç½®"></a>10.2.2 ParameterTool ç®¡ç†é…ç½®</h3><p>ä¸Šé¢é€šè¿‡ Configuration çš„å±€é™æ€§å¾ˆå¤§ï¼Œå…¶å®åœ¨ Flink ä¸­è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ ParameterTool ç±»è¯»å–é…ç½®ï¼Œå®ƒå¯ä»¥è¯»å–ç¯å¢ƒå˜é‡ã€è¿è¡Œå‚æ•°ã€é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢åˆ†åˆ«è®²ä¸‹æ¯ç§å¦‚ä½•ä½¿ç”¨ã€‚</p><h4 id="è¯»å–è¿è¡Œå‚æ•°"><a href="#è¯»å–è¿è¡Œå‚æ•°" class="headerlink" title="è¯»å–è¿è¡Œå‚æ•°"></a>è¯»å–è¿è¡Œå‚æ•°</h4><p>æˆ‘ä»¬çŸ¥é“ Flink UI ä¸Šæ˜¯æ”¯æŒä¸ºæ¯ä¸ª Job å•ç‹¬ä¼ å…¥ argumentsï¼ˆå‚æ•°ï¼‰çš„ï¼Œå®ƒçš„æ ¼å¼è¦æ±‚æ˜¯å¦‚ä¸‹è¿™ç§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--brokers 127.0.0.1:9200</span><br><span class="line">--username admin</span><br><span class="line">--password 123456</span><br></pre></td></tr></table></figure><p>æˆ–è€…è¿™ç§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-brokers 127.0.0.1:9200</span><br><span class="line">-username admin</span><br><span class="line">-password 123456</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ Flink ç¨‹åºä¸­ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>ParameterTool.fromArgs(args)</code> è·å–åˆ°æ‰€æœ‰çš„å‚æ•°ï¼Œç„¶åå¦‚æœä½ è¦è·å–æŸä¸ªå‚æ•°å¯¹åº”çš„å€¼çš„è¯ï¼Œå¯ä»¥é€šè¿‡ <code>parameterTool.get(&quot;username&quot;)</code> æ–¹æ³•ã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªåœ°æ–¹å…¶å®ä½ å°±å¯ä»¥å°†é…ç½®æ”¾åœ¨ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æ¥å£ï¼Œç„¶åè¿™ä¸ªå‚æ•°å€¼ä¸­ä¼ å…¥ä¸€ä¸ªæ¥å£ï¼Œæ‹¿åˆ°è¯¥æ¥å£åå°±èƒ½å¤Ÿé€šè¿‡è¯·æ±‚å»è·å–æ›´å¤šä½ æƒ³è¦çš„é…ç½®ã€‚</p><h4 id="è¯»å–ç³»ç»Ÿå±æ€§"><a href="#è¯»å–ç³»ç»Ÿå±æ€§" class="headerlink" title="è¯»å–ç³»ç»Ÿå±æ€§"></a>è¯»å–ç³»ç»Ÿå±æ€§</h4><p>ParameterTool è¿˜æ”¯æŒé€šè¿‡ <code>ParameterTool.fromSystemProperties()</code> æ–¹æ³•è¯»å–ç³»ç»Ÿå±æ€§ã€‚</p><h4 id="è¯»å–é…ç½®æ–‡ä»¶"><a href="#è¯»å–é…ç½®æ–‡ä»¶" class="headerlink" title="è¯»å–é…ç½®æ–‡ä»¶"></a>è¯»å–é…ç½®æ–‡ä»¶</h4><p>é™¤äº†ä¸Šé¢ä¸¤ç§å¤–ï¼ŒParameterTool è¿˜æ”¯æŒ <code>ParameterTool.fromPropertiesFile(&quot;/application.properties&quot;)</code> è¯»å– properties é…ç½®æ–‡ä»¶ã€‚ä½ å¯ä»¥å°†æ‰€æœ‰è¦é…ç½®çš„åœ°æ–¹ï¼ˆæ¯”å¦‚å¹¶è¡Œåº¦å’Œä¸€äº› Kafkaã€MySQL ç­‰é…ç½®ï¼‰éƒ½å†™æˆå¯é…ç½®çš„ï¼Œç„¶åå…¶å¯¹åº”çš„ key å’Œ value å€¼éƒ½å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæœ€åé€šè¿‡ ParameterTool å»è¯»å–é…ç½®æ–‡ä»¶è·å–å¯¹åº”çš„å€¼ã€‚</p><h4 id="ParameterTool-è·å–å€¼"><a href="#ParameterTool-è·å–å€¼" class="headerlink" title="ParameterTool è·å–å€¼"></a>ParameterTool è·å–å€¼</h4><p>ParameterTool ç±»æä¾›äº†å¾ˆå¤šä¾¿æ·æ–¹æ³•å»è·å–å€¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-09-134119.png" alt=""></p><p>ä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„ main() æ–¹æ³•ä¸­ç›´æ¥ä½¿ç”¨è¿™äº›æ–¹æ³•è¿”å›çš„å€¼ï¼Œä¾‹å¦‚ï¼šä½ å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹æ³•æ¥è®¾ç½®ä¸€ä¸ªç®—å­çš„å¹¶è¡Œåº¦ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ParameterTool parameters = ParameterTool.fromArgs(args);</span><br><span class="line"><span class="keyword">int</span> parallelism = parameters.get(<span class="string">"mapParallelism"</span>, <span class="number">2</span>);</span><br><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; counts = data.flatMap(<span class="keyword">new</span> Tokenizer()).setParallelism(parallelism);</span><br></pre></td></tr></table></figure><p>å› ä¸º ParameterTool æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥å°†å®ƒå½“ä½œå‚æ•°è¿›è¡Œä¼ é€’ç»™è‡ªå®šä¹‰çš„å‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ParameterTool parameters = ParameterTool.fromArgs(args);</span><br><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; counts = dara.flatMap(<span class="keyword">new</span> Tokenizer(parameters));</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ ParameterTool æ¥è·å–å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™æ ·å°±æ„å‘³ç€ä½ åœ¨ä½œä¸šä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è·å–åˆ°å‚æ•°ï¼Œè€Œä¸æ˜¯åƒ withParameters ä¸€æ ·éœ€è¦æ¯æ¬¡éƒ½è®¾ç½®ã€‚</p><h4 id="æ³¨å†Œå…¨å±€å‚æ•°"><a href="#æ³¨å†Œå…¨å±€å‚æ•°" class="headerlink" title="æ³¨å†Œå…¨å±€å‚æ•°"></a>æ³¨å†Œå…¨å±€å‚æ•°</h4><p>åœ¨ ExecutionConfig ä¸­å¯ä»¥å°† ParameterTool æ³¨å†Œä¸ºå…¨ä½œä¸šå‚æ•°çš„å‚æ•°ï¼Œè¿™æ ·å°±å¯ä»¥è¢« JobManager çš„ web ç«¯ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ä¸­ä»¥é…ç½®å€¼çš„å½¢å¼è®¿é—®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.getConfig().setGlobalJobParameters(ParameterTool.fromArgs(args));</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥åœ¨ç”¨æˆ·è‡ªå®šä¹‰çš„ Rich å‡½æ•°ä¸­åƒå¦‚ä¸‹è¿™æ ·è·å–åˆ°å‚æ•°å€¼äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">env.addSource(<span class="keyword">new</span> RichSourceFunction&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;String&gt; sourceContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            ParameterTool parameterTool = (ParameterTool) getRuntimeContext().getExecutionConfig().getGlobalJobParameters();</span><br><span class="line">            sourceContext.collect(System.currentTimeMillis() + parameterTool.get(<span class="string">"os.name"</span>) + parameterTool.get(<span class="string">"user.home"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨ç¬”è€…å…¬å¸å†…é€šå¸¸æ˜¯ä»¥ Job è¿è¡Œçš„ç¯å¢ƒå˜é‡ä¸ºå‡†ï¼Œæ¯”å¦‚æˆ‘ä»¬æ˜¯è¿è¡Œåœ¨ K8s ä¸Šé¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šä¸ºæˆ‘ä»¬çš„è¿™ä¸ª Flink Job è®¾ç½®å¾ˆå¤šç¯å¢ƒå˜é‡ï¼Œè®¾ç½®çš„ç¯å¢ƒå˜é‡çš„å€¼å°±å¾—é€šè¿‡ ParameterTool ç±»å»è·å–ï¼Œæˆ‘ä»¬æ˜¯ä¼šä¼˜å…ˆæ ¹æ®ç¯å¢ƒå˜é‡çš„å€¼ä¸ºå‡†ï¼Œå¦‚æœç¯å¢ƒå˜é‡çš„å€¼æ²¡æœ‰å°±ä¼šå»è¯»å–åº”ç”¨è¿è¡Œå‚æ•°ï¼Œå¦‚æœåº”ç”¨è¿è¡Œå‚æ•°ä¹Ÿæ²¡æœ‰æ‰ä¼šå»è¯»å–ä¹‹å‰å·²ç»å†™å¥½åœ¨é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ã€‚å¤§æ¦‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ParameterTool <span class="title">createParameterTool</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ParameterTool</span><br><span class="line">            .fromPropertiesFile(ExecutionEnv.class.getResourceAsStream(<span class="string">"/application.properties"</span>))</span><br><span class="line">            .mergeWith(ParameterTool.fromArgs(args))</span><br><span class="line">            .mergeWith(ParameterTool.fromSystemProperties())</span><br><span class="line">            .mergeWith(ParameterTool.fromMap(getenv()));<span class="comment">// mergeWith ä¼šä½¿ç”¨æœ€æ–°çš„é…ç½®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å– Job è®¾ç½®çš„ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">getenv</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : System.getenv().entrySet()) &#123;</span><br><span class="line">        map.put(entry.getKey().toLowerCase().replace(<span class="string">'_'</span>, <span class="string">'.'</span>), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¦‚æœ Job è¦æ›´æ”¹ä¸€äº›é…ç½®ï¼Œç›´æ¥åœ¨ Job åœ¨ K8s ä¸Šé¢çš„ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®å°±å¥½äº†ï¼Œä¿®æ”¹é…ç½®åç„¶åé‡å¯ Job å°±å¯ä»¥è¿è¡Œèµ·æ¥äº†ï¼Œæ•´ä¸ªè¿‡ç¨‹éƒ½ä¸éœ€è¦å†æ¬¡å°†ä½œä¸šé‡æ–°ç¼–è¯‘æ‰“åŒ…çš„ã€‚ä½†æ˜¯è¿™æ ·å…¶å®ä¹Ÿæœ‰ä¸€å®šçš„åå¤„ï¼Œé‡å¯ä¸€ä¸ªä½œä¸šçš„ä»£ä»·å¾ˆå¤§ï¼Œå› ä¸ºåœ¨é‡å¯åä½ åˆè¦å»ä¿è¯çŠ¶æ€è¦æ¢å¤åˆ°ä¹‹å‰æœªé‡å¯æ—¶çš„çŠ¶æ€ï¼Œå°½ç®¡ Flink ä¸­çš„ Checkpoint å’Œ Savepoint å·²ç»å¾ˆå¼ºå¤§äº†ï¼Œä½†æ˜¯å¯¹äºå¤æ‚çš„å®ƒæ¥è¯´æˆ‘ä»¬å¤šä¸€äº‹ä¸å¦‚å°‘ä¸€äº‹ï¼Œæ‰€ä»¥å…¶å®æ›´å¸Œæœ›èƒ½å¤Ÿç›´æ¥åŠ¨æ€çš„è·å–é…ç½®ï¼Œå¦‚æœé…ç½®åšäº†æ›´æ”¹ï¼Œä½œä¸šèƒ½å¤Ÿæ„ŸçŸ¥åˆ°ã€‚åœ¨ Flink ä¸­æœ‰çš„é…ç½®æ˜¯ä¸èƒ½å¤ŸåŠ¨æ€è®¾ç½®çš„ï¼Œä½†æ˜¯æ¯”å¦‚åº”ç”¨ä¸šåŠ¡é…ç½®å´æ˜¯å¯ä»¥åšåˆ°åŠ¨æ€çš„é…ç½®ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨æ¯”è¾ƒå¼ºå¤§çš„å¹¿æ’­å˜é‡ï¼Œå¹¿æ’­å˜é‡åœ¨ä¹‹å‰ 3.4 èŠ‚å·²ç»ä»‹ç»è¿‡äº†ï¼Œå¦‚æœå¿˜è®°å¯ä»¥å†å›å»æŸ¥çœ‹ï¼Œå¦å¤–åœ¨ 11.4 èŠ‚ä¸­ä¼šé€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹æ¥æ•™ä½ å¦‚ä½•ä½¿ç”¨å¹¿æ’­å˜é‡å»åŠ¨æ€çš„æ›´æ–°é…ç½®æ•°æ®ã€‚</p><h3 id="10-2-3-ParameterTool-æºç åˆ†æ"><a href="#10-2-3-ParameterTool-æºç åˆ†æ" class="headerlink" title="10.2.3 ParameterTool æºç åˆ†æ"></a>10.2.3 ParameterTool æºç åˆ†æ</h3><h3 id="10-2-4-è‡ªå®šä¹‰é…ç½®å‚æ•°ç±»"><a href="#10-2-4-è‡ªå®šä¹‰é…ç½®å‚æ•°ç±»" class="headerlink" title="10.2.4 è‡ªå®šä¹‰é…ç½®å‚æ•°ç±»"></a>10.2.4 è‡ªå®šä¹‰é…ç½®å‚æ•°ç±»</h3><h3 id="10-2-5-å°ç»“ä¸åæ€"><a href="#10-2-5-å°ç»“ä¸åæ€" class="headerlink" title="10.2.5 å°ç»“ä¸åæ€"></a>10.2.5 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/RBYj66M">https://t.zsxq.com/RBYj66M</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p><p>æœ¬ç« è®²äº†ä¸¤ä¸ªå®è·µç›¸å…³çš„å†…å®¹ï¼Œä¸€ä¸ªæ˜¯ä½œä¸šçš„é‡å¯ç­–ç•¥ï¼Œä»åˆ†æçœŸå®çº¿ä¸Šæ•…éšœæ¥æ•™å¤§å®¶å¦‚ä½•å»é…ç½®é‡å¯ç­–ç•¥ï¼Œä»¥åŠä»‹ç»é‡å¯ç­–ç•¥çš„ç§ç±»ï¼Œå¦ä¸€ä¸ªæ˜¯ä½¿ç”¨ ParameterTool å»ç®¡ç†é…ç½®ã€‚ä¸¤ä¸ªå®è·µéƒ½æ˜¯æ¯”è¾ƒçœŸå®ä¸”æœ‰ä¸€å®šå¸®åŠ©ä½œç”¨çš„ï¼Œå¸Œæœ›ä½ ä¹Ÿå¯ä»¥åº”ç”¨åœ¨ä½ çš„é¡¹ç›®ä¸­å»ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;10-2-å¦‚ä½•ä½¿ç”¨-Flink-ParameterTool-è¯»å–é…ç½®ï¼Ÿ&quot;&gt;&lt;a href=&quot;#10-2-å¦‚ä½•ä½¿ç”¨-Flink-ParameterTool-è¯»å–é…ç½®ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;10.2 å¦‚ä½•ä½¿ç”¨ Flink ParameterTool è¯»å–é…ç½®ï¼Ÿ&quot;&gt;&lt;/a&gt;10.2 å¦‚ä½•ä½¿ç”¨ Flink ParameterTool è¯»å–é…ç½®ï¼Ÿ&lt;/h2&gt;&lt;p&gt;åœ¨ä½¿ç”¨ Flink ä¸­ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰è§‰å¾—é…ç½®çš„ç®¡ç†å¾ˆä¸æ–¹ä¾¿ï¼Œæ¯”å¦‚åƒç®—å­çš„å¹¶è¡Œåº¦é…ç½®ã€Kafka æ•°æ®æºçš„é…ç½®ï¼ˆbroker åœ°å€ã€topic åã€group.idï¼‰ã€Checkpoint æ˜¯å¦å¼€å¯ã€çŠ¶æ€åç«¯å­˜å‚¨è·¯å¾„ã€æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åå’Œå¯†ç ç­‰ï¼Œåæ­£å„ç§å„æ ·çš„é…ç½®éƒ½æ‚ä¹±åœ¨ä¸€èµ·ï¼Œå½“ç„¶ä½ å¯èƒ½è¯´æˆ‘å°±åœ¨ä»£ç é‡Œé¢å†™æ­»ä¸å°±å¥½äº†ï¼Œä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä½ çš„ä½œä¸šæ˜¯å¦å¯ä»¥ä¸ä¿®æ”¹ä»»ä½•é…ç½®å°±ç›´æ¥åœ¨å„ç§ç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€é¢„å‘ã€ç”Ÿäº§ï¼‰è¿è¡Œå‘¢ï¼Ÿå¯èƒ½æ¯ä¸ªç¯å¢ƒçš„è¿™äº›é…ç½®å¯¹åº”çš„å€¼éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚æœä½ æ˜¯ç›´æ¥åœ¨ä»£ç é‡Œé¢å†™æ­»çš„é…ç½®ï¼Œé‚£è¿™ä¸‹å­å°±æ¯”è¾ƒç—›è‹¦äº†ï¼Œæ¯æ¬¡æ¢ä¸ªç¯å¢ƒå»è¿è¡Œæµ‹è¯•ä½ çš„ä½œä¸šï¼Œä½ éƒ½è¦é‡æ–°å»ä¿®æ”¹ä»£ç ä¸­çš„é…ç½®ï¼Œç„¶åç¼–è¯‘æ‰“åŒ…ï¼Œæäº¤è¿è¡Œï¼Œè¿™æ ·ä½ å°±è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´åœ¨è¿™äº›é‡å¤çš„åŠ³åŠ¨åŠ›ä¸Šäº†ã€‚æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è§£å†³è¿™ç§é—®é¢˜å‘¢ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•è®¾ç½® Flink Job RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/12/flink-in-action-10.1/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/12/flink-in-action-10.1/</id>
    <published>2021-08-11T16:00:00.000Z</published>
    <updated>2022-01-23T12:08:58.313Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬åç« -â€”â€”-Flink-æœ€ä½³å®è·µ"><a href="#ç¬¬åç« -â€”â€”-Flink-æœ€ä½³å®è·µ" class="headerlink" title="ç¬¬åç«  â€”â€” Flink æœ€ä½³å®è·µ"></a>ç¬¬åç«  â€”â€” Flink æœ€ä½³å®è·µ</h1><p>æœ¬ç« å°†ä»‹ç»ä¸¤ä¸ªæœ€ä½³å®è·µï¼Œç¬¬ä¸€ä¸ªæ˜¯å¦‚ä½•åˆç†çš„é…ç½®é‡å¯ç­–ç•¥ï¼Œç¬”è€…é€šè¿‡è‡ªå·±çš„äº²èº«ç»å†æ¥è®²è¿°é…ç½®é‡å¯ç­–ç•¥çš„é‡è¦æ€§ï¼Œæ¥ç€ä»‹ç»äº† Flink ä¸­çš„é‡å¯ç­–ç•¥å’Œæ¢å¤ç­–ç•¥çš„å‘å±•å®ç°è¿‡ç¨‹ï¼›ç¬¬äºŒä¸ªæ˜¯å¦‚ä½•å»ç®¡ç† Flink ä½œä¸šçš„é…ç½®ã€‚ä¸¤ä¸ªå®è·µå¤§å®¶å¯ä»¥å‚è€ƒï¼Œä¸ä¸€å®šè¦ç…§æ¬è¿ç”¨åœ¨è‡ªå·±çš„å…¬å¸ï¼ŒåŒæ—¶ä¹Ÿå¸Œæœ›ä½ å¯ä»¥æ€è€ƒä¸‹è‡ªå·±æ˜¯å¦æœ‰å•¥æœ€ä½³å®è·µå¯ä»¥åˆ†äº«ã€‚</p><h2 id="10-1-å¦‚ä½•è®¾ç½®-Flink-Job-RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ"><a href="#10-1-å¦‚ä½•è®¾ç½®-Flink-Job-RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ" class="headerlink" title="10.1 å¦‚ä½•è®¾ç½® Flink Job RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ"></a>10.1 å¦‚ä½•è®¾ç½® Flink Job RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ</h2><p>ä»ä½¿ç”¨ Flink åˆ°è‡³ä»Šï¼Œé‡åˆ°çš„ Flink æœ‰å¾ˆå¤šï¼Œè§£å†³çš„é—®é¢˜æ›´å¤šï¼ˆå«å¸®åŠ©å¾®ä¿¡å¥½å‹è§£å†³é—®é¢˜ï¼‰ï¼Œæ‰€ä»¥å¯¹äº Flink å¯èƒ½é‡åˆ°çš„é—®é¢˜åŠè§£å†³åŠæ³•éƒ½æ¯”è¾ƒæ¸…æ¥šï¼Œé‚£ä¹ˆåœ¨è¿™ç« å°±ç»™å¤§å®¶è®²è§£ä¸‹å‡ ä¸ª Flink ä¸­æ¯”è¾ƒå¸¸é‡åˆ°çš„é—®é¢˜çš„è§£å†³åŠæ³•ã€‚</p><a id="more"></a><h3 id="10-1-1-å¸¸è§é”™è¯¯å¯¼è‡´-Flink-ä½œä¸šé‡å¯"><a href="#10-1-1-å¸¸è§é”™è¯¯å¯¼è‡´-Flink-ä½œä¸šé‡å¯" class="headerlink" title="10.1.1 å¸¸è§é”™è¯¯å¯¼è‡´ Flink ä½œä¸šé‡å¯"></a>10.1.1 å¸¸è§é”™è¯¯å¯¼è‡´ Flink ä½œä¸šé‡å¯</h3><p>ä¸çŸ¥é“å¤§å®¶æ˜¯å¦æœ‰é‡åˆ°è¿‡è¿™æ ·çš„é—®é¢˜ï¼šæ•´ä¸ª Job ä¸€ç›´åœ¨é‡å¯ï¼Œå¹¶ä¸”è¿˜ä¼šä¼´éšç€ä¸€äº›é”™è¯¯ï¼ˆå¯ä»¥é€šè¿‡ UI æŸ¥çœ‹ Exceptions æ—¥å¿—ï¼‰ï¼Œä»¥ä¸‹ä¸‰å¼ å›¾ç‰‡ä¸­çš„é”™è¯¯ä¿¡æ¯æ˜¯ç¬”è€…æ›¾ç»ç”Ÿäº§ç¯å¢ƒé‡åˆ°è¿‡çš„ä¸€äº›é—®é¢˜ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-04-152844.png" alt=""></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-06-140519.png" alt=""></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-26-2019-05-14_00-59-25.png" alt=""></p><p>ç¬”è€…å°±æ›¾å› ä¸ºä¸Šå›¾ä¸­çš„ä¸€ä¸ªå¼‚å¸¸æŠ¥é”™ï¼Œä½œä¸šä¸€ç›´é‡å¯ï¼Œåœ¨æ·±å¤œçº¿ä¸Šå‘ç‰ˆçš„æ—¶å€™ï¼ŒåŒäº‹å‘ç°è¿™ä¸ªé—®é¢˜ï¼Œå‡Œæ™¨ä¸¤ç‚¹çš„æ—¶å€™æ‰“ç”µè¯æŠŠæˆ‘å«é†’èµ·æ¥ä¿® BUGï¼ŒçœŸæ˜¯æƒ¨çš„æ•™è®­ï¼Œå“ˆå“ˆå“ˆï¼Œä¼°è®¡è¿™è¾ˆå­éƒ½å¿˜ä¸æ‰äº†ï¼</p><p>å…¶å®é‡åˆ°ä¸Šé¢è¿™ç§é—®é¢˜æ¯”è¾ƒå¸¸è§çš„ï¼Œæ¯”å¦‚æœ‰æ—¶å€™å› ä¸ºæ•°æ®çš„é—®é¢˜ï¼ˆä¸åˆè§„èŒƒã€ä¸º null ç­‰ï¼‰ï¼Œè¿™æ—¶åœ¨å¤„ç†è¿™äº›è„æ•°æ®çš„æ—¶å€™å¯èƒ½å°±ä¼šé‡åˆ°å„ç§å„æ ·çš„å¼‚å¸¸é”™è¯¯ï¼Œæ¯”å¦‚ç©ºæŒ‡é’ˆã€æ•°ç»„è¶Šç•Œã€æ•°æ®ç±»å‹è½¬æ¢é”™è¯¯ç­‰ã€‚å¯èƒ½ä½ ä¼šè¯´åªè¦è¿‡æ»¤æ‰è¿™ç§è„æ•°æ®å°±è¡Œäº†ï¼Œæˆ–è€…è¿›è¡Œå¼‚å¸¸æ•è·å°±ä¸ä¼šå¯¼è‡´ Job ä¸æ–­é‡å¯çš„é—®é¢˜äº†ã€‚</p><p>ç¡®å®å¦‚æ­¤ï¼Œå¦‚æœåšå¥½äº†è„æ•°æ®çš„è¿‡æ»¤å’Œå¼‚å¸¸çš„æ•è·ï¼ŒJob çš„ç¨³å®šæ€§ç¡®å®æœ‰ä¿è¯ï¼Œä½†æ˜¯å¤æ‚çš„ Job ä¸‹æ¯ä¸ªç®—å­å¯èƒ½éƒ½ä¼šäº§ç”Ÿå‡ºè„æ•°æ®ï¼ˆåŒ…å«æºæ•°æ®å¯èƒ½ä¹Ÿä¼šä¸ºç©ºæˆ–è€…ä¸åˆæ³•çš„æ•°æ®ï¼‰ï¼Œä½ ä¸å¯èƒ½åœ¨æ¯ä¸ªç®—å­é‡Œé¢ä¹Ÿç”¨ä¸€ä¸ªå¤§çš„ try catch åšä¸€ä¸ªå¼‚å¸¸æ•è·ï¼Œæ‰€ä»¥è„æ•°æ®å’Œå¼‚å¸¸ç®€ç›´å°±æ˜¯é˜²ä¸èƒœé˜²ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯è¦å°½åŠ›çš„ä¿è¯ä»£ç çš„å¥å£®æ€§ï¼Œä½†æ˜¯ä¹Ÿè¦é…ç½®å¥½ Flink Job çš„ RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ã€‚</p><h3 id="10-1-2-RestartStrategy-ç®€ä»‹"><a href="#10-1-2-RestartStrategy-ç®€ä»‹" class="headerlink" title="10.1.2 RestartStrategy ç®€ä»‹"></a>10.1.2 RestartStrategy ç®€ä»‹</h3><p>RestartStrategyï¼Œé‡å¯ç­–ç•¥ï¼Œåœ¨é‡åˆ°æœºå™¨æˆ–è€…ä»£ç ç­‰ä¸å¯é¢„çŸ¥çš„é—®é¢˜æ—¶å¯¼è‡´ Job æˆ–è€… Task æŒ‚æ‰çš„æ—¶å€™ï¼Œå®ƒä¼šæ ¹æ®é…ç½®çš„é‡å¯ç­–ç•¥å°† Job æˆ–è€…å—å½±å“çš„ Task æ‹‰èµ·æ¥é‡æ–°æ‰§è¡Œï¼Œä»¥ä½¿å¾—ä½œä¸šæ¢å¤åˆ°ä¹‹å‰æ­£å¸¸æ‰§è¡ŒçŠ¶æ€ã€‚Flink ä¸­çš„é‡å¯ç­–ç•¥å†³å®šäº†æ˜¯å¦è¦é‡å¯ Job æˆ–è€… Taskï¼Œä»¥åŠé‡å¯çš„æ¬¡æ•°å’Œæ¯æ¬¡é‡å¯çš„æ—¶é—´é—´éš”ã€‚</p><h3 id="10-1-3-ä¸ºä»€ä¹ˆéœ€è¦-RestartStrategyï¼Ÿ"><a href="#10-1-3-ä¸ºä»€ä¹ˆéœ€è¦-RestartStrategyï¼Ÿ" class="headerlink" title="10.1.3 ä¸ºä»€ä¹ˆéœ€è¦ RestartStrategyï¼Ÿ"></a>10.1.3 ä¸ºä»€ä¹ˆéœ€è¦ RestartStrategyï¼Ÿ</h3><p>é‡å¯ç­–ç•¥ä¼šè®© Job ä»ä¸Šä¸€æ¬¡å®Œæ•´çš„ Checkpoint å¤„æ¢å¤çŠ¶æ€ï¼Œä¿è¯ Job å’ŒæŒ‚ä¹‹å‰çš„çŠ¶æ€ä¿æŒä¸€è‡´ï¼Œå¦å¤–è¿˜å¯ä»¥è®© Job ç»§ç»­å¤„ç†æ•°æ®ï¼Œä¸ä¼šå‡ºç° Job æŒ‚äº†å¯¼è‡´æ¶ˆæ¯å‡ºç°å¤§é‡å †ç§¯çš„é—®é¢˜ï¼Œåˆç†çš„è®¾ç½®é‡å¯ç­–ç•¥å¯ä»¥å‡å°‘ Job ä¸å¯ç”¨æ—¶é—´å’Œé¿å…äººå·¥ä»‹å…¥å¤„ç†æ•…éšœçš„è¿ç»´æˆæœ¬ï¼Œå› æ­¤é‡å¯ç­–ç•¥å¯¹äº Flink Job çš„ç¨³å®šæ€§æ¥è¯´æœ‰ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚</p><h3 id="10-1-4-å¦‚ä½•é…ç½®-RestartStrategyï¼Ÿ"><a href="#10-1-4-å¦‚ä½•é…ç½®-RestartStrategyï¼Ÿ" class="headerlink" title="10.1.4 å¦‚ä½•é…ç½® RestartStrategyï¼Ÿ"></a>10.1.4 å¦‚ä½•é…ç½® RestartStrategyï¼Ÿ</h3><p>æ—¢ç„¶ Flink ä¸­çš„é‡å¯ç­–ç•¥ä½œç”¨è¿™ä¹ˆå¤§ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•é…ç½®å‘¢ï¼Ÿå…¶å®å¦‚æœ Flink Job æ²¡æœ‰å•ç‹¬è®¾ç½®é‡å¯é‡å¯ç­–ç•¥çš„è¯ï¼Œåˆ™ä¼šä½¿ç”¨é›†ç¾¤å¯åŠ¨æ—¶åŠ è½½çš„é»˜è®¤é‡å¯ç­–ç•¥ï¼Œå¦‚æœ Flink Job ä¸­å•ç‹¬è®¾ç½®äº†é‡å¯ç­–ç•¥åˆ™ä¼šè¦†ç›–é»˜è®¤çš„é›†ç¾¤é‡å¯ç­–ç•¥ã€‚é»˜è®¤é‡å¯ç­–ç•¥å¯ä»¥åœ¨ Flink çš„é…ç½®æ–‡ä»¶ <code>flink-conf.yaml</code> ä¸­è®¾ç½®ï¼Œç”± <code>restart-strategy</code> å‚æ•°æ§åˆ¶ï¼Œæœ‰ fixed-delayï¼ˆå›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼‰ã€failure-rateï¼ˆæ•…éšœç‡é‡å¯ç­–ç•¥ï¼‰ã€noneï¼ˆä¸é‡å¯ç­–ç•¥ï¼‰ä¸‰ç§å¯ä»¥é€‰æ‹©ï¼Œå¦‚æœé€‰æ‹©çš„å‚æ•°ä¸åŒï¼Œå¯¹åº”çš„å…¶ä»–å‚æ•°ä¹Ÿä¸åŒã€‚ä¸‹é¢åˆ†åˆ«ä»‹ç»è¿™å‡ ç§é‡å¯ç­–ç•¥å’Œå¦‚ä½•é…ç½®ã€‚</p><h4 id="FixedDelayRestartStrategyï¼ˆå›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼‰"><a href="#FixedDelayRestartStrategyï¼ˆå›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼‰" class="headerlink" title="FixedDelayRestartStrategyï¼ˆå›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼‰"></a>FixedDelayRestartStrategyï¼ˆå›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼‰</h4><p>FixedDelayRestartStrategy æ˜¯å›ºå®šå»¶è¿Ÿé‡å¯ç­–ç•¥ï¼Œç¨‹åºæŒ‰ç…§é›†ç¾¤é…ç½®æ–‡ä»¶ä¸­æˆ–è€…ç¨‹åºä¸­é¢å¤–è®¾ç½®çš„é‡å¯æ¬¡æ•°å°è¯•é‡å¯ä½œä¸šï¼Œå¦‚æœå°è¯•æ¬¡æ•°è¶…è¿‡äº†ç»™å®šçš„æœ€å¤§æ¬¡æ•°ï¼Œç¨‹åºè¿˜æ²¡æœ‰èµ·æ¥ï¼Œåˆ™åœæ­¢ä½œä¸šï¼Œå¦å¤–è¿˜å¯ä»¥é…ç½®è¿ç»­ä¸¤æ¬¡é‡å¯ä¹‹é—´çš„ç­‰å¾…æ—¶é—´ï¼Œåœ¨ <code>flink-conf.yaml</code> ä¸­å¯ä»¥åƒä¸‹é¢è¿™æ ·é…ç½®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">restart-strategy:</span> <span class="string">fixed-delay</span></span><br><span class="line"><span class="string">restart-strategy.fixed-delay.attempts:</span> <span class="number">3</span>  <span class="comment">#è¡¨ç¤ºä½œä¸šé‡å¯çš„æœ€å¤§æ¬¡æ•°ï¼Œå¯ç”¨ checkpoint çš„è¯æ˜¯ Integer.MAX_VALUEï¼Œå¦åˆ™æ˜¯ 1ã€‚</span></span><br><span class="line"><span class="string">restart-strategy.fixed-delay.delay:</span> <span class="number">10</span> <span class="string">s</span>  <span class="comment">#å¦‚æœè®¾ç½®åˆ†é’Ÿå¯ä»¥ç±»ä¼¼ 1 minï¼Œè¯¥å‚æ•°è¡¨ç¤ºä¸¤æ¬¡é‡å¯ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œå½“ç¨‹åºä¸å¤–éƒ¨ç³»ç»Ÿæœ‰è¿æ¥äº¤äº’æ—¶å»¶è¿Ÿé‡å¯å¯èƒ½ä¼šæœ‰å¸®åŠ©ï¼Œå¯ç”¨ checkpoint çš„è¯ï¼Œå»¶è¿Ÿé‡å¯çš„æ—¶é—´æ˜¯ 10 ç§’ï¼Œå¦åˆ™ä½¿ç”¨ akka.ask.timeout çš„å€¼ã€‚</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¨‹åºä¸­è®¾ç½®å›ºå®šå»¶è¿Ÿé‡å¯ç­–ç•¥çš„è¯å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.setRestartStrategy(RestartStrategies.fixedDelayRestart(</span><br><span class="line">  <span class="number">3</span>, <span class="comment">// å°è¯•é‡å¯çš„æ¬¡æ•°</span></span><br><span class="line">  Time.of(<span class="number">10</span>, TimeUnit.SECONDS) <span class="comment">// å»¶æ—¶</span></span><br><span class="line">));</span><br></pre></td></tr></table></figure><h4 id="FailureRateRestartStrategyï¼ˆæ•…éšœç‡é‡å¯ç­–ç•¥ï¼‰"><a href="#FailureRateRestartStrategyï¼ˆæ•…éšœç‡é‡å¯ç­–ç•¥ï¼‰" class="headerlink" title="FailureRateRestartStrategyï¼ˆæ•…éšœç‡é‡å¯ç­–ç•¥ï¼‰"></a>FailureRateRestartStrategyï¼ˆæ•…éšœç‡é‡å¯ç­–ç•¥ï¼‰</h4><p>FailureRateRestartStrategy æ˜¯æ•…éšœç‡é‡å¯ç­–ç•¥ï¼Œåœ¨å‘ç”Ÿæ•…éšœä¹‹åé‡å¯ä½œä¸šï¼Œå¦‚æœå›ºå®šæ—¶é—´é—´éš”ä¹‹å†…å‘ç”Ÿæ•…éšœçš„æ¬¡æ•°è¶…è¿‡è®¾ç½®çš„å€¼åï¼Œä½œä¸šå°±ä¼šå¤±è´¥åœæ­¢ï¼Œè¯¥é‡å¯ç­–ç•¥ä¹Ÿæ”¯æŒè®¾ç½®è¿ç»­ä¸¤æ¬¡é‡å¯ä¹‹é—´çš„ç­‰å¾…æ—¶é—´ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">restart-strategy:</span> <span class="string">failure-rate</span></span><br><span class="line"><span class="string">restart-strategy.failure-rate.max-failures-per-interval:</span> <span class="number">3</span>  <span class="comment">#å›ºå®šæ—¶é—´é—´éš”å†…å…è®¸çš„æœ€å¤§é‡å¯æ¬¡æ•°ï¼Œé»˜è®¤ 1</span></span><br><span class="line"><span class="string">restart-strategy.failure-rate.failure-rate-interval:</span> <span class="number">5</span> <span class="string">min</span>  <span class="comment">#å›ºå®šæ—¶é—´é—´éš”ï¼Œé»˜è®¤ 1 åˆ†é’Ÿ</span></span><br><span class="line"><span class="string">restart-strategy.failure-rate.delay:</span> <span class="number">10</span> <span class="string">s</span> <span class="comment">#è¿ç»­ä¸¤æ¬¡é‡å¯å°è¯•ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤æ˜¯ akka.ask.timeout</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­è¿™æ ·è®¾ç½®æ¥é…ç½®æ•…éšœç‡é‡å¯ç­–ç•¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.setRestartStrategy(RestartStrategies.failureRateRestart(</span><br><span class="line">  <span class="number">3</span>, <span class="comment">// å›ºå®šæ—¶é—´é—´éš”å…è®¸ Job é‡å¯çš„æœ€å¤§æ¬¡æ•°</span></span><br><span class="line">  Time.of(<span class="number">5</span>, TimeUnit.MINUTES), <span class="comment">// å›ºå®šæ—¶é—´é—´éš”</span></span><br><span class="line">  Time.of(<span class="number">10</span>, TimeUnit.SECONDS) <span class="comment">// ä¸¤æ¬¡é‡å¯çš„å»¶è¿Ÿæ—¶é—´</span></span><br><span class="line">));</span><br></pre></td></tr></table></figure><h4 id="NoRestartStrategyï¼ˆä¸é‡å¯ç­–ç•¥ï¼‰"><a href="#NoRestartStrategyï¼ˆä¸é‡å¯ç­–ç•¥ï¼‰" class="headerlink" title="NoRestartStrategyï¼ˆä¸é‡å¯ç­–ç•¥ï¼‰"></a>NoRestartStrategyï¼ˆä¸é‡å¯ç­–ç•¥ï¼‰</h4><p>NoRestartStrategy ä½œä¸šä¸é‡å¯ç­–ç•¥ï¼Œç›´æ¥å¤±è´¥åœæ­¢ï¼Œåœ¨ <code>flink-conf.yaml</code> ä¸­é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">restart-strategy:</span> <span class="string">none</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¨‹åºä¸­å¦‚ä¸‹è®¾ç½®å³å¯é…ç½®ä¸é‡å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.setRestartStrategy(RestartStrategies.noRestart());</span><br></pre></td></tr></table></figure><h4 id="Fallbackï¼ˆå¤‡ç”¨é‡å¯ç­–ç•¥ï¼‰"><a href="#Fallbackï¼ˆå¤‡ç”¨é‡å¯ç­–ç•¥ï¼‰" class="headerlink" title="Fallbackï¼ˆå¤‡ç”¨é‡å¯ç­–ç•¥ï¼‰"></a>Fallbackï¼ˆå¤‡ç”¨é‡å¯ç­–ç•¥ï¼‰</h4><p>å¦‚æœç¨‹åºæ²¡æœ‰å¯ç”¨ Checkpointï¼Œåˆ™é‡‡ç”¨ä¸é‡å¯ç­–ç•¥ï¼Œå¦‚æœå¼€å¯äº† Checkpoint ä¸”æ²¡æœ‰è®¾ç½®é‡å¯ç­–ç•¥ï¼Œé‚£ä¹ˆé‡‡ç”¨å›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼Œæœ€å¤§é‡å¯æ¬¡æ•°ä¸º Integer.MAX_VALUEã€‚</p><p>åœ¨åº”ç”¨ç¨‹åºä¸­é…ç½®å¥½äº†å›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼Œå¯ä»¥æµ‹è¯•ä¸€ä¸‹ä»£ç å¼‚å¸¸åå¯¼è‡´ Job å¤±è´¥åé‡å¯çš„æƒ…å†µï¼Œç„¶åè§‚å¯Ÿæ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ° Job é‡å¯ç›¸å…³çš„æ—¥å¿—ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[flink-akka.actor.default-dispatcher-5] INFO org.apache.flink.runtime.executiongraph.ExecutionGraph - Try to restart or fail the job zhisheng default RestartStrategy example (a890361aed156610b354813894d02cd0) if no longer possible.</span><br><span class="line">[flink-akka.actor.default-dispatcher-5] INFO org.apache.flink.runtime.executiongraph.ExecutionGraph - Job zhisheng default RestartStrategy example (a890361aed156610b354813894d02cd0) switched from state FAILING to RESTARTING.</span><br><span class="line">[flink-akka.actor.default-dispatcher-5] INFO org.apache.flink.runtime.executiongraph.ExecutionGraph - Restarting the job zhisheng default RestartStrategy example (a890361aed156610b354813894d02cd0).</span><br></pre></td></tr></table></figure><p>æœ€åé‡å¯æ¬¡æ•°è¾¾åˆ°é…ç½®çš„æœ€å¤§é‡å¯æ¬¡æ•°å Job è¿˜æ²¡æœ‰èµ·æ¥çš„è¯ï¼Œåˆ™ä¼šåœæ­¢ Job å¹¶æ‰“å°æ—¥å¿—ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[flink-akka.actor.default-dispatcher-2] INFO org.apache.flink.runtime.executiongraph.ExecutionGraph - Could not restart the job zhisheng default RestartStrategy example (a890361aed156610b354813894d02cd0) because the restart strategy prevented it.</span><br></pre></td></tr></table></figure><p>Flink ä¸­å‡ ç§é‡å¯ç­–ç•¥çš„è®¾ç½®å¦‚ä¸Šï¼Œå¤§å®¶å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„é‡å¯ç­–ç•¥ï¼Œæ¯”å¦‚å¦‚æœç¨‹åºæŠ›å‡ºäº†ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä½†æ˜¯ä½ é…ç½®çš„æ˜¯ä¸€ç›´æ— é™é‡å¯ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ Job ä¸€ç›´åœ¨é‡å¯ï¼Œè¿™æ ·æ— éå†æµªè´¹æœºå™¨èµ„æºï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥é…ç½®é‡è¯•å›ºå®šæ¬¡æ•°ï¼Œæ¯æ¬¡éš”å¤šä¹…é‡è¯•çš„å›ºå®šå»¶æ—¶é‡å¯ç­–ç•¥ï¼Œè¿™æ ·åœ¨é‡è¯•ä¸€å®šæ¬¡æ•°å Job å°±ä¼šåœæ­¢ï¼Œå¦‚æœå¯¹ Job çš„çŠ¶æ€åšäº†ç›‘æ§å‘Šè­¦çš„è¯ï¼Œé‚£ä¹ˆä½ å°±ä¼šæ”¶åˆ°å‘Šè­¦ä¿¡æ¯ï¼Œè¿™æ ·ä¹Ÿä¼šæç¤ºä½ å»æŸ¥çœ‹ Job çš„è¿è¡ŒçŠ¶å†µï¼Œèƒ½åŠæ—¶çš„å»å‘ç°å’Œä¿®å¤ Job çš„é—®é¢˜ã€‚</p><h3 id="10-1-5-RestartStrategy-æºç åˆ†æ"><a href="#10-1-5-RestartStrategy-æºç åˆ†æ" class="headerlink" title="10.1.5 RestartStrategy æºç åˆ†æ"></a>10.1.5 RestartStrategy æºç åˆ†æ</h3><p>å†ä»‹ç»é‡å¯ç­–ç•¥åº”ç”¨ç¨‹åºä»£ç é…ç½®çš„æ—¶å€™ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰çœ‹åˆ°è®¾ç½®é‡å¯ç­–ç•¥éƒ½æ˜¯ä½¿ç”¨ RestartStrategies ç±»ï¼Œé€šè¿‡è¯¥ç±»çš„æ–¹æ³•å°±å¯ä»¥åˆ›å»ºä¸åŒçš„é‡å¯ç­–ç•¥ï¼Œåœ¨ RestartStrategies ç±»ä¸­æä¾›äº†äº”ä¸ªæ–¹æ³•ç”¨æ¥åˆ›å»ºå››ç§ä¸åŒçš„é‡å¯ç­–ç•¥ï¼ˆæœ‰ä¸¤ä¸ªæ–¹æ³•æ˜¯åˆ›å»º FixedDelay é‡å¯ç­–ç•¥çš„ï¼Œåªä¸è¿‡æ–¹æ³•çš„å‚æ•°ä¸åŒï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-08-151745.png" alt=""></p><p>åœ¨æ¯ä¸ªæ–¹æ³•å†…éƒ¨å…¶å®è°ƒç”¨çš„æ˜¯ RestartStrategies ä¸­çš„å†…éƒ¨é™æ€ç±»ï¼Œåˆ†åˆ«æ˜¯ NoRestartStrategyConfigurationã€FixedDelayRestartStrategyConfigurationã€FailureRateRestartStrategyConfigurationã€FallbackRestartStrategyConfigurationï¼Œè¿™å››ä¸ªç±»éƒ½ç»§æ‰¿è‡ª RestartStrategyConfiguration æŠ½è±¡ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-08-151617.png" alt=""></p><p>ä¸Šé¢æ˜¯å®šä¹‰çš„å››ç§é‡å¯ç­–ç•¥çš„é…ç½®ç±»ï¼Œåœ¨ Flink ä¸­æ˜¯é  RestartStrategyResolving ç±»ä¸­çš„ resolve æ–¹æ³•æ¥è§£æ RestartStrategies.RestartStrategyConfigurationï¼Œç„¶åæ ¹æ®é…ç½®ä½¿ç”¨ RestartStrategyFactory åˆ›å»º RestartStrategyã€‚RestartStrategy æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰ canRestart å’Œ restart ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ƒæœ‰å››ä¸ªå®ç°ç±»ï¼š FixedDelayRestartStrategyã€FailureRateRestartStrategyã€ThrowingRestartStrategyã€NoRestartStrategyï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-08-151311.png" alt=""></p><h3 id="10-1-6-Failover-Strategiesï¼ˆæ•…éšœæ¢å¤ç­–ç•¥ï¼‰"><a href="#10-1-6-Failover-Strategiesï¼ˆæ•…éšœæ¢å¤ç­–ç•¥ï¼‰" class="headerlink" title="10.1.6 Failover Strategiesï¼ˆæ•…éšœæ¢å¤ç­–ç•¥ï¼‰"></a>10.1.6 Failover Strategiesï¼ˆæ•…éšœæ¢å¤ç­–ç•¥ï¼‰</h3><h4 id="é‡å¯æ‰€æœ‰çš„ä»»åŠ¡"><a href="#é‡å¯æ‰€æœ‰çš„ä»»åŠ¡" class="headerlink" title="é‡å¯æ‰€æœ‰çš„ä»»åŠ¡"></a>é‡å¯æ‰€æœ‰çš„ä»»åŠ¡</h4><h4 id="åŸºäº-Region-çš„å±€éƒ¨æ•…éšœé‡å¯ç­–ç•¥"><a href="#åŸºäº-Region-çš„å±€éƒ¨æ•…éšœé‡å¯ç­–ç•¥" class="headerlink" title="åŸºäº Region çš„å±€éƒ¨æ•…éšœé‡å¯ç­–ç•¥"></a>åŸºäº Region çš„å±€éƒ¨æ•…éšœé‡å¯ç­–ç•¥</h4><h3 id="10-1-7-å°ç»“ä¸åæ€"><a href="#10-1-7-å°ç»“ä¸åæ€" class="headerlink" title="10.1.7 å°ç»“ä¸åæ€"></a>10.1.7 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/RBYj66M">https://t.zsxq.com/RBYj66M</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ç¬¬åç« -â€”â€”-Flink-æœ€ä½³å®è·µ&quot;&gt;&lt;a href=&quot;#ç¬¬åç« -â€”â€”-Flink-æœ€ä½³å®è·µ&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬åç«  â€”â€” Flink æœ€ä½³å®è·µ&quot;&gt;&lt;/a&gt;ç¬¬åç«  â€”â€” Flink æœ€ä½³å®è·µ&lt;/h1&gt;&lt;p&gt;æœ¬ç« å°†ä»‹ç»ä¸¤ä¸ªæœ€ä½³å®è·µï¼Œç¬¬ä¸€ä¸ªæ˜¯å¦‚ä½•åˆç†çš„é…ç½®é‡å¯ç­–ç•¥ï¼Œç¬”è€…é€šè¿‡è‡ªå·±çš„äº²èº«ç»å†æ¥è®²è¿°é…ç½®é‡å¯ç­–ç•¥çš„é‡è¦æ€§ï¼Œæ¥ç€ä»‹ç»äº† Flink ä¸­çš„é‡å¯ç­–ç•¥å’Œæ¢å¤ç­–ç•¥çš„å‘å±•å®ç°è¿‡ç¨‹ï¼›ç¬¬äºŒä¸ªæ˜¯å¦‚ä½•å»ç®¡ç† Flink ä½œä¸šçš„é…ç½®ã€‚ä¸¤ä¸ªå®è·µå¤§å®¶å¯ä»¥å‚è€ƒï¼Œä¸ä¸€å®šè¦ç…§æ¬è¿ç”¨åœ¨è‡ªå·±çš„å…¬å¸ï¼ŒåŒæ—¶ä¹Ÿå¸Œæœ›ä½ å¯ä»¥æ€è€ƒä¸‹è‡ªå·±æ˜¯å¦æœ‰å•¥æœ€ä½³å®è·µå¯ä»¥åˆ†äº«ã€‚&lt;/p&gt;
&lt;h2 id=&quot;10-1-å¦‚ä½•è®¾ç½®-Flink-Job-RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ&quot;&gt;&lt;a href=&quot;#10-1-å¦‚ä½•è®¾ç½®-Flink-Job-RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;10.1 å¦‚ä½•è®¾ç½® Flink Job RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ&quot;&gt;&lt;/a&gt;10.1 å¦‚ä½•è®¾ç½® Flink Job RestartStrategyï¼ˆé‡å¯ç­–ç•¥ï¼‰ï¼Ÿ&lt;/h2&gt;&lt;p&gt;ä»ä½¿ç”¨ Flink åˆ°è‡³ä»Šï¼Œé‡åˆ°çš„ Flink æœ‰å¾ˆå¤šï¼Œè§£å†³çš„é—®é¢˜æ›´å¤šï¼ˆå«å¸®åŠ©å¾®ä¿¡å¥½å‹è§£å†³é—®é¢˜ï¼‰ï¼Œæ‰€ä»¥å¯¹äº Flink å¯èƒ½é‡åˆ°çš„é—®é¢˜åŠè§£å†³åŠæ³•éƒ½æ¯”è¾ƒæ¸…æ¥šï¼Œé‚£ä¹ˆåœ¨è¿™ç« å°±ç»™å¤§å®¶è®²è§£ä¸‹å‡ ä¸ª Flink ä¸­æ¯”è¾ƒå¸¸é‡åˆ°çš„é—®é¢˜çš„è§£å†³åŠæ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•å¤„ç† Flink ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/11/flink-in-action-9.6/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/11/flink-in-action-9.6/</id>
    <published>2021-08-10T16:00:00.000Z</published>
    <updated>2022-01-23T12:05:28.185Z</updated>
    
    <content type="html"><![CDATA[<h2 id="9-6-å¦‚ä½•å¤„ç†-Flink-ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ"><a href="#9-6-å¦‚ä½•å¤„ç†-Flink-ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ" class="headerlink" title="9.6 å¦‚ä½•å¤„ç† Flink ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ"></a>9.6 å¦‚ä½•å¤„ç† Flink ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ</h2><p>åœ¨å¤§æ•°æ®è®¡ç®—åœºæ™¯ï¼Œæ— è®ºä½¿ç”¨ MapReduceã€Spark è¿˜æ˜¯ Flink è®¡ç®—æ¡†æ¶ï¼Œæ— è®ºæ˜¯æ‰¹å¤„ç†è¿˜æ˜¯æµå¤„ç†éƒ½å­˜åœ¨æ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œé€šè¿‡æœ¬èŠ‚å­¦ä¹ äº§ç”Ÿæ•°æ®å€¾æ–œçš„åŸå› åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒè§£å†³æ•°æ®å€¾æ–œã€‚</p><a id="more"></a><h3 id="9-6-1-æ•°æ®å€¾æ–œç®€ä»‹"><a href="#9-6-1-æ•°æ®å€¾æ–œç®€ä»‹" class="headerlink" title="9.6.1 æ•°æ®å€¾æ–œç®€ä»‹"></a>9.6.1 æ•°æ®å€¾æ–œç®€ä»‹</h3><p>åˆ†æä¸€ä¸ªè®¡ç®—å„ app PV çš„æ¡ˆä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ†çƒè¡¨ç¤º app1 çš„æ—¥å¿—ï¼Œæ–¹å—è¡¨ç¤º app2 çš„æ—¥å¿—ï¼ŒSource ç«¯ä»å¤–éƒ¨ç³»ç»Ÿè¯»å–ç”¨æˆ·ä¸ŠæŠ¥çš„å„ app è¡Œä¸ºæ—¥å¿—ï¼Œè¦è®¡ç®—å„ app çš„ PVï¼Œæ‰€ä»¥æŒ‰ç…§ app è¿›è¡Œ keyByï¼Œç›¸åŒ app çš„æ•°æ®å‘é€åˆ°åŒä¸€ä¸ª Operator å®ä¾‹ä¸­å¤„ç†ï¼ŒkeyBy åå¯¹ app çš„ PV å€¼è¿›è¡Œç´¯åŠ æ¥ï¼Œæœ€åå°†è®¡ç®—çš„ PV ç»“æœè¾“å‡ºåˆ°å¤–éƒ¨ Sink ç«¯ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-11-12-004442.jpg" alt=""></p><p>å¯ä»¥çœ‹åˆ°åœ¨ä»»åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè®¡ç®— Count çš„ç®—å­æœ‰ä¸¤ä¸ªå¹¶è¡Œåº¦ï¼Œå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œåº¦å¤„ç† app1 çš„æ•°æ®ï¼Œå¦ä¸€ä¸ªå¹¶è¡Œåº¦å¤„ç† app2 çš„æ•°æ®ã€‚ç”±äº app1 æ¯”è¾ƒçƒ­é—¨ï¼Œæ‰€ä»¥ app1 çš„æ—¥å¿—é‡è¿œå¤§äº app2 çš„æ—¥å¿—é‡ï¼Œé€ æˆè®¡ç®— app1 PV çš„å¹¶è¡Œåº¦å‹åŠ›è¿‡å¤§æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆï¼Œè€Œè®¡ç®— app2 PV çš„å¹¶è¡Œåº¦æ•°æ®é‡è¾ƒå°‘æ‰€ä»¥ CPUã€å†…å­˜ä»¥åŠç½‘ç»œèµ„æºçš„ä½¿ç”¨ç‡æ•´ä½“éƒ½æ¯”è¾ƒä½ï¼Œè¿™å°±æ˜¯äº§ç”Ÿæ•°æ®å€¾æ–œçš„æ¡ˆä¾‹ã€‚</p><p>éšç€ä¸šåŠ¡çš„ä¸æ–­å‘å±•ï¼Œå¦‚æœ app1 çš„æ—¥å¿—é‡æš´å¢ï¼Œå•ä¸ªèŠ‚ç‚¹çš„å•ä¸ªå¹¶è¡Œåº¦å·²ç»æ‰¿æ‹…ä¸äº†è®¡ç®— app1 PV çš„ä»»åŠ¡ï¼Œæ­¤æ—¶å¦‚ä½•æ¥è§£å†³å‘¢ï¼Ÿå¯¹äºä¸äº†è§£æ•°æ®å€¾æ–œçš„åŒå­¦çœ‹åˆ° Flink ä»»åŠ¡å‡ºç°äº†å»¶è¿Ÿï¼Œç»“åˆä¹‹å‰å­¦ä¹ çš„åå‹ç« èŠ‚ï¼Œå®šä½æ•´ä¸ª Flink ä»»åŠ¡çš„ç“¶é¢ˆåœ¨äº Count ç®—å­ï¼Œæ‰€ä»¥è®¤ä¸º Count ç®—å­çš„å¹¶è¡Œåº¦ä¸å¤Ÿï¼Œäºæ˜¯è§£å†³æ€è·¯å°±æ˜¯è°ƒå¤§ Count ç®—å­çš„å¹¶è¡Œåº¦è‡³ 4 æ¥æé«˜ Count ç®—å­çš„è®¡ç®—èƒ½åŠ›ï¼Œè°ƒå¤§å¹¶è¡Œåº¦ä»¥åå‘ç° Flink ä»»åŠ¡çš„ååé‡å¹¶æ²¡æœ‰æå‡ï¼Œè€Œä¸”é€šè¿‡åå‹æœºåˆ¶å®šä½åˆ°ç³»ç»Ÿçš„ç“¶é¢ˆè¿˜åœ¨äº Count ç®—å­ï¼Œéš¾é“ Count ç®—å­çš„å¹¶è¡Œåº¦éœ€è¦ä» 2 è°ƒå¤§åˆ° 10 å—ï¼ŸNoï¼Œä¸Šè¿°æƒ…å†µå°±ç®—æŠŠå¹¶è¡Œåº¦è°ƒå¤§åˆ° 100ï¼Œä¾ç„¶ä¸èƒ½è§£å†³ä»»åŠ¡ç“¶é¢ˆã€‚ä¸ºä»€ä¹ˆå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè¦è®¡ç®—å„ app çš„ PV æ•°æ®ï¼Œé‚£ä¹ˆç›¸åŒ app çš„æ•°æ®å¿…ç„¶è¦å‘é€åˆ°ç›¸åŒçš„ Operator å®ä¾‹å»å¤„ç†ï¼Œç°åœ¨åªæœ‰ä¸¤ä¸ª appï¼Œæœ€å¤šåªèƒ½åˆ†é…åˆ°ä¸¤ä¸ªå¹¶è¡Œåº¦ä¸Šå»æ‰§è¡Œï¼Œå¦‚æœ Count ç®—å­çš„å¹¶è¡Œåº¦å¤§äº 2ï¼Œæ„å‘³ç€è‚¯å®šæœ‰ä¸€äº›å¹¶è¡Œåº¦åˆ†é…ä¸åˆ°æ•°æ®ï¼Œæ‰€ä»¥ä¸Šè¿°æƒ…å†µè°ƒå¤§ Count ç®—å­çš„å¹¶è¡Œåº¦ä¸èƒ½è§£å†³é—®é¢˜ã€‚é‚£ä½¿ç”¨ Flink å¦‚ä½•æ¥è§£å†³æ•°æ®å€¾æ–œå‘¢ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹  Flink ä¸­å¦‚ä½•æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†æ•°æ®å€¾æ–œã€‚</p><h3 id="9-6-2-åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®å€¾æ–œ"><a href="#9-6-2-åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®å€¾æ–œ" class="headerlink" title="9.6.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®å€¾æ–œ"></a>9.6.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®å€¾æ–œ</h3><p>è¿™é‡Œå†é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥è®²è¿° Flink ä»»åŠ¡å¦‚ä½•æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®å€¾æ–œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯ Flink Web UI Job é¡µé¢å±•ç¤ºçš„ä»»åŠ¡æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥çœ‹åˆ°ä»»åŠ¡ç»è¿‡ Operator Chain åï¼Œæ€»å…±æœ‰ä¸¤ä¸ª Taskï¼Œä¸Šæ¸¸ Task å°†æ•°æ® keyBy åå‘é€åˆ°ä¸‹æ¸¸ Taskï¼Œå¦‚ä½•åˆ¤æ–­ç¬¬äºŒä¸ª Task è®¡ç®—çš„æ•°æ®æ˜¯å¦å­˜åœ¨æ•°æ®å‘¢ï¼Ÿ</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-11-12-004443.jpg" alt=""></p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé€šè¿‡ Flink Web UI ä¸­ Job é¡µé¢çš„ç¬¬ä¸€ä¸ª Subtasks é€‰é¡¹å¡ï¼Œå¯ä»¥çœ‹åˆ°ä»»åŠ¡çš„ä¸¤ä¸ª Taskï¼Œç‚¹å‡» Taskï¼Œå¯ä»¥çœ‹åˆ° Task ç›¸åº”çš„ Subtask è¯¦æƒ…ã€‚ä¾‹å¦‚ Subtask çš„å¯åŠ¨æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æŒç»­æ—¶é•¿ã€æ¥æ”¶æ•°æ®é‡çš„å­—èŠ‚æ•°ä»¥åŠæ¥æ”¶æ•°æ®çš„ä¸ªæ•°ã€‚å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç›¸åŒ Task çš„å¤šä¸ª Subtask ä¸­ï¼Œæœ‰çš„ Subtask æ¥æ”¶åˆ° 1.69 TB çš„æ•°æ®é‡ï¼Œæœ‰çš„ Subtask æ¥æ”¶åˆ° 17.6 TB çš„æ•°æ®é‡ï¼Œé€šè¿‡ Flink Web UI å¯ä»¥ç²¾ç¡®åœ°çœ‹åˆ°æ¯ä¸ª Subtask å¤„ç†äº†å¤šå°‘æ•°æ®ï¼Œå³å¯åˆ¤æ–­å‡º Flink ä»»åŠ¡æ˜¯å¦å­˜åœ¨æ•°æ®å€¾æ–œï¼Œæ¥ä¸‹æ¥å­¦ä¹  Flink ä¸­å¦‚ä½•æ¥è§£å†³æ•°æ®å€¾æ–œã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-11-12-004431.jpg" alt=""></p><h3 id="9-6-3-åˆ†æå’Œè§£å†³æ•°æ®å€¾æ–œé—®é¢˜"><a href="#9-6-3-åˆ†æå’Œè§£å†³æ•°æ®å€¾æ–œé—®é¢˜" class="headerlink" title="9.6.3 åˆ†æå’Œè§£å†³æ•°æ®å€¾æ–œé—®é¢˜"></a>9.6.3 åˆ†æå’Œè§£å†³æ•°æ®å€¾æ–œé—®é¢˜</h3><p>åœ¨ Flink ä¸­ï¼Œå¾ˆå¤šå› ç´ éƒ½ä¼šå¯¼è‡´æ•°æ®å€¾æ–œï¼Œä¾‹å¦‚ 9.6.1 èŠ‚æè¿°çš„ keyBy åçš„èšåˆæ“ä½œå­˜åœ¨æ•°æ®å€¾æ–œã€‚keyBy ä¹‹å‰çš„æ•°æ®ç›´æ¥æ¥è‡ªäºæ•°æ®æºï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°æ•°æ®å€¾æ–œï¼Œé™¤éæ•°æ®æºä¸­çš„æ•°æ®å‘ç”Ÿäº†æ•°æ®å€¾æ–œã€‚æœ¬å°èŠ‚å°†ä»å¤šä¸ªè§’åº¦æ¥è§£å†³æ•°æ®å€¾æ–œã€‚</p><h5 id="keyBy-åçš„èšåˆæ“ä½œå­˜åœ¨æ•°æ®å€¾æ–œ"><a href="#keyBy-åçš„èšåˆæ“ä½œå­˜åœ¨æ•°æ®å€¾æ–œ" class="headerlink" title="keyBy åçš„èšåˆæ“ä½œå­˜åœ¨æ•°æ®å€¾æ–œ"></a>keyBy åçš„èšåˆæ“ä½œå­˜åœ¨æ•°æ®å€¾æ–œ</h5><h5 id="keyBy-ä¹‹å‰å‘ç”Ÿæ•°æ®å€¾æ–œ"><a href="#keyBy-ä¹‹å‰å‘ç”Ÿæ•°æ®å€¾æ–œ" class="headerlink" title="keyBy ä¹‹å‰å‘ç”Ÿæ•°æ®å€¾æ–œ"></a>keyBy ä¹‹å‰å‘ç”Ÿæ•°æ®å€¾æ–œ</h5><h3 id="9-6-4-å°ç»“ä¸åæ€"><a href="#9-6-4-å°ç»“ä¸åæ€" class="headerlink" title="9.6.4 å°ç»“ä¸åæ€"></a>9.6.4 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/uFEEYzJ">https://t.zsxq.com/uFEEYzJ</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p><p>åœ¨å‰ä¸€ç« ä¸­è®²è§£äº† Flink ç›‘æ§ç³»ç»Ÿçš„é‡è¦æ€§ï¼Œè¿™ç« ä¸»è¦è®²è§£ Flink ä½œä¸šçš„æ€§èƒ½è°ƒä¼˜ã€‚å½“ä½œä¸šå‡ºç°å„ç§å„æ ·çš„é—®é¢˜æ—¶ï¼Œå…¶å®è¿™æ—¶å°±ä½“ç°äº†å‰é¢ç« èŠ‚æåˆ°çš„ç›‘æ§çš„é‡è¦æ€§ï¼Œæ‰€ä»¥æœ¬ç« çš„å†…å®¹ä¹Ÿæ¯”è¾ƒä¾èµ–äºç›‘æ§ç³»ç»Ÿï¼Œç„¶åæ‰èƒ½å¤Ÿæ›´å¥½çš„å»æ’æŸ¥é—®é¢˜ï¼Œç„¶åå»è§£å†³é—®é¢˜ã€‚</p><p>åœ¨æœ¬ç« ä¸­è®²è§£çš„åå‹é—®é¢˜ã€å¹¶è¡Œåº¦è®¾ç½®é—®é¢˜ã€æ•°æ®å€¾æ–œé—®é¢˜ç­‰éƒ½æ˜¯å¼€å‘ä½œä¸šæ—¶è¦æ³¨æ„çš„ç‚¹ï¼Œæœ¬ç« ä¸ä»…è®²è§£äº†è¿™äº›é—®é¢˜å‡ºç°åçš„è§£å†³æ–¹æ¡ˆï¼Œè¿˜æ·±å…¥çš„å‰–æäº†è¿™äº›é—®é¢˜ä¸ºå•¥ä¼šå‡ºç°ï¼Œåªæœ‰çŸ¥å…¶åŸå› åï¼Œåé¢å¼€å‘æ–°çš„ä½œä¸šæ—¶æ‰ä¼šå»æ³¨æ„è¿™äº›é—®é¢˜ã€‚æœ¬ç« çš„å†…å®¹å±äºé«˜é˜¶ç©å®¶è¦æŒæ¡çš„ï¼Œå¸Œæœ›ä½ ä¹Ÿèƒ½å¤Ÿå¥½å¥½ç†è§£ï¼Œåœ¨ä½ ä»¬å…¬å¸é‡åˆ°åŒæ ·é—®é¢˜çš„æ—¶å€™å¯ä»¥ç«™å‡ºæ¥å»è§£å†³ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;9-6-å¦‚ä½•å¤„ç†-Flink-ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ&quot;&gt;&lt;a href=&quot;#9-6-å¦‚ä½•å¤„ç†-Flink-ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;9.6 å¦‚ä½•å¤„ç† Flink ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ&quot;&gt;&lt;/a&gt;9.6 å¦‚ä½•å¤„ç† Flink ä¸­æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ&lt;/h2&gt;&lt;p&gt;åœ¨å¤§æ•°æ®è®¡ç®—åœºæ™¯ï¼Œæ— è®ºä½¿ç”¨ MapReduceã€Spark è¿˜æ˜¯ Flink è®¡ç®—æ¡†æ¶ï¼Œæ— è®ºæ˜¯æ‰¹å¤„ç†è¿˜æ˜¯æµå¤„ç†éƒ½å­˜åœ¨æ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œé€šè¿‡æœ¬èŠ‚å­¦ä¹ äº§ç”Ÿæ•°æ®å€¾æ–œçš„åŸå› åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒè§£å†³æ•°æ®å€¾æ–œã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” Flink ä¸­å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/11/flink-in-action-9.5/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/11/flink-in-action-9.5/</id>
    <published>2021-08-10T16:00:00.000Z</published>
    <updated>2022-01-23T12:03:10.112Z</updated>
    
    <content type="html"><![CDATA[<h2 id="9-5-Flink-ä¸­å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ"><a href="#9-5-Flink-ä¸­å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ" class="headerlink" title="9.5 Flink ä¸­å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ"></a>9.5 Flink ä¸­å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ</h2><p>åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéšæ—¶å¯èƒ½å‡ºç°ä»»ä½•å½¢å¼çš„æ•…éšœï¼Œä¾‹å¦‚ï¼šæœºå™¨ç¡¬ä»¶æ•…éšœã€ç¨‹åº OOM ç­‰ã€‚å½“åº”ç”¨ç¨‹åºå‡ºç°æ•…éšœæ—¶ï¼ŒFlink ä¸ºäº†ä¿è¯æ•°æ®æ¶ˆè´¹çš„ Exactly Onceï¼Œéœ€è¦æœ‰ç›¸åº”çš„æ•…éšœå®¹é”™èƒ½åŠ›ã€‚Flink æ˜¯é€šè¿‡å‘¨æœŸæ€§ Checkpoint çš„æ–¹å¼æ¥å®ç°æ•…éšœå®¹é”™ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯åŸºäº Chandy-Lamport æ”¹è¿›çš„ç®—æ³•ã€‚æœ¬èŠ‚ä¼šä»‹ç» Flink å†…éƒ¨å¦‚ä½•ä¿è¯ Exactly Once ä»¥åŠç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯ Exactly Onceã€‚</p><a id="more"></a><h3 id="9-5-1-Flink-å†…éƒ¨å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ"><a href="#9-5-1-Flink-å†…éƒ¨å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ" class="headerlink" title="9.5.1 Flink å†…éƒ¨å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ"></a>9.5.1 Flink å†…éƒ¨å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ</h3><p>Flink å®˜ç½‘çš„å®šä¹‰æ˜¯ Stateful Computations over Data Streamsï¼ˆæ•°æ®æµä¸Šçš„æœ‰çŠ¶æ€è®¡ç®—ï¼‰ï¼Œé‚£åˆ°åº•ä»€ä¹ˆæ˜¯çŠ¶æ€å‘¢ï¼Ÿä¸¾ä¸€ä¸ªæ— çŠ¶æ€è®¡ç®—çš„ä¾‹å­ï¼Œæ¯”å¦‚ï¼šæˆ‘ä»¬åªæ˜¯è¿›è¡Œä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œè¾“å…¥aï¼Œè¾“å‡ºa_666,è¾“å…¥bï¼Œè¾“å‡º b_666ã€‚æ— çŠ¶æ€è¡¨ç¤ºè®¡ç®—è¾“å‡ºçš„ç»“æœè·Ÿä¹‹å‰çš„çŠ¶æ€æ²¡å…³ç³»ï¼Œç¬¦åˆå¹‚ç­‰æ€§ã€‚å¹‚ç­‰æ€§å°±æ˜¯ç”¨æˆ·å¯¹äºåŒä¸€æ“ä½œå‘èµ·çš„ä¸€æ¬¡è¯·æ±‚æˆ–è€…å¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä¸ä¼šå› ä¸ºå¤šæ¬¡ç‚¹å‡»è€Œäº§ç”Ÿå‰¯ä½œç”¨ã€‚è€Œè®¡ç®— PVã€UV å°±å±äºæœ‰çŠ¶æ€è®¡ç®—ã€‚å®æ—¶è®¡ç®— PV æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦ä»æŸä¸ªå­˜å‚¨ä»‹è´¨çš„ç»“æœè¡¨ä¸­æ‹¿åˆ°ä¹‹å‰çš„ PV å€¼ï¼Œ+1 å set åˆ°ç»“æœè¡¨ä¸­ã€‚æœ‰çŠ¶æ€è®¡ç®—è¡¨ç¤ºè¾“å‡ºçš„ç»“æœè·Ÿä¹‹å‰çš„çŠ¶æ€æœ‰å…³ç³»ï¼Œä¸ç¬¦åˆå¹‚ç­‰æ€§ï¼Œè®¿é—®å¤šæ¬¡ï¼ŒPV ä¼šå¢åŠ ã€‚</p><h4 id="Flinkçš„-Checkpoint-åŠŸèƒ½ç®€ä»‹"><a href="#Flinkçš„-Checkpoint-åŠŸèƒ½ç®€ä»‹" class="headerlink" title="Flinkçš„ Checkpoint åŠŸèƒ½ç®€ä»‹"></a>Flinkçš„ Checkpoint åŠŸèƒ½ç®€ä»‹</h4><p>Flink Checkpoint æœºåˆ¶çš„å­˜åœ¨å°±æ˜¯ä¸ºäº†è§£å†³ Flink ä»»åŠ¡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç”±äºå„ç§åŸå› å¯¼è‡´ä»»åŠ¡å¤±è´¥åï¼Œèƒ½å¤Ÿæ­£å¸¸æ¢å¤ä»»åŠ¡ã€‚é‚£ Checkpoint å…·ä½“åšäº†å“ªäº›åŠŸèƒ½ï¼Œä¸ºä»€ä¹ˆä»»åŠ¡æŒ‚æ‰ä¹‹åï¼Œé€šè¿‡ Checkpoint æœºåˆ¶èƒ½ä½¿å¾—ä»»åŠ¡æ¢å¤å‘¢ï¼ŸCheckpoint æ˜¯é€šè¿‡ç»™ç¨‹åºåšå¿«ç…§çš„æ–¹å¼ä½¿å¾—å°†æ•´ä¸ªç¨‹åºæŸäº›æ—¶åˆ»çš„çŠ¶æ€ä¿å­˜ä¸‹æ¥ï¼Œå½“ä»»åŠ¡æŒ‚æ‰ä¹‹åï¼Œé»˜è®¤ä»æœ€è¿‘ä¸€æ¬¡ä¿å­˜çš„å®Œæ•´å¿«ç…§å¤„è¿›è¡Œæ¢å¤ä»»åŠ¡ã€‚é—®é¢˜æ¥äº†ï¼Œå¿«ç…§æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼ŸSnapShotç¿»è¯‘ä¸ºå¿«ç…§ï¼Œæ˜¯æŒ‡å°†ç¨‹åºä¸­æŸäº›ä¿¡æ¯å­˜ä¸€ä»½ï¼ŒåæœŸå¯ä»¥ç”¨è¿™äº›ä¿¡æ¯æ¥æ¢å¤ä»»åŠ¡ã€‚å¯¹äºä¸€ä¸ª Flink ä»»åŠ¡æ¥è®²ï¼Œå¿«ç…§é‡Œé¢åˆ°åº•ä¿å­˜ç€ä»€ä¹ˆä¿¡æ¯å‘¢ï¼Ÿç†è®ºçŸ¥è¯†ä¸€èˆ¬æ¯”è¾ƒæ™¦æ¶©éš¾æ‡‚ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸ªæ¡ˆä¾‹ï¼Œç”¨æ¡ˆä¾‹è¾…åŠ©å¤§å®¶ç†è§£å¿«ç…§é‡Œé¢åˆ°åº•å­˜å‚¨ä»€ä¹ˆä¿¡æ¯ã€‚è®¡ç®—å„ä¸ª app çš„ PVï¼Œä½¿ç”¨ Flink è¯¥æ€ä¹ˆç»Ÿè®¡å‘¢ï¼Ÿ</p><p>å¯ä»¥æŠŠè¦ç»Ÿè®¡çš„ app_id åšä¸º keyï¼Œå¯¹åº”çš„ PV å€¼åšä¸º valueï¼Œå°†ç»Ÿè®¡çš„ç»“æœæ”¾åˆ°ä¸€ä¸ª Map é›†åˆä¸­ï¼Œè¿™ä¸ª Map é›†åˆå¯ä»¥æ˜¯å†…å­˜é‡Œçš„ HashMap æˆ–å…¶ä»– kv æ•°æ®åº“ï¼Œä¾‹å¦‚æ”¾åˆ°Redis çš„ keyã€value ç»“æ„ä¸­ã€‚ä» Kafka è¯»å–åˆ°ä¸€æ¡æ¡æ—¥å¿—ï¼Œç”±äºè¦ç»Ÿè®¡å„ app çš„ PVï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»æ—¥å¿—ä¸­è§£æå‡º app_id å­—æ®µï¼Œæ¯æ¥ä¸€æ¡æ—¥å¿—ï¼Œåªéœ€è¦ä» Map é›†åˆå°†ç›¸åº” app_id çš„ PV å€¼æ‹¿å‡ºæ¥ï¼Œ+1 å put åˆ° Map ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬çš„ Map ä¸­æ°¸è¿œä¿å­˜ç€æ‰€æœ‰ app æœ€æ–°çš„ PV æ•°æ®ã€‚è¯¦ç»†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151541.jpg" alt="flinkä»»åŠ¡taskå›¾.png" style="zoom:50%;" /></p><p>å›¾ä¸­åŒ…å«ä¸‰éƒ¨åˆ†ï¼šç¬¬ä¸€ä¸ªæ˜¯ Kafka çš„ä¸€ä¸ªåä¸º test çš„ Topicï¼Œæˆ‘ä»¬çš„æ•°æ®æ¥æºäºè¿™ä¸ª Topicï¼Œç¬¬äºŒä¸ªæ˜¯ Flink çš„ Source Taskï¼Œæ˜¯ Flink åº”ç”¨ç¨‹åºè¯»å–æ•°æ®çš„ Taskï¼Œç¬¬ä¸‰ä¸ªæ˜¯è®¡ç®— PV çš„ Flink Taskï¼Œç”¨äºç»Ÿè®¡å„ä¸ª app çš„ PV å€¼ï¼Œå¹¶å°† PV ç»“æœè¾“å‡ºåˆ° Map é›†åˆã€‚</p><p>Flink çš„ Source Task è®°å½•äº†å½“å‰æ¶ˆè´¹åˆ° test Topic æ‰€æœ‰ partition çš„ offsetï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ Checkpoint çš„ä½œç”¨ï¼Œè¿™é‡Œå…ˆç”¨ä¸€ä¸ª partition è¿›è¡Œè®²è§£ï¼Œå‡è®¾åä¸º test çš„ Topicåªæœ‰ä¸€ä¸ªpartition0ã€‚ä¾‹ï¼šï¼ˆ0ï¼Œ60000ï¼‰è¡¨ç¤º0å·partition ç›®å‰æ¶ˆè´¹åˆ° offset ä¸º 60000 çš„æ•°æ®ã€‚Flink çš„ PV task è®°å½•äº†å½“å‰è®¡ç®—çš„å„ app çš„ PV å€¼ï¼Œä¸ºäº†æ–¹ä¾¿è®²è§£ï¼Œè¿™é‡Œå‡è®¾æœ‰ä¸¤ä¸ªappï¼šapp1ã€app2ã€‚ä¾‹ï¼šï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰è¡¨ç¤º app1 å½“å‰ PV å€¼ä¸º50000ã€app2 å½“å‰ PV å€¼ä¸º 10000ã€‚è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®ï¼Œåªéœ€è¦ç¡®å®šç›¸åº” app_idï¼Œå°†ç›¸åº”çš„ PV å€¼ +1 å put åˆ° map ä¸­å³å¯ã€‚</p><p>è¯¥æ¡ˆä¾‹ä¸­ï¼ŒCheckpoint åˆ°åº•è®°å½•äº†ä»€ä¹ˆä¿¡æ¯å‘¢ï¼Ÿè®°å½•çš„å…¶å®å°±æ˜¯ç¬¬ n æ¬¡ Checkpoint æ¶ˆè´¹çš„ offset ä¿¡æ¯å’Œå„app çš„ PV å€¼ä¿¡æ¯ï¼Œè®°å½•ä¸‹å‘ç”Ÿ Checkpoint å½“å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶å°†è¯¥çŠ¶æ€ä¿¡æ¯ä¿å­˜åˆ°ç›¸åº”çš„çŠ¶æ€åç«¯ã€‚ï¼ˆæ³¨ï¼š<strong>çŠ¶æ€åç«¯æ˜¯ä¿å­˜çŠ¶æ€çš„åœ°æ–¹</strong>ï¼Œå†³å®šçŠ¶æ€å¦‚ä½•ä¿å­˜ï¼Œå¦‚ä½•ä¿è¯çŠ¶æ€é«˜å¯ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬èƒ½ä»çŠ¶æ€åç«¯æ‹¿åˆ° offset ä¿¡æ¯å’Œ PV ä¿¡æ¯å³å¯ã€‚çŠ¶æ€åç«¯å¿…é¡»æ˜¯é«˜å¯ç”¨çš„ï¼Œå¦åˆ™æˆ‘ä»¬çš„çŠ¶æ€åç«¯ç»å¸¸å‡ºç°æ•…éšœï¼Œä¼šå¯¼è‡´æ— æ³•é€šè¿‡ Checkpoint æ¥æ¢å¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼‰ã€‚ä¸‹é¢åˆ—å‡ºäº†ç¬¬ 100 æ¬¡ Checkpoint çš„æ—¶å€™ï¼ŒçŠ¶æ€åç«¯ä¿å­˜çš„çŠ¶æ€ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chk-100</span><br><span class="line">- offsetï¼šï¼ˆ0ï¼Œ60000ï¼‰</span><br><span class="line">- PVï¼šï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰</span><br></pre></td></tr></table></figure><p>è¯¥çŠ¶æ€ä¿¡æ¯è¡¨ç¤ºç¬¬ 100 æ¬¡ Checkpoint çš„æ—¶å€™ï¼Œ partition 0 offset æ¶ˆè´¹åˆ°äº† 60000ï¼ŒPV ç»Ÿè®¡ç»“æœä¸ºï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰ ã€‚å¦‚æœä»»åŠ¡æŒ‚äº†ï¼Œå¦‚ä½•æ¢å¤ï¼Ÿ</p><p>å‡å¦‚æˆ‘ä»¬è®¾ç½®äº†ä¸€åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡ Checkpointï¼Œç¬¬ 100 æ¬¡ Checkpoint æˆåŠŸåï¼Œè¿‡äº†åç§’é’Ÿï¼Œoffsetå·²ç»æ¶ˆè´¹åˆ° ï¼ˆ0ï¼Œ60100ï¼‰ï¼ŒPV ç»Ÿè®¡ç»“æœå˜æˆäº†ï¼ˆapp1ï¼Œ50080ï¼‰ï¼ˆapp2ï¼Œ10020ï¼‰ï¼Œçªç„¶ä»»åŠ¡æŒ‚äº†ï¼Œæ€ä¹ˆåŠï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒFlink åªéœ€è¦ä»æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„ Checkpointï¼Œä¹Ÿå°±æ˜¯ä»ç¬¬ 100 æ¬¡ Checkpoint ä¿å­˜çš„ offsetï¼ˆ0ï¼Œ60000ï¼‰å¤„æ¥ç€æ¶ˆè´¹å³å¯ï¼Œå½“ç„¶ PV å€¼ä¹Ÿè¦ä»ç¬¬ 100 æ¬¡ Checkpoint é‡Œä¿å­˜çš„ PV å€¼ï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰è¿›è¡Œç´¯åŠ ï¼Œä¸èƒ½ä»ï¼ˆapp1ï¼Œ50080ï¼‰ï¼ˆapp2ï¼Œ10020ï¼‰å¤„è¿›è¡Œç´¯åŠ ï¼Œå› ä¸º <strong>partition 0 offsetæ¶ˆè´¹åˆ° 60000 æ—¶ï¼Œå¯¹åº”çš„ PV ç»Ÿè®¡ç»“æœä¸ºï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰</strong>ã€‚å½“ç„¶å¦‚æœä½ æƒ³ä»offset ï¼ˆ0ï¼Œ60100ï¼‰PVï¼ˆapp1ï¼Œ50080ï¼‰ï¼ˆapp2ï¼Œ10020ï¼‰è¿™ä¸ªçŠ¶æ€æ¢å¤ï¼Œä¹Ÿæ˜¯åšä¸åˆ°çš„ï¼Œå› ä¸ºé‚£ä¸ªæ—¶åˆ»ç¨‹åºçªç„¶æŒ‚äº†ï¼Œè¿™ä¸ªçŠ¶æ€æ ¹æœ¬æ²¡æœ‰ä¿å­˜ä¸‹æ¥ï¼Œåªæœ‰åœ¨ Checkpoint çš„æ—¶å€™ï¼Œæ‰ä¼šæŠŠè¿™äº›å®Œæ•´çš„çŠ¶æ€ä¿å­˜åˆ°çŠ¶æ€åç«¯ï¼Œä¾›æˆ‘ä»¬æ¢å¤ä»»åŠ¡ã€‚æˆ‘ä»¬èƒ½åšçš„æœ€é«˜æ•ˆæ–¹å¼å°±æ˜¯ä»æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„ Checkpoint å¤„æ¢å¤ï¼Œä¹Ÿå°±æ˜¯ä¸€ç›´æ‰€è¯´çš„ chk-100ã€‚ä»¥ä¸ŠåŸºæœ¬å°±æ˜¯ Checkpoint æ‰¿æ‹…çš„å·¥ä½œï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæè¿°çš„ä¸šåŠ¡åœºæ™¯æ¯”è¾ƒç®€å•ã€‚</p><p>è¡¥å……ä¸¤ä¸ªé—®é¢˜ï¼šè®¡ç®— PV çš„ task åœ¨ä¸€ç›´è¿è¡Œï¼Œå®ƒæ€ä¹ˆçŸ¥é“ä»€ä¹ˆæ—¶å€™å»åš Checkpoint å‘¢ï¼Ÿè®¡ç®— PV çš„ task æ€ä¹ˆä¿è¯å®ƒè‡ªå·±è®¡ç®—çš„ PV å€¼ï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰å°±æ˜¯offsetï¼ˆ0ï¼Œ60000ï¼‰é‚£ä¸€åˆ»çš„ç»Ÿè®¡ç»“æœå‘¢ï¼ŸFlink åœ¨æ•°æ®ä¸­åŠ äº†ä¸€ä¸ªå«åš barrierï¼ˆæ …æ ï¼‰ çš„ä¸œè¥¿ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”¨åœˆæ ‡æ³¨çš„å°±æ˜¯ barrierã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151548.jpg" style="zoom:20%;" /></p><p>barrier ä» Source Task å¤„ç”Ÿæˆï¼Œä¸€ç›´æµåˆ° Sink Taskï¼ŒæœŸé—´æ‰€æœ‰çš„ Task åªè¦ç¢°åˆ° barrierï¼Œå°±ä¼šè§¦å‘è‡ªèº«è¿›è¡Œå¿«ç…§ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒCheckpoint barrier n-1 å¤„åšçš„å¿«ç…§å°±æ˜¯æŒ‡ Job ä»å¼€å§‹å¤„ç†åˆ° barrier n-1 æ‰€æœ‰çš„çŠ¶æ€æ•°æ®ï¼Œbarrier n å¤„åšçš„å¿«ç…§å°±æ˜¯æŒ‡ä» Job å¼€å§‹åˆ°å¤„ç†åˆ° barrier n æ‰€æœ‰çš„çŠ¶æ€æ•°æ®ã€‚å¯¹åº”åˆ° PV æ¡ˆä¾‹ä¸­å°±æ˜¯ï¼ŒSource Task æ¥æ”¶åˆ° JobManager çš„ç¼–å·ä¸º chk-100 çš„ Checkpoint è§¦å‘è¯·æ±‚åï¼Œå‘ç°è‡ªå·±æ°å¥½æ¥æ”¶åˆ° kafka offsetï¼ˆ0ï¼Œ60000ï¼‰å¤„çš„æ•°æ®ï¼Œæ‰€ä»¥ä¼šå¾€ offsetï¼ˆ0ï¼Œ60000ï¼‰æ•°æ®ä¹‹å offsetï¼ˆ0ï¼Œ60001ï¼‰æ•°æ®ä¹‹å‰æ’å…¥ä¸€ä¸ªbarrierï¼Œç„¶åè‡ªå·±å¼€å§‹åšå¿«ç…§ï¼Œä¹Ÿå°±æ˜¯å°†offsetï¼ˆ0ï¼Œ60000ï¼‰ä¿å­˜åˆ°çŠ¶æ€åç«¯ chk-100 ä¸­ã€‚ç„¶åï¼ŒSource Task ä¼šæŠŠ barrier å’Œæˆ‘ä»¬è¦å¤„ç†çš„æ•°æ®ä¸€å—å¾€ä¸‹æ¸¸å‘é€ï¼Œå½“ç»Ÿè®¡ PV çš„ task æ¥æ”¶åˆ° barrier åï¼Œæ„å‘³ç€ barrier ä¹‹å‰çš„æ•°æ®å·²ç»è¢« PV task å¤„ç†å®Œäº†ï¼Œæ­¤æ—¶ä¹Ÿä¼šæš‚åœå¤„ç† barrier ä¹‹åçš„æ•°æ®ï¼Œå°†è‡ªå·±å†…å­˜ä¸­ä¿å­˜çš„ PV ä¿¡æ¯ï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰ä¿å­˜åˆ°çŠ¶æ€åç«¯ chk-100 ä¸­ã€‚Flink å¤§æ¦‚å°±æ˜¯é€šè¿‡ä»¥ä¸Šè¿‡ç¨‹æ¥ä¿å­˜å¿«ç…§çš„ã€‚</p><p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œbarrier çš„ä½œç”¨å°±æ˜¯ä¸ºäº†æŠŠæ•°æ®åŒºåˆ†å¼€ï¼Œbarrier ä¹‹å‰çš„æ•°æ®æ˜¯æœ¬æ¬¡ Checkpoint ä¹‹å‰å¿…é¡»å¤„ç†å®Œçš„æ•°æ®ï¼Œbarrier ä¹‹åçš„æ•°æ®åœ¨æœ¬æ¬¡ Checkpoint ä¹‹å‰ä¸èƒ½è¢«å¤„ç†ã€‚Checkpoint è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªåŒæ­¥åšå¿«ç…§çš„ç¯èŠ‚ä¸èƒ½å¤„ç† barrier ä¹‹åçš„æ•°æ®ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœåšå¿«ç…§çš„åŒæ—¶ï¼Œä¹Ÿåœ¨å¤„ç†æ•°æ®ï¼Œé‚£ä¹ˆå¤„ç†çš„æ•°æ®å¯èƒ½ä¼šä¿®æ”¹å¿«ç…§å†…å®¹ï¼Œæ‰€ä»¥å…ˆæš‚åœå¤„ç†æ•°æ®ï¼ŒæŠŠå†…å­˜ä¸­å¿«ç…§ä¿å­˜å¥½åï¼Œå†å¤„ç†æ•°æ®ã€‚ç»“åˆæ¡ˆä¾‹æ¥è®²å°±æ˜¯ï¼ŒPV task åœ¨å¯¹ï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰åšå¿«ç…§çš„åŒæ—¶ï¼Œå¦‚æœ barrier ä¹‹åçš„æ•°æ®è¿˜åœ¨å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´çŠ¶æ€ä¿¡æ¯è¿˜æ²¡ä¿å­˜åˆ°ç£ç›˜ï¼ŒçŠ¶æ€å·²ç»å˜æˆäº†ï¼ˆapp1ï¼Œ50001ï¼‰ï¼ˆapp2ï¼Œ10001ï¼‰ï¼Œå¯¼è‡´æˆ‘ä»¬æœ€åå¿«ç…§é‡Œä¿å­˜çš„ PV å€¼å˜æˆäº†ï¼ˆapp1ï¼Œ50001ï¼‰ï¼ˆapp2ï¼Œ10001ï¼‰ï¼Œè¿™æ ·å¦‚æœä» Checkpoint æ¢å¤ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬ä» offset 60000 å¼€å§‹æ¶ˆè´¹ï¼ŒPV å€¼ä» ï¼ˆapp1ï¼Œ50001ï¼‰ï¼ˆapp2ï¼Œ10001ï¼‰ å¼€å§‹ç´¯åŠ ï¼Œå°±ä¼šé€ æˆè®¡ç®—çš„ PV ç»“æœåé«˜ï¼Œç»“æœä¸å‡†ç¡®ï¼Œå°±ä¸èƒ½ä¿è¯ Exactly Onceã€‚æ‰€ä»¥ï¼ŒCheckpoint åŒæ­¥åšå¿«ç…§çš„è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½å¤„ç† barrier ä¹‹åçš„æ•°æ®ã€‚Checkpoint å°†å¿«ç…§ä¿¡æ¯å†™å…¥åˆ°ç£ç›˜åï¼Œä¸ºäº†ä¿è¯å¿«ç…§ä¿¡æ¯çš„é«˜å¯ç”¨ï¼Œéœ€è¦å°†å¿«ç…§ä¸Šä¼ åˆ° HDFSï¼Œè¿™ä¸ªä¸Šä¼ å¿«ç…§åˆ° HDFS çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå¯ä»¥å¤„ç† barrier ä¹‹åçš„æ•°æ®ï¼Œå¤„ç† barrier ä¹‹åçš„æ•°æ®ä¸ä¼šå½±å“åˆ°ç£ç›˜ä¸Šçš„å¿«ç…§ä¿¡æ¯ã€‚</p><p>ä» PV æ¡ˆä¾‹å†åˆ†æ Flink æ˜¯å¦‚ä½•åš Checkpoint å¹¶ä» Checkpoint å¤„æ¢å¤ä»»åŠ¡çš„ï¼Œé¦–å…ˆ JobManager ç«¯ä¼šå‘æ‰€æœ‰ SourceTask å‘é€ Checkpointï¼ŒSource Task ä¼šåœ¨æ•°æ®æµä¸­å®‰æ’ Checkpoint barrierï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151547.jpg" alt="å•å¹¶è¡Œåº¦ PV æ¡ˆä¾‹ Checkpoint è¿‡ç¨‹å›¾ç¤º1" style="zoom:13%;" /></p><p>Source Task å®‰æ’å¥½ barrier åï¼Œä¼šå°† barrier è·Ÿæ•°æ®ä¸€å—å‘é€ç»™ä¸‹æ¸¸ï¼Œç„¶åè‡ªèº«å¼€å§‹åšå¿«ç…§ï¼Œå¹¶å°†å¿«ç…§ä¿¡æ¯ offset (0,60000) å‘é€åˆ°é«˜å¯ç”¨çš„æŒä¹…åŒ–å­˜å‚¨ä»‹è´¨ï¼Œä¾‹å¦‚ HDFS ä¸Šï¼Œå‘é€æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151542.jpg" alt="å•å¹¶è¡Œåº¦ PV æ¡ˆä¾‹ Checkpoint è¿‡ç¨‹å›¾ç¤º2" style="zoom:13%;" /></p><p>ä¸‹æ¸¸çš„ PV task æ¥æ”¶åˆ° barrier åï¼Œä¹Ÿä¼šåšå¿«ç…§ï¼Œå¹¶å°†å¿«ç…§ä¿¡æ¯ PVï¼š(app1,50000) (app2,10000) å‘é€åˆ° HDFS ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151543.jpg" style="zoom:13%;" /></p><p>å‡è®¾ç¬¬ 100 æ¬¡ Checkpoint å®Œæˆåï¼Œä¸€æ®µæ—¶é—´åä»»åŠ¡æŒ‚äº†ï¼ŒFlink ä»»åŠ¡ä¼šè‡ªåŠ¨ä»çŠ¶æ€åç«¯æ¢å¤ä»»åŠ¡ã€‚Source Task å»è¯»å–è‡ªå·±éœ€è¦çš„çŠ¶æ€ä¿¡æ¯ offset (0,60000) ï¼Œå¹¶ä» offset ä¸º 60000 çš„ä½ç½®æ¥ç€å¼€å§‹æ¶ˆè´¹æ•°æ®ï¼ŒPV task ä¹Ÿä¼šå»è¯»å–éœ€è¦çš„çŠ¶æ€ä¿¡æ¯ PVï¼š(app1,50000) (app2,10000)ï¼Œå¹¶åœ¨è¯¥çŠ¶æ€å€¼çš„åŸºç¡€ä¸Šï¼Œå¾€ä¸Šç´¯ç§¯è®¡ç®— PV å€¼ï¼Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151544.jpg" style="zoom:13%;" /></p><h4 id="å¤šå¹¶è¡Œåº¦ã€å¤š-Operator-æƒ…å†µä¸‹ï¼ŒCheckpoint-çš„è¿‡ç¨‹"><a href="#å¤šå¹¶è¡Œåº¦ã€å¤š-Operator-æƒ…å†µä¸‹ï¼ŒCheckpoint-çš„è¿‡ç¨‹" class="headerlink" title="å¤šå¹¶è¡Œåº¦ã€å¤š Operator æƒ…å†µä¸‹ï¼ŒCheckpoint çš„è¿‡ç¨‹"></a>å¤šå¹¶è¡Œåº¦ã€å¤š Operator æƒ…å†µä¸‹ï¼ŒCheckpoint çš„è¿‡ç¨‹</h4><p>ä¸Šä¸€èŠ‚ä¸­è®²è¿°äº†å•å¹¶è¡Œåº¦æƒ…å†µä¸‹ Checkpoint çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€èˆ¬éƒ½æ˜¯å¤šå¹¶è¡Œåº¦ï¼Œè€Œä¸”ç®—å­ä¹Ÿä¼šæ¯”è¾ƒå¤šï¼Œè¿™ç§æƒ…å†µä¸‹ Checkpoint çš„è¿‡ç¨‹å°±ä¼šå˜å¾—å¤æ‚ã€‚åˆ†å¸ƒå¼çŠ¶æ€å®¹é”™é¢ä¸´çš„é—®é¢˜ä¸æŒ‘æˆ˜ï¼š</p><ul><li>å¦‚ä½•ç¡®ä¿çŠ¶æ€æ‹¥æœ‰<strong>ç²¾ç¡®ä¸€æ¬¡</strong>çš„å®¹é”™ä¿è¯ï¼Ÿ</li><li>å¦‚ä½•åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹æ›¿å¤šä¸ªæ‹¥æœ‰æœ¬åœ°çŠ¶æ€çš„ç®—å­äº§ç”Ÿ<strong>ä¸€ä¸ªå…¨åŸŸä¸€è‡´çš„å¿«ç…§</strong>ï¼Ÿ</li><li>å¦‚ä½•åœ¨<strong>ä¸ä¸­æ–­è¿ç®—</strong>çš„å‰æä¸‹äº§ç”Ÿå¿«ç…§ï¼Ÿ</li></ul><p>å¤šå¹¶è¡Œåº¦ã€å¤š Operator å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•åšå…¨åŸŸä¸€è‡´çš„å¿«ç…§ï¼Ÿæ‰€æœ‰çš„ Operator è¿è¡Œè¿‡ç¨‹ä¸­æ¥æ”¶åˆ°æ‰€æœ‰ä¸Šæ¸¸ç®—å­å‘é€ barrier åï¼Œå¯¹è‡ªèº«çš„çŠ¶æ€è¿›è¡Œä¸€æ¬¡å¿«ç…§ï¼Œä¿å­˜åˆ°ç›¸åº”çŠ¶æ€åç«¯ï¼Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151553.jpg" style="zoom: 13%;" /></p><p>å½“ä»»åŠ¡ä»çŠ¶æ€æ¢å¤æ—¶ï¼Œæ¯ä¸ª Operator ä»çŠ¶æ€åç«¯è¯»å–è‡ªå·±ç›¸åº”çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ•°æ®æºä¼šä»çŠ¶æ€ä¸­ä¿å­˜çš„ä½ç½®å¼€å§‹é‡æ–°æ¶ˆè´¹ï¼Œåç»­çš„å…¶ä»–ç®—å­ä¹Ÿä¼šåŸºäº Checkpoint ä¸­ä¿å­˜çš„çŠ¶æ€è¿›è¡Œè®¡ç®—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151556.jpg" alt="å¤šå¹¶è¡Œåº¦ä¸‹ï¼Œä»»åŠ¡ä» Checkpoint æ¢å¤å›¾ç¤º" style="zoom:13%;" /></p><p>æ•´ä¸ª Checkpoint çš„è¿‡ç¨‹è·Ÿä¹‹å‰å•å¹¶è¡Œåº¦ç±»ä¼¼ï¼Œå›¾ä¸­æœ‰ 4 ä¸ªå¸¦çŠ¶æ€çš„ Operator å®ä¾‹ï¼Œç›¸åº”çš„çŠ¶æ€åç«¯å°±å¯ä»¥æƒ³è±¡æˆ 4 ä¸ªæ ¼å­ã€‚æ•´ä¸ª Checkpoint çš„è¿‡ç¨‹å¯ä»¥å½“åš Operator å®ä¾‹å¡«è‡ªå·±æ ¼å­çš„è¿‡ç¨‹ï¼ŒOperator å®ä¾‹å°†è‡ªèº«çš„çŠ¶æ€å†™åˆ°çŠ¶æ€åç«¯ä¸­ç›¸åº”çš„æ ¼å­ï¼Œå½“æ‰€æœ‰çš„æ ¼å­å¡«æ»¡å¯ä»¥ç®€å•çš„è®¤ä¸ºä¸€æ¬¡å®Œæ•´çš„ Checkpoint åšå®Œäº†ã€‚</p><p>ä¸Šé¢åªæ˜¯å¿«ç…§çš„è¿‡ç¨‹ï¼ŒCheckpoint æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>1ã€JobManager ç«¯çš„ CheckPointCoordinator å‘æ‰€æœ‰ Source Task å‘é€ CheckPointTriggerï¼ŒSource Taskä¼šåœ¨æ•°æ®æµä¸­å®‰æ’ Checkpoint barrier</p><p>2ã€å½“ task æ”¶åˆ°æ‰€æœ‰çš„ barrier åï¼Œå‘è‡ªå·±çš„ä¸‹æ¸¸ç»§ç»­ä¼ é€’ barrierï¼Œç„¶åè‡ªèº«æ‰§è¡Œå¿«ç…§ï¼Œå¹¶å°†è‡ªå·±çš„çŠ¶æ€<strong>å¼‚æ­¥å†™å…¥åˆ°æŒä¹…åŒ–å­˜å‚¨</strong>ä¸­</p><ul><li>å¢é‡ CheckPoint åªæ˜¯æŠŠæœ€æ–°çš„ä¸€éƒ¨åˆ†æ•°æ®æ›´æ–°å†™å…¥åˆ°å¤–éƒ¨å­˜å‚¨</li><li>ä¸ºäº†ä¸‹æ¸¸å°½å¿«å¼€å§‹åš CheckPointï¼Œæ‰€ä»¥ä¼šå…ˆå‘é€ barrier åˆ°ä¸‹æ¸¸ï¼Œè‡ªèº«å†åŒæ­¥è¿›è¡Œå¿«ç…§</li></ul><p>3ã€å½“ task å¯¹çŠ¶æ€çš„å¿«ç…§ä¿¡æ¯å®Œæˆå¤‡ä»½åï¼Œä¼šå°†å¤‡ä»½æ•°æ®çš„åœ°å€ï¼ˆstate handleï¼‰é€šçŸ¥ç»™ JobManager çš„ CheckPointCoordinator</p><p>å¦‚æœ Checkpoint çš„æŒç»­æ—¶é•¿è¶…è¿‡äº† Checkpoint è®¾å®šçš„è¶…æ—¶æ—¶é—´ï¼ŒCheckPointCoordinator è¿˜æ²¡æœ‰æ”¶é›†å®Œæ‰€æœ‰çš„ State Handleï¼ŒCheckPointCoordinatorå°±ä¼šè®¤ä¸ºæœ¬æ¬¡ Checkpoint å¤±è´¥ï¼Œä¼šæŠŠè¿™æ¬¡ Checkpoint äº§ç”Ÿçš„æ‰€æœ‰ çŠ¶æ€æ•°æ®å…¨éƒ¨åˆ é™¤</p><p>4ã€CheckPointCoordinator æŠŠæ•´ä¸ª StateHandle å°è£…æˆ Completed Checkpoint Metaï¼Œå†™å…¥åˆ° HDFSï¼Œæ•´ä¸ª Checkpoint ç»“æŸ</p><h4 id="barrier-å¯¹é½"><a href="#barrier-å¯¹é½" class="headerlink" title="barrier å¯¹é½"></a>barrier å¯¹é½</h4><p>ä»€ä¹ˆæ˜¯ barrier å¯¹é½ï¼Ÿå¦‚å›¾æ‰€ç¤ºï¼Œå½“å‰çš„ Operator å®ä¾‹æ¥æ”¶ä¸Šæ¸¸ä¸¤ä¸ªæµçš„æ•°æ®ï¼Œä¸€ä¸ªæ˜¯å­—æ¯æµï¼Œä¸€ä¸ªæ˜¯æ•°å­—æµã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151558.jpg" style="zoom:10%;" /></p><p>å½“ Checkpoint æ—¶ï¼Œä¸Šæ¸¸å­—æ¯æµå’Œæ•°å­—æµéƒ½ä¼šå¾€ Operator å®ä¾‹å‘é€ Checkpoint barrierï¼Œä½†æ˜¯ç”±äºæ¯ä¸ªç®—å­çš„æ‰§è¡Œé€Ÿç‡ä¸åŒï¼Œæ‰€ä»¥ä¸å¯èƒ½ä¿è¯ä¸Šæ¸¸ä¸¤ä¸ªæµçš„ barrier åŒæ—¶åˆ°è¾¾ Operator å®ä¾‹ï¼Œé‚£å›¾ä¸­çš„ Operator å®ä¾‹åˆ°åº•ä»€ä¹ˆæ—¶å€™è¿›è¡Œå¿«ç…§å‘¢ï¼Ÿæ¥æ”¶åˆ°ä»»æ„ä¸€ä¸ª barrier å°±å¯ä»¥å¼€å§‹è¿›è¡Œå¿«ç…§äº†å—ï¼Œè¿˜æ˜¯æ¥æ”¶åˆ°æ‰€æœ‰çš„ barrier æ‰èƒ½å¼€å§‹è¿›è¡Œå¿«ç…§å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šå½“ä¸€ä¸ª Operator å®ä¾‹æœ‰å¤šä¸ªè¾“å…¥æµæ—¶ï¼ŒOperator å®ä¾‹éœ€è¦åœ¨åšå¿«ç…§ä¹‹å‰è¿›è¡Œ barrier å¯¹é½ï¼Œç­‰å¾…æ‰€æœ‰è¾“å…¥æµçš„ barrier éƒ½åˆ°è¾¾ã€‚barrier å¯¹é½çš„è¯¦ç»†è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>1ã€å¯¹äºä¸€ä¸ªæœ‰å¤šä¸ªè¾“å…¥æµçš„ Operator å®ä¾‹ï¼Œå½“ Operator å®ä¾‹ä»å…¶ä¸­ä¸€ä¸ªè¾“å…¥æµæ¥æ”¶åˆ° Checkpoint barrier n æ—¶ï¼Œå°±ä¸èƒ½å¤„ç†æ¥è‡ªè¯¥æµçš„ä»»ä½•æ•°æ®è®°å½•äº†ï¼Œç›´åˆ°å®ƒä»å…¶ä»–æ‰€æœ‰è¾“å…¥æµæ¥æ”¶åˆ° barrier nä¸ºæ­¢ï¼Œå¦åˆ™ <strong>Operator å®ä¾‹ Checkpoint n çš„å¿«ç…§ä¼šæ··å…¥å¿«ç…§ n çš„è®°å½•å’Œå¿«ç…§ n + 1 çš„è®°å½•</strong>ã€‚å¦‚ä¸Šå›¾ä¸­ç¬¬ 1 ä¸ªå°å›¾æ‰€ç¤ºï¼Œæ•°å­—æµçš„ barrier å…ˆåˆ°è¾¾äº†ã€‚</p><p>2ã€æ¥æ”¶åˆ° barrier n çš„æµæš‚æ—¶è¢«æç½®ï¼Œä»è¿™äº›æµæ¥æ”¶çš„è®°å½•ä¸ä¼šè¢«å¤„ç†ï¼Œè€Œæ˜¯æ”¾å…¥è¾“å…¥ç¼“å†²åŒºã€‚å›¾ 2 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è™½ç„¶æ•°å­—æµå¯¹åº”çš„ barrier å·²ç»åˆ°è¾¾äº†ï¼Œä½†æ˜¯barrierä¹‹åçš„ 1ã€2ã€3 è¿™äº›æ•°æ®åªèƒ½æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œç­‰å¾…å­—æ¯æµçš„barrieråˆ°è¾¾ã€‚</p><p>3ã€ä¸€æ—¦æœ€åæ‰€æœ‰è¾“å…¥æµéƒ½æ¥æ”¶åˆ° barrier nï¼ŒOperator å®ä¾‹å°±ä¼šæŠŠ barrier ä¹‹å‰æ‰€æœ‰å·²ç»å¤„ç†å®Œæˆçš„æ•°æ®å’Œ barrier n ä¸€å—å‘é€ç»™ä¸‹æ¸¸ã€‚ç„¶å Operator å®ä¾‹å°±å¯ä»¥å¯¹çŠ¶æ€ä¿¡æ¯è¿›è¡Œå¿«ç…§ã€‚å¦‚å›¾ 3 æ‰€ç¤ºï¼ŒOperator å®ä¾‹æ¥æ”¶åˆ°ä¸Šæ¸¸æ‰€æœ‰æµçš„ barrier nï¼Œæ­¤æ—¶ Operator å®ä¾‹å°±å¯ä»¥å°† barrier å’Œ barrier ä¹‹å‰çš„æ•°æ®å‘é€åˆ°ä¸‹æ¸¸ï¼Œç„¶åè‡ªèº«çŠ¶æ€è¿›è¡Œå¿«ç…§ã€‚</p><p>4ã€å¿«ç…§åšå®Œåï¼ŒOperator å®ä¾‹å°†ç»§ç»­å¤„ç†ç¼“å†²åŒºçš„è®°å½•ï¼Œç„¶åå°±å¯ä»¥å¤„ç†è¾“å…¥æµçš„æ•°æ®ã€‚å¦‚å›¾ 4 æ‰€ç¤ºï¼Œå…ˆå¤„ç†å®Œç¼“å†²åŒºæ•°æ®ï¼Œå°±å¯ä»¥æ­£å¸¸å¤„ç†è¾“å…¥æµçš„æ•°æ®äº†ã€‚</p><p>ä¸Šé¢çš„è¿‡ç¨‹å°±æ˜¯ Flink åœ¨ Operator å®ä¾‹æœ‰å¤šä¸ªè¾“å…¥æµçš„æƒ…å†µä¸‹ï¼Œæ•´ä¸ª barrier å¯¹é½çš„è¿‡ç¨‹ã€‚é‚£ä»€ä¹ˆæ˜¯ barrier ä¸å¯¹é½å‘¢ï¼Ÿbarrier ä¸å¯¹é½æ˜¯æŒ‡å½“è¿˜æœ‰å…¶ä»–æµçš„ barrier è¿˜æ²¡åˆ°è¾¾æ—¶ï¼Œä¸ºäº†æé«˜ Operator å®ä¾‹çš„å¤„ç†æ€§èƒ½ï¼ŒOperator å®ä¾‹ä¼šç›´æ¥å¤„ç† barrier ä¹‹åçš„æ•°æ®ï¼Œç­‰åˆ°æ‰€æœ‰æµçš„ barrier éƒ½åˆ°è¾¾åï¼Œå°±å¯ä»¥å¯¹è¯¥ Operator åš Checkpoint å¿«ç…§äº†ã€‚å¯¹åº”åˆ°å›¾ä¸­å°±æ˜¯ï¼Œbarrier ä¸å¯¹é½æ—¶ä¼šç›´æ¥æŠŠ barrier ä¹‹åçš„æ•°æ® 1ã€2ã€3 ç›´æ¥å¤„ç†æ‰ï¼Œè€Œ<strong>ä¸æ˜¯</strong>æ”¾åˆ°ç¼“å†²åŒºä¸­ç­‰å¾…å…¶ä»–çš„è¾“å…¥æµçš„ barrier åˆ°è¾¾ï¼Œå½“æ‰€æœ‰è¾“å…¥æµçš„ barrier éƒ½åˆ°è¾¾åï¼Œæ‰å¼€å§‹å¯¹ Operator å®ä¾‹çš„çŠ¶æ€ä¿¡æ¯è¿›è¡Œå¿«ç…§ï¼Œè¿™æ ·ä¼šå¯¼è‡´åšå¿«ç…§ä¹‹å‰ï¼ŒOperator å®ä¾‹å·²ç»å¤„ç†äº†ä¸€äº› barrier n ä¹‹åçš„æ•°æ®ã€‚Checkpoint çš„ç›®çš„æ˜¯ä¸ºäº†ä¿å­˜å¿«ç…§ä¿¡æ¯ï¼Œå¦‚æœ barrier ä¸å¯¹é½ï¼Œé‚£ä¹ˆ Operator å®ä¾‹åœ¨åšç¬¬ n æ¬¡ Checkpoint ä¹‹å‰ï¼Œå·²ç»å¤„ç†äº†ä¸€äº› barrier n ä¹‹åçš„æ•°æ®ï¼Œå½“ç¨‹åºä»ç¬¬ n æ¬¡ Checkpoint æ¢å¤ä»»åŠ¡æ—¶ï¼Œç¨‹åºä¼šä»ç¬¬ n æ¬¡ Checkpoint ä¿å­˜çš„ offset ä½ç½®å¼€å§‹æ¶ˆè´¹æ•°æ®ï¼Œå°±ä¼šå¯¼è‡´ä¸€äº›æ•°æ®è¢«å¤„ç†äº†ä¸¤æ¬¡ï¼Œå°±å‡ºç°äº†é‡å¤æ¶ˆè´¹ã€‚å¦‚æœè¿›è¡Œ barrier å¯¹é½ï¼Œå°±ä¸ä¼šå‡ºç°è¿™ç§é‡å¤æ¶ˆè´¹çš„é—®é¢˜ï¼Œæ‰€ä»¥ <strong>barrier å¯¹é½å°±å¯ä»¥å®ç° Exactly Onceï¼Œbarrier ä¸å¯¹é½å°±å˜æˆäº†At Least Onceã€‚</strong></p><p>å†ç»“åˆè®¡ç®— PV çš„æ¡ˆä¾‹æ¥è¯æ˜ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆ barrier å¯¹é½å°±å¯ä»¥å®ç° Exactly Onceï¼Œbarrier ä¸å¯¹é½å°±å˜æˆäº† At Least Onceã€‚ä¹‹å‰çš„æ¡ˆä¾‹ä¸ºäº†ç®€å•ï¼Œæè¿°çš„ kafka topic åªæœ‰ 1 ä¸ª partitionï¼Œè¿™é‡Œä¸ºäº†è®²è¿° barrier å¯¹é½ï¼Œå‡è®¾ topic æœ‰ 2 ä¸ª partittionï¼Œä¸”è®¡ç®—çš„æ˜¯æˆ‘ä»¬å¹³å°çš„æ€» PVï¼Œä¹Ÿå°±æ˜¯è¯´ä¸éœ€è¦åŒºåˆ† appï¼Œæ¯æ¡ä¸€æ¡æ•°æ®ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å°†å…¶ PV å€¼ +1 å³å¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒFlink åº”ç”¨ç¨‹åºæœ‰ä¸¤ä¸ª Source Taskï¼Œä¸€ä¸ªè®¡ç®— PV çš„ Taskï¼Œè¿™é‡Œè®¡ç®— PV çš„ Task å°±å‡ºç°äº†å­˜åœ¨å¤šä¸ªè¾“å…¥æµçš„æƒ…å†µã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151546.jpg" style="zoom:13%;" /></p><p>å‡è®¾ barrier ä¸å¯¹é½ï¼Œé‚£ä¹ˆ Checkpoint è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151554.jpg" style="zoom:12%;" /></p><p>å¦‚ä¸Šå›¾å·¦éƒ¨åˆ†æ‰€ç¤ºï¼ŒSource Subtask 0 å’Œ Subtask 1 å·²ç»å®Œæˆäº†å¿«ç…§æ“ä½œï¼Œä»–ä»¬çš„çŠ¶æ€ä¿¡æ¯ä¸º offset(0,10000)(1,10005) è¡¨ç¤º partition0 æ¶ˆè´¹åˆ° offset ä¸º 10000 çš„ä½ç½®ï¼Œpartition 1 æ¶ˆè´¹åˆ° offset ä¸º 10005 çš„ä½ç½®ã€‚å½“ Source Subtask 1 çš„ barrier åˆ°è¾¾ PV task æ—¶ï¼Œè®¡ç®—çš„ PV ç»“æœä¸º 20002ï¼Œä½† PV task è¿˜æ²¡æœ‰æ¥æ”¶åˆ° Source Subtask 0 å‘é€çš„ barrierï¼Œæ‰€ä»¥ PV task è¿˜ä¸èƒ½å¯¹è‡ªèº«çŠ¶æ€ä¿¡æ¯è¿›è¡Œå¿«ç…§ã€‚ç”±äºè®¾ç½®çš„ barrier ä¸å¯¹é½ï¼Œæ‰€ä»¥æ­¤æ—¶ PV task ä¼šç»§ç»­å¤„ç† Source Subtask 0 å’Œ Source Subtask 1 ä¼ æ¥çš„æ•°æ®ã€‚å¾ˆå¿«ï¼Œå¦‚ä¸Šå›¾å³éƒ¨åˆ†æ‰€ç¤ºï¼ŒPV task æ¥æ”¶åˆ° Source Subtask 0 å‘æ¥çš„ barrierï¼Œä½†æ˜¯ PV task å·²ç»å¤„ç†äº† Source Subtask 1 barrier ä¹‹åçš„ä¸‰æ¡æ•°æ®ï¼Œæ‰€ä»¥ PV å€¼ç›®å‰å·²ç»ä¸º 20008äº†ï¼Œè¿™é‡Œçš„ PV=20008 å®é™…ä¸Šå·²ç»å¤„ç†åˆ° partition 1 offset ä¸º 10008 çš„ä½ç½®ï¼Œæ­¤æ—¶ PV task ä¼šå¯¹è‡ªèº«çš„çŠ¶æ€ä¿¡æ¯ï¼ˆPV = 20008ï¼‰åšå¿«ç…§ï¼Œæ•´ä½“çš„å¿«ç…§ä¿¡æ¯ä¸º offset(0,10000)(1,10005)  PV=20008ã€‚</p><p>æ¥ç€ç¨‹åºåœ¨ç»§ç»­è¿è¡Œï¼Œè¿‡äº† 10 ç§’ï¼Œç”±äºæŸä¸ªæœåŠ¡å™¨æ•…éšœï¼Œå¯¼è‡´æˆ‘ä»¬çš„ Operator å®ä¾‹æœ‰ä¸€ä¸ªæŒ‚äº†ï¼Œæ‰€ä»¥ Flink ä¼šä»æœ€è¿‘ä¸€æ¬¡ Checkpoint ä¿å­˜çš„çŠ¶æ€æ¢å¤ã€‚é‚£å…·ä½“æ˜¯æ€ä¹ˆæ¢å¤çš„å‘¢ï¼ŸFlink åŒæ ·ä¼šèµ·ä¸‰ä¸ª Operator å®ä¾‹ï¼Œæˆ‘è¿˜ç§°ä»–ä»¬æ˜¯ Source Subtask 0 ã€Source Subtask 1 å’Œ PV taskã€‚ä¸‰ä¸ª Operator ä¼šä»çŠ¶æ€åç«¯è¯»å–ä¿å­˜çš„çŠ¶æ€ä¿¡æ¯ã€‚Source Subtask 0 ä¼šä» partition 0 offset ä¸º 10000 çš„ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼ŒSource Subtask 1 ä¼šä» partition 1 offset ä¸º 10005 çš„ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼ŒPV task ä¼šåŸºäº PV=20008 è¿›è¡Œç´¯åŠ ç»Ÿè®¡ã€‚ç„¶åå°±ä¼šå‘ç°çš„ PV å€¼ 20008 å®é™…ä¸Šå·²ç»åŒ…å«äº† partition 1 çš„ offset 10005~10008 çš„æ•°æ®ï¼Œæ‰€ä»¥ partition 1 ä» offset 10005 æ¢å¤ä»»åŠ¡æ—¶ï¼Œpartition1 çš„ offset 10005~10008 çš„æ•°æ®è¢«æ¶ˆè´¹äº†ä¸¤æ¬¡ï¼Œå‡ºç°äº†é‡å¤æ¶ˆè´¹çš„é—®é¢˜ï¼Œæ‰€ä»¥ barrier ä¸å¯¹é½åªèƒ½ä¿è¯ At Least Onceã€‚</p><p>å¦‚æœè®¾ç½®ä¸º barrier å¯¹é½ï¼Œè¿™é‡Œèƒ½ä¿è¯ Exactly Once å—ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“ PV task æ¥æ”¶åˆ° Source Subtask 1 çš„ barrier åï¼Œå¹¶ä¸ä¼šå¤„ç† Source Subtask 1 barrier ä¹‹åçš„æ•°æ®ï¼Œè€Œæ˜¯æŠŠè¿™äº›æ•°æ®æ”¾åˆ° PV task çš„è¾“å…¥ç¼“å†²åŒºä¸­ï¼Œç›´åˆ°ç­‰åˆ° Source Subtask 0 çš„ barrier åˆ°è¾¾åï¼ŒPV task æ‰ä¼šå¯¹è‡ªèº«çŠ¶æ€ä¿¡æ¯è¿›è¡Œå¿«ç…§ï¼Œæ­¤æ—¶ PV task ä¼šæŠŠ PV=20005 ä¿å­˜åˆ°å¿«ç…§ä¿¡æ¯ä¸­ï¼Œæ•´ä½“çš„å¿«ç…§çŠ¶æ€ä¿¡æ¯ä¸º offset(0,10000)(1,10005)  PV=20005ï¼Œå½“ä»»åŠ¡ä» Checkpoint æ¢å¤æ—¶ï¼ŒSource Subtask 0 ä¼šä» partition 0 offset ä¸º 10000 çš„ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼ŒSource Subtask 1 ä¼šä» partition 1 offset ä¸º 10005 çš„ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼ŒPV task ä¼šåŸºäº PV=20005 è¿›è¡Œç´¯åŠ ç»Ÿè®¡ï¼Œæ‰€ä»¥ barrier å¯¹é½èƒ½ä¿è¯ Flink å†…éƒ¨çš„ Exactly Onceã€‚åœ¨ Flink åº”ç”¨ç¨‹åºä¸­ï¼Œå½“ Checkpoint è¯­ä¹‰è®¾ç½® Exactly Once æˆ– At Least Once æ—¶ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ barrier å¯¹ä¸å¯¹é½ã€‚å½“è®¾ç½®ä¸º Exactly Once æ—¶ï¼Œå°±ä¼š barrier å¯¹é½ï¼Œå½“è®¾ç½®ä¸º At Least Once æ—¶ï¼Œå°±ä¼š barrier ä¸å¯¹é½ã€‚</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151555.jpg" style="zoom:12%;" /></p><p>é€šè¿‡æœ¬æ¡ˆä¾‹ï¼Œæˆ‘ä»¬åº”è¯¥å‘ç°äº† barrier åœ¨ Flink çš„ Checkpoint ä¸­èµ·ç€éå¸¸å¤§çš„ä½œç”¨ã€‚barrier å‘Šè¯‰ Flink åº”ç”¨ç¨‹åºï¼ŒCheckpoint ä¹‹å‰å“ªäº›æ•°æ®ä¸åº”è¯¥è¢«å¤„ç†ï¼Œbarrier å¯¹é½çš„è¿‡ç¨‹å…¶å®å°±æ˜¯ä¸ºäº†é˜²æ­¢ Flink åº”ç”¨ç¨‹åºå¤„ç†é‡å¤çš„æ•°æ®ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œæ»¡è¶³å“ªäº›æ¡ä»¶æ—¶ï¼Œä¼šå‡ºç° barrier å¯¹é½ï¼Ÿåœ¨ä»£ç ä¸­è®¾ç½®äº† Flink çš„ Checkpoint è¯­ä¹‰æ˜¯ Exactly Onceï¼Œå…¶æ¬¡ Operator å®ä¾‹å¿…é¡»æœ‰å¤šä¸ªè¾“å…¥æµæ‰ä¼šå‡ºç° barrier å¯¹é½ã€‚å¯¹é½ï¼Œæ±‰è¯­è¯æ±‡ï¼Œé‡Šä¹‰ä¸ºä½¿ä¸¤ä¸ªä»¥ä¸Šäº‹ç‰©é…åˆæˆ–æ¥è§¦å¾—æ•´é½ã€‚ç”±æ±‰è¯­è§£é‡Šå¯å¾—å¯¹é½è‚¯å®šéœ€è¦ä¸¤ä¸ªä»¥ä¸Šäº‹ç‰©ï¼Œæ‰€ä»¥å¿…é¡»æœ‰å¤šä¸ªè¾“å…¥æµæ‰å¯èƒ½å­˜åœ¨å¯¹é½ã€‚barrier å¯¹é½å°±æ˜¯ä¸Šæ¸¸å¤šä¸ªæµé…åˆä½¿å¾—æ•°æ®å¯¹é½çš„è¿‡ç¨‹ã€‚è¨€å¤–ä¹‹æ„ï¼šå¦‚æœ Operator å®ä¾‹åªæœ‰ä¸€ä¸ªè¾“å…¥æµï¼Œå°±æ ¹æœ¬ä¸å­˜åœ¨ barrier å¯¹é½ï¼Œè‡ªå·±è·Ÿè‡ªå·±é»˜è®¤æ°¸è¿œéƒ½æ˜¯å¯¹é½çš„ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä» Source åˆ° Sink æ‰€æœ‰ç®—å­çš„å¹¶è¡Œåº¦éƒ½æ˜¯ 1 çš„è¯ï¼Œå°±ç®—è®¾ç½®çš„ At Least Onceï¼Œæ— å½¢ä¸­ä¹Ÿå®ç°äº† barrier å¯¹é½ï¼Œæ­¤æ—¶ Checkpoint è®¾ç½®æˆ Exactly Once å’Œ At Least Once ä¸€ç‚¹åŒºåˆ«éƒ½æ²¡æœ‰ï¼Œéƒ½å¯ä»¥ä¿è¯ Exactly Onceã€‚çœ‹åˆ°è¿™é‡Œä½ åº”è¯¥å·²ç»çŸ¥é“äº†å“ªç§æƒ…å†µä¼šå‡ºç°é‡å¤æ¶ˆè´¹äº†ï¼Œä¹Ÿåº”è¯¥è¦æŒæ¡ä¸ºä»€ä¹ˆ barrier å¯¹é½å°±èƒ½ä¿è¯ Exactly Onceï¼Œä¸ºä»€ä¹ˆ barrier ä¸å¯¹é½å°±æ˜¯ At Least Onceã€‚</p><p>barrier å¯¹é½å…¶å®æ˜¯è¦ä»˜å‡ºä»£ä»·çš„ï¼Œä» barrier å¯¹é½çš„è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼ŒPV task æ˜æ˜å¯ä»¥æ›´é«˜æ•ˆçš„å¤„ç†æ•°æ®ï¼Œä½†å› ä¸º barrier å¯¹é½ï¼Œå¯¼è‡´ Source Subtask 1 barrier ä¹‹åçš„æ•°æ®è¢«æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œæš‚æ—¶æ€§åœ°æ²¡æœ‰è¢«å¤„ç†ï¼Œå‡å¦‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒSource Subtask 0 çš„ barrier è¿Ÿè¿Ÿæ²¡æœ‰åˆ°è¾¾ï¼Œæ¯” Source Subtask 1 å»¶è¿Ÿäº† 30 ç§’ï¼Œé‚£ä¹ˆè¿™ 30 ç§’æœŸé—´ï¼ŒSource Subtask 1 barrier ä¹‹åçš„æ•°æ®ä¸èƒ½è¢«å¤„ç†ï¼Œæ‰€ä»¥ PV task ç›¸å½“äºè¢«é—²ç½®äº†ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬çš„ä¸€äº›ä¸šåŠ¡åœºæ™¯å¯¹ Exactly Once è¦æ±‚ä¸é«˜æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® Flink çš„ Checkpoint è¯­ä¹‰æ˜¯ At Least Once æ¥å°å¹…åº¦çš„æé«˜åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚Flink Web UI çš„ Checkpoint é€‰é¡¹å¡ä¸­å¯ä»¥çœ‹åˆ° barrier å¯¹é½çš„è€—æ—¶ï¼Œå¦‚æœå‘ç°è€—æ—¶æ¯”è¾ƒé•¿ï¼Œä¸”å¯¹ Exactly Once è¯­ä¹‰è¦æ±‚ä¸é«˜æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è¯¥ä¼˜åŒ–æ–¹æ¡ˆã€‚</p><p>å‰é¢æåˆ°å¦‚ä½•åœ¨ä¸ä¸­æ–­è¿ç®—çš„å‰æä¸‹äº§ç”Ÿå¿«ç…§ï¼Ÿåœ¨ Flink çš„ Checkpoint è¿‡ç¨‹ä¸­ï¼Œæ— è®ºä¸‹æ¸¸ç®—å­æœ‰æ²¡æœ‰åšå®Œå¿«ç…§ï¼Œåªè¦ä¸Šæ¸¸ç®—å­å°† barrier å‘é€åˆ°ä¸‹æ¸¸ä¸”ä¸Šæ¸¸ç®—å­è‡ªèº«å·²ç»åšå®Œå¿«ç…§æ—¶ï¼Œé‚£ä¹ˆä¸Šæ¸¸ç®—å­å°±å¯ä»¥å¤„ç† barrier ä¹‹åçš„æ•°æ®äº†ï¼Œä»è€Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿ Checkpoint çš„è¿‡ç¨‹å½±å“é¢å°½é‡ç¼©åˆ°æœ€å°ï¼Œæ¥æå‡ç³»ç»Ÿæ•´ä½“çš„ååé‡ã€‚</p><p>åœ¨æ•´ä¸ª Checkpoint çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå‡è®¾æˆ‘ä»¬è®¾ç½®çš„ 10 åˆ†é’Ÿä¸€æ¬¡ Checkpointã€‚åœ¨ç¬¬ n æ¬¡ Checkpoint æˆåŠŸåï¼Œè¿‡äº† 9 åˆ†é’Ÿï¼Œä»»åŠ¡çªç„¶æŒ‚äº†ï¼Œæˆ‘ä»¬éœ€è¦ä»æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„ Checkpoint å¤„æ¢å¤ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä» 9 åˆ†é’Ÿä¹‹å‰çš„çŠ¶æ€æ¢å¤ä»»åŠ¡ï¼Œå°±éœ€è¦æŠŠè¿™ 9åˆ†é’Ÿçš„æ•°æ®å…¨éƒ¨å†æ¶ˆè´¹ä¸€æ¬¡ï¼Œæˆæœ¬æ¯”è¾ƒå¤§ã€‚æœ‰çš„åŒå­¦å¯èƒ½ä¼šæƒ³ï¼Œé‚£å¯ä»¥ä¸å¯ä»¥è®¾ç½®ä¸º 100 mså°±åšä¸€æ¬¡ Checkpoint å‘¢ï¼Ÿè¿™æ ·çš„è¯ï¼Œå½“ä»»åŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œå°±ä¸éœ€è¦ä» 9 åˆ†é’Ÿå‰çš„çŠ¶æ€è¿›è¡Œæ¢å¤äº†ï¼Œç›´æ¥ä» 100 msä¹‹å‰çš„çŠ¶æ€æ¢å¤å³å¯ï¼Œæ¢å¤å°±ä¼šå¾ˆå¿«ï¼Œä¸éœ€è¦å¤„ç†å¤§é‡é‡å¤æ•°æ®äº†ã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšä¼šå¯¼è‡´åº”ç”¨ç¨‹åºé¢‘ç¹çš„è®¿é—®çŠ¶æ€åç«¯ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¸ºäº†é«˜å¯ç”¨ï¼Œä¼šæŠŠçŠ¶æ€é‡Œçš„æ•°æ®æ¯”å¦‚ offsetï¼šï¼ˆ0ï¼Œ60000ï¼‰PVï¼šï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰ ä¿¡æ¯ä¿å­˜åˆ° HDFS ä¸­ï¼Œå¦‚æœé¢‘ç¹è®¿é—® HDFSï¼Œè‚¯å®šä¼šé€ æˆååé‡ä¸‹é™ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬çš„ Checkpoint æ—¶é—´é—´éš”å¯ä»¥è®¾ç½®ä¸ºåˆ†é’Ÿçº§åˆ«ï¼Œä¾‹å¦‚ 1 åˆ†é’Ÿã€3 åˆ†é’Ÿï¼Œå¯¹äºçŠ¶æ€å¾ˆå¤§çš„ä»»åŠ¡æ¯æ¬¡ Checkpoint è®¿é—® HDFS æ¯”è¾ƒè€—æ—¶ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥è®¾ç½®ä¸º 5 åˆ†é’Ÿä¸€æ¬¡ Checkpointï¼Œæ¯•ç«Ÿæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæŒ‚çš„æ¦‚ç‡å¹¶ä¸é«˜ï¼Œå¶å°”ä¸€æ¬¡ä» 5 åˆ†é’Ÿå‰çš„çŠ¶æ€æ¢å¤ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ¥å—çš„ã€‚å¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯åˆç†åœ°è°ƒèŠ‚ Checkpoint çš„é—´éš”æ—¶é•¿ï¼Œå¯¹äºçŠ¶æ€å¾ˆå°çš„ Job Checkpoint ä¼šå¾ˆå¿«ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒå°æ—¶é—´é—´éš”ï¼Œå¯¹äºçŠ¶æ€æ¯”è¾ƒå¤§çš„ Job Checkpoint ä¼šæ¯”è¾ƒæ…¢ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒå¤§ Checkpoint æ—¶é—´é—´éš”ã€‚</p><p>æœ‰çš„åŒå­¦å¯èƒ½è¿˜æœ‰ç–‘é—®ï¼Œæ˜æ˜è¯´å¥½çš„ Exactly Onceï¼Œä½†åœ¨ Checkpoint æˆåŠŸå 10s å‘ç”Ÿäº†æ•…éšœï¼Œä»æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„ Checkpoint å¤„æ¢å¤æ—¶ï¼Œç”±äºå‘ç”Ÿæ•…éšœå‰çš„ 10s Flink ä¹Ÿåœ¨å¤„ç†æ•°æ®ï¼Œæ‰€ä»¥ Flink åº”ç”¨ç¨‹åºè‚¯å®šæ˜¯æŠŠä¸€äº›æ•°æ®é‡å¤å¤„ç†äº†å‘€ã€‚åœ¨é¢å¯¹ä»»æ„æ•…éšœæ—¶ï¼Œä¸å¯èƒ½ä¿è¯æ¯ä¸ªç®—å­ä¸­ç”¨æˆ·å®šä¹‰çš„é€»è¾‘åœ¨æ¯ä¸ªäº‹ä»¶ä¸­åªæ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºç”¨æˆ·ä»£ç è¢«éƒ¨åˆ†æ‰§è¡Œçš„å¯èƒ½æ€§æ˜¯æ°¸è¿œå­˜åœ¨çš„ã€‚é‚£ä¹ˆï¼Œå½“å¼•æ“å£°æ˜ Exactly Once å¤„ç†è¯­ä¹‰æ—¶ï¼Œå®ƒä»¬èƒ½ä¿è¯ä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœä¸èƒ½ä¿è¯ç”¨æˆ·é€»è¾‘åªæ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆå“ªäº›é€»è¾‘åªæ‰§è¡Œä¸€æ¬¡ï¼Ÿå½“å¼•æ“å£°æ˜ Exactly Once å¤„ç†è¯­ä¹‰æ—¶ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯åœ¨è¯´ï¼Œå®ƒä»¬å¯ä»¥ä¿è¯å¼•æ“ç®¡ç†çš„çŠ¶æ€æ›´æ–°åªæäº¤ä¸€æ¬¡åˆ°æŒä¹…çš„åç«¯å­˜å‚¨ã€‚æ¢è¨€ä¹‹ï¼Œæ— è®ºä»¥ä»€ä¹ˆç»´åº¦è®¡ç®— PVã€æ— è®º Flink åº”ç”¨ç¨‹åºå‘ç”Ÿå¤šå°‘æ¬¡æ•…éšœå¯¼è‡´é‡å¯ä» Checkpoint æ¢å¤ï¼ŒFlink éƒ½å¯ä»¥ä¿è¯ PV ç»“æœæ˜¯å‡†ç¡®çš„ï¼Œä¸ä¼šå› ä¸ºå„ç§ä»»åŠ¡é‡å¯è€Œå¯¼è‡´ PV å€¼è®¡ç®—åé«˜ã€‚</p><p>ä¸ºäº†ä¸‹æ¸¸å°½å¿«åš Checkpointï¼Œæ‰€ä»¥ä¼šå…ˆå‘é€ barrier åˆ°ä¸‹æ¸¸ï¼Œè‡ªèº«å†åŒæ­¥è¿›è¡Œå¿«ç…§ã€‚è¿™ä¸€æ­¥ï¼Œå¦‚æœå‘ä¸‹å‘é€barrieråï¼Œè‡ªå·±åŒæ­¥å¿«ç…§æ…¢æ€ä¹ˆåŠï¼Ÿä¸‹æ¸¸å·²ç»åŒæ­¥å¥½äº†ï¼Œè‡ªå·±è¿˜æ²¡ï¼Ÿå¯èƒ½ä¼šå‡ºç°ä¸‹æ¸¸æ¯”ä¸Šæ¸¸å¿«ç…§è¿˜æ—©çš„æƒ…å†µï¼Œä½†æ˜¯è¿™ä¸å½±å“å¿«ç…§ç»“æœï¼Œåªæ˜¯ä¸‹æ¸¸åšå¿«ç…§æ›´åŠæ—¶äº†ï¼Œæˆ‘åªè¦ä¿è¯ä¸‹æ¸¸æŠŠbarrierä¹‹å‰çš„æ•°æ®éƒ½å¤„ç†äº†ï¼Œå¹¶ä¸”ä¸å¤„ç† barrier ä¹‹åçš„æ•°æ®ï¼Œç„¶ååšå¿«ç…§ï¼Œé‚£ä¹ˆä¸‹æ¸¸ä¹ŸåŒæ ·æ”¯æŒ Exactly Onceã€‚è¿™ä¸ªé—®é¢˜ä¸è¦ä»å…¨å±€æ€è€ƒï¼Œå•ç‹¬æ€è€ƒä¸Šæ¸¸å’Œä¸‹æ¸¸çš„å®ä¾‹ï¼Œä½ ä¼šå‘ç°ä¸Šä¸‹æ¸¸çš„çŠ¶æ€éƒ½æ˜¯å‡†ç¡®çš„ï¼Œæ—¢æ²¡æœ‰ä¸¢ï¼Œä¹Ÿæ²¡æœ‰é‡å¤è®¡ç®—ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¦‚æœæœ‰ä¸€ä¸ªOperator çš„ Checkpoint å¤±è´¥äº†æˆ–è€…å› ä¸º Checkpoint è¶…æ—¶ä¹Ÿä¼šå¯¼è‡´å¤±è´¥ï¼Œé‚£ä¹ˆ JobManager ä¼šè®¤ä¸ºæ•´ä¸ª Checkpoint å¤±è´¥ã€‚å¤±è´¥çš„ Checkpoint æ˜¯ä¸èƒ½ç”¨æ¥æ¢å¤ä»»åŠ¡çš„ï¼Œå¿…é¡»æ‰€æœ‰çš„ç®—å­çš„ Checkpoint éƒ½æˆåŠŸï¼Œé‚£ä¹ˆè¿™æ¬¡ Checkpoint æ‰èƒ½è®¤ä¸ºæ˜¯æˆåŠŸçš„ï¼Œæ‰èƒ½ç”¨æ¥æ¢å¤ä»»åŠ¡ã€‚å¯¹åº”åˆ° PV æ¡ˆä¾‹å°±æ˜¯ï¼ŒPV task åšå¿«ç…§é€Ÿåº¦è¾ƒå¿«ï¼ŒPV=20005 è¾ƒæ—©åœ°å†™å…¥åˆ°äº† HDFSï¼Œä½†æ˜¯ offset(0,10000)(1,10005) è¿‡äº†å‡ ç§’æ‰å†™å…¥åˆ° HDFSï¼Œè¿™ç§æƒ…å†µå°±ç®—å‡ºç°äº†ï¼Œä¹Ÿä¸ä¼šå½±å“è®¡ç®—ç»“æœï¼Œå› ä¸ºæˆ‘ä»¬çš„å¿«ç…§ä¿¡æ¯æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚</p><p>å†åˆ†äº«ä¸€ä¸ªæ¡ˆä¾‹ï¼ŒFlink çš„ Checkpoint è¯­ä¹‰è®¾ç½®äº† Exactly Onceï¼Œç¨‹åºä¸­è®¾ç½®äº† 1 åˆ†é’Ÿ 1 æ¬¡ Checkpointï¼Œ5 ç§’å‘ MySQL å†™ä¸€æ¬¡æ•°æ®ï¼Œå¹¶commitã€‚æœ€åå‘ç° MySQL ä¸­æ•°æ®é‡å¤äº†ã€‚ä¸ºä»€ä¹ˆä¼šé‡å¤å‘¢ï¼ŸFlinkè¦æ±‚ç«¯å¯¹ç«¯çš„ Exactly Once éƒ½å¿…é¡»å®ç° TwoPhaseCommitSinkFunctionã€‚å¦‚æœä½ çš„ Checkpoint æˆåŠŸäº†ï¼Œè¿‡äº†30ç§’çªç„¶ç¨‹åºæŒ‚äº†ï¼Œç”±äº 5 ç§’ commit ä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨åº”ç”¨ç¨‹åºæŒ‚ä¹‹å‰çš„ 30 ç§’å®é™…ä¸Šå·²ç»å†™å…¥äº† 6 æ‰¹æ•°æ®è¿›å…¥ MySQLã€‚ä» Checkpoint å¤„æ¢å¤æ—¶ï¼Œä¹‹å‰æäº¤çš„ 6 æ‰¹æ•°æ®å°±ä¼šé‡å¤å†™å…¥ï¼Œæ‰€ä»¥å‡ºç°äº†é‡å¤æ¶ˆè´¹ã€‚Flink çš„ Exactly Once æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯æˆ‘ä»¬æœ¬èŠ‚æ‰€è®²çš„ Flink å†…éƒ¨çš„ Exactly Onceï¼Œä¸€ä¸ªæ˜¯ç«¯å¯¹ç«¯çš„ Exactly Onceã€‚å…³äºç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯ Exactly Onceï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚ä¸­æ·±å…¥åˆ†æã€‚</p><h3 id="9-5-2-ç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ"><a href="#9-5-2-ç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ" class="headerlink" title="9.5.2 ç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ"></a>9.5.2 ç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ</h3><p>Flink ä¸å¤–éƒ¨å­˜å‚¨ä»‹è´¨ä¹‹é—´è¿›è¡Œæ•°æ®äº¤äº’ç»Ÿç§°ä¸ºç«¯å¯¹ç«¯æˆ– end to end æ•°æ®ä¼ è¾“ã€‚ä¸Šä¸€èŠ‚è®²è¿°äº† Flink å†…éƒ¨å¦‚ä½•ä¿è¯ Exactly Onceï¼Œè¿™ä¸€èŠ‚æ¥åˆ†æç«¯å¯¹ç«¯çš„ Exactly Onceã€‚æ­£å¦‚ä¸Šè¿° Flink å†™ MySQL çš„æ¡ˆä¾‹æ‰€ç¤ºï¼Œåœ¨ç¬¬ n æ¬¡ Checkpoint ç»“æŸåï¼Œç¬¬ n+1 æ¬¡ Checkpoint ä¹‹å‰ï¼Œå¦‚æœ Flink åº”ç”¨ç¨‹åºå·²ç»å‘å¤–éƒ¨çš„å­˜å‚¨ä»‹è´¨ä¸­æˆåŠŸå†™å…¥å¹¶æäº¤äº†ä¸€äº›æ•°æ®åï¼ŒFlink åº”ç”¨ç¨‹åºç”±äºæŸäº›åŸå› æŒ‚äº†ï¼Œå¯¼è‡´ä»»åŠ¡ä»ç¬¬ n æ¬¡ Checkpoint å¤„æ¢å¤ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå°±ä¼šå¯¼è‡´ç¬¬ n æ¬¡ Checkpoint ç»“æŸåä¸”ä»»åŠ¡å¤±è´¥ä¹‹å‰å¾€å¤–éƒ¨å­˜å‚¨ä»‹è´¨ä¸­å†™å…¥çš„é‚£ä¸€éƒ¨åˆ†æ•°æ®é‡å¤å†™å…¥ä¸¤æ¬¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç›¸åŒçš„æ•°æ®åœ¨å­˜å‚¨ä»‹è´¨ä¸­å­˜å‚¨äº†ä¸¤ä»½ï¼Œä»è€Œç«¯å¯¹ç«¯çš„ä¸€è‡´æ€§è¯­ä¹‰ä¿è¯ä» Exactly Once é€€åŒ–ä¸º At Least Onceã€‚è¿™é‡Œåªè€ƒè™‘äº†æ•°æ®é‡å¤çš„æƒ…å†µï¼Œä¸ºä»€ä¹ˆä¸è€ƒè™‘ä¸¢æ•°æ®çš„æƒ…å†µå‘¢ï¼Ÿåœ¨å†™æ•°æ®æ—¶å¯ä»¥å¯¹å¼‚å¸¸è¿›è¡Œæ•è·å¢åŠ é‡è¯•ç­–ç•¥ï¼Œå¦‚æœé‡è¯•å¤šæ¬¡è¿˜æ²¡æœ‰æˆåŠŸå¯ä»¥è®© Flink ä»»åŠ¡å¤±è´¥ï¼ŒFlink ä»»åŠ¡å°±ä¼šä»æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„ Checkpoint å¤„æ¢å¤ï¼Œå°±ä¸ä¼šå‡ºç°ä¸¢æ•°æ®çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬æœ¬èŠ‚å†…å®¹ä¸»è¦ç”¨æ¥è§£å†³æ•°æ®é‡å¤çš„é—®é¢˜ã€‚</p><p>é’ˆå¯¹ä¸Šè¿°ç«¯å¯¹ç«¯ Exactly Once çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ¡ˆæ¥è§£å†³ï¼š</p><p>1ã€å‡å¦‚æˆ‘ä»¬ä½¿ç”¨çš„å­˜å‚¨ä»‹è´¨æ”¯æŒæŒ‰ç…§å…¨å±€ä¸»é”®å»é‡ï¼Œé‚£ä¹ˆæ¯”è¾ƒå®¹æ˜“å®ç° Exactly Onceï¼Œæ— è®ºç›¸åŒçš„æ•°æ®å¾€å¤–éƒ¨å­˜å‚¨ä¸­å†™å…¥äº†å‡ æ¬¡ï¼Œå¤–éƒ¨å­˜å‚¨éƒ½ä¼šè¿›è¡Œå»é‡ï¼Œåªä¿ç•™ä¸€æ¡æ•°æ®ã€‚ä¾‹å¦‚ï¼Œapp1 çš„ PV å€¼ä¸º 10ï¼Œç°åœ¨æŠŠ ï¼ˆkey=app1ï¼Œvalue=10ï¼‰ å¾€ Redis ä¸­å†™å…¥ 10 æ¬¡ï¼Œåªæ˜¯è¯´æŠŠ value å€¼è¦†ç›–äº† 10æ¬¡ï¼Œå¹¶ä¸ä¼šå¯¼è‡´ç»“æœé”™è¯¯ï¼Œè¿™ç§æ–¹æ¡ˆå±äºå¹‚ç­‰æ€§å†™å…¥ã€‚</p><p>2ã€æˆ‘ä»¬ä¸Šè¿°æ¡ˆä¾‹ä¸­ä¸ºä»€ä¹ˆä¼šå¯¼è‡´é‡å¤å†™å…¥æ•°æ®åˆ°å¤–éƒ¨å­˜å‚¨å‘¢ï¼Ÿæ˜¯å› ä¸ºåœ¨ä¸‹ä¸€æ¬¡ Checkpoint ä¹‹å‰å¦‚æœä»»åŠ¡å¤±è´¥æ—¶ï¼Œä¸€äº›æ•°æ®å·²ç»æˆåŠŸå†™å…¥åˆ°äº†å¤–éƒ¨å­˜å‚¨ä¸­ï¼Œæ²¡åŠæ³•åˆ é™¤é‚£äº›æ•°æ®ã€‚æ—¢ç„¶é—®é¢˜æ˜¯è¿™æ ·ï¼Œé‚£å¯ä»¥æƒ³åŠæ³•æŠŠ â€œå‘å¤–éƒ¨å­˜å‚¨ä¸­æäº¤æ•°æ®â€ ä¸ â€œCheckpointâ€ å¼ºå…³è”ï¼Œä¸¤æ¬¡ Checkpoint ä¹‹é—´ä¸å…è®¸å‘å¤–éƒ¨å­˜å‚¨ä»‹è´¨ä¸­æäº¤æ•°æ®ï¼ŒCheckpoint çš„æ—¶å€™å†å‘å¤–éƒ¨å­˜å‚¨æäº¤ã€‚å¦‚æœæäº¤æˆåŠŸï¼Œåˆ™ Checkpoint æˆåŠŸï¼Œæäº¤å¤±è´¥ï¼Œåˆ™ Checkpoint ä¹Ÿå¤±è´¥ã€‚è¿™æ ·åœ¨ä¸‹ä¸€æ¬¡ Checkpoint ä¹‹å‰ï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¹Ÿæ²¡æœ‰é‡å¤æ•°æ®è¢«æäº¤åˆ°å¤–éƒ¨å­˜å‚¨ã€‚è¿™é‡Œåªæ˜¯æè¿°ä¸€ä¸‹å¤§æ¦‚æ€æƒ³ï¼Œå¥½å¤šç»†èŠ‚è¿™é‡Œå¹¶æ²¡æœ‰è¯¦ç»†æè¿°ï¼Œä¼šåœ¨ä¸‹æ–‡ä¸­è¯¦ç»†æè¿°ã€‚åŸºäºä¸Šè¿°æ€æƒ³ï¼ŒFlink å®ç°äº† TwoPhaseCommitSinkFunctionï¼Œå®ƒæå–äº†ä¸¤é˜¶æ®µæäº¤åè®®çš„é€šç”¨é€»è¾‘ï¼Œä½¿å¾—é€šè¿‡ Flink æ¥æ„å»ºç«¯åˆ°ç«¯çš„Exactly Once ç¨‹åºæˆä¸ºå¯èƒ½ã€‚å®ƒæä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œç”¨æˆ·åªéœ€è¦å®ç°å°‘æ•°æ–¹æ³•å°±èƒ½å®ç°ç«¯åˆ°ç«¯çš„ Exactly Once è¯­ä¹‰ã€‚ä¸è¿‡è¿™ç§æ–¹æ¡ˆå¿…é¡»è¦æ±‚æˆ‘ä»¬çš„è¾“å‡ºç«¯ (Sink ç«¯) å¿…é¡»æ”¯æŒäº‹åŠ¡ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸¤éƒ¨åˆ†æ¥è¯¦ç»†ä»‹ç»ä¸Šè¿°ä¸¤ç§æ–¹æ¡ˆã€‚</p><h4 id="å¹‚ç­‰æ€§å†™å…¥å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„-Exactly-Once"><a href="#å¹‚ç­‰æ€§å†™å…¥å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„-Exactly-Once" class="headerlink" title="å¹‚ç­‰æ€§å†™å…¥å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„ Exactly Once"></a>å¹‚ç­‰æ€§å†™å…¥å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„ Exactly Once</h4><p>å®æ—¶ ETL å½“ HBase åšä¸º Sink ç«¯æ—¶ï¼Œå°±æ˜¯å…¸å‹çš„åº”ç”¨åœºæ™¯ã€‚æŠŠæ—¥å¿—ä¸­çš„ä¸»é”®åšä¸º HBase çš„ RowKeyï¼Œå°±å¯ä»¥ä¿è¯æ•°æ®ä¸é‡å¤ï¼Œå®ç°æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ã€‚</p><p>ç»§ç»­æ¢è®¨å®æ—¶è®¡ç®—å„ app PV çš„æ¡ˆä¾‹ï¼Œå°†ç»Ÿè®¡ç»“æœä»¥æ™®é€šé”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ° Redis ä¸­ä¾›ä¸šåŠ¡æ–¹æŸ¥è¯¢ã€‚åˆ°åº•å¦‚ä½•å®ç°ï¼Œæ‰èƒ½ä¿è¯ Redis ä¸­çš„ç»“æœæ˜¯ç²¾å‡†çš„å‘¢ï¼Ÿåœ¨ä¹‹å‰ Strom æˆ– Spark Streaming çš„æ–¹æ¡ˆä¸­ï¼Œå°†ç»Ÿè®¡çš„ PV ç»“æœä¿å­˜åœ¨ Redis ä¸­ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®ï¼Œä» Redis ä¸­è·å–ç›¸åº” app å¯¹åº”çš„ PV å€¼ç„¶åå†…å­˜ä¸­è¿›è¡Œ +1 åï¼Œå†å°† PV å€¼ put åˆ° Redis ä¸­ã€‚ä¾‹å¦‚ï¼šRedis ä¸­ä¿å­˜ app1 çš„ PV ä¸º 10ï¼Œç°åœ¨æ¥äº†ä¸€æ¡ app1 çš„æ—¥å¿—ï¼Œé¦–å…ˆä» Redis ä¸­è·å– app1 çš„ PV å€¼=10ï¼Œå†…å­˜ä¸­ 10+1=11ï¼Œå°† (app1,11) put åˆ° Redis ä¸­ï¼Œè¿™é‡Œçš„ 11 å°±æ˜¯æˆ‘ä»¬ç»Ÿè®¡çš„ app1 çš„ PV ç»“æœã€‚å¯ä»¥å°†è¿™ç§æ–¹æ¡ˆä¼˜åŒ–ä¸º incr æˆ– incrbyï¼Œç›´æ¥å¯¹ Redis ä¸­çš„ 10 è¿›è¡Œç´¯åŠ ï¼Œä¸éœ€è¦æ‰‹åŠ¨åœ¨å†…å­˜ä¸­è¿›è¡Œç´¯åŠ æ“ä½œã€‚å½“ç„¶ Flink ä¹Ÿå¯ä»¥ç”¨ä¸Šè¿°çš„è¿™ç§æ–¹æ¡ˆæ¥ç»Ÿè®¡å„ app çš„ PVï¼Œä½†æ˜¯ä¸Šè¿°æ–¹æ¡ˆå¹¶ä¸èƒ½ä¿è¯ Exactly Onceï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå½“ç¬¬ n æ¬¡ Checkpoint æ—¶ï¼Œapp1 çš„ PV ç»“æœä¸º 10000ï¼Œç¬¬ n æ¬¡ Checkpoint ç»“æŸåè¿è¡Œäº† 10 ç§’ï¼ŒRedis ä¸­ app1 çš„ PV ç»“æœå·²ç»ç´¯åŠ åˆ°äº† 10200ã€‚æ­¤æ—¶å¦‚æœä»»åŠ¡æŒ‚äº†ï¼Œä»ç¬¬ n æ¬¡ Checkpoint æ¢å¤ä»»åŠ¡æ—¶ï¼Œä¼šç»§ç»­æŒ‰ç…§ Redis ä¸­ä¿å­˜çš„ PV=10200 è¿›è¡Œç´¯åŠ ï¼Œä½†æ˜¯æ­£ç¡®çš„ç»“æœåº”è¯¥æ˜¯ä» PV=10000 å¼€å§‹ç´¯åŠ ã€‚å¦‚æœæŒ‰ç…§ä¸Šé¢çš„æ–¹æ¡ˆç»Ÿè®¡ PVï¼Œå°±å¯èƒ½ä¼šå‡ºç°ç»Ÿè®¡å€¼åé«˜çš„æƒ…å†µã€‚è¿™é‡Œä¹Ÿè¯å®äº†ä¸€ç‚¹ï¼šå¹¶ä¸æ˜¯è¯´ Flink ç¨‹åºçš„ Checkpoint è¯­ä¹‰è®¾ç½®ä¸º Exactly Onceï¼Œå°±èƒ½ä¿è¯æˆ‘ä»¬çš„ç»Ÿè®¡ç»“æœæˆ–è€…å„ç§è¾“å‡ºç»“æœéƒ½èƒ½æ»¡è¶³ Exactly Onceã€‚ä¸ºäº†ç¼–å†™çœŸæ­£æ»¡è¶³ Exactly Once çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Flink çš„ Checkpoint åŸç†åšä¸€äº›äº†è§£ï¼Œç¼–å†™å¯¹ Exactly Once å‹å¥½çš„ä»£ç ã€‚</p><p>é‚£å¦‚ä½•ç¼–å†™ä»£ç æ‰èƒ½ä½¿å¾—æœ€ååœ¨ Redis ä¸­ä¿å­˜çš„ PV ç»“æœæ»¡è¶³ Exactly Once å‘¢ï¼Ÿä¸Šä¸€èŠ‚ä¸­ï¼Œè®²è¿°äº† Flink å†…éƒ¨çŠ¶æ€å¯ä»¥ä¿è¯ Exactly Onceï¼Œè¿™é‡Œå¯ä»¥å°†ç»Ÿè®¡çš„ PV ç»“æœä¿å­˜åœ¨ Flink å†…éƒ¨çš„çŠ¶æ€é‡Œï¼Œæ¯æ¬¡åŸºäºçŠ¶æ€è¿›è¡Œç´¯åŠ æ“ä½œï¼Œå¹¶å°†ç´¯åŠ åˆ°çš„ç»“æœ put åˆ° Redis ä¸­ï¼Œè¿™æ ·å½“ä»»åŠ¡ä» Checkpoint å¤„æ¢å¤æ—¶ï¼Œå¹¶ä¸æ˜¯åŸºäº Redis ä¸­å®æ—¶ç»Ÿè®¡çš„ PV å€¼è¿›è¡Œç´¯åŠ ï¼Œè€Œæ˜¯åŸºäº Checkpoint ä¸­ä¿å­˜çš„ PV å€¼è¿›è¡Œç´¯åŠ ï¼ŒCheckpoint ä¸­ä¼šä¿å­˜æ¯æ¬¡ Checkpoint æ—¶å¯¹åº”çš„ PV å¿«ç…§ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šç¬¬ n æ¬¡ Checkpoint ä¼šæŠŠå½“æ—¶ pv=10000 ä¿å­˜åˆ°å¿«ç…§ä¿¡æ¯é‡Œï¼ŒåŒæ—¶çŠ¶æ€åç«¯è¿˜ä¿å­˜ç€ä¸€ä»½å®æ—¶çš„çŠ¶æ€ä¿¡æ¯ç”¨äºå®æ—¶ç´¯åŠ ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"><span class="comment">// 1 åˆ†é’Ÿä¸€æ¬¡Checkpoint</span></span><br><span class="line">env.enableCheckpointing(TimeUnit.MINUTES.toMillis(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">CheckpointConfig checkpointConf = env.getCheckpointConfig();</span><br><span class="line"><span class="comment">// Checkpoint è¯­ä¹‰ EXACTLY ONCE</span></span><br><span class="line">checkpointConf.setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line">checkpointConf.enableExternalizedCheckpoints(CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION);</span><br><span class="line"></span><br><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092"</span>);</span><br><span class="line">props.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">"app-pv-stat"</span>);</span><br><span class="line"></span><br><span class="line">DataStreamSource&lt;String&gt; appInfoSource = env.addSource(<span class="keyword">new</span> FlinkKafkaConsumer011&lt;&gt;(</span><br><span class="line">        <span class="comment">// kafka topicï¼Œ String åºåˆ—åŒ–</span></span><br><span class="line">        <span class="string">"app-topic"</span>,  <span class="keyword">new</span> SimpleStringSchema(), props));</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‰ç…§ appId è¿›è¡Œ keyBy</span></span><br><span class="line">appInfoSource.keyBy((KeySelector&lt;String, String&gt;) appId -&gt; appId)</span><br><span class="line">        .map(<span class="keyword">new</span> RichMapFunction&lt;String, Tuple2&lt;String, Long&gt;&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> ValueState&lt;Long&gt; pvState;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">long</span> pv = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.open(parameters);</span><br><span class="line">                <span class="comment">// åˆå§‹åŒ–çŠ¶æ€</span></span><br><span class="line">                pvState = getRuntimeContext().getState(</span><br><span class="line">                        <span class="keyword">new</span> ValueStateDescriptor&lt;&gt;(<span class="string">"pvStat"</span>,</span><br><span class="line">                        TypeInformation.of(<span class="keyword">new</span> TypeHint&lt;Long&gt;() &#123;&#125;)));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title">map</span><span class="params">(String appId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// ä»çŠ¶æ€ä¸­è·å–è¯¥ app çš„ PV å€¼ï¼Œ+1åï¼Œupdate åˆ°çŠ¶æ€ä¸­</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> == pvState.value())&#123;</span><br><span class="line">                    pv = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pv = pvState.value();</span><br><span class="line">                    pv += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                pvState.update(pv);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(appId, pv);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .print();</span><br><span class="line"></span><br><span class="line">env.execute(<span class="string">"Flink PV stat"</span>);</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­è®¾ç½® 1 åˆ†é’Ÿä¸€æ¬¡ Checkpointï¼ŒCheckpoint è¯­ä¹‰ EXACTLY ONCEï¼Œä» Kafka ä¸­è¯»å–æ•°æ®ï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæ‰€ä»¥ Kafka ä¸­è¯»å–çš„ç›´æ¥å°±æ˜¯ String ç±»å‹çš„ appIdï¼ŒæŒ‰ç…§ appId KeyBy åï¼Œæ‰§è¡Œ RichMapFunctionï¼ŒRichMapFunction çš„ open æ–¹æ³•ä¸­ä¼šåˆå§‹åŒ– ValueState<Long> ç±»å‹çš„ pvStateï¼ŒpvState å°±æ˜¯ä¸Šæ–‡ä¸€ç›´å¼ºè°ƒçš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯æ¬¡ Checkpoint çš„æ—¶å€™ï¼Œä¼šæŠŠ pvState çš„çŠ¶æ€ä¿¡æ¯å¿«ç…§ä¸€ä»½åˆ° HDFS æ¥æä¾›æ¢å¤ã€‚è¿™é‡ŒæŒ‰ç…§ appId è¿›è¡Œ keyByï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª appId éƒ½ä¼šå¯¹åº”ä¸€ä¸ª pvStateï¼ŒpvState é‡Œå­˜å‚¨ç€è¯¥ appId å¯¹åº”çš„ pv å€¼ã€‚æ¯æ¥ä¸€æ¡æ•°æ®éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ map æ–¹æ³•ï¼Œå½“è¿™æ¡æ•°æ®å¯¹åº”çš„ appId æ˜¯æ–° app æ—¶ï¼ŒpvState é‡Œå°±æ²¡æœ‰å­˜å‚¨è¿™ä¸ª appId å½“å‰çš„ pv å€¼ï¼Œå°† pv å€¼èµ‹å€¼ä¸º 1ï¼Œå½“ pvState é‡Œå­˜å‚¨çš„ value ä¸ä¸º null æ—¶ï¼Œæ‹¿å‡º pv å€¼ +1å update åˆ° pvState é‡Œã€‚map æ–¹æ³•å†å°† appId å’Œ pv å€¼å‘é€åˆ°ä¸‹æ¸¸ç®—å­ï¼Œä¸‹æ¸¸ç›´æ¥è°ƒç”¨äº† print è¿›è¡Œè¾“å‡ºï¼Œè¿™é‡Œå®Œå…¨å¯ä»¥æ›¿æ¢æˆç›¸åº”çš„ RedisSink æˆ– HBaseSinkã€‚æœ¬æ¡ˆä¾‹ä¸­è®¡ç®— pv çš„å·¥ä½œäº¤ç»™äº† Flink å†…éƒ¨çš„ ValueStateï¼Œä¸ä¾èµ–å¤–éƒ¨å­˜å‚¨ä»‹è´¨è¿›è¡Œç´¯åŠ ï¼Œå¤–éƒ¨ä»‹è´¨æ‰¿æ‹…çš„è§’è‰²ä»…ä»…æ˜¯æä¾›æ•°æ®ç»™ä¸šåŠ¡æ–¹æŸ¥è¯¢ï¼Œæ‰€ä»¥æ— è®ºä¸‹æ¸¸ä½¿ç”¨ä»€ä¹ˆå½¢å¼çš„ Sinkï¼Œåªè¦ Sink ç«¯èƒ½å¤ŸæŒ‰ç…§ä¸»é”®å»é‡ï¼Œè¯¥ç»Ÿè®¡æ–¹æ¡ˆå°±å¯ä»¥ä¿è¯ Exactly Onceã€‚æœ¬æ¡ˆä¾‹ä½¿ç”¨çš„ ValueStateï¼Œå…³äº State çš„è¯¦ç»†ä½¿ç”¨è¯·å‚é˜…ç¬¬3.1èŠ‚ã€‚</p><h4 id="TwoPhaseCommitSinkFunction-å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„-Exactly-Once"><a href="#TwoPhaseCommitSinkFunction-å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„-Exactly-Once" class="headerlink" title="TwoPhaseCommitSinkFunction å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„ Exactly Once"></a>TwoPhaseCommitSinkFunction å¦‚ä½•ä¿è¯ç«¯å¯¹ç«¯çš„ Exactly Once</h4><p>Flink çš„æºç ä¸­æœ‰è¿™ä¹ˆä¸€æ®µæ³¨é‡Šï¼šThis is a recommended base class for all of the {@link SinkFunction} that intend to implement exactly-once semanticã€‚æ„æ€æ˜¯å¯¹äºæ‰“ç®—å®ç° Exactly Once è¯­ä¹‰çš„æ‰€æœ‰ SinkFunction éƒ½æ¨èç»§æ‰¿è¯¥æŠ½è±¡ç±»ã€‚åœ¨ä»‹ç» TwoPhaseCommitSinkFunction ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹ 2PC åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ã€‚</p><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€ä¸ªæœºå™¨èŠ‚ç‚¹è™½ç„¶éƒ½èƒ½æ˜ç¡®åœ°çŸ¥é“è‡ªå·±åœ¨è¿›è¡Œäº‹åŠ¡æ“ä½œè¿‡ç¨‹ä¸­çš„ç»“æœæ˜¯æˆåŠŸæˆ–å¤±è´¥ï¼Œä½†æ— æ³•ç›´æ¥è·å–åˆ°å…¶ä»–åˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ“ä½œç»“æœã€‚å› æ­¤ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡æ“ä½œéœ€è¦è·¨è¶Šå¤šä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸ºäº†è®©æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½å¤Ÿè·å–åˆ°å…¶ä»–èŠ‚ç‚¹çš„äº‹åŠ¡æ‰§è¡ŒçŠ¶å†µï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªâ€åè°ƒè€…ï¼ˆCoordinatorï¼‰â€èŠ‚ç‚¹æ¥ç»Ÿä¸€è°ƒåº¦æ‰€æœ‰åˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘ï¼Œè¿™äº›è¢«è°ƒåº¦çš„åˆ†å¸ƒå¼èŠ‚ç‚¹è¢«ç§°ä¸ºâ€å‚ä¸è€…ï¼ˆParticipantï¼‰â€ã€‚åè°ƒè€…è´Ÿè´£è°ƒåº¦å‚ä¸è€…çš„è¡Œä¸ºï¼Œå¹¶æœ€ç»ˆå†³å®šè¿™äº›å‚ä¸è€…æ˜¯å¦è¦æŠŠäº‹åŠ¡çœŸæ­£çš„æäº¤ã€‚<br>æ™®é€šçš„äº‹åŠ¡å¯ä»¥ä¿è¯å•ä¸ªäº‹åŠ¡å†…æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œè€Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…·ä½“å¦‚ä½•ä¿è¯å¤šå°èŠ‚ç‚¹ä¸Šæ‰§è¡Œçš„äº‹åŠ¡è¦ä¹ˆæ‰€æœ‰èŠ‚ç‚¹äº‹åŠ¡éƒ½æˆåŠŸï¼Œè¦ä¹ˆæ‰€æœ‰èŠ‚ç‚¹äº‹åŠ¡éƒ½å¤±è´¥å‘¢ï¼Ÿå…ˆäº†è§£ä¸€ä¸‹ 2PC ä¸€è‡´æ€§åè®®ã€‚</p><p>2PC æ˜¯ Two-Phase Commit çš„ç¼©å†™ï¼Œå³ä¸¤é˜¶æ®µæäº¤ã€‚2PC å°†åˆ†å¸ƒå¼äº‹åŠ¡åˆ†ä¸ºäº†ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯æäº¤äº‹åŠ¡è¯·æ±‚ï¼ˆæŠ•ç¥¨ï¼‰å’Œæ‰§è¡Œäº‹åŠ¡æäº¤ã€‚åè°ƒè€…ä¼šæ ¹æ®å‚ä¸è€…åœ¨ç¬¬ä¸€é˜¶æ®µçš„æŠ•ç¥¨ç»“æœï¼Œæ¥å†³å®šç¬¬äºŒé˜¶æ®µæ˜¯å¦çœŸæ­£çš„æ‰§è¡Œäº‹åŠ¡ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ã€‚</p><h5 id="æäº¤äº‹åŠ¡è¯·æ±‚ï¼ˆæŠ•ç¥¨ï¼‰é˜¶æ®µ"><a href="#æäº¤äº‹åŠ¡è¯·æ±‚ï¼ˆæŠ•ç¥¨ï¼‰é˜¶æ®µ" class="headerlink" title="æäº¤äº‹åŠ¡è¯·æ±‚ï¼ˆæŠ•ç¥¨ï¼‰é˜¶æ®µ"></a>æäº¤äº‹åŠ¡è¯·æ±‚ï¼ˆæŠ•ç¥¨ï¼‰é˜¶æ®µ</h5><p>æäº¤äº‹åŠ¡è¯·æ±‚é˜¶æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ prepare è¯·æ±‚ä¸äº‹åŠ¡å†…å®¹ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥å‡†å¤‡äº‹åŠ¡æäº¤ï¼Œå¹¶ç­‰å¾…å‚ä¸è€…çš„å“åº”</li><li>å„å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶è®°å½• Undoæ—¥å¿—ï¼ˆç”¨äºå›æ»šï¼‰å’Œ Redoæ—¥å¿—ï¼ˆç”¨äºé‡æ”¾ï¼‰ï¼Œä½†ä¸çœŸæ­£æäº¤</li><li>å‚ä¸è€…å‘åè°ƒè€…è¿”å›äº‹åŠ¡æ“ä½œçš„æ‰§è¡Œç»“æœï¼Œæ‰§è¡ŒæˆåŠŸè¿”å› Yesï¼Œå¦åˆ™è¿”å› No</li></ul><h5 id="æ‰§è¡Œäº‹åŠ¡æäº¤é˜¶æ®µ"><a href="#æ‰§è¡Œäº‹åŠ¡æäº¤é˜¶æ®µ" class="headerlink" title="æ‰§è¡Œäº‹åŠ¡æäº¤é˜¶æ®µ"></a>æ‰§è¡Œäº‹åŠ¡æäº¤é˜¶æ®µ</h5><p>åˆ†ä¸ºæˆåŠŸä¸å¤±è´¥ä¸¤ç§æƒ…å†µï¼š</p><ul><li>è‹¥ç¬¬ä¸€é˜¶æ®µæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å› Yesï¼Œè¯´æ˜äº‹åŠ¡å¯ä»¥æäº¤<ul><li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ Commit è¯·æ±‚</li><li>å‚ä¸è€…æ”¶åˆ° Commit è¯·æ±‚åï¼Œä¼šæ­£å¼æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶åœ¨æäº¤å®Œæˆåé‡Šæ”¾äº‹åŠ¡èµ„æº</li><li>å®Œæˆäº‹åŠ¡æäº¤åï¼Œå‘åè°ƒè€…å‘é€ Ack æ¶ˆæ¯</li><li>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ Ack æ¶ˆæ¯ï¼Œå®Œæˆäº‹åŠ¡</li></ul></li></ul><p>äº‹åŠ¡æäº¤æˆåŠŸçš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151552.jpg" style="zoom:12%;" /></p><ul><li>è‹¥ç¬¬ä¸€é˜¶æ®µæœ‰å‚ä¸è€…è¿”å› No æˆ–è€…è¶…æ—¶æœªè¿”å›ï¼Œè¯´æ˜äº‹åŠ¡ä¸­æ–­ï¼Œéœ€è¦å›æ»š<ul><li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ Rollback è¯·æ±‚</li><li>å‚ä¸è€…æ”¶åˆ° Rollback è¯·æ±‚åï¼Œæ ¹æ® Undoæ—¥å¿—å›æ»šåˆ°äº‹åŠ¡æ‰§è¡Œå‰çš„çŠ¶æ€ï¼Œé‡Šæ”¾å ç”¨çš„äº‹åŠ¡èµ„æº</li><li>å‚ä¸è€…åœ¨å®Œæˆäº‹åŠ¡å›æ»šåï¼Œå‘åè°ƒè€…è¿”å› Ack</li><li>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ Ack æ¶ˆæ¯ï¼Œäº‹åŠ¡å›æ»šå®Œæˆ</li></ul></li></ul><p>äº‹åŠ¡æäº¤ä¸­æ–­ï¼Œéœ€è¦å›æ»šçš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-10-07-151557.jpg" style="zoom:12%;" /></p><p>ç®€å•æ¥è®²ï¼Œ2PC å°†ä¸€ä¸ªäº‹åŠ¡çš„å¤„ç†è¿‡ç¨‹åˆ†ä¸ºäº†æŠ•ç¥¨å’Œæ‰§è¡Œä¸¤ä¸ªé˜¶æ®µï¼Œå…¶æ ¸å¿ƒæ˜¯æ¯ä¸ªäº‹åŠ¡éƒ½é‡‡ç”¨å…ˆå°è¯•åæäº¤çš„å¤„ç†æ–¹å¼ã€‚2PC çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>ä¼˜ç‚¹ï¼šåŸç†ç®€å•ï¼Œå®ç°æ–¹ä¾¿</p><p>ç¼ºç‚¹ï¼š</p><ul><li>åè°ƒè€…å•ç‚¹é—®é¢˜ï¼šåè°ƒè€…åœ¨æ•´ä¸ª 2PC åè®®ä¸­éå¸¸é‡è¦ï¼Œä¸€æ—¦åè°ƒè€…æ•…éšœï¼Œåˆ™ 2PC å°†æ— æ³•è¿è½¬</li><li>è¿‡äºä¿å®ˆï¼šåœ¨ 2PC çš„é˜¶æ®µä¸€ï¼Œå¦‚æœå‚ä¸è€…å‡ºç°æ•…éšœè€Œå¯¼è‡´åè°ƒè€…æ— æ³•è·å–åˆ°å‚ä¸è€…çš„å“åº”ä¿¡æ¯ï¼Œè¿™æ—¶åè°ƒè€…åªèƒ½ä¾é è‡ªèº«çš„è¶…æ—¶æœºåˆ¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­äº‹åŠ¡ï¼Œè¿™ç§ç­–ç•¥æ¯”è¾ƒä¿å®ˆã€‚æ¢è¨€ä¹‹ï¼Œ2PC æ²¡æœ‰æ¶‰åŠè¾ƒä¸ºå®Œå–„çš„å®¹é”™æœºåˆ¶ï¼Œä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡çš„å¤±è´¥</li><li>åŒæ­¥é˜»å¡ï¼šæ‰§è¡Œè¿‡ç¨‹æ˜¯å®Œå…¨åŒæ­¥çš„ï¼Œå„ä¸ªå‚ä¸è€…åœ¨ç­‰å¾…å…¶ä»–å‚ä¸è€…æŠ•ç¥¨å“åº”çš„çš„è¿‡ç¨‹ä¸­ï¼Œå°†æ— æ³•è¿›è¡Œå…¶ä»–ä»»ä½•æ“ä½œ</li><li>æ•°æ®ä¸ä¸€è‡´ï¼šåœ¨äºŒé˜¶æ®µæäº¤åè®®çš„é˜¶æ®µäºŒï¼Œå½“åè°ƒè€…å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€ Commit è¯·æ±‚åï¼Œå‡ºç°äº†å±€éƒ¨ç½‘ç»œå¼‚å¸¸æˆ–å±€éƒ¨å‚ä¸è€…æœºå™¨æ•…éšœç­‰å› ç´ å¯¼è‡´ä¸€éƒ¨åˆ†çš„å‚ä¸è€…æ‰§è¡Œäº† Commit æ“ä½œï¼Œè€Œå‘ç”Ÿæ•…éšœçš„å‚ä¸è€…æ²¡æœ‰æ‰§è¡Œ Commitï¼Œäºæ˜¯æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¾¿å‡ºç°äº†æ•°æ®ä¸ä¸€è‡´ç°è±¡</li></ul><p>Flink çš„ TwoPhaseCommitSinkFunction æ˜¯åŸºäº 2PC å®ç°çš„ã€‚Flink çš„ JobManager å¯¹åº”åˆ° 2PC ä¸­çš„åè°ƒè€…ï¼ŒOperator å®ä¾‹å¯¹åº”åˆ° 2PC ä¸­çš„å‚ä¸è€…ã€‚TwoPhaseCommitSinkFunction å®ç°äº† CheckpointedFunction å’Œ CheckpointListener æ¥å£ã€‚CheckpointedFunction æ¥å£ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³• snapshotState å’Œ initializeStateï¼ŒsnapshotState æ–¹æ³•ä¼šåœ¨ Checkpoint æ—¶ä¸”åšå¿«ç…§ä¹‹å‰è¢«è°ƒç”¨ï¼ŒinitializeState æ–¹æ³•ä¼šåœ¨è‡ªå®šä¹‰ Function åˆå§‹åŒ–æ¢å¤çŠ¶æ€æ—¶è¢«è°ƒç”¨ã€‚CheckpointListener æ¥å£ä¸­æœ‰ä¸€ä¸ª notifyCheckpointComplete æ–¹æ³•ï¼ŒOperator å®ä¾‹çš„ Checkpoint æˆåŠŸåï¼Œä¼šåé¦ˆç»™ JobManagerï¼Œå½“ JobManager æ¥æ”¶åˆ°æ‰€æœ‰ Operator å®ä¾‹ Checkpoint æˆåŠŸçš„é€šçŸ¥åï¼Œå°±è®¤ä¸ºæœ¬æ¬¡ Checkpoint æˆåŠŸäº†ï¼Œä¼šç»™æ‰€æœ‰ Operator å®ä¾‹å‘é€ä¸€ä¸ª Checkpoint å®Œæˆçš„é€šçŸ¥ï¼ŒOperator å®ä¾‹æ¥æ”¶åˆ°é€šçŸ¥åï¼Œå°±ä¼šè°ƒç”¨ notifyCheckpointComplete æ–¹æ³•ã€‚</p><p>TwoPhaseCommitSinkFunctionå®šä¹‰äº†å¦‚ä¸‹ 5 ä¸ªæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†æ¯ä¸€æ¡æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(TXN transaction, IN value, Context context)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="comment">// å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿”å›äº‹åŠ¡ä¿¡æ¯çš„å¥æŸ„</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> TXN <span class="title">beginTransaction</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="comment">// é¢„æäº¤ï¼ˆå³æäº¤è¯·æ±‚ï¼‰é˜¶æ®µçš„é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">preCommit</span><span class="params">(TXN transaction)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="comment">// æ­£å¼æäº¤é˜¶æ®µçš„é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(TXN transaction)</span></span>;</span><br><span class="line"><span class="comment">// å–æ¶ˆäº‹åŠ¡,Rollback ç›¸å…³çš„é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">abort</span><span class="params">(TXN transaction)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="9-5-3-åˆ†æ-FlinkKafkaConsumer-çš„è®¾è®¡æ€æƒ³"><a href="#9-5-3-åˆ†æ-FlinkKafkaConsumer-çš„è®¾è®¡æ€æƒ³" class="headerlink" title="9.5.3 åˆ†æ FlinkKafkaConsumer çš„è®¾è®¡æ€æƒ³"></a>9.5.3 åˆ†æ FlinkKafkaConsumer çš„è®¾è®¡æ€æƒ³</h3><h4 id="kafka-offset-å­˜å‚¨åŠå¦‚ä½•å®ç°-Consumer-å®ä¾‹æ¶ˆè´¹-partition-çš„è´Ÿè½½å‡è¡¡"><a href="#kafka-offset-å­˜å‚¨åŠå¦‚ä½•å®ç°-Consumer-å®ä¾‹æ¶ˆè´¹-partition-çš„è´Ÿè½½å‡è¡¡" class="headerlink" title="kafka offset å­˜å‚¨åŠå¦‚ä½•å®ç° Consumer å®ä¾‹æ¶ˆè´¹ partition çš„è´Ÿè½½å‡è¡¡"></a>kafka offset å­˜å‚¨åŠå¦‚ä½•å®ç° Consumer å®ä¾‹æ¶ˆè´¹ partition çš„è´Ÿè½½å‡è¡¡</h4><h4 id="Source-ç«¯å¹¶è¡Œåº¦æ”¹å˜äº†ï¼Œå¦‚ä½•æ¥æ¢å¤-offset"><a href="#Source-ç«¯å¹¶è¡Œåº¦æ”¹å˜äº†ï¼Œå¦‚ä½•æ¥æ¢å¤-offset" class="headerlink" title="Source ç«¯å¹¶è¡Œåº¦æ”¹å˜äº†ï¼Œå¦‚ä½•æ¥æ¢å¤ offset"></a>Source ç«¯å¹¶è¡Œåº¦æ”¹å˜äº†ï¼Œå¦‚ä½•æ¥æ¢å¤ offset</h4><h4 id="å¦‚ä½•å®ç°è‡ªåŠ¨å‘ç°å½“å‰æ¶ˆè´¹-topic-ä¸‹æ–°å¢çš„-partition"><a href="#å¦‚ä½•å®ç°è‡ªåŠ¨å‘ç°å½“å‰æ¶ˆè´¹-topic-ä¸‹æ–°å¢çš„-partition" class="headerlink" title="å¦‚ä½•å®ç°è‡ªåŠ¨å‘ç°å½“å‰æ¶ˆè´¹ topic ä¸‹æ–°å¢çš„ partition"></a>å¦‚ä½•å®ç°è‡ªåŠ¨å‘ç°å½“å‰æ¶ˆè´¹ topic ä¸‹æ–°å¢çš„ partition</h4><h3 id="9-5-4-å°ç»“ä¸åæ€"><a href="#9-5-4-å°ç»“ä¸åæ€" class="headerlink" title="9.5.4 å°ç»“ä¸åæ€"></a>9.5.4 å°ç»“ä¸åæ€</h3><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/uFEEYzJ">https://t.zsxq.com/uFEEYzJ</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;9-5-Flink-ä¸­å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ&quot;&gt;&lt;a href=&quot;#9-5-Flink-ä¸­å¦‚ä½•ä¿è¯-Exactly-Onceï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;9.5 Flink ä¸­å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ&quot;&gt;&lt;/a&gt;9.5 Flink ä¸­å¦‚ä½•ä¿è¯ Exactly Onceï¼Ÿ&lt;/h2&gt;&lt;p&gt;åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéšæ—¶å¯èƒ½å‡ºç°ä»»ä½•å½¢å¼çš„æ•…éšœï¼Œä¾‹å¦‚ï¼šæœºå™¨ç¡¬ä»¶æ•…éšœã€ç¨‹åº OOM ç­‰ã€‚å½“åº”ç”¨ç¨‹åºå‡ºç°æ•…éšœæ—¶ï¼ŒFlink ä¸ºäº†ä¿è¯æ•°æ®æ¶ˆè´¹çš„ Exactly Onceï¼Œéœ€è¦æœ‰ç›¸åº”çš„æ•…éšœå®¹é”™èƒ½åŠ›ã€‚Flink æ˜¯é€šè¿‡å‘¨æœŸæ€§ Checkpoint çš„æ–¹å¼æ¥å®ç°æ•…éšœå®¹é”™ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯åŸºäº Chandy-Lamport æ”¹è¿›çš„ç®—æ³•ã€‚æœ¬èŠ‚ä¼šä»‹ç» Flink å†…éƒ¨å¦‚ä½•ä¿è¯ Exactly Once ä»¥åŠç«¯å¯¹ç«¯å¦‚ä½•ä¿è¯ Exactly Onceã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠFlink å®æˆ˜ä¸æ€§èƒ½ä¼˜åŒ–ã€‹â€”â€” å¦‚ä½•åˆç†çš„è®¾ç½® Flink ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ</title>
    <link href="http://www.54tianzhisheng.cn/2021/08/10/flink-in-action-9.4/"/>
    <id>http://www.54tianzhisheng.cn/2021/08/10/flink-in-action-9.4/</id>
    <published>2021-08-09T16:00:00.000Z</published>
    <updated>2022-01-23T12:03:10.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="9-4-å¦‚ä½•åˆç†çš„è®¾ç½®-Flink-ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ"><a href="#9-4-å¦‚ä½•åˆç†çš„è®¾ç½®-Flink-ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ" class="headerlink" title="9.4 å¦‚ä½•åˆç†çš„è®¾ç½® Flink ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ"></a>9.4 å¦‚ä½•åˆç†çš„è®¾ç½® Flink ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ</h2><p>åœ¨ 9.2 èŠ‚ä¸­è®²è§£äº† Flink Job ä¸­çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¹¶è¯¦ç»†åˆ†æäº† Flink ä¸­çš„ operator chain åœ¨ä¸€èµ·çš„å„ç§æ¡ä»¶ï¼Œåœ¨ 9.3 èŠ‚ä¸­ä¹Ÿé€šè¿‡çœŸå®ç”Ÿäº§ç¯å¢ƒçš„æ¡ˆä¾‹æ¥åˆ†äº«å¹¶è¡Œåº¦ä¸ Slot çš„æ¦‚å¿µä¸å…³ç³»ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½æœ‰ä¸€å®šçš„ç†è§£ï¼Œä½†æ˜¯æœ‰æ—¶å€™ç”Ÿäº§ç¯å¢ƒå¦‚æœ Job çªç„¶æ¶ˆè´¹ä¸åŠæ—¶äº†ï¼Œæˆ–è€… Job å°±æ ¹æœ¬ä¸åœ¨æ¶ˆè´¹æ•°æ®äº†ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆåŠï¼Ÿé¦–å…ˆå¾—çœ‹ä¸‹ç›¸å…³çš„ç›‘æ§æŸ¥çœ‹ Job æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œï¼Œæ˜¯å¦å‡ºç°åå‹çš„æƒ…å†µï¼Œæ˜¯å¦è¿™ä¼šç”Ÿäº§æ•°æ®é‡è¿‡å¤§ç„¶è€Œå¹¶è¡Œåº¦å´æ˜¯æ ¹æ®ä¹‹å‰æ•°æ®é‡è®¾ç½®çš„ï¼Œç§ç§åŸå› éƒ½éœ€è¦ä¸€ä¸ªä¸ªæ’æŸ¥ä¸€ä¸‹ï¼Œç„¶åæ‰¾åˆ°æ ¹å› æ‰èƒ½å¤Ÿå¯¹åº”çš„å»è§£å†³ã€‚è¿™èŠ‚æ¥è®²è§£ä¸‹é‡åˆ°è¿™ç§é—®é¢˜åå¦‚ä½•åˆç†é…ç½®å¹¶è¡Œåº¦å‘¢ï¼Ÿ</p><a id="more"></a><h3 id="9-4-1-Source-ç«¯å¹¶è¡Œåº¦çš„é…ç½®"><a href="#9-4-1-Source-ç«¯å¹¶è¡Œåº¦çš„é…ç½®" class="headerlink" title="9.4.1 Source ç«¯å¹¶è¡Œåº¦çš„é…ç½®"></a>9.4.1 Source ç«¯å¹¶è¡Œåº¦çš„é…ç½®</h3><p>å‡è®¾æ•°æ®æºç«¯æ˜¯ Kafkaï¼Œåœ¨å‡ºç°ä½œä¸šæ¶ˆè´¹ä¸åŠæ—¶çš„æ—¶å€™ï¼Œé¦–å…ˆçœ‹ä¸‹ Kafka çš„ç›‘æ§æ˜¯ä¸æ˜¯ç°åœ¨ç”Ÿäº§è€…ç”Ÿäº§çš„æ•°æ®ä¸Šæ¶¨é€Ÿåº¦è¾ƒå¿«ï¼Œä»è€Œå¯¼è‡´ä½œä¸šç›®å‰çš„æ¶ˆè´¹é€Ÿåº¦å°±æ˜¯è·Ÿä¸ä¸Š Kafka ç”Ÿäº§è€…çš„ç”Ÿäº§é€Ÿåº¦ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£ä¹ˆå°±å¾—æŸ¥çœ‹ä½œä¸šçš„å¹¶è¡Œåº¦å’Œ Kafka çš„åˆ†åŒºæ•°æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœå°äº Kafka çš„åˆ†åŒºæ•°ï¼Œé‚£ä¹ˆå¯ä»¥å¢å¤§å¹¶è¡Œåº¦è‡³ Kafka çš„åˆ†åŒºæ•°ï¼Œç„¶åå†è§‚å¯Ÿä½œä¸šæ¶ˆè´¹é€Ÿåº¦æ˜¯å¦å¯ä»¥è·Ÿä¸Šæ•°æ®ç”Ÿäº§é€Ÿåº¦ï¼›å¦‚æœå·²ç»ç­‰äº Kafka çš„åˆ†åŒºæ•°äº†ï¼Œé‚£å¾—è€ƒè™‘ä¸‹æ˜¯å¦ Kafka è¦æ‰©å¤§åˆ†åŒºï¼Œä½†æ˜¯è¿™æ ·å¯èƒ½ä¼šå¸¦æ¥ Kafka å…¶ä»–çš„é—®é¢˜ï¼Œè¿™ä¸ªæ“ä½œéœ€è¦è°¨æ…ã€‚</p><p>Kafka ä¸­æ•°æ®å‡ºç°å †ç§¯çš„è¯ï¼Œè¿˜å¯ä»¥åˆ†æä¸‹æ•°æ®çš„ç±»å‹ï¼Œå¦‚æœæ•°æ®ä¸é‡è¦ï¼Œä½†æ˜¯åˆè¦ä¿è¯æ•°æ®çš„åŠæ—¶æ€§ï¼Œå¯ä»¥ä¿®æ”¹ä½œä¸šè®©ä½œä¸šå§‹ç»ˆä»æœ€æ–°çš„æ•°æ®å¼€å§‹æ¶ˆè´¹ï¼Œä¸¢å¼ƒä¹‹å‰å †ç§¯çš„æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ•°æ®çš„åŠæ—¶æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ä¸€ä¸ªå®æ—¶å‘Šè­¦ä½œä¸šå®ƒçªç„¶æ¶ˆè´¹ä¸åŠæ—¶ï¼ŒKafka ä¸­å †ç§¯äº†å‡ äº¿æ¡æ•°æ®ï¼ˆæ•°æ®å»¶è¿Ÿå‡ ä¸ªå°æ—¶ï¼‰ï¼Œé‚£ä¹ˆå¦‚æœä½œä¸šè°ƒé«˜å¹¶è¡Œåº¦é‡å¯åï¼Œå®ƒè¿˜æ˜¯ä»ä¸Šä¸€æ¬¡æäº¤çš„ offset å¤„å¼€å§‹æ¶ˆè´¹çš„è¯ï¼Œè¿™æ ·å‘Šè­¦ä½œä¸šå³ä½¿ç°åœ¨æ¶ˆè´¹é€Ÿåº¦è·Ÿçš„ä¸Šäº†ï¼Œä½†æ˜¯å®ƒè¦å¤„ç†æ‰ä¹‹å‰å †ç§¯çš„å‡ äº¿æ¡æ•°æ®ä¹Ÿæ˜¯è¦ä¸€æ®µæ—¶é—´çš„ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¿™ä¸ªä½œä¸šä»å°†æœ‰æ®µæ—¶é—´å¤„äº â€˜ä¸å¯ç”¨â€™ã€‚å› ä¸ºå³ä½¿åˆ¤æ–­å‡ºæ¥è¦å‘Šè­¦ï¼Œå¯èƒ½è¿™ä¸ªå‘Šè­¦ä¿¡æ¯çš„åŸæ•°æ®å·²ç»æ˜¯å‡ ä¸ªå°æ—¶å‰çš„äº†ï¼Œæ²¡å‡†è¿™ä¸ªå‘Šè­¦æ­¤æ—¶å·²ç»æ¢å¤äº†ï¼Œä½†æ˜¯è¿˜å‘å‡ºæ¥å‘Šè­¦è¿™å°±æ„å‘³ç€å»¶è¿Ÿæ€§æ¯”è¾ƒå¤§ï¼Œè¿˜ä¼šå¯¹å‘Šè­¦æ¶ˆæ¯æ¥æ”¶è€…é€ æˆä¸€å®šçš„å¹²æ‰°ï¼Œæ‰€ä»¥è¿™ç§åœºæ™¯ä¸‹å»ºè®®é‡å¯ä½œä¸šå°±ç›´æ¥å¼€å§‹ä»æœ€æ–°çš„æ•°æ®å¼€å§‹æ¶ˆè´¹ã€‚å½“ç„¶ä¸åŒçš„åœºæ™¯å¯èƒ½ä¸ä¸€æ ·ï¼Œå¦‚æœé‡‘èè¡Œä¸šçš„äº¤æ˜“æ•°æ®ï¼Œé‚£ä¹ˆæ˜¯è‚¯å®šä¸èƒ½å…è®¸è¿™æ ·ä¸¢æ•°æ®çš„ï¼Œå³ä½¿å †ç§¯äº†ï¼Œä¹Ÿè¦æ…¢æ…¢çš„å»æ¶ˆè´¹å †ç§¯çš„æ•°æ®ï¼Œç›´åˆ°åé¢è¿½å¹³è‡³æœ€æ–°çš„æ•°æ®ã€‚</p><p>åœ¨ Source ç«¯è®¾ç½®å¹¶è¡Œåº¦çš„è¯ï¼Œå¦‚æœæ•°æ®æºæ˜¯ Kafka çš„è¯ï¼Œå»ºè®®å¹¶è¡Œåº¦ä¸è¦è¶…è¿‡ Kafka çš„åˆ†åŒºæ•°ï¼Œå› ä¸ºä¸€ä¸ªå¹¶è¡Œåº¦ä¼šå»å¤„ç†ä¸€è‡³å¤šä¸ªåˆ†åŒºçš„æ•°æ®ï¼Œå¦‚æœè®¾ç½®è¿‡å¤šçš„è¯ï¼Œä¼šå‡ºç°éƒ¨åˆ†å¹¶è¡Œåº¦ç©ºé—²ã€‚å¦‚æœæ˜¯å…¶ä»–çš„æ•°æ®æºï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µåˆç†å¢å¤§å¹¶è¡Œåº¦æ¥æé«˜ä½œä¸šçš„å¤„ç†æ•°æ®èƒ½åŠ›ã€‚</p><h3 id="9-4-2-ä¸­é—´-Operator-å¹¶è¡Œåº¦çš„é…ç½®"><a href="#9-4-2-ä¸­é—´-Operator-å¹¶è¡Œåº¦çš„é…ç½®" class="headerlink" title="9.4.2 ä¸­é—´ Operator å¹¶è¡Œåº¦çš„é…ç½®"></a>9.4.2 ä¸­é—´ Operator å¹¶è¡Œåº¦çš„é…ç½®</h3><p>æ•°æ®ä» Source ç«¯æµå…¥åï¼Œé€šå¸¸ä¼šè¿›è¡Œä¸€å®šçš„æ•°æ®è½¬æ¢ã€èšåˆæ‰èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ï¼Œåœ¨æ•°æ®è½¬æ¢ä¸­å¯èƒ½ä¼šå’Œç¬¬ä¸‰æ–¹ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œåœ¨äº¤äº’çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºç½‘ç»œåŸå› æˆ–è€…ç¬¬ä¸‰æ–¹æœåŠ¡åŸå› å¯¼è‡´æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªæ•°æ®äº¤äº’çš„ç®—å­å¤„ç†æ•°æ®çš„ååé‡ä¼šé™ä½ï¼Œå¯èƒ½ä¼šé€ æˆåå‹ï¼Œä»è€Œä¼šå½±å“ä¸Šæ¸¸çš„ç®—å­çš„æ¶ˆè´¹ã€‚é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹è¿™äº›ä¸ç¬¬ä¸‰æ–¹ç³»ç»Ÿæœ‰äº¤äº’çš„ç®—å­å¾—ç¨å¾®æé«˜å¹¶è¡Œåº¦ï¼Œé˜²æ­¢å‡ºç°è¿™ç§åå‹é—®é¢˜ï¼ˆå½“ç„¶åå‹é—®é¢˜ä¸ä¸€å®šå°±è¿™æ ·å¯ä»¥è§£å†³ï¼Œå…·ä½“å¦‚ä½•å¤„ç†å‚è§ 9.1 èŠ‚ï¼‰ã€‚</p><p>é™¤äº†è¿™ç§ä¸ç¬¬ä¸‰æ–¹æœåŠ¡åšäº¤äº’çš„å¤–ï¼Œå¦å¤–å¯èƒ½çš„æ€§èƒ½ç“¶é¢ˆä¹Ÿä¼šå‡ºç°åœ¨è¿™ç±»ç®—å­ä¸­ï¼Œæ¯”å¦‚ä½  Kafka è¿‡æ¥çš„æ•°æ®æ˜¯ JSON ä¸²çš„ Stringï¼Œç„¶åéœ€è¦è½¬æ¢æˆå¯¹è±¡ï¼Œåœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹è¿™ä¸ªè½¬æ¢ä¹Ÿæ˜¯æ¯”è¾ƒè€—è´¹æ€§èƒ½çš„ã€‚</p><p>æ‰€ä»¥æ•°æ®è½¬æ¢ä¸­é—´è¿‡ç¨‹çš„ç®—å­ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœå“ªä¸€æ­¥ç®—å­çš„å¹¶è¡Œåº¦è®¾ç½®çš„ä¸åˆç†ï¼Œå¯èƒ½å°±ä¼šé€ æˆå„ç§å„æ ·çš„é—®é¢˜å‡ºç°ã€‚</p><h3 id="9-4-3-Sink-ç«¯å¹¶è¡Œåº¦çš„é…ç½®"><a href="#9-4-3-Sink-ç«¯å¹¶è¡Œåº¦çš„é…ç½®" class="headerlink" title="9.4.3 Sink ç«¯å¹¶è¡Œåº¦çš„é…ç½®"></a>9.4.3 Sink ç«¯å¹¶è¡Œåº¦çš„é…ç½®</h3><p>Sink ç«¯æ˜¯æ•°æ®æµå‘ä¸‹æ¸¸çš„åœ°æ–¹ï¼Œå¯ä»¥æ ¹æ® Sink ç«¯çš„æ•°æ®é‡è¿›è¡Œè¯„ä¼°ï¼Œå¯èƒ½æœ‰çš„ä½œä¸šæ˜¯ Source ç«¯çš„æ•°æ®é‡æœ€å¤§ï¼Œç„¶åæ•°æ®é‡ä¸æ–­çš„å˜å°‘ï¼Œæœ€ååˆ° Sink ç«¯çš„æ•°æ®å°±ä¸€ç‚¹ç‚¹äº†ï¼Œæ¯”è¾ƒå¸¸è§çš„å°±æ˜¯ç›‘æ§å‘Šè­¦çš„åœºæ™¯ã€‚Source ç«¯çš„æ•°æ®æ˜¯æµ·é‡çš„ï¼Œä½†æ˜¯é€šè¿‡é€å±‚çš„è¿‡æ»¤å’Œè½¬æ¢ï¼Œåˆ°æœ€ååˆ¤æ–­è¦å‘Šè­¦çš„æ•°æ®å…¶å®å·²ç»å‡å°‘å¾ˆå¤šå¾ˆå¤šäº†ï¼Œé‚£ä¹ˆåœ¨æœ€åçš„è¿™ä¸ªåœ°æ–¹å°±å¯ä»¥å°†å¹¶è¡Œåº¦è®¾ç½®çš„å°ä¸€äº›ã€‚</p><p>å½“ç„¶ä¹Ÿå¯èƒ½ä¼šæœ‰è¿™æ ·çš„æƒ…å†µï¼Œåœ¨ Source ç«¯çš„æ•°æ®é‡æ˜¯æœ€å°çš„ï¼Œæ‹¿åˆ° Source ç«¯æµè¿‡æ¥çš„æ•°æ®ååšäº†ç»†ç²’åº¦çš„æ‹†åˆ†ï¼Œé‚£ä¹ˆæ•°æ®é‡å°±ä¸æ–­çš„å¢åŠ äº†ï¼Œåˆ° Sink ç«¯çš„æ•°æ®é‡å°±éå¸¸éå¸¸çš„å¤§äº†ã€‚é‚£ä¹ˆåœ¨ Sink åˆ°ä¸‹æ¸¸çš„å­˜å‚¨ä¸­é—´ä»¶çš„æ—¶å€™å°±éœ€è¦æé«˜å¹¶è¡Œåº¦ã€‚</p><p>å¦å¤– Sink ç«¯ä¹Ÿæ˜¯è¦ä¸ä¸‹æ¸¸çš„æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå¹¶è¡Œåº¦è¿˜å¾—æ ¹æ®ä¸‹æ¸¸çš„æœåŠ¡æŠ—å‹èƒ½åŠ›æ¥è®¾ç½®ï¼Œå¦‚æœåœ¨ Flink Sink è¿™ç«¯çš„æ•°æ®é‡è¿‡å¤§çš„è¯ï¼Œç„¶ååœ¨ Sink å¤„å¹¶è¡Œåº¦ä¹Ÿè®¾ç½®çš„å¾ˆå¤§ï¼Œä½†æ˜¯ä¸‹æ¸¸çš„æœåŠ¡å®Œå…¨æ’‘ä¸ä½è¿™ä¹ˆå¤§çš„å¹¶å‘å†™å…¥ï¼Œä¹Ÿæ˜¯å¯èƒ½ä¼šé€ æˆä¸‹æ¸¸æœåŠ¡ç›´æ¥è¢«å†™æŒ‚çš„ï¼Œä¸‹æ¸¸æœåŠ¡å¯èƒ½è¿˜è¦å¯¹å¤–æä¾›ä¸€äº›å…¶ä»–çš„æœåŠ¡ï¼Œå¦‚æœç¨³å®šæ€§ä¸èƒ½ä¿è¯çš„è¯ï¼Œä¼šé€ æˆå¾ˆå¤§çš„å½±å“ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯è¦åœ¨ Sink å¤„çš„å¹¶è¡Œåº¦åšä¸€å®šçš„æƒè¡¡ã€‚</p><h3 id="9-4-4-Operator-Chain"><a href="#9-4-4-Operator-Chain" class="headerlink" title="9.4.4 Operator Chain"></a>9.4.4 Operator Chain</h3><p>å¯¹äºä¸€èˆ¬çš„ä½œä¸šï¼ˆæ— ç‰¹æ®Šè€—æ€§èƒ½å¤„ï¼‰ï¼Œå¯ä»¥å°½é‡è®©ç®—å­çš„å¹¶è¡Œåº¦ä» Source ç«¯åˆ° Sink ç«¯éƒ½ä¿æŒä¸€è‡´ï¼Œè¿™æ ·å¯ä»¥å°½å¯èƒ½çš„è®© Job ä¸­çš„ç®—å­è¿›è¡Œ chain åœ¨ä¸€èµ·ï¼Œå½¢æˆé“¾ï¼Œæ•°æ®åœ¨é“¾ä¸­å¯ä»¥ç›´æ¥ä¼ è¾“ï¼Œè€Œä¸éœ€è¦å†æ¬¡è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œè¿™æ ·å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—å°±ä¼šå¾—åˆ°é™ä½ã€‚åœ¨ 9.2 èŠ‚ä¸­å…·ä½“è®²è§£äº†ç®—å­ chain åœ¨ä¸€èµ·çš„æ¡ä»¶ï¼Œå¿˜è®°çš„è¯å¯ä»¥å»å›é¡¾ä¸€ä¸‹ã€‚</p><h3 id="9-4-5-å°ç»“ä¸åæ€"><a href="#9-4-5-å°ç»“ä¸åæ€" class="headerlink" title="9.4.5 å°ç»“ä¸åæ€"></a>9.4.5 å°ç»“ä¸åæ€</h3><p>æœ¬èŠ‚è®²äº†ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­ Source ç«¯ã€ä¸­é—´ç®—å­å’Œ Sink ç«¯çš„å¹¶è¡Œåº¦è®¾ç½®çš„ä¸€äº›æŠ€å·§ã€‚å¹¶è¡Œåº¦ä¿®æ”¹åï¼ˆå¢å¤§æˆ–è€…å‡å°ï¼‰é‡å¯ Jobï¼Œå¦‚æœæ˜¯å‡å°å¹¶è¡Œåº¦ï¼Œä¹‹å‰åŸæœ‰çš„å¹¶è¡Œåº¦çš„çŠ¶æ€è¯¥æ€ä¹ˆåŠï¼›å¦‚æœæ˜¯æ–°å¢å¹¶è¡Œåº¦ï¼Œå¦‚ä½•ç¡®ä¿å’ŒåŸæ¥çš„å¹¶è¡Œåº¦çŠ¶æ€ä¿æŒä¸€è‡´ï¼Ÿ</p><p>åŠ å…¥çŸ¥è¯†æ˜Ÿçƒå¯ä»¥çœ‹åˆ°ä¸Šé¢æ–‡ç« ï¼š<a href="https://t.zsxq.com/uFEEYzJ">https://t.zsxq.com/uFEEYzJ</a></p><p><img src="http://zhisheng-blog.oss-cn-hangzhou.aliyuncs.com/img/2019-09-25-zsxq.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;9-4-å¦‚ä½•åˆç†çš„è®¾ç½®-Flink-ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ&quot;&gt;&lt;a href=&quot;#9-4-å¦‚ä½•åˆç†çš„è®¾ç½®-Flink-ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;9.4 å¦‚ä½•åˆç†çš„è®¾ç½® Flink ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ&quot;&gt;&lt;/a&gt;9.4 å¦‚ä½•åˆç†çš„è®¾ç½® Flink ä½œä¸šå¹¶è¡Œåº¦ï¼Ÿ&lt;/h2&gt;&lt;p&gt;åœ¨ 9.2 èŠ‚ä¸­è®²è§£äº† Flink Job ä¸­çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¹¶è¯¦ç»†åˆ†æäº† Flink ä¸­çš„ operator chain åœ¨ä¸€èµ·çš„å„ç§æ¡ä»¶ï¼Œåœ¨ 9.3 èŠ‚ä¸­ä¹Ÿé€šè¿‡çœŸå®ç”Ÿäº§ç¯å¢ƒçš„æ¡ˆä¾‹æ¥åˆ†äº«å¹¶è¡Œåº¦ä¸ Slot çš„æ¦‚å¿µä¸å…³ç³»ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½æœ‰ä¸€å®šçš„ç†è§£ï¼Œä½†æ˜¯æœ‰æ—¶å€™ç”Ÿäº§ç¯å¢ƒå¦‚æœ Job çªç„¶æ¶ˆè´¹ä¸åŠæ—¶äº†ï¼Œæˆ–è€… Job å°±æ ¹æœ¬ä¸åœ¨æ¶ˆè´¹æ•°æ®äº†ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆåŠï¼Ÿé¦–å…ˆå¾—çœ‹ä¸‹ç›¸å…³çš„ç›‘æ§æŸ¥çœ‹ Job æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œï¼Œæ˜¯å¦å‡ºç°åå‹çš„æƒ…å†µï¼Œæ˜¯å¦è¿™ä¼šç”Ÿäº§æ•°æ®é‡è¿‡å¤§ç„¶è€Œå¹¶è¡Œåº¦å´æ˜¯æ ¹æ®ä¹‹å‰æ•°æ®é‡è®¾ç½®çš„ï¼Œç§ç§åŸå› éƒ½éœ€è¦ä¸€ä¸ªä¸ªæ’æŸ¥ä¸€ä¸‹ï¼Œç„¶åæ‰¾åˆ°æ ¹å› æ‰èƒ½å¤Ÿå¯¹åº”çš„å»è§£å†³ã€‚è¿™èŠ‚æ¥è®²è§£ä¸‹é‡åˆ°è¿™ç§é—®é¢˜åå¦‚ä½•åˆç†é…ç½®å¹¶è¡Œåº¦å‘¢ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://www.54tianzhisheng.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Flink" scheme="http://www.54tianzhisheng.cn/tags/Flink/"/>
    
      <category term="æµå¼è®¡ç®—" scheme="http://www.54tianzhisheng.cn/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
</feed>
